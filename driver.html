<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA Delivery｜配達員</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="container">

  <div class="topbar">
    <div class="brand">
      <div style="width:38px;height:38px;border-radius:14px;background:linear-gradient(180deg,rgba(255,214,10,.95),rgba(255,45,85,.55));display:grid;place-items:center;font-weight:900;color:#111;">OFA</div>
      <div>
        <div style="font-size:14px;font-weight:900;">配達員アプリ</div>
        <small>入力 → 保存</small>
      </div>
    </div>
    <span class="badge">Driver</span>
  </div>

  <div class="card">
    <div class="cardTitle">
      <strong>配達入力</strong>
      <span class="badge">Firestore</span>
    </div>

    <div class="twoCol">
      <div class="field">
        <label>日付</label>
        <input id="date" type="date" />
      </div>
      <div class="field">
        <label>エリア</label>
        <input id="area" type="text" placeholder="例：鹿児島市" />
      </div>
    </div>

    <div class="twoCol">
      <div class="field">
        <label>取引先</label>
        <input id="client" type="text" placeholder="例：ヤマト / 佐川 / Amazon" />
      </div>
      <div class="field">
        <label>個数</label>
        <input id="qty" type="number" min="0" step="1" placeholder="例：120" />
      </div>
    </div>

    <div class="field">
      <label>メモ</label>
      <input id="memo" type="text" placeholder="例：持ち戻り2件、雨" />
    </div>

    <div class="field">
      <label>画像（任意）</label>
      <input id="img" type="file" accept="image/*" />
      <small class="note">※画像は Storage に上げてURLを保存します</small>
    </div>

    <div class="btnRow">
      <button class="btn primary" id="btnSave">保存</button>
      <button class="btn yellow" id="btnReload">一覧更新</button>
      <a class="btn danger" href="index.html">戻る</a>
    </div>
  </div>

  <div class="card">
    <div class="cardTitle">
      <strong>保存済み一覧</strong>
      <span class="badge">latest</span>
    </div>
    <div id="list" class="note">読み込み中...</div>
  </div>

</div>

<script type="module">
  import { saveDelivery, loadDeliveries, uploadImage } from "./app.js";

  const $ = (id) => document.getElementById(id);

  // 初期日付
  (() => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    $("date").value = `${yyyy}-${mm}-${dd}`;
  })();

  async function renderList() {
    try {
      const rows = await loadDeliveries();
      // ざっくり新しい順（createdAtがFirestore Timestampの場合は取れないことがあるのでID順）
      const html = rows
        .slice()
        .reverse()
        .map((r) => {
          const img = r.imageUrl ? `<div style="margin-top:8px;"><img src="${r.imageUrl}" style="max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.08);" /></div>` : "";
          return `
            <div style="padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;margin:10px 0;">
              <div style="font-weight:900;">${r.date ?? ""} / ${r.area ?? ""}</div>
              <div style="opacity:.9;margin-top:4px;">取引先：${r.client ?? ""} ｜ 個数：${r.qty ?? ""}</div>
              <div style="opacity:.8;margin-top:4px;">${r.memo ?? ""}</div>
              ${img}
            </div>
          `;
        })
        .join("");
      $("list").innerHTML = html || `<div class="note">まだデータがありません</div>`;
    } catch (e) {
      $("list").innerHTML = `<div class="note">読み込みエラー：${e?.message ?? String(e)}</div>`;
    }
  }

  $("btnReload").onclick = renderList;

  $("btnSave").onclick = async () => {
    try {
      const date = $("date").value;
      const area = $("area").value.trim();
      const client = $("client").value.trim();
      const qty = Number($("qty").value || 0);
      const memo = $("memo").value.trim();

      let imageUrl = "";
      const file = $("img").files?.[0];
      if (file) {
        imageUrl = await uploadImage(file);
      }

      await saveDelivery({ date, area, client, qty, memo, imageUrl });
      alert("保存しました");

      // 画像リセット
      $("img").value = "";
      await renderList();
    } catch (e) {
      alert(e?.message ?? String(e));
    }
  };

  renderList();
</script>
</body>
</html>
