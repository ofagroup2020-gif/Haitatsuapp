<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --ofa-black:#111;
      --ofa-yellow:#FFD400;
      --ofa-red:#E53935;
      --ofa-blue:#1565C0;
      --bg:#0f1115;
      --card:#151a22;
      --muted:#9aa4b2;
      --text:#eef2f7;
      --line:#263044;
      --ok:#18b26a;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1100px 600px at 20% -10%, rgba(255,212,0,.25), transparent 60%),
                  radial-gradient(900px 500px at 100% 10%, rgba(21,101,192,.20), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(90deg, rgba(255,212,0,.18), rgba(229,57,53,.12), rgba(21,101,192,.12));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(38,48,68,.7);
      padding:14px 14px 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, var(--ofa-yellow), #fff2a8);
      color:#000;font-weight:900;display:grid;place-items:center;
      box-shadow:0 10px 30px rgba(255,212,0,.18);
    }
    .title{
      line-height:1.1;
    }
    .title b{font-size:15px}
    .title small{display:block;color:var(--muted);font-size:11px;margin-top:2px}
    .tabs{
      display:flex; gap:8px; margin-top:10px;
    }
    .tab{
      flex:1;
      padding:10px 8px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(38,48,68,.8);
      color:var(--text);
      border-radius:14px;
      font-weight:800;
      font-size:12px;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(255,212,0,.22), rgba(21,101,192,.12));
      border-color: rgba(255,212,0,.35);
    }

    main{padding:14px; max-width:980px; margin:0 auto;}
    .grid{display:grid; gap:12px;}
    .card{
      background:rgba(21,26,34,.9);
      border:1px solid rgba(38,48,68,.9);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.02em;
    }
    .row{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media(min-width:720px){
      .row.two{grid-template-columns: 1fr 1fr;}
      .row.three{grid-template-columns: 1fr 1fr 1fr;}
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(38,48,68,.9);
      background:rgba(10,12,16,.55);
      color:var(--text);
      padding:11px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:84px; resize:vertical;}
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    button{
      border:0;
      border-radius:14px;
      padding:11px 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--ofa-yellow), #ffe77a);
      color:#000;
    }
    .btn-ghost{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(38,48,68,.9);
      color:var(--text);
    }
    .btn-ok{background:rgba(24,178,106,.15); border:1px solid rgba(24,178,106,.35); color:#d7ffe8;}
    .btn-warn{background:rgba(255,176,32,.12); border:1px solid rgba(255,176,32,.35); color:#fff3d4;}
    .btn-bad{background:rgba(255,77,77,.10); border:1px solid rgba(255,77,77,.35); color:#ffd6d6;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(38,48,68,.9);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:11px;
      margin-right:8px;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi .box{
      flex:1; min-width:140px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(38,48,68,.9);
      border-radius:14px;
      padding:12px;
    }
    .kpi .box b{display:block;font-size:18px;margin-top:4px}
    .list{
      display:grid; gap:10px;
    }
    .item{
      border:1px solid rgba(38,48,68,.9);
      border-radius:14px;
      padding:12px;
      background:rgba(10,12,16,.35);
    }
    .item-top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item-top b{font-size:14px}
    .status{
      font-weight:900; font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(38,48,68,.9);
      white-space:nowrap;
    }
    .st-created{background:rgba(255,255,255,.04); color:var(--muted)}
    .st-out{background:rgba(21,101,192,.14); border-color:rgba(21,101,192,.35); color:#d7e8ff}
    .st-done{background:rgba(24,178,106,.15); border-color:rgba(24,178,106,.35); color:#d7ffe8}
    .st-absent{background:rgba(255,176,32,.14); border-color:rgba(255,176,32,.35); color:#fff3d4}
    .st-return{background:rgba(255,77,77,.12); border-color:rgba(255,77,77,.35); color:#ffd6d6}
    .meta{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .mini{color:var(--muted); font-size:11px}
    .split{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .hr{height:1px;background:rgba(38,48,68,.9); margin:12px 0;}
    .cam{
      display:none;
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(38,48,68,.9);
      background:#000;
    }
    video{width:100%; height:auto; display:block;}
    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">OFA</div>
    <div class="title">
      <b>é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</b>
      <small>èª­ã¿å–ã‚Š / å±¥æ­´ / æ—¥å ±ï¼ˆPDFãƒ»CSVï¼‰</small>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="input">å…¥åŠ›</button>
    <button class="tab" data-tab="list">å±¥æ­´</button>
    <button class="tab" data-tab="report">æ—¥å ±</button>
  </div>
</header>

<main>
  <!-- å…¥åŠ› -->
  <section id="tab-input" class="grid">
    <div class="card">
      <h2>â‘  ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>

      <div class="row two">
        <div>
          <label>é…é”æ—¥</label>
          <input id="shipDate" type="date">
        </div>
        <div>
          <label>é…é”å“¡å</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸">
        </div>
      </div>

      <div class="row two" style="margin-top:10px;">
        <div>
          <label>ä¼ç¥¨ç•ªå·ï¼ˆè¿½è·¡ç•ªå·ï¼‰</label>
          <input id="tracking" type="text" inputmode="numeric" placeholder="èª­ã¿å–ã‚Š or æ‰‹å…¥åŠ›">
          <div class="mini" style="margin-top:6px;">â€»QR/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã¯ç«¯æœ«å¯¾å¿œæ™‚ã®ã¿è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</div>
        </div>
        <div>
          <label>å–å¼•å…ˆï¼ˆä»»æ„ï¼‰</label>
          <input id="client" type="text" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆ / ä½å· / Amazon / ã‚¢ãƒ‘ãƒ¬ãƒ« ç­‰">
        </div>
      </div>

      <div class="row two" style="margin-top:10px;">
        <div>
          <label>ä½æ‰€ï¼ˆä»»æ„ï¼šåœ°å›³èµ·å‹•ã«ä½¿ç”¨ï¼‰</label>
          <input id="address" type="text" placeholder="ä¾‹ï¼šé¹¿å…å³¶å¸‚ã€‡ã€‡â€¦">
        </div>
        <div>
          <label>è·ç‰©æ•°ï¼ˆä»»æ„ï¼‰</label>
          <input id="pieces" type="number" min="1" step="1" placeholder="ä¾‹ï¼š1">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="memo" placeholder="ç½®ãé…ã€æ™‚é–“æŒ‡å®šã€æ³¨æ„ç‚¹ãªã©"></textarea>
        </div>
      </div>

      <div class="btns" style="margin-top:12px;">
        <button class="btn-ghost" id="btnScan">ğŸ“· ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Š</button>
        <button class="btn-primary" id="btnAdd">ï¼‹ ç™»éŒ²ï¼ˆæœªæŒå‡ºï¼‰</button>
      </div>

      <div class="cam" id="camBox">
        <video id="video" playsinline></video>
      </div>

      <div class="hr"></div>
      <div class="note">
        <b>é‹ç”¨ãƒ¡ãƒ¢ï¼š</b><br>
        ãƒ»ã¾ãšã€Œç™»éŒ²ã€â†’ ãã®å¾Œã«ã€ŒæŒå‡ºã€ã€Œå®Œäº†ã€ã€Œä¸åœ¨ã€ã‚’æŠ¼ã™æµã‚ŒãŒæ¥½ã§ã™ã€‚<br>
        ãƒ»ã“ã®ãƒšãƒ¼ã‚¸ã¯ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã™ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œï¼‰ã€‚ä¼šç¤¾å…±æœ‰ã‚’ã™ã‚‹å ´åˆã¯æ¬¡æ®µéšã§ã‚¯ãƒ©ã‚¦ãƒ‰é€£æºã—ã¾ã™ã€‚
      </div>
    </div>
  </section>

  <!-- å±¥æ­´ -->
  <section id="tab-list" class="grid" style="display:none;">
    <div class="card">
      <h2>â‘¡ å±¥æ­´ä¸€è¦§ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼‰</h2>

      <div class="row three">
        <div>
          <label>æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿</label>
          <input id="filterDate" type="date">
        </div>
        <div>
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="filterStatus">
            <option value="">ã™ã¹ã¦</option>
            <option value="created">æœªæŒå‡º</option>
            <option value="out">æŒå‡º</option>
            <option value="done">å®Œäº†</option>
            <option value="absent">ä¸åœ¨</option>
            <option value="return">è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
          </select>
        </div>
        <div>
          <label>æ¤œç´¢ï¼ˆä¼ç¥¨ç•ªå·/ä½æ‰€/å–å¼•å…ˆï¼‰</label>
          <input id="filterText" type="text" placeholder="æ¤œç´¢">
        </div>
      </div>

      <div class="hr"></div>

      <div class="list" id="historyList"></div>

      <div class="hr"></div>
      <div class="btns">
        <button class="btn-ghost" id="btnExportCSVAll">CSVå‡ºåŠ›ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰</button>
        <button class="btn-ghost" id="btnExportPDFAll">PDFå‡ºåŠ›ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰</button>
        <button class="btn-bad" id="btnClearAll">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆæ³¨æ„ï¼‰</button>
      </div>
    </div>
  </section>

  <!-- æ—¥å ± -->
  <section id="tab-report" class="grid" style="display:none;">
    <div class="card">
      <h2>â‘¢ æ—¥å ±ï¼ˆä»Šæ—¥/æŒ‡å®šæ—¥ï¼‰</h2>

      <div class="row two">
        <div>
          <label>å¯¾è±¡æ—¥</label>
          <input id="reportDate" type="date">
        </div>
        <div>
          <label>é…é”å“¡åï¼ˆå°å­—ç”¨ï¼‰</label>
          <input id="reportDriver" type="text" placeholder="æœªå…¥åŠ›ãªã‚‰å…¥åŠ›ã‚¿ãƒ–ã®é…é”å“¡åã‚’ä½¿ç”¨">
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpi" id="kpi"></div>

      <div class="hr"></div>

      <div class="btns">
        <button class="btn-primary" id="btnExportCSVReport">CSVå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
        <button class="btn-primary" id="btnExportPDFReport">PDFå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
      </div>

      <div class="note" style="margin-top:10px;">
        â€»PDFã¯A4ã§ã€LINEé€ä¿¡ç”¨ã«ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ã§å‡ºã¾ã™ã€‚
      </div>
    </div>
  </section>
</main>

<script>
/** =========================
 *  ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
 *  shipments: [
 *    {
 *      id, shipDate, driver, tracking, client, address, pieces, memo,
 *      status: created|out|done|absent|return,
 *      history: [{at, action, note}]
 *    }
 *  ]
 * ========================= */
const STORAGE_KEY = "ofa_shipments_v1";

function nowISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function uid(){
  return "S" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function loadShipments(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  }catch(e){
    return [];
  }
}
function saveShipments(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

function statusLabel(s){
  return ({
    created:"æœªæŒå‡º",
    out:"æŒå‡º",
    done:"å®Œäº†",
    absent:"ä¸åœ¨",
    return:"è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
  })[s] || s;
}
function statusClass(s){
  return ({
    created:"st-created",
    out:"st-out",
    done:"st-done",
    absent:"st-absent",
    return:"st-return"
  })[s] || "st-created";
}

/** =========================
 *  ã‚¿ãƒ–
 * ========================= */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const name = t.dataset.tab;
    document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
    document.getElementById("tab-"+name).style.display="grid";
    if(name==="list") renderList();
    if(name==="report") renderReport();
  });
});

/** =========================
 *  åˆæœŸå€¤ï¼ˆæ—¥ä»˜ï¼‰
 * ========================= */
const today = new Date();
const pad = n => String(n).padStart(2,"0");
const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

document.getElementById("shipDate").value = todayStr;
document.getElementById("filterDate").value = todayStr;
document.getElementById("reportDate").value = todayStr;

/** =========================
 *  ç™»éŒ²
 * ========================= */
document.getElementById("btnAdd").addEventListener("click", ()=>{
  const shipDate = document.getElementById("shipDate").value || todayStr;
  const driver = (document.getElementById("driver").value || "").trim();
  const tracking = (document.getElementById("tracking").value || "").trim();
  const client = (document.getElementById("client").value || "").trim();
  const address = (document.getElementById("address").value || "").trim();
  const pieces = parseInt(document.getElementById("pieces").value || "1",10);
  const memo = (document.getElementById("memo").value || "").trim();

  if(!tracking){
    alert("ä¼ç¥¨ç•ªå·ï¼ˆè¿½è·¡ç•ªå·ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const list = loadShipments();
  // åŒã˜ç•ªå·ãŒã‚ã‚Œã°è­¦å‘Šï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  const dup = list.find(x => x.tracking === tracking && x.shipDate === shipDate);
  if(dup){
    if(!confirm("åŒã˜ä¼ç¥¨ç•ªå·ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚é‡è¤‡ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
  }

  const item = {
    id: uid(),
    shipDate,
    driver,
    tracking,
    client,
    address,
    pieces: Number.isFinite(pieces) && pieces>0 ? pieces : 1,
    memo,
    status: "created",
    history: [{ at: nowISO(), action: "ç™»éŒ²", note: "" }]
  };
  list.unshift(item);
  saveShipments(list);

  // å…¥åŠ›ã‚¯ãƒªã‚¢ï¼ˆè¿½è·¡ç•ªå·ã ã‘ç©ºã«ï¼‰
  document.getElementById("tracking").value = "";
  document.getElementById("memo").value = "";
  document.getElementById("pieces").value = "";

  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼ˆæœªæŒå‡ºï¼‰");
});

/** =========================
 *  å±¥æ­´ä¸€è¦§
 * ========================= */
["filterDate","filterStatus","filterText"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderList);
});

function applyFilters(list){
  const d = document.getElementById("filterDate").value;
  const st = document.getElementById("filterStatus").value;
  const q = (document.getElementById("filterText").value || "").trim().toLowerCase();

  return list.filter(x=>{
    const okD = d ? x.shipDate === d : true;
    const okS = st ? x.status === st : true;
    const hay = `${x.tracking} ${x.address} ${x.client} ${x.memo}`.toLowerCase();
    const okQ = q ? hay.includes(q) : true;
    return okD && okS && okQ;
  });
}

function renderList(){
  const box = document.getElementById("historyList");
  const list = applyFilters(loadShipments());

  if(list.length===0){
    box.innerHTML = `<div class="note">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }

  box.innerHTML = list.map(x=>{
    const last = x.history?.[x.history.length-1];
    const lastLine = last ? `${last.at} / ${last.action}` : "";
    const mapLink = x.address ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(x.address)}` : "";
    return `
      <div class="item">
        <div class="item-top">
          <div>
            <b>${escapeHtml(x.tracking)}</b>
            <div class="mini">${escapeHtml(x.client || "ï¼ˆå–å¼•å…ˆæœªå…¥åŠ›ï¼‰")} / ${escapeHtml(x.shipDate)}</div>
          </div>
          <div class="status ${statusClass(x.status)}">${statusLabel(x.status)}</div>
        </div>
        <div class="meta">
          ä½æ‰€ï¼š${escapeHtml(x.address || "ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          å€‹æ•°ï¼š${escapeHtml(String(x.pieces || 1))} ï¼ é…é”å“¡ï¼š${escapeHtml(x.driver || "ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          æœ€çµ‚ï¼š${escapeHtml(lastLine)}
        </div>

        <div class="split">
          <div class="btns">
            <button class="btn-ok" onclick="updateStatus('${x.id}','out','æŒå‡º')">æŒå‡º</button>
            <button class="btn-ok" onclick="updateStatus('${x.id}','done','å®Œäº†')">å®Œäº†</button>
            <button class="btn-warn" onclick="updateStatus('${x.id}','absent','ä¸åœ¨')">ä¸åœ¨</button>
            <button class="btn-bad" onclick="updateStatus('${x.id}','return','è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«')">è¿”å´</button>
          </div>
          <div class="btns">
            ${mapLink ? `<button class="btn-ghost" onclick="openMap('${mapLink}')">ğŸ—º åœ°å›³</button>` : `<button class="btn-ghost" disabled>ğŸ—º åœ°å›³</button>`}
            <button class="btn-ghost" onclick="showDetail('${x.id}')">è©³ç´°</button>
            <button class="btn-bad" onclick="deleteOne('${x.id}')">å‰Šé™¤</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function openMap(url){
  window.open(url, "_blank");
}

function updateStatus(id, status, label){
  const list = loadShipments();
  const item = list.find(x=>x.id===id);
  if(!item) return;

  item.status = status;
  item.history = item.history || [];
  item.history.push({ at: nowISO(), action: label, note: "" });
  saveShipments(list);
  renderList();
}

function deleteOne(id){
  if(!confirm("ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const list = loadShipments().filter(x=>x.id!==id);
  saveShipments(list);
  renderList();
}

function showDetail(id){
  const list = loadShipments();
  const item = list.find(x=>x.id===id);
  if(!item) return;
  const h = (item.history||[]).map(r=>`ãƒ»${r.at}ï¼š${r.action}`).join("\n");
  alert(
`ã€è©³ç´°ã€‘
ä¼ç¥¨ç•ªå·ï¼š${item.tracking}
æ—¥ä»˜ï¼š${item.shipDate}
å–å¼•å…ˆï¼š${item.client||""}
ä½æ‰€ï¼š${item.address||""}
å€‹æ•°ï¼š${item.pieces||1}
é…é”å“¡ï¼š${item.driver||""}
ãƒ¡ãƒ¢ï¼š${item.memo||""}

ã€å±¥æ­´ã€‘
${h}`
  );
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/** =========================
 *  ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰
 * ========================= */
function toCSV(rows){
  const esc = v => `"${String(v??"").replaceAll('"','""')}"`;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

function rowsFromList(list){
  return list.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate,
      x.driver,
      x.tracking,
      x.client,
      x.address,
      x.pieces,
      statusLabel(x.status),
      last?.at || "",
      (x.memo||"")
    ];
  });
}

document.getElementById("btnExportCSVAll").addEventListener("click", ()=>{
  const list = applyFilters(loadShipments());
  const header = ["æ—¥ä»˜","é…é”å“¡","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","ä½æ‰€","å€‹æ•°","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsFromList(list)]);
  downloadFile(csv, `OFA_é…é”å±¥æ­´_${todayStr}.csv`, "text/csv;charset=utf-8");
});

/** =========================
 *  PDFå‡ºåŠ›ï¼ˆä¸€è¦§/æ—¥å ±ï¼‰
 * ========================= */
function exportPDF(title, list, filename, metaLines=[]){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});
  doc.setFontSize(14);
  doc.text(title, 14, 14);

  doc.setFontSize(10);
  let y = 20;
  metaLines.forEach(line=>{
    doc.text(line, 14, y);
    y += 5;
  });

  const head = [["æ—¥ä»˜","é…é”å“¡","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","å€‹æ•°","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æœ€çµ‚æ›´æ–°"]];
  const body = list.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate,
      x.driver || "",
      x.tracking,
      x.client || "",
      String(x.pieces || 1),
      statusLabel(x.status),
      (last?.at || "")
    ];
  });

  doc.autoTable({
    startY: y + 2,
    head,
    body,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [20, 26, 34] }, // dark-ish
    theme: "grid"
  });

  // ãƒ•ãƒƒã‚¿ãƒ¼
  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`OFA GROUP / ${todayStr} / Page ${i}/${pageCount}`, 14, 292);
  }

  doc.save(filename);
}

document.getElementById("btnExportPDFAll").addEventListener("click", ()=>{
  const list = applyFilters(loadShipments());
  exportPDF("OFA é…é”å±¥æ­´ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰", list, `OFA_é…é”å±¥æ­´_${todayStr}.pdf`, [
    `å‡ºåŠ›æ—¥æ™‚ï¼š${nowISO()}`
  ]);
});

/** =========================
 *  å…¨å‰Šé™¤
 * ========================= */
document.getElementById("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
  if(!confirm("æœ€çµ‚ç¢ºèªï¼šå¾©å…ƒã§ãã¾ã›ã‚“ã€‚å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY);
  renderList();
  alert("å‰Šé™¤ã—ã¾ã—ãŸ");
});

/** =========================
 *  æ—¥å ±
 * ========================= */
function listByDate(dateStr){
  return loadShipments().filter(x=>x.shipDate===dateStr);
}
function renderReport(){
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = listByDate(dateStr);

  // driver name
  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();

  const total = list.reduce((a,x)=>a+(x.pieces||1),0);
  const cCreated = list.filter(x=>x.status==="created").reduce((a,x)=>a+(x.pieces||1),0);
  const cOut = list.filter(x=>x.status==="out").reduce((a,x)=>a+(x.pieces||1),0);
  const cDone = list.filter(x=>x.status==="done").reduce((a,x)=>a+(x.pieces||1),0);
  const cAbsent = list.filter(x=>x.status==="absent").reduce((a,x)=>a+(x.pieces||1),0);
  const cReturn = list.filter(x=>x.status==="return").reduce((a,x)=>a+(x.pieces||1),0);

  document.getElementById("kpi").innerHTML = `
    <div class="box"><div class="mini">å¯¾è±¡æ—¥</div><b>${escapeHtml(dateStr)}</b></div>
    <div class="box"><div class="mini">é…é”å“¡</div><b>${escapeHtml(driver||"ï¼ˆæœªå…¥åŠ›ï¼‰")}</b></div>
    <div class="box"><div class="mini">åˆè¨ˆå€‹æ•°</div><b>${total}</b></div>
    <div class="box"><div class="mini">å®Œäº†</div><b>${cDone}</b></div>
    <div class="box"><div class="mini">ä¸åœ¨</div><b>${cAbsent}</b></div>
    <div class="box"><div class="mini">æœªæŒå‡º</div><b>${cCreated}</b></div>
    <div class="box"><div class="mini">æŒå‡º</div><b>${cOut}</b></div>
    <div class="box"><div class="mini">è¿”å´</div><b>${cReturn}</b></div>
  `;
}

document.getElementById("reportDate").addEventListener("change", renderReport);
document.getElementById("reportDriver").addEventListener("input", renderReport);

document.getElementById("btnExportCSVReport").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = listByDate(dateStr);

  const header = ["æ—¥ä»˜","é…é”å“¡","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","ä½æ‰€","å€‹æ•°","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsFromList(list)]);
  downloadFile(csv, `OFA_æ—¥å ±_${dateStr}.csv`, "text/csv;charset=utf-8");
});

document.getElementById("btnExportPDFReport").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = listByDate(dateStr);
  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();

  exportPDF("OFA æ—¥å ±ï¼ˆé…é”ï¼‰", list, `OFA_æ—¥å ±_${dateStr}.pdf`, [
    `å¯¾è±¡æ—¥ï¼š${dateStr}`,
    `é…é”å“¡ï¼š${driver || "ï¼ˆæœªå…¥åŠ›ï¼‰"}`,
    `å‡ºåŠ›æ—¥æ™‚ï¼š${nowISO()}`
  ]);
});

/** =========================
 *  ã‚«ãƒ¡ãƒ©èª­ã¿å–ã‚Š
 *  - BarcodeDetector API ãŒä½¿ãˆã‚‹ç«¯æœ«ã¯ç°¡å˜ã«ã‚¹ã‚­ãƒ£ãƒ³å¯èƒ½
 *  - éå¯¾å¿œç«¯æœ«ã¯æ‰‹å…¥åŠ›é‹ç”¨ï¼ˆã“ã“ãŒä¸€ç•ªå®‰å®šï¼‰
 * ========================= */
let stream = null;
let scanning = false;

document.getElementById("btnScan").addEventListener("click", async ()=>{
  const camBox = document.getElementById("camBox");
  const video = document.getElementById("video");

  if(scanning){
    stopCamera();
    camBox.style.display = "none";
    scanning = false;
    return;
  }

  if(!("mediaDevices" in navigator) || !navigator.mediaDevices.getUserMedia){
    alert("ã“ã®ç«¯æœ«ã§ã¯ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚æ‰‹å…¥åŠ›ã§é‹ç”¨ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  camBox.style.display = "block";
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    video.srcObject = stream;
    await video.play();
  }catch(e){
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPSã‹ã€æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    camBox.style.display = "none";
    return;
  }

  // BarcodeDetectorï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
  if(!("BarcodeDetector" in window)){
    alert("ã“ã®ç«¯æœ«ã¯è‡ªå‹•èª­ã¿å–ã‚Šã«éå¯¾å¿œã§ã™ã€‚æ‰‹å…¥åŠ›ã§é‹ç”¨ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const formats = ["qr_code","ean_13","ean_8","code_128","code_39","itf","upc_a","upc_e","data_matrix","pdf417"];
  const detector = new BarcodeDetector({ formats });
  scanning = true;

  const tick = async ()=>{
    if(!scanning) return;
    try{
      const barcodes = await detector.detect(video);
      if(barcodes && barcodes.length){
        // ä¸€ç•ªæœ€åˆã®å€¤ã‚’æ¡ç”¨
        const val = barcodes[0].rawValue || "";
        if(val){
          document.getElementById("tracking").value = val;
          alert("èª­ã¿å–ã‚Šå®Œäº†ï¼š " + val);
          stopCamera();
          camBox.style.display = "none";
          scanning = false;
          return;
        }
      }
    }catch(e){
      // ignore
    }
    requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
});

function stopCamera(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
  }catch(e){}
}

// åˆå›è¡¨ç¤º
renderList();
renderReport();
</script>

</body>
</html>
