<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Leaflet (è»½ã„åœ°å›³) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;

      /* OFA pop */
      --y:#facc15;  /* yellow */
      --r:#ef4444;  /* red */
      --b:#3b82f6;  /* blue */
      --g:#10b981;

      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(900px 450px at 10% 0%, rgba(250,204,21,.18), transparent 55%),
        radial-gradient(900px 450px at 90% 0%, rgba(59,130,246,.16), transparent 55%),
        radial-gradient(900px 450px at 50% 100%, rgba(239,68,68,.10), transparent 55%),
        var(--bg);
      color:var(--ink);
    }

    .wrap{
      max-width: 960px;
      margin: 0 auto;
      padding: 14px 14px 100px;
    }

    /* Header */
    .top{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid rgba(229,231,235,.7);
    }
    .topInner{
      max-width: 960px;
      margin: 0 auto;
      padding: 10px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:40px; height:40px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--y), #ffeaa7);
      display:grid; place-items:center;
      font-weight: 900;
      color:#111827;
      box-shadow: 0 10px 22px rgba(250,204,21,.35);
      flex:0 0 auto;
    }
    .title{
      display:flex;
      flex-direction:column;
      min-width:0;
      line-height:1.15;
    }
    .title b{
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .title small{
      color: var(--muted);
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .statusPills{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 16px rgba(0,0,0,.04);
    }
    .dot{width:8px;height:8px;border-radius:99px;background:#9ca3af}
    .dot.ok{background: var(--g)}
    .dot.ng{background: var(--r)}
    .dot.warn{background: var(--y)}
    .pill b{font-weight:900}
    .pill .mini{color:var(--muted); font-weight:700; font-size:11px}

    /* Tabs */
    .tabs{
      max-width: 960px;
      margin: 0 auto;
      padding: 10px 14px 12px;
    }
    .tabRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    .tabBtn{
      flex:1 1 auto;
      min-width: 140px;
      border-radius: 999px;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      font-weight: 900;
      color:#111827;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.05);
      user-select:none;
    }
    .tabBtn.active{
      border-color: rgba(0,0,0,.06);
      background: linear-gradient(135deg, rgba(250,204,21,.95), rgba(59,130,246,.12));
      box-shadow: 0 14px 30px rgba(250,204,21,.22);
    }
    .tabBtn .badge{
      display:inline-grid;
      place-items:center;
      min-width: 22px;
      height: 22px;
      padding: 0 7px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(17,24,39,.08);
      color:#111827;
      font-weight:900;
    }

    /* Card */
    .card{
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(229,231,235,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 14px 0;
    }
    .card h2{
      margin:0 0 10px;
      font-size: 16px;
    }
    .card p{
      margin: 8px 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* Form */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){
      .grid{grid-template-columns:1fr}
      .tabBtn{min-width: 110px}
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    .req{
      color: var(--r);
      font-weight: 900;
      margin-left: 6px;
      font-size: 11px;
    }
    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.95);
      outline: none;
      font-size: 15px;
    }
    textarea{min-height: 90px; resize: vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.65);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    /* Buttons */
    .btnRow{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: 0 14px 28px rgba(0,0,0,.08);
      user-select:none;
    }
    .btn.primary{background: linear-gradient(135deg, var(--b), rgba(59,130,246,.75)); color:white}
    .btn.yellow{background: linear-gradient(135deg, var(--y), rgba(250,204,21,.85)); color:#111827}
    .btn.red{background: linear-gradient(135deg, var(--r), rgba(239,68,68,.85)); color:white}
    .btn.gray{background: rgba(17,24,39,.06); color:#111827; border:1px solid rgba(17,24,39,.08); box-shadow:none}
    .btn.small{padding: 9px 10px; border-radius: 12px; font-size: 13px; box-shadow:none}
    .btn:active{transform: translateY(1px)}

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.5;
    }

    /* Lists */
    .listTools{
      display:flex;
      flex-wrap: wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .listTools .left, .listTools .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      font-weight: 900;
      font-size: 12px;
      color:#111827;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.25)}
    .items{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      box-shadow: 0 10px 20px rgba(0,0,0,.04);
    }
    .itemLeft{
      display:flex; flex-direction:column; gap:8px; min-width: 0; flex: 1 1 auto;
    }
    .itemTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .idBadge{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid; place-items:center;
      font-weight: 900;
      background: rgba(59,130,246,.10);
      color: var(--b);
      border:1px solid rgba(59,130,246,.20);
      flex:0 0 auto;
    }
    .meta{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
      flex: 1 1 auto;
    }
    .meta b{
      font-size: 15px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .meta small{
      color: var(--muted);
      font-weight: 700;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tags{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top: 2px;
    }
    .tag{
      font-size: 11px;
      font-weight: 900;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(229,231,235,.9);
      background: rgba(17,24,39,.04);
      color:#111827;
    }
    .tag.type{background: rgba(250,204,21,.18); border-color: rgba(250,204,21,.30)}
    .tag.status{background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.25)}
    .tag.status.ng{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22)}

    .actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      flex:0 0 auto;
    }
    .actions .btn{white-space:nowrap}
    .dragHandle{
      cursor: grab;
      user-select:none;
      font-weight: 900;
      color: rgba(17,24,39,.45);
      text-align:center;
      padding: 6px 8px;
      border-radius: 10px;
      border:1px dashed rgba(17,24,39,.15);
      background: rgba(17,24,39,.03);
    }

    /* Map */
    #map{
      width: 100%;
      height: 58vh;
      min-height: 420px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: var(--shadow);
    }
    .mapNote{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.35);
      z-index: 2000;
      padding: 14px;
    }
    .modal.show{display:flex}
    .sheet{
      width: min(720px, 100%);
      border-radius: 22px;
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      padding: 14px;
    }
    .sheetHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .sheetHead b{font-size: 15px}
    .xbtn{
      border:0;
      background: rgba(17,24,39,.06);
      border:1px solid rgba(17,24,39,.10);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheetGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    /* Video scan */
    .scanBox{
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.95);
      overflow:hidden;
      background: rgba(0,0,0,.06);
      position: relative;
      box-shadow: var(--shadow);
    }
    video{
      width:100%;
      height: 260px;
      object-fit: cover;
      display:block;
      background: #111827;
    }
    .scanOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .scanFrame{
      width: 82%;
      height: 56%;
      border: 3px solid rgba(250,204,21,.95);
      border-radius: 16px;
      box-shadow: 0 0 0 999px rgba(0,0,0,.12) inset;
    }
    .scanToast{
      font-size: 12px;
      color:#111827;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(229,231,235,.95);
      border-radius: 999px;
      padding: 8px 10px;
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
      position:absolute;
      left: 10px;
      bottom: 10px;
      display:none;
    }
    .scanToast.show{display:inline-flex}

    /* Footer quick actions */
    .footerBar{
      position: fixed;
      left:0; right:0;
      bottom:0;
      z-index: 1200;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.80);
    }
    .footerInner{
      max-width: 960px;
      margin:0 auto;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap: wrap;
    }
    .footerInner .left, .footerInner .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .kpi{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .kpi b{color:#111827}
  </style>
</head>

<body>
  <!-- Header -->
  <div class="top">
    <div class="topInner">
      <div class="brand">
        <div class="logo">OFA</div>
        <div class="title">
          <b>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</b>
          <small>â‘ ç‚¹å‘¼ â†’ â‘¡é›†è·(SCAN) â†’ â‘¢ãƒªã‚¹ãƒˆ(æ¤œç´¢/ä¸¦æ›¿) â†’ â‘£åœ°å›³(ãƒ”ãƒ³) â†’ â‘¤æ—¥å ±(CSV/PDF)</small>
        </div>
      </div>

      <div class="statusPills">
        <div class="pill"><span class="dot" id="gpsDot"></span><b>GPS</b><span class="mini" id="gpsTxt">æœª</span></div>
        <div class="pill"><span class="dot" id="pinDot"></span><b>ãƒ”ãƒ³</b><span class="mini" id="pinTxt">0</span></div>
        <div class="pill"><span class="dot" id="torchDot"></span><b>ãƒ©ã‚¤ãƒˆ</b><span class="mini" id="torchTxt">æœª</span></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tabRow">
        <div class="tabBtn active" data-tab="tenko">â‘  Webç‚¹å‘¼ <span class="badge" id="badgeTenko">!</span></div>
        <div class="tabBtn" data-tab="pickup">â‘¡ é›†è·(SCAN) <span class="badge" id="badgePickup">0</span></div>
        <div class="tabBtn" data-tab="list">â‘¢ ãƒªã‚¹ãƒˆ <span class="badge" id="badgeList">0</span></div>
        <div class="tabBtn" data-tab="map">â‘£ åœ°å›³ <span class="badge" id="badgeMap">0</span></div>
        <div class="tabBtn" data-tab="report">â‘¤ æ—¥å ± <span class="badge" id="badgeReport">0</span></div>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- â‘  TENKO -->
    <section class="card" id="tab-tenko">
      <h2>â‘  Webç‚¹å‘¼ï¼ˆï¼‹æ—¥å¸¸ç‚¹æ¤œï¼‰</h2>
      <p>ã¾ãšã“ã“ã§ã€Œç‚¹å‘¼ãƒ»æ—¥å¸¸ç‚¹æ¤œã€ã‚’å®Œäº† â†’ ãã®æ—¥ã®é…é”ã«é€²ã‚€ã€‚å±¥æ­´ã¯ç«¯æœ«ä¿å­˜ï¼ˆCSV/PDFå‡ºåŠ›å¯ï¼‰ã€‚</p>

      <div class="grid">
        <div class="field">
          <label>æ—¥ä»˜</label>
          <input type="date" id="tenkoDate">
        </div>
        <div class="field">
          <label>ç‚¹å‘¼æ™‚åˆ»</label>
          <input type="time" id="tenkoTime">
        </div>
        <div class="field">
          <label>æ°åï¼ˆä»»æ„ï¼šä¼šç¤¾å´ã®ç®¡ç†ç”¨ï¼‰</label>
          <input type="text" id="tenkoName" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸">
        </div>
        <div class="field">
          <label>ä½“èª¿</label>
          <select id="tenkoCondition">
            <option value="è‰¯å¥½">è‰¯å¥½</option>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="ä¸å®‰ã‚ã‚Š">ä¸å®‰ã‚ã‚Š</option>
          </select>
        </div>
        <div class="field">
          <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ï¼ˆè‡ªå·±ç”³å‘Šï¼‰</label>
          <select id="tenkoAlcohol">
            <option value="å•é¡Œãªã—">å•é¡Œãªã—</option>
            <option value="æœªå®Ÿæ–½">æœªå®Ÿæ–½</option>
            <option value="NG">NG</option>
          </select>
        </div>
        <div class="field">
          <label>é‹è¡Œå¯å¦</label>
          <select id="tenkoGo">
            <option value="é‹è¡Œå¯">é‹è¡Œå¯</option>
            <option value="é‹è¡Œä¸å¯">é‹è¡Œä¸å¯</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:6px">æ—¥å¸¸ç‚¹æ¤œï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</h2>
        <div class="grid">
          <label class="field" style="flex-direction:row; align-items:center; gap:10px">
            <input type="checkbox" id="chkTire"> ã‚¿ã‚¤ãƒ¤ï¼ˆç©ºæ°—åœ§/äº€è£‚ï¼‰
          </label>
          <label class="field" style="flex-direction:row; align-items:center; gap:10px">
            <input type="checkbox" id="chkBrake"> ãƒ–ãƒ¬ãƒ¼ã‚­
          </label>
          <label class="field" style="flex-direction:row; align-items:center; gap:10px">
            <input type="checkbox" id="chkLight"> ç¯ç«é¡ï¼ˆãƒ©ã‚¤ãƒˆ/ã‚¦ã‚£ãƒ³ã‚«ãƒ¼ï¼‰
          </label>
          <label class="field" style="flex-direction:row; align-items:center; gap:10px">
            <input type="checkbox" id="chkOil"> ã‚ªã‚¤ãƒ«/æ°´æ¼ã‚Œ
          </label>
        </div>
        <div class="field" style="margin-top:10px">
          <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
          <textarea id="tenkoMemo" placeholder="ä¾‹ï¼šå³å¾Œè¼ªç©ºæ°—åœ§æ³¨æ„ã€ãªã©"></textarea>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnTenkoSave">ç‚¹å‘¼ã‚’ä¿å­˜ï¼ˆæœ¬æ—¥ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰</button>
          <button class="btn gray" id="btnTenkoGoPickup">â‘¡ é›†è·ã¸</button>
        </div>
        <div class="hint">â€»ç‚¹å‘¼ã‚’ä¿å­˜ã™ã‚‹ã¨ã€æ—¥å ±ã«ç‚¹å‘¼æƒ…å ±ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™ã€‚</div>
      </div>
    </section>

    <!-- â‘¡ PICKUP / SCAN -->
    <section class="card" id="tab-pickup" style="display:none">
      <h2>â‘¡ é›†è·ï¼ˆSCAN â†’ å¿…é ˆå…¥åŠ› â†’ è‡ªå‹•ãƒ”ãƒ³ / ãƒ”ãƒ³ä¿®æ­£ï¼‰</h2>
      <p>åå‰ãƒ»éƒµä¾¿ç•ªå·ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã¯å¿…é ˆã€‚éƒµä¾¿ç•ªå· â†’ ä½æ‰€ã¯è‡ªå‹•è£œå®Œï¼ˆã§ããªã„æ™‚ã¯æ‰‹å…¥åŠ›ï¼‰ã€‚</p>

      <div class="scanBox">
        <video id="video" playsinline muted></video>
        <div class="scanOverlay"><div class="scanFrame"></div></div>
        <div class="scanToast" id="scanToast">èª­ã¿å–ã‚Šï¼š-</div>
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button class="btn primary" id="btnStartScan">ğŸ“· SCANé–‹å§‹ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰</button>
        <button class="btn yellow" id="btnTorch">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
        <button class="btn gray" id="btnStopScan">åœæ­¢</button>
        <button class="btn gray" id="btnOcr">ğŸ”¤ OCRï¼ˆæ–‡å­—èª­ã¿å–ã‚Šï¼‰</button>
      </div>
      <div class="hint">
        ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å¯¾å¿œç«¯æœ«ã¯è‡ªå‹•ã§ç•ªå·å–å¾—ã€‚<br/>
        ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¸å¯/æ‰‹ç´™/å®›åã ã‘ç­‰ã¯ã€ŒOCRã€â†’çµæœã‚’è²¼ã‚Šä»˜ã‘ â†’ å¿…é ˆå…¥åŠ›ã§ç™»éŒ²ã€‚<br/>
        ãƒ»ãƒ©ã‚¤ãƒˆã¯ç«¯æœ«å¯¾å¿œæ™‚ã®ã¿ONï¼ˆæœªå¯¾å¿œç«¯æœ«ã¯ONä¸å¯ï¼‰ã€‚
      </div>

      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:6px">ç™»éŒ²ï¼ˆå¿…è¦æœ€ä½é™ï¼‰</h2>

        <div class="grid">
          <div class="field">
            <label>è·ç‰©ç¨®åˆ¥</label>
            <select id="pkgType">
              <option value="å®…é…">å®…é…</option>
              <option value="æ‰‹ç´™">æ‰‹ç´™</option>
              <option value="ãƒ¡ãƒ¼ãƒ«ä¾¿">ãƒ¡ãƒ¼ãƒ«ä¾¿</option>
              <option value="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°">ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°</option>
              <option value="é£Ÿå“">é£Ÿå“</option>
              <option value="åŒ»ç™‚">åŒ»ç™‚</option>
              <option value="å»ºæ">å»ºæ</option>
              <option value="ã‚¢ãƒ‘ãƒ¬ãƒ«">ã‚¢ãƒ‘ãƒ¬ãƒ«</option>
              <option value="é›‘è²¨">é›‘è²¨</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="field">
            <label>ä¼ç¥¨ç•ªå·ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰/æ‰‹å…¥åŠ›ï¼‰</label>
            <input id="trackNo" inputmode="numeric" placeholder="ä¾‹ï¼š9501-0001-3413ï¼ˆãªã‘ã‚Œã°ç©ºã§ã‚‚OKï¼‰">
          </div>

          <div class="field">
            <label>ãŠåå‰<span class="req">å¿…é ˆ</span></label>
            <input id="custName" placeholder="ä¾‹ï¼šåƒç”° ç¯¤å¸">
          </div>

          <div class="field">
            <label>é›»è©±ç•ªå·<span class="req">å¿…é ˆ</span></label>
            <input id="phone" inputmode="tel" placeholder="ä¾‹ï¼š09012345678">
          </div>

          <div class="field">
            <label>éƒµä¾¿ç•ªå·ï¼ˆ7æ¡ï¼‰<span class="req">å¿…é ˆ</span></label>
            <input id="zip" inputmode="numeric" placeholder="ä¾‹ï¼š1234567ï¼ˆãƒã‚¤ãƒ•ãƒ³ç„¡ã—ï¼‰">
          </div>

          <div class="field">
            <label>ä½æ‰€ï¼ˆè‡ªå‹•è£œå®Œâ†’å¾®ä¿®æ­£OKï¼‰<span class="req">å¿…é ˆ</span></label>
            <input id="address" placeholder="ä¾‹ï¼šå¤§é˜ªå¸‚å¤§æ­£åŒºå¹³å°¾4ä¸ç›®17-3">
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
            <input id="building" placeholder="ä¾‹ï¼šå·å¿ ãƒ“ãƒ« 203">
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼šç½®ãé…/å—æ¸¡ãªã©ï¼‰</label>
            <input id="memo" placeholder="ä¾‹ï¼šã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ç„¡ã—ï¼å®…é…ãƒœãƒƒã‚¯ã‚¹ç„¡ã—">
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px">
          <button class="btn yellow" id="btnZipToAddr">ğŸ“® éƒµä¾¿ç•ªå·â†’ä½æ‰€</button>
          <button class="btn primary" id="btnAutoPin">ğŸ“ è‡ªå‹•ãƒ”ãƒ³ï¼ˆä½æ‰€â†’åº§æ¨™ï¼‰</button>
          <button class="btn gray" id="btnManualPin">ğŸ§· ãƒ”ãƒ³ä¿®æ­£ï¼ˆæ‰‹å‹•ï¼‰</button>
          <button class="btn red" id="btnAddPkg">ï¼‹ ç™»éŒ²ï¼ˆãƒªã‚¹ãƒˆã¸ï¼‰</button>
        </div>

        <div class="hint">
          âœ… ç¾å ´ã¯ã€Œä¼ç¥¨ç•ªå· or ä½æ‰€ã€ã§è·ç‰©ã‚’æ¢ã™ â†’ ãªã®ã§<strong>ä½æ‰€ãƒ»åå‰ãƒ»é›»è©±ãƒ»éƒµä¾¿ç•ªå·ã¯å¿…é ˆ</strong>ã€‚<br/>
          âœ… ãƒ”ãƒ³ãŒç«‹ãŸãªã„æ™‚ã¯ã€Œãƒ”ãƒ³ä¿®æ­£ã€ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç¢ºå®šã§ãã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- â‘¢ LIST -->
    <section class="card" id="tab-list" style="display:none">
      <h2>â‘¢ ãƒªã‚¹ãƒˆï¼ˆæ¤œç´¢ / ä¸¦ã³æ›¿ãˆ / è¿‘ã„é †ï¼‰</h2>

      <div class="listTools">
        <div class="left">
          <input id="search" placeholder="æ¤œç´¢ï¼šä¼ç¥¨/åå‰/ä½æ‰€/é›»è©±/ç¨®åˆ¥" style="min-width: 240px">
          <span class="chip active" data-filter="all">å…¨ã¦</span>
          <span class="chip" data-filter="undelivered">æœªé…é”</span>
          <span class="chip" data-filter="done">é…é”å®Œäº†</span>
          <span class="chip" data-filter="absent">ä¸åœ¨</span>
        </div>
        <div class="right">
          <button class="btn small gray" id="btnSortNear">ğŸ“è¿‘ã„é †ã«ä¸¦ã³æ›¿ãˆ</button>
          <button class="btn small gray" id="btnGoMap">â‘£åœ°å›³ã¸</button>
        </div>
      </div>

      <div class="hint" style="margin-bottom:10px">
        ãƒ»é †ç•ªå…¥æ›¿ï¼šå„ã‚«ãƒ¼ãƒ‰ã®ã€Œâ‰¡ã€ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚¹ãƒãƒ›OKï¼‰ã€‚<br/>
        ãƒ»é…é”ä¸­ï¼šå®¶ã§è·ç‰©ã‚¹ã‚­ãƒ£ãƒ³ â†’ è©²å½“ã‚’ä¸€ç™ºæ¤œç´¢ â†’ é–“é•ã„é˜²æ­¢ã€‚
      </div>

      <div class="items" id="items"></div>

      <div class="btnRow" style="margin-top:12px">
        <button class="btn gray" id="btnClearDone">é…é”å®Œäº†ã ã‘å‰Šé™¤</button>
        <button class="btn gray" id="btnClearAll">å…¨å‰Šé™¤</button>
      </div>
    </section>

    <!-- â‘£ MAP -->
    <section class="card" id="tab-map" style="display:none">
      <h2>â‘£ åœ°å›³ï¼ˆè»½ã„ / ç¾åœ¨åœ°å‘¨è¾º / ãƒ”ãƒ³å¤§é‡è¡¨ç¤ºï¼‰</h2>

      <div class="btnRow" style="margin-bottom:10px">
        <button class="btn primary" id="btnMapMyPos">ğŸ¯ ç¾åœ¨åœ°ã¸</button>
        <button class="btn gray" id="btnRefreshPins">ğŸ”„ ãƒ”ãƒ³å†æç”»</button>
        <button class="btn gray" id="btnMapGoList">â‘¢ãƒªã‚¹ãƒˆã¸</button>
      </div>

      <div id="map"></div>

      <div class="mapNote">
        <div>âœ… ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ— â†’ è©³ç´°ã‚·ãƒ¼ãƒˆ â†’ <b>å®Œäº†/ä¸åœ¨</b> ã‚’å³æ‰“ã¡</div>
        <div>è¡¨ç¤ºãŒé‡ã„æ™‚ï¼šã‚ºãƒ¼ãƒ ã‚’å°‘ã—ä¸Šã’ã¦ãã ã•ã„ï¼ˆãƒ”ãƒ³100ä»¶ã§ã‚‚OKè¨­è¨ˆï¼‰</div>
      </div>
    </section>

    <!-- â‘¤ REPORT -->
    <section class="card" id="tab-report" style="display:none">
      <h2>â‘¤ æ—¥å ±ï¼ˆCSV / PDFï¼‰</h2>
      <p>ç‚¹å‘¼ï¼‹æœ¬æ—¥ã®é…é”çµæœã‚’ã¾ã¨ã‚ã¦å‡ºåŠ›ã€‚</p>

      <div class="grid">
        <div class="field">
          <label>å¯¾è±¡æ—¥</label>
          <input type="date" id="repDate">
        </div>
        <div class="field">
          <label>é›†è¨ˆ</label>
          <input type="text" id="repSummary" readonly>
        </div>
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button class="btn primary" id="btnExportCsv">CSVå‡ºåŠ›</button>
        <button class="btn yellow" id="btnExportPdf">PDFå‡ºåŠ›ï¼ˆA4ï¼‰</button>
        <button class="btn gray" id="btnRecalc">å†é›†è¨ˆ</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h2 style="margin-bottom:6px">ãƒ¡ãƒ¢ï¼ˆä¼šç¤¾å´ï¼‰</h2>
        <textarea id="repMemo" placeholder="ä¾‹ï¼šæ³¨æ„äº‹é …ï¼ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ç½®ãé…ãƒˆãƒ©ãƒ–ãƒ«ãªã©"></textarea>
      </div>
    </section>

  </div>

  <!-- Bottom bar -->
  <div class="footerBar">
    <div class="footerInner">
      <div class="left kpi">
        <span>æœªé…é” <b id="kpiUndel">0</b></span>
        <span>å®Œäº† <b id="kpiDone">0</b></span>
        <span>ä¸åœ¨ <b id="kpiAbs">0</b></span>
      </div>
      <div class="right">
        <button class="btn small yellow" id="quickScan">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button class="btn small primary" id="quickList">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
        <button class="btn small gray" id="quickMap">ğŸ—º åœ°å›³</button>
      </div>
    </div>
  </div>

  <!-- Modal sheet (pin detail / manual pin) -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <b id="modalTitle">è©³ç´°</b>
        <button class="xbtn" id="modalClose">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheetGrid" id="modalBody"></div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    /**********************
     * Storage / Model
     **********************/
    const LS_KEY = "ofa_delivery_app_v2";
    const LS_TENKO = "ofa_delivery_tenko_v2";

    function loadState(){
      try{
        return JSON.parse(localStorage.getItem(LS_KEY)) || { items: [] };
      }catch(e){
        return { items: [] };
      }
    }
    function saveState(s){
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    }

    function loadTenko(){
      try{
        return JSON.parse(localStorage.getItem(LS_TENKO)) || null;
      }catch(e){ return null; }
    }
    function saveTenko(t){
      localStorage.setItem(LS_TENKO, JSON.stringify(t));
    }

    let state = loadState(); // {items:[...]}
    // item schema:
    // {id, type, trackNo, name, phone, zip, address, building, memo, lat, lng, status, createdAt, deliveredAt, distanceKm}

    /**********************
     * Utils
     **********************/
    const $ = (q)=>document.querySelector(q);
    const $$ = (q)=>[...document.querySelectorAll(q)];

    function uid(){
      return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
    }

    function nowISO(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function todayYMD(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (x)=>x*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    function sanitizeZip(z){
      return (z||"").replace(/[^0-9]/g,"").slice(0,7);
    }
    function sanitizePhone(p){
      return (p||"").replace(/[^0-9]/g,"").slice(0,13);
    }

    function toastScan(msg){
      const t = $("#scanToast");
      t.textContent = `èª­ã¿å–ã‚Šï¼š${msg}`;
      t.classList.add("show");
      clearTimeout(toastScan._tm);
      toastScan._tm = setTimeout(()=>t.classList.remove("show"), 1200);
    }

    /**********************
     * Tabs
     **********************/
    function showTab(name){
      $$(".tabBtn").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
      ["tenko","pickup","list","map","report"].forEach(t=>{
        $(`#tab-${t}`).style.display = (t===name) ? "block" : "none";
      });
      if(name==="map"){
        setTimeout(()=>{
          if(map){ map.invalidateSize(); }
          renderMapPins();
        }, 120);
      }
      if(name==="report"){ recalcReport(); }
    }
    $$(".tabBtn").forEach(b=>b.addEventListener("click", ()=>showTab(b.dataset.tab)));

    // quick buttons
    $("#quickScan").addEventListener("click", ()=>showTab("pickup"));
    $("#quickList").addEventListener("click", ()=>showTab("list"));
    $("#quickMap").addEventListener("click", ()=>showTab("map"));

    /**********************
     * GPS
     **********************/
    let myPos = { lat: null, lng: null, ok: false };
    let watchId = null;

    function setGpsUI(ok){
      $("#gpsDot").className = "dot " + (ok ? "ok":"ng");
      $("#gpsTxt").textContent = ok ? "OK" : "NG";
    }

    async function startGPS(){
      if(!navigator.geolocation){
        setGpsUI(false);
        return;
      }
      return new Promise((resolve)=>{
        watchId = navigator.geolocation.watchPosition(
          (pos)=>{
            myPos.lat = pos.coords.latitude;
            myPos.lng = pos.coords.longitude;
            myPos.ok = true;
            setGpsUI(true);
            updateDistances();
            resolve(true);
          },
          (err)=>{
            myPos.ok = false;
            setGpsUI(false);
            resolve(false);
          },
          { enableHighAccuracy: true, maximumAge: 8000, timeout: 8000 }
        );
      });
    }

    /**********************
     * Tenko
     **********************/
    function initTenkoForm(){
      $("#tenkoDate").value = todayYMD();
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      $("#tenkoTime").value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;

      const t = loadTenko();
      if(t){
        $("#tenkoDate").value = t.date || todayYMD();
        $("#tenkoTime").value = (t.time || $("#tenkoTime").value);
        $("#tenkoName").value = t.name || "";
        $("#tenkoCondition").value = t.condition || "è‰¯å¥½";
        $("#tenkoAlcohol").value = t.alcohol || "å•é¡Œãªã—";
        $("#tenkoGo").value = t.go || "é‹è¡Œå¯";
        $("#chkTire").checked = !!t.chkTire;
        $("#chkBrake").checked = !!t.chkBrake;
        $("#chkLight").checked = !!t.chkLight;
        $("#chkOil").checked = !!t.chkOil;
        $("#tenkoMemo").value = t.memo || "";
        $("#badgeTenko").textContent = "OK";
      }else{
        $("#badgeTenko").textContent = "!";
      }
    }

    $("#btnTenkoSave").addEventListener("click", ()=>{
      const t = {
        date: $("#tenkoDate").value || todayYMD(),
        time: $("#tenkoTime").value || "",
        name: $("#tenkoName").value.trim(),
        condition: $("#tenkoCondition").value,
        alcohol: $("#tenkoAlcohol").value,
        go: $("#tenkoGo").value,
        chkTire: $("#chkTire").checked,
        chkBrake: $("#chkBrake").checked,
        chkLight: $("#chkLight").checked,
        chkOil: $("#chkOil").checked,
        memo: $("#tenkoMemo").value.trim(),
        savedAt: nowISO(),
      };
      saveTenko(t);
      $("#badgeTenko").textContent = "OK";
      alert("ç‚¹å‘¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚â‘¡é›†è·ã¸é€²ã‚ã¾ã™ã€‚");
    });

    $("#btnTenkoGoPickup").addEventListener("click", ()=>showTab("pickup"));

    /**********************
     * Zip -> Address (ZipCloud)
     **********************/
    async function zipToAddress(zip){
      // ZipCloud (CORS works in many environments; if blocked, user can type)
      const url = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${encodeURIComponent(zip)}`;
      const res = await fetch(url);
      const j = await res.json();
      if(j && j.results && j.results[0]){
        const r = j.results[0];
        return `${r.address1}${r.address2}${r.address3}`.replace(/\s+/g,"").trim();
      }
      return null;
    }

    $("#btnZipToAddr").addEventListener("click", async ()=>{
      const z = sanitizeZip($("#zip").value);
      $("#zip").value = z;
      if(z.length!==7){
        alert("éƒµä¾¿ç•ªå·ã¯7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒã‚¤ãƒ•ãƒ³ç„¡ã—ï¼‰");
        return;
      }
      try{
        const addr = await zipToAddress(z);
        if(addr){
          $("#address").value = addr;
        }else{
          alert("ä½æ‰€è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½æ‰€ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
      }catch(e){
        alert("ä½æ‰€è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡/CORSã®å¯èƒ½æ€§ï¼‰ã€‚ä½æ‰€ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
    });

    $("#zip").addEventListener("blur", async ()=>{
      const z = sanitizeZip($("#zip").value);
      $("#zip").value = z;
      if(z.length===7 && !$("#address").value.trim()){
        try{
          const addr = await zipToAddress(z);
          if(addr) $("#address").value = addr;
        }catch(e){}
      }
    });

    $("#phone").addEventListener("input", ()=>{
      $("#phone").value = sanitizePhone($("#phone").value);
    });

    /**********************
     * Geocoding (Nominatim)
     **********************/
    async function geocodeAddress(addr){
      // Nominatim: rate limited. For real ops, later replace with your own server or paid geocoder.
      const q = encodeURIComponent(addr);
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" }});
      const j = await res.json();
      if(j && j[0]){
        return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) };
      }
      return null;
    }

    $("#btnAutoPin").addEventListener("click", async ()=>{
      const addr = ($("#address").value || "").trim();
      const bld = ($("#building").value || "").trim();
      if(!addr){
        alert("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      try{
        const full = bld ? `${addr} ${bld}` : addr;
        const p = await geocodeAddress(full);
        if(!p){
          alert("è‡ªå‹•ãƒ”ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã€ãƒ”ãƒ³ä¿®æ­£ã€ã§æ‰‹å‹•è¨­å®šã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        // store in temp fields
        $("#btnAutoPin").dataset.lat = p.lat;
        $("#btnAutoPin").dataset.lng = p.lng;
        $("#pinDot").className = "dot ok";
        $("#pinTxt").textContent = "OK(ä»®)";
        alert(`ãƒ”ãƒ³å–å¾—OKï¼š${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}\nâ€»ç™»éŒ²ãƒœã‚¿ãƒ³ã§ç¢ºå®šã—ã¾ã™`);
      }catch(e){
        alert("è‡ªå‹•ãƒ”ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€ãƒ”ãƒ³ä¿®æ­£ã€ã§æ‰‹å‹•è¨­å®šã—ã¦ãã ã•ã„ã€‚");
      }
    });

    /**********************
     * Manual pin adjust (mini map)
     **********************/
    let manualMap = null;
    let manualMarker = null;

    function openModal(title, html){
      $("#modalTitle").textContent = title;
      $("#modalBody").innerHTML = html;
      $("#modal").classList.add("show");
    }
    function closeModal(){
      $("#modal").classList.remove("show");
      $("#modalBody").innerHTML = "";
      // destroy manual map to avoid heavy memory
      if(manualMap){
        manualMap.remove();
        manualMap = null;
        manualMarker = null;
      }
    }
    $("#modalClose").addEventListener("click", closeModal);
    $("#modal").addEventListener("click", (e)=>{
      if(e.target.id==="modal") closeModal();
    });

    $("#btnManualPin").addEventListener("click", async ()=>{
      // open modal with draggable marker; center = current gps or geocode
      let center = null;

      const addr = ($("#address").value || "").trim();
      const bld = ($("#building").value || "").trim();
      if(myPos.ok) center = { lat: myPos.lat, lng: myPos.lng };

      if(!center && addr){
        try{
          const p = await geocodeAddress(bld ? `${addr} ${bld}` : addr);
          if(p) center = p;
        }catch(e){}
      }
      if(!center) center = { lat: 34.701909, lng: 135.494977 }; // fallback Osaka-ish

      openModal("ãƒ”ãƒ³ä¿®æ­£ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§åˆã‚ã›ã¦ç¢ºå®šï¼‰", `
        <div class="card" style="margin:0">
          <div id="manualMap" style="width:100%; height: 44vh; min-height: 340px; border-radius:18px; overflow:hidden; border:1px solid rgba(229,231,235,.95)"></div>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn primary" id="btnPinOk">ã“ã®ä½ç½®ã§ç¢ºå®š</button>
            <button class="btn gray" id="btnPinMy">ç¾åœ¨åœ°ã¸</button>
          </div>
          <div class="hint">â€»ãƒ”ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€Œå»ºç‰©å…¥å£ã€ä»˜è¿‘ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚</div>
        </div>
      `);

      setTimeout(()=>{
        manualMap = L.map("manualMap", { preferCanvas:true }).setView([center.lat, center.lng], 16);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19
        }).addTo(manualMap);

        manualMarker = L.marker([center.lat, center.lng], { draggable:true }).addTo(manualMap);
        manualMarker.bindPopup("ã“ã“ã«åˆã‚ã›ã‚‹").openPopup();

        $("#btnPinOk").addEventListener("click", ()=>{
          const p = manualMarker.getLatLng();
          $("#btnAutoPin").dataset.lat = p.lat;
          $("#btnAutoPin").dataset.lng = p.lng;
          $("#pinDot").className = "dot ok";
          $("#pinTxt").textContent = "OK(ä»®)";
          closeModal();
          alert("ãƒ”ãƒ³ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚æ¬¡ã«ã€ç™»éŒ²ã€ã‚’æŠ¼ã™ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚");
        });

        $("#btnPinMy").addEventListener("click", ()=>{
          if(myPos.ok){
            manualMap.setView([myPos.lat, myPos.lng], 17);
            manualMarker.setLatLng([myPos.lat, myPos.lng]);
          }else{
            alert("GPSãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
          }
        });

      }, 80);
    });

    /**********************
     * Scan (BarcodeDetector)
     **********************/
    let stream = null;
    let scanning = false;
    let detector = null;
    let torchOn = false;
    let currentTrack = null;

    function setTorchUI(){
      $("#torchDot").className = "dot " + (torchOn ? "ok":"warn");
      $("#torchTxt").textContent = torchOn ? "ON" : "OFF/æœª";
    }

    async function startCamera(){
      if(stream) return stream;
      const constraintsBase = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      };
      stream = await navigator.mediaDevices.getUserMedia(constraintsBase);
      const video = $("#video");
      video.srcObject = stream;
      await video.play();

      const [track] = stream.getVideoTracks();
      currentTrack = track;
      // check torch capability
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      const torchCap = !!caps.torch;
      $("#torchDot").className = "dot " + (torchCap ? "warn":"ng");
      $("#torchTxt").textContent = torchCap ? "OFF" : "æœªå¯¾å¿œ";
      return stream;
    }

    async function stopCamera(){
      scanning = false;
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
        currentTrack = null;
      }
    }

    async function toggleTorch(){
      if(!currentTrack || !currentTrack.applyConstraints){
        alert("ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã¯ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯æœªå¯¾å¿œã§ã™ã€‚");
        return;
      }
      const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
      if(!caps.torch){
        alert("ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã¯æœªå¯¾å¿œã§ã™ï¼ˆiPhoneå«ã‚Webä»•æ§˜ã§ä¸å¯ã®å ´åˆã‚ã‚Šï¼‰ã€‚");
        return;
      }
      torchOn = !torchOn;
      await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      setTorchUI();
    }

    $("#btnTorch").addEventListener("click", async ()=>{
      try{ await toggleTorch(); }catch(e){
        torchOn = false; setTorchUI();
        alert("ãƒ©ã‚¤ãƒˆONã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç«¯æœ«å´ã§è¨±å¯/å¯¾å¿œã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      }
    });

    $("#btnStartScan").addEventListener("click", async ()=>{
      try{
        await startCamera();
      }catch(e){
        alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©è¨±å¯/HTTPSã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if(!("BarcodeDetector" in window)){
        toastScan("BarcodeDetectoréå¯¾å¿œ â†’ æ‰‹å…¥åŠ›/OCRã¸");
        alert("ã“ã®ç«¯æœ«ã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è‡ªå‹•èª­ã¿å–ã‚Šã«éå¯¾å¿œã§ã™ã€‚\næ‰‹å…¥åŠ› or OCRã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
        return;
      }

      detector = detector || new BarcodeDetector({ formats: ["qr_code","ean_13","ean_8","code_128","code_39","itf","upc_a","upc_e","codabar","data_matrix"]});
      scanning = true;
      scanLoop();
    });

    $("#btnStopScan").addEventListener("click", async ()=>{
      await stopCamera();
      toastScan("åœæ­¢");
    });

    async function scanLoop(){
      if(!scanning) return;
      const video = $("#video");
      try{
        const barcodes = await detector.detect(video);
        if(barcodes && barcodes[0]){
          const v = (barcodes[0].rawValue || "").trim();
          if(v){
            $("#trackNo").value = v;
            toastScan(v);
            // continue scanning to allow rapid input, but throttle a bit
            await new Promise(r=>setTimeout(r, 700));
          }
        }
      }catch(e){}
      requestAnimationFrame(scanLoop);
    }

    /**********************
     * OCR (Tesseract.js) on-demand
     **********************/
    async function ensureTesseract(){
      if(window.Tesseract) return true;
      // load only when user taps OCR (heavy)
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
      document.head.appendChild(s);
      await new Promise((res, rej)=>{
        s.onload = res; s.onerror = rej;
      });
      return true;
    }

    async function ocrFromCameraSnapshot(){
      // take snapshot from video into canvas, then OCR (Japanese is heavy; default eng)
      const video = $("#video");
      if(!video || video.readyState < 2){
        alert("OCRã®å‰ã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼ˆSCANé–‹å§‹ or å…ˆã«ã‚«ãƒ¡ãƒ©è¨±å¯ï¼‰ã€‚");
        return;
      }
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL("image/png");

      await ensureTesseract();
      toastScan("OCRä¸­â€¦");
      // NOTE: Japanese OCR is heavy; use "eng" for speed. Users can paste results.
      const { data } = await Tesseract.recognize(dataUrl, "eng", {
        logger: (m)=>{}
      });
      const text = (data && data.text) ? data.text : "";
      openModal("OCRçµæœï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦å…¥åŠ›ã¸ï¼‰", `
        <div class="card" style="margin:0">
          <p style="margin:0 0 10px">â€»æ—¥æœ¬èªOCRã¯é‡ããªã‚Šã‚„ã™ã„ã®ã§ã€ã¾ãšã¯è‹±æ•°ä¸­å¿ƒï¼ˆä¼ç¥¨ç•ªå·/é›»è©±/éƒµä¾¿ï¼‰ã‚’ç‹™ã„ã¾ã™ã€‚</p>
          <textarea id="ocrText" style="min-height:160px">${text.trim()}</textarea>
          <div class="btnRow" style="margin-top:10px">
            <button class="btn primary" id="btnOcrToTrack">ä¼ç¥¨ç•ªå·ã¸è²¼ä»˜</button>
            <button class="btn yellow" id="btnOcrToPhone">é›»è©±ã¸è²¼ä»˜</button>
            <button class="btn gray" id="btnOcrClose">é–‰ã˜ã‚‹</button>
          </div>
        </div>
      `);

      $("#btnOcrToTrack").addEventListener("click", ()=>{
        const t = $("#ocrText").value || "";
        const m = t.match(/[0-9]{4}[-\s]?[0-9]{4}[-\s]?[0-9]{4}/) || t.match(/[0-9]{10,14}/);
        if(m) $("#trackNo").value = m[0].replace(/\s+/g,"");
        closeModal();
      });
      $("#btnOcrToPhone").addEventListener("click", ()=>{
        const t = $("#ocrText").value || "";
        const m = t.match(/0\d{9,10}/);
        if(m) $("#phone").value = m[0];
        closeModal();
      });
      $("#btnOcrClose").addEventListener("click", closeModal);
    }

    $("#btnOcr").addEventListener("click", async ()=>{
      try{
        // Ensure camera is running (for snapshot)
        await startCamera();
        await ocrFromCameraSnapshot();
      }catch(e){
        alert("OCRã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç«¯æœ«æ€§èƒ½/é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      }
    });

    /**********************
     * Add Package (Required fields)
     **********************/
    function requiredPickupOK(){
      const name = $("#custName").value.trim();
      const phone = sanitizePhone($("#phone").value);
      const zip = sanitizeZip($("#zip").value);
      const addr = $("#address").value.trim();
      $("#phone").value = phone;
      $("#zip").value = zip;

      if(!name) return "ãŠåå‰ãŒæœªå…¥åŠ›ã§ã™";
      if(phone.length < 10) return "é›»è©±ç•ªå·ãŒä¸æ­£ã§ã™";
      if(zip.length !== 7) return "éƒµä¾¿ç•ªå·ãŒ7æ¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“";
      if(!addr) return "ä½æ‰€ãŒæœªå…¥åŠ›ã§ã™";
      return null;
    }

    $("#btnAddPkg").addEventListener("click", async ()=>{
      const err = requiredPickupOK();
      if(err){ alert(err); return; }

      const type = $("#pkgType").value;
      const trackNo = ($("#trackNo").value || "").trim();
      const name = $("#custName").value.trim();
      const phone = sanitizePhone($("#phone").value);
      const zip = sanitizeZip($("#zip").value);
      const address = $("#address").value.trim();
      const building = ($("#building").value || "").trim();
      const memo = ($("#memo").value || "").trim();

      // lat/lng from auto pin dataset if exists; else try geocode quickly; else null
      let lat = null, lng = null;
      const dlat = $("#btnAutoPin").dataset.lat;
      const dlng = $("#btnAutoPin").dataset.lng;

      if(dlat && dlng){
        lat = parseFloat(dlat); lng = parseFloat(dlng);
      }else{
        try{
          const p = await geocodeAddress(building ? `${address} ${building}` : address);
          if(p){ lat = p.lat; lng = p.lng; }
        }catch(e){}
      }

      const item = {
        id: uid(),
        type,
        trackNo,
        name,
        phone,
        zip,
        address,
        building,
        memo,
        lat, lng,
        status: "æœªé…é”",
        createdAt: nowISO(),
        deliveredAt: "",
        distanceKm: null
      };

      state.items.unshift(item);
      saveState(state);

      // clear quick fields for fast 100ä»¶å…¥åŠ›
      $("#trackNo").value = "";
      $("#custName").value = "";
      $("#phone").value = "";
      $("#zip").value = "";
      $("#address").value = "";
      $("#building").value = "";
      $("#memo").value = "";
      delete $("#btnAutoPin").dataset.lat;
      delete $("#btnAutoPin").dataset.lng;

      renderAll();
      showTab("list");
    });

    /**********************
     * List rendering + Sortable
     **********************/
    let listSortable = null;
    let currentFilter = "all";

    function filterItems(items){
      const q = ($("#search").value || "").trim().toLowerCase();
      let out = items;

      if(currentFilter==="undelivered") out = out.filter(x=>x.status==="æœªé…é”");
      if(currentFilter==="done") out = out.filter(x=>x.status==="é…é”å®Œäº†");
      if(currentFilter==="absent") out = out.filter(x=>x.status==="ä¸åœ¨");

      if(q){
        out = out.filter(x=>{
          const s = `${x.trackNo} ${x.name} ${x.phone} ${x.zip} ${x.address} ${x.building} ${x.type} ${x.memo}`.toLowerCase();
          return s.includes(q);
        });
      }
      return out;
    }

    function statusTagHTML(item){
      if(item.status==="é…é”å®Œäº†") return `<span class="tag status">é…é”å®Œäº†</span>`;
      if(item.status==="ä¸åœ¨") return `<span class="tag status ng">ä¸åœ¨</span>`;
      return `<span class="tag status" style="background:rgba(59,130,246,.10);border-color:rgba(59,130,246,.22);color:var(--b)">æœªé…é”</span>`;
    }

    function itemCardHTML(item, idx){
      const dist = (myPos.ok && item.lat!=null && item.lng!=null)
        ? `${(item.distanceKm ?? haversineKm(myPos.lat,myPos.lng,item.lat,item.lng)).toFixed(2)}km`
        : (item.lat!=null ? "è·é›¢-":"è·é›¢-");

      return `
        <div class="item" data-id="${item.id}">
          <div class="idBadge">${idx+1}</div>

          <div class="itemLeft">
            <div class="itemTop">
              <div class="meta">
                <b>${(item.trackNo || "ï¼ˆä¼ç¥¨ãªã—ï¼‰")}ã€€${escapeHtml(item.name)}</b>
                <small>${escapeHtml(item.address)} ${escapeHtml(item.building || "")}</small>
                <small>â˜ ${escapeHtml(item.phone)}ã€€ğŸ“® ${escapeHtml(item.zip)}ã€€ãƒ»è·é›¢ ${dist}</small>
              </div>
              <div class="dragHandle" title="ãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªå¤‰æ›´">â‰¡</div>
            </div>
            <div class="tags">
              <span class="tag type">ğŸ“¦ ${escapeHtml(item.type)}</span>
              ${statusTagHTML(item)}
              ${item.memo ? `<span class="tag">ğŸ“ ${escapeHtml(item.memo)}</span>` : ``}
            </div>

            <div class="btnRow" style="margin-top:10px">
              <button class="btn small primary" data-act="nav">ğŸ§­ ãƒŠãƒ“</button>
              <button class="btn small gray" data-act="copy">ä½æ‰€ã‚³ãƒ”ãƒ¼</button>
              <button class="btn small yellow" data-act="done">å®Œäº†</button>
              <button class="btn small red" data-act="absent">ä¸åœ¨</button>
            </div>
          </div>

          <div class="actions">
            <button class="btn small gray" data-act="scanCheck">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ç…§åˆ</button>
            <button class="btn small gray" data-act="pinFix">ğŸ“ ãƒ”ãƒ³ä¿®æ­£</button>
            <button class="btn small gray" data-act="del">ğŸ—‘</button>
          </div>
        </div>
      `;
    }

    function renderList(){
      const box = $("#items");
      const items = filterItems(state.items);

      box.innerHTML = items.map((it,i)=>itemCardHTML(it,i)).join("");

      // bind actions
      box.querySelectorAll(".item").forEach(el=>{
        const id = el.dataset.id;
        el.querySelectorAll("button").forEach(btn=>{
          const act = btn.dataset.act;
          if(!act) return;
          btn.addEventListener("click", ()=>handleItemAction(id, act));
        });
      });

      // Sortable (order change)
      if(listSortable) listSortable.destroy();
      listSortable = new Sortable(box, {
        handle: ".dragHandle",
        animation: 150,
        onEnd: ()=>{
          // rebuild order based on DOM
          const ids = [...box.querySelectorAll(".item")].map(x=>x.dataset.id);
          const map = new Map(state.items.map(x=>[x.id,x]));
          state.items = ids.map(id=>map.get(id)).filter(Boolean);
          saveState(state);
          renderAll(true);
        }
      });
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    async function handleItemAction(id, act){
      const item = state.items.find(x=>x.id===id);
      if(!item) return;

      if(act==="del"){
        if(confirm("ã“ã®è·ç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
          state.items = state.items.filter(x=>x.id!==id);
          saveState(state);
          renderAll();
          renderMapPins();
        }
        return;
      }

      if(act==="copy"){
        const txt = `${item.address} ${item.building||""}`.trim();
        await navigator.clipboard.writeText(txt);
        alert("ä½æ‰€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        return;
      }

      if(act==="nav"){
        // open Google Maps navigation (address or latlng)
        const dest = (item.lat!=null && item.lng!=null)
          ? `${item.lat},${item.lng}`
          : encodeURIComponent(`${item.address} ${item.building||""}`.trim());
        const url = `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;
        window.open(url, "_blank");
        return;
      }

      if(act==="done"){
        item.status = "é…é”å®Œäº†";
        item.deliveredAt = nowISO();
        saveState(state);
        renderAll();
        renderMapPins();
        return;
      }

      if(act==="absent"){
        item.status = "ä¸åœ¨";
        item.deliveredAt = nowISO();
        saveState(state);
        renderAll();
        renderMapPins();
        return;
      }

      if(act==="scanCheck"){
        // For safety: scan and compare with trackNo, or quick search
        openModal("ã‚¹ã‚­ãƒ£ãƒ³ç…§åˆï¼ˆé–“é•ã„é˜²æ­¢ï¼‰", `
          <div class="card" style="margin:0">
            <p style="margin:0 0 10px">ã“ã®è·ç‰©ï¼š<b>${escapeHtml(item.trackNo||"ï¼ˆä¼ç¥¨ãªã—ï¼‰")}</b></p>
            <div class="btnRow">
              <button class="btn primary" id="goPickupScan">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã¸</button>
              <button class="btn gray" id="goSearchThis">ğŸ” ã“ã®è·ç‰©ã‚’æ¤œç´¢</button>
            </div>
            <p class="hint">â€»ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ä¼ç¥¨ç•ªå·ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã€‚ä¼ç¥¨ãªã—ã¯ä½æ‰€/åå‰ã§ç¢ºèªã€‚</p>
          </div>
        `);
        $("#goPickupScan").addEventListener("click", ()=>{
          closeModal();
          showTab("pickup");
        });
        $("#goSearchThis").addEventListener("click", ()=>{
          closeModal();
          showTab("list");
          $("#search").value = item.trackNo || item.address || item.name;
          renderList();
        });
        return;
      }

      if(act==="pinFix"){
        // open manual pin for that item
        openModal("ãƒ”ãƒ³ä¿®æ­£ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç¢ºå®šï¼‰", `
          <div class="card" style="margin:0">
            <p style="margin:0 0 10px"><b>${escapeHtml(item.name)}</b> / ${escapeHtml(item.address)}</p>
            <div id="manualMap" style="width:100%; height: 44vh; min-height: 340px; border-radius:18px; overflow:hidden; border:1px solid rgba(229,231,235,.95)"></div>
            <div class="btnRow" style="margin-top:10px">
              <button class="btn primary" id="btnPinSaveItem">ã“ã®ä½ç½®ã§ä¿å­˜</button>
              <button class="btn gray" id="btnPinMyItem">ç¾åœ¨åœ°ã¸</button>
            </div>
          </div>
        `);

        const center = (item.lat!=null && item.lng!=null)
          ? {lat:item.lat, lng:item.lng}
          : (myPos.ok ? {lat:myPos.lat, lng:myPos.lng} : {lat:34.701909, lng:135.494977});

        setTimeout(()=>{
          manualMap = L.map("manualMap", { preferCanvas:true }).setView([center.lat, center.lng], 16);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(manualMap);
          manualMarker = L.marker([center.lat, center.lng], { draggable:true }).addTo(manualMap);

          $("#btnPinSaveItem").addEventListener("click", ()=>{
            const p = manualMarker.getLatLng();
            item.lat = p.lat;
            item.lng = p.lng;
            saveState(state);
            closeModal();
            renderAll();
            renderMapPins();
            alert("ãƒ”ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
          });

          $("#btnPinMyItem").addEventListener("click", ()=>{
            if(myPos.ok){
              manualMap.setView([myPos.lat, myPos.lng], 17);
              manualMarker.setLatLng([myPos.lat, myPos.lng]);
            }else{
              alert("GPSãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
            }
          });

        }, 80);

        return;
      }
    }

    $("#search").addEventListener("input", ()=>renderList());

    $$(".chip").forEach(c=>{
      c.addEventListener("click", ()=>{
        $$(".chip").forEach(x=>x.classList.remove("active"));
        c.classList.add("active");
        currentFilter = c.dataset.filter;
        renderList();
      });
    });

    $("#btnSortNear").addEventListener("click", ()=>{
      if(!myPos.ok){
        alert("GPSãŒå–ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      updateDistances();
      state.items.sort((a,b)=>{
        const da = (a.distanceKm ?? 9e9);
        const db = (b.distanceKm ?? 9e9);
        return da - db;
      });
      saveState(state);
      renderAll(true);
    });

    $("#btnGoMap").addEventListener("click", ()=>showTab("map"));
    $("#btnMapGoList").addEventListener("click", ()=>showTab("list"));

    $("#btnClearDone").addEventListener("click", ()=>{
      if(confirm("é…é”å®Œäº†ã ã‘å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        state.items = state.items.filter(x=>x.status!=="é…é”å®Œäº†");
        saveState(state);
        renderAll();
        renderMapPins();
      }
    });
    $("#btnClearAll").addEventListener("click", ()=>{
      if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        state.items = [];
        saveState(state);
        renderAll();
        renderMapPins();
      }
    });

    /**********************
     * Map (Leaflet)
     **********************/
    let map = null;
    let myMarker = null;
    const markersById = new Map();

    function initMap(){
      if(map) return;

      map = L.map("map", { preferCanvas:true, zoomControl:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);

      const start = (myPos.ok) ? [myPos.lat, myPos.lng] : [34.701909, 135.494977];
      map.setView(start, 13);

      myMarker = L.circleMarker(start, {
        radius: 10,
        weight: 3,
        color: "#111827",
        fillColor: "#3b82f6",
        fillOpacity: 0.9
      }).addTo(map).bindPopup("ç¾åœ¨åœ°");

      // follow location gently
      setInterval(()=>{
        if(map && myPos.ok && myMarker){
          const latlng = [myPos.lat, myPos.lng];
          myMarker.setLatLng(latlng);
        }
      }, 1500);
    }

    function renderMapPins(){
      initMap();
      // clear existing markers
      markersById.forEach(m=>map.removeLayer(m));
      markersById.clear();

      let pinCount = 0;

      state.items.forEach(item=>{
        if(item.lat==null || item.lng==null) return;

        pinCount++;
        const color = (item.status==="é…é”å®Œäº†") ? "#10b981" : (item.status==="ä¸åœ¨") ? "#ef4444" : "#3b82f6";

        const m = L.circleMarker([item.lat, item.lng], {
          radius: 9,
          weight: 2,
          color: "#111827",
          fillColor: color,
          fillOpacity: 0.95
        }).addTo(map);

        m.on("click", ()=>{
          openModal("é…é”è©³ç´°ï¼ˆåœ°å›³â†’å³æ‰“ã¡ï¼‰", `
            <div class="card" style="margin:0">
              <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap">
                <div>
                  <div style="font-weight:900; font-size:15px">${escapeHtml(item.trackNo||"ï¼ˆä¼ç¥¨ãªã—ï¼‰")}ã€€${escapeHtml(item.name)}</div>
                  <div style="color:var(--muted); font-weight:800; margin-top:4px">${escapeHtml(item.address)} ${escapeHtml(item.building||"")}</div>
                  <div style="color:var(--muted); font-weight:800; margin-top:4px">â˜ ${escapeHtml(item.phone)}ã€€ğŸ“® ${escapeHtml(item.zip)}ã€€ğŸ“¦ ${escapeHtml(item.type)}</div>
                  ${item.memo ? `<div style="margin-top:6px"><span class="tag">ğŸ“ ${escapeHtml(item.memo)}</span></div>` : ""}
                </div>
              </div>

              <div class="btnRow" style="margin-top:10px">
                <button class="btn primary" id="mNav">ğŸ§­ ãƒŠãƒ“</button>
                <button class="btn yellow" id="mDone">å®Œäº†</button>
                <button class="btn red" id="mAbsent">ä¸åœ¨</button>
                <button class="btn gray" id="mSearch">ğŸ” ãƒªã‚¹ãƒˆã§æ¤œç´¢</button>
              </div>

              <div class="hint">â€»åœ°å›³ä¸Šã§ã€Œãƒ”ãƒ³â†’å®Œäº†/ä¸åœ¨ã€ã¾ã§æœ€çŸ­å°ç·šã€‚</div>
            </div>
          `);

          $("#mNav").addEventListener("click", ()=>{
            const dest = `${item.lat},${item.lng}`;
            const url = `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;
            window.open(url, "_blank");
          });
          $("#mDone").addEventListener("click", ()=>{
            item.status = "é…é”å®Œäº†";
            item.deliveredAt = nowISO();
            saveState(state);
            closeModal();
            renderAll();
            renderMapPins();
          });
          $("#mAbsent").addEventListener("click", ()=>{
            item.status = "ä¸åœ¨";
            item.deliveredAt = nowISO();
            saveState(state);
            closeModal();
            renderAll();
            renderMapPins();
          });
          $("#mSearch").addEventListener("click", ()=>{
            closeModal();
            showTab("list");
            $("#search").value = item.trackNo || item.address || item.name;
            renderList();
          });
        });

        markersById.set(item.id, m);
      });

      // pin KPI
      $("#pinDot").className = "dot " + (pinCount>0 ? "ok":"ng");
      $("#pinTxt").textContent = String(pinCount);
      $("#badgeMap").textContent = String(pinCount);

      // keep around my position
      if(myPos.ok){
        // do not force recenter every time; user wants smoothæ“ä½œ
      }
    }

    $("#btnMapMyPos").addEventListener("click", ()=>{
      if(!myPos.ok){ alert("GPSãŒå–ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"); return; }
      map.setView([myPos.lat, myPos.lng], 15, { animate:true });
    });
    $("#btnRefreshPins").addEventListener("click", renderMapPins);

    /**********************
     * Distances
     **********************/
    function updateDistances(){
      if(!myPos.ok) return;
      state.items.forEach(it=>{
        if(it.lat!=null && it.lng!=null){
          it.distanceKm = haversineKm(myPos.lat, myPos.lng, it.lat, it.lng);
        }else{
          it.distanceKm = null;
        }
      });
      saveState(state);
      // do not render list too often; but update when in list
    }

    /**********************
     * Report
     **********************/
    function recalcReport(){
      $("#repDate").value = todayYMD();
      const und = state.items.filter(x=>x.status==="æœªé…é”").length;
      const done = state.items.filter(x=>x.status==="é…é”å®Œäº†").length;
      const abs = state.items.filter(x=>x.status==="ä¸åœ¨").length;
      const total = state.items.length;
      $("#repSummary").value = `ç·æ•°${total} / æœª${und} / å®Œäº†${done} / ä¸åœ¨${abs}`;

      $("#badgeReport").textContent = String(total);
    }

    $("#btnRecalc").addEventListener("click", recalcReport);

    function buildCsv(){
      const tenko = loadTenko();
      const headers = [
        "æ—¥ä»˜","ç‚¹å‘¼æ™‚åˆ»","ç‚¹å‘¼æ°å","ä½“èª¿","ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«","é‹è¡Œå¯å¦","æ—¥å¸¸ç‚¹æ¤œ(ã‚¿ã‚¤ãƒ¤)","æ—¥å¸¸ç‚¹æ¤œ(ãƒ–ãƒ¬ãƒ¼ã‚­)","æ—¥å¸¸ç‚¹æ¤œ(ç¯ç«)","æ—¥å¸¸ç‚¹æ¤œ(ã‚ªã‚¤ãƒ«)","ç‚¹å‘¼å‚™è€ƒ",
        "è·ç‰©ID","è·ç‰©ç¨®åˆ¥","ä¼ç¥¨ç•ªå·","æ°å","é›»è©±","éƒµä¾¿","ä½æ‰€","å»ºç‰©","ãƒ¡ãƒ¢","ç·¯åº¦","çµŒåº¦","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","ç™»éŒ²æ—¥æ™‚","é…é”æ—¥æ™‚"
      ];
      const rows = [headers];

      state.items.forEach(it=>{
        rows.push([
          tenko?.date||"", tenko?.time||"", tenko?.name||"", tenko?.condition||"", tenko?.alcohol||"", tenko?.go||"",
          tenko?.chkTire?"OK":"", tenko?.chkBrake?"OK":"", tenko?.chkLight?"OK":"", tenko?.chkOil?"OK":"", tenko?.memo||"",
          it.id, it.type, it.trackNo, it.name, it.phone, it.zip, it.address, it.building, it.memo,
          it.lat ?? "", it.lng ?? "", it.status, it.createdAt, it.deliveredAt
        ]);
      });

      return rows.map(r=>r.map(v=>{
        const s = String(v ?? "");
        // CSV escape
        if(s.includes(",") || s.includes('"') || s.includes("\n")){
          return `"${s.replace(/"/g,'""')}"`;
        }
        return s;
      }).join(",")).join("\n");
    }

    $("#btnExportCsv").addEventListener("click", ()=>{
      const csv = buildCsv();
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `OFA_æ—¥å ±_${todayYMD()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    $("#btnExportPdf").addEventListener("click", ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });

      const tenko = loadTenko();
      const und = state.items.filter(x=>x.status==="æœªé…é”").length;
      const done = state.items.filter(x=>x.status==="é…é”å®Œäº†").length;
      const abs = state.items.filter(x=>x.status==="ä¸åœ¨").length;

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("OFA é…é”æ—¥å ±", 14, 18);

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text(`æ—¥ä»˜: ${todayYMD()}`, 14, 26);
      doc.text(`é›†è¨ˆ: ç·${state.items.length} / æœª${und} / å®Œäº†${done} / ä¸åœ¨${abs}`, 14, 33);

      let y = 40;
      doc.setFont("helvetica","bold");
      doc.text("ç‚¹å‘¼", 14, y); y+=6;
      doc.setFont("helvetica","normal");
      const tenkoLine = tenko
        ? `æ™‚åˆ»:${tenko.time||""} / æ°å:${tenko.name||""} / ä½“èª¿:${tenko.condition||""} / Alc:${tenko.alcohol||""} / ${tenko.go||""}`
        : "æœªç™»éŒ²";
      doc.text(tenkoLine, 14, y); y+=6;
      if(tenko?.memo){
        doc.text(`å‚™è€ƒ: ${tenko.memo}`, 14, y); y+=6;
      }

      y+=4;
      doc.setFont("helvetica","bold");
      doc.text("é…é”æ˜ç´°ï¼ˆä¸Šä½40ä»¶ã¾ã§è¡¨ç¤ºï¼šCSVã«å…¨ä»¶ï¼‰", 14, y); y+=6;
      doc.setFont("helvetica","normal");
      doc.setFontSize(9);

      const show = state.items.slice(0,40);
      show.forEach((it, i)=>{
        const line1 = `${String(i+1).padStart(2,"0")} [${it.status}] ${it.type} ${it.trackNo||"(ä¼ç¥¨ãªã—)"} ${it.name}`;
        const line2 = `${it.zip} ${it.address} ${it.building||""}`;
        doc.text(line1, 14, y); y+=4.5;
        doc.text(line2, 14, y); y+=5.2;
        if(y>280){
          doc.addPage();
          y = 18;
        }
      });

      const memo = ($("#repMemo").value||"").trim();
      if(memo){
        if(y>260){ doc.addPage(); y=18; }
        doc.setFontSize(10);
        doc.setFont("helvetica","bold");
        doc.text("ä¼šç¤¾ãƒ¡ãƒ¢", 14, y); y+=6;
        doc.setFont("helvetica","normal");
        const lines = doc.splitTextToSize(memo, 180);
        doc.text(lines, 14, y);
      }

      doc.save(`OFA_æ—¥å ±_${todayYMD()}.pdf`);
    });

    /**********************
     * Navigation helpers
     **********************/
    $("#btnGoMap").addEventListener("click", ()=>showTab("map"));

    /**********************
     * Render badges / KPI
     **********************/
    function renderBadges(){
      const total = state.items.length;
      const und = state.items.filter(x=>x.status==="æœªé…é”").length;
      const done = state.items.filter(x=>x.status==="é…é”å®Œäº†").length;
      const abs = state.items.filter(x=>x.status==="ä¸åœ¨").length;

      $("#badgePickup").textContent = String(total);
      $("#badgeList").textContent = String(total);
      $("#badgeMap").textContent = String(state.items.filter(x=>x.lat!=null && x.lng!=null).length);
      $("#badgeReport").textContent = String(total);

      $("#kpiUndel").textContent = String(und);
      $("#kpiDone").textContent = String(done);
      $("#kpiAbs").textContent = String(abs);
    }

    function renderAll(skipList){
      renderBadges();
      if(!skipList) renderList();
      recalcReport();
    }

    /**********************
     * Initial
     **********************/
    async function boot(){
      initTenkoForm();
      setTorchUI();
      renderAll();

      await startGPS();
      // map should init lazily on tab open

      // default report date
      $("#repDate").value = todayYMD();

      // if tenko exists, badge ok
      const t = loadTenko();
      if(t) $("#badgeTenko").textContent = "OK";

      // Buttons
      $("#btnGoMap").addEventListener("click", ()=>showTab("map"));

      // lightweight map when user enters map tab
      $("#btnMapMyPos").addEventListener("click", ()=>{
        if(!map) initMap();
      });

      // For pickup page: stop camera when leaving
      $$(".tabBtn").forEach(b=>{
        b.addEventListener("click", async ()=>{
          if(b.dataset.tab!=="pickup"){
            // stop camera to avoid freeze / heavy
            await stopCamera();
            torchOn = false;
            setTorchUI();
          }
        });
      });

      // quick buttons
      $("#quickScan").addEventListener("click", ()=>showTab("pickup"));
      $("#quickList").addEventListener("click", ()=>showTab("list"));
      $("#quickMap").addEventListener("click", ()=>showTab("map"));

      // map init once after slight delay if user opens map quickly
      setTimeout(()=>{ if($("#tab-map").style.display==="block") initMap(); }, 300);
    }

    boot();
  </script>
</body>
</html>
