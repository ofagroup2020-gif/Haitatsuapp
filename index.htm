<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --ofa-yellow:#FFD400;
      --ofa-red:#E53935;
      --ofa-blue:#1565C0;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f7f8fb;
      --card:#ffffff;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(255,212,0,.35), transparent 55%),
        radial-gradient(900px 480px at 100% 0%, rgba(21,101,192,.18), transparent 55%),
        radial-gradient(900px 480px at 70% 110%, rgba(229,57,53,.12), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(229,231,235,.9);
    }
    .top{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      max-width:1100px; margin:0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, var(--ofa-yellow), #fff2a8);
      box-shadow: 0 10px 22px rgba(255,212,0,.25);
      display:grid; place-items:center;
      font-weight:900;
    }
    .ttl b{display:block; font-size:14px; letter-spacing:.02em}
    .ttl small{display:block; color:var(--muted); font-size:11px; margin-top:2px}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      white-space:nowrap;
    }
    .chip b{color:var(--ink)}
    nav{
      padding:0 14px 12px;
      max-width:1100px; margin:0 auto;
      display:flex; gap:10px;
    }
    .tab{
      flex:1;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:12px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(21,101,192,.35);
      background: linear-gradient(135deg, rgba(21,101,192,.10), rgba(255,212,0,.16));
    }

    main{max-width:1100px;margin:0 auto;padding:14px; display:grid; gap:12px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 10px; font-size:14px}
    .grid{display:grid; gap:10px;}
    @media(min-width:820px){
      .grid.two{grid-template-columns: 1fr 1fr;}
      .grid.three{grid-template-columns: 1fr 1fr 1fr;}
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:90px; resize:vertical}
    .btns{display:flex; flex-wrap:wrap; gap:10px;}
    button{
      border:0;
      border-radius:16px;
      padding:12px 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{background: linear-gradient(135deg, var(--ofa-yellow), #ffe77a); color:#111;}
    .btn-blue{background: linear-gradient(135deg, rgba(21,101,192,.95), rgba(21,101,192,.75)); color:#fff;}
    .btn-ghost{background:#fff; border:1px solid var(--line); color:var(--ink);}
    .btn-ok{background: rgba(16,185,129,.10); border:1px solid rgba(16,185,129,.35); color:#065f46;}
    .btn-warn{background: rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); color:#7c2d12;}
    .btn-bad{background: rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.30); color:#7f1d1d;}
    .btn-mini{padding:10px 10px; border-radius:14px; font-size:12px;}

    .note{color:var(--muted); font-size:12px; line-height:1.6}
    .hr{height:1px;background:var(--line); margin:12px 0;}

    /* Scanner */
    .scanWrap{
      border:1px dashed rgba(21,101,192,.35);
      background: linear-gradient(135deg, rgba(21,101,192,.05), rgba(255,212,0,.10));
      border-radius:18px;
      padding:12px;
    }
    .camBox{
      display:none;
      margin-top:10px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background:#000;
    }
    video{width:100%; height:auto; display:block;}
    .scanHint{
      display:flex; gap:10px; align-items:flex-start;
      color:var(--muted); font-size:12px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:var(--ofa-red);
      box-shadow:0 0 0 6px rgba(229,57,53,.10);
      margin-top:4px;
    }

    /* List */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .toolbar .left{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .kpis{display:flex; flex-wrap:wrap; gap:10px;}
    .kpi{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 8px 18px rgba(17,24,39,.06);
      min-width:130px;
    }
    .kpi small{display:block;color:var(--muted); font-size:11px}
    .kpi b{display:block; font-size:18px; margin-top:2px}

    .list{display:grid; gap:10px; margin-top:12px;}
    .item{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      background:#fff;
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .itemTop b{font-size:14px}
    .tag{
      font-weight:900; font-size:11px;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .st-created{background:#f9fafb; color:var(--muted)}
    .st-out{background:rgba(21,101,192,.10); border-color:rgba(21,101,192,.22); color:#0b3a7a}
    .st-done{background:rgba(16,185,129,.10); border-color:rgba(16,185,129,.22); color:#065f46}
    .st-absent{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25); color:#7c2d12}
    .st-return{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.22); color:#7f1d1d}
    .meta{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.55}
    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .actions .grow{flex:1}
    .mini{color:var(--muted); font-size:11px}

    /* Pop accent */
    .popLine{
      height:4px; border-radius:999px;
      background: linear-gradient(90deg, var(--ofa-yellow), var(--ofa-red), var(--ofa-blue));
      margin-top:10px;
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div class="ttl">
        <b>é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</b>
        <small>SCAN â†’ ãƒªã‚¹ãƒˆ â†’ ãƒŠãƒ“ â†’ å®Œäº†/ä¸åœ¨ â†’ æ—¥å ±</small>
      </div>
    </div>
    <div class="chip">GPSï¼š<b id="gpsState">æœªå–å¾—</b></div>
  </div>
  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="list">ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="report">æ—¥å ±</button>
  </nav>
</header>

<main>

  <!-- SCAN -->
  <section id="tab-scan" class="card">
    <h2>â‘  SCANï¼ˆé€£ç¶šèª­ã¿å–ã‚Šã§ä¸€æ°—ã«ç™»éŒ²ï¼‰</h2>

    <div class="scanWrap">
      <div class="scanHint">
        <div class="dot"></div>
        <div>
          <b>ãƒã‚¤ãƒ³ãƒˆï¼š</b>ã€ŒSCANé–‹å§‹ã€â†’ ä¼ç¥¨ã‚’ã‹ã–ã™ â†’ è‡ªå‹•ã§ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆ50å€‹ã§ã‚‚æ—©ã„ï¼‰<br>
          <span class="mini">â€»BarcodeDetectorå¯¾å¿œç«¯æœ«ã¯è‡ªå‹•ã€‚éå¯¾å¿œã®å ´åˆã¯æ‰‹å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚</span>
        </div>
      </div>

      <div class="grid three" style="margin-top:10px;">
        <div>
          <label>é…é”æ—¥</label>
          <input id="shipDate" type="date" />
        </div>
        <div>
          <label>é…é”å“¡å</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸" />
        </div>
        <div>
          <label>å–å¼•å…ˆï¼ˆä»»æ„ï¼‰</label>
          <input id="client" type="text" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆ / ä½å· / Amazonâ€¦" />
        </div>
      </div>

      <div class="grid two" style="margin-top:10px;">
        <div>
          <label>ä½æ‰€ï¼ˆä»»æ„ï¼šãƒŠãƒ“ã§ä½¿ã†ï¼‰</label>
          <input id="address" type="text" placeholder="ä¾‹ï¼šé¹¿å…å³¶å¸‚ã€‡ã€‡â€¦" />
          <div class="mini" style="margin-top:6px;">â€»ä½æ‰€ã¯å¾Œã‹ã‚‰ç·¨é›†ã‚‚ã§ãã¾ã™ï¼ˆã¾ãšã¯ç•ªå·ã ã‘ã§ã‚‚OKï¼‰ã€‚</div>
        </div>
        <div>
          <label>æ‰‹å…¥åŠ›ï¼ˆèª­ã¿å–ã‚Šã§ããªã„æ™‚ï¼‰</label>
          <input id="tracking" type="text" inputmode="numeric" placeholder="ä¼ç¥¨ç•ªå·ã‚’å…¥åŠ›â†’è¿½åŠ " />
        </div>
      </div>

      <div class="btns" style="margin-top:12px;">
        <button class="btn-blue" id="btnGPS">ğŸ“ GPSå–å¾—</button>
        <button class="btn-primary" id="btnStartScan">ğŸ“· SCANé–‹å§‹ï¼ˆè‡ªå‹•ï¼‰</button>
        <button class="btn-ghost" id="btnStopScan" style="display:none;">åœæ­¢</button>
        <button class="btn-ghost" id="btnAddManual">ï¼‹ æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
      </div>

      <div class="camBox" id="camBox">
        <video id="video" playsinline></video>
      </div>

      <div class="popLine"></div>

      <div class="note" style="margin-top:10px;">
        âœ… ç™»éŒ²ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§ã€ŒæœªæŒå‡ºã€ã«å…¥ã‚Šã¾ã™ã€‚å‡ºç™ºå‰ã«ã€ŒæŒå‡ºä¸€æ‹¬ã€ã‚‚ã§ãã¾ã™ï¼ˆãƒªã‚¹ãƒˆã‚¿ãƒ–ï¼‰ã€‚
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section id="tab-list" class="card" style="display:none;">
    <h2>â‘¡ ãƒªã‚¹ãƒˆï¼ˆé…é”ã«å‡ºã‚‹ï¼‰</h2>

    <div class="toolbar">
      <div class="left">
        <div>
          <label style="margin-bottom:6px;">æ—¥ä»˜</label>
          <input id="filterDate" type="date" />
        </div>
        <div>
          <label style="margin-bottom:6px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="filterStatus">
            <option value="created">æœªæŒå‡º</option>
            <option value="out">æŒå‡º</option>
            <option value="done">å®Œäº†</option>
            <option value="absent">ä¸åœ¨</option>
            <option value="return">è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="grow" style="min-width:220px;">
          <label style="margin-bottom:6px;">æ¤œç´¢ï¼ˆç•ªå·/ä½æ‰€/å–å¼•å…ˆï¼‰</label>
          <input id="filterText" type="text" placeholder="ä¾‹ï¼š1234 / é¹¿å…å³¶ / ãƒ¤ãƒãƒˆ" />
        </div>
      </div>

      <div class="btns">
        <button class="btn-primary btn-mini" id="btnBulkOut">ğŸšš æŒå‡ºä¸€æ‹¬ï¼ˆæœªæŒå‡ºâ†’æŒå‡ºï¼‰</button>
        <button class="btn-ghost btn-mini" id="btnNext">â–¶ æ¬¡ã®æœªå®Œã¸</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kpis" id="kpis"></div>

    <div class="list" id="historyList"></div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-ghost" id="btnExportCSV">CSVå‡ºåŠ›</button>
      <button class="btn-ghost" id="btnExportPDF">PDFå‡ºåŠ›</button>
      <button class="btn-bad" id="btnClearAll">å…¨å‰Šé™¤ï¼ˆæ³¨æ„ï¼‰</button>
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="card" style="display:none;">
    <h2>â‘¢ æ—¥å ±ï¼ˆLINEé€ä¿¡ç”¨ï¼šPDF/CSVï¼‰</h2>

    <div class="grid two">
      <div>
        <label>å¯¾è±¡æ—¥</label>
        <input id="reportDate" type="date" />
      </div>
      <div>
        <label>é…é”å“¡åï¼ˆå°å­—ï¼‰</label>
        <input id="reportDriver" type="text" placeholder="æœªå…¥åŠ›ãªã‚‰SCANã®é…é”å“¡å" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="kpis" id="reportKpis"></div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-primary" id="btnReportCSV">CSVå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
      <button class="btn-primary" id="btnReportPDF">PDFå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
    </div>

    <div class="note" style="margin-top:10px;">
      â€»ä¼šç¤¾ãŒå±¥æ­´ã‚’è¦‹ã‚Œã‚Œã°OKãªã‚‰ã€ã“ã®PDF/CSVã‚’æ¯æ—¥LINEé€ä¿¡ã§é‹ç”¨ã§ãã¾ã™ã€‚<br>
      æ¬¡æ®µéšã§ã€Œä¼šç¤¾å´ã®ç®¡ç†ç”»é¢ï¼ˆå…¨å“¡åˆ†ã®ä¸€è¦§ï¼‰ã€ã«æ‹¡å¼µã§ãã¾ã™ã€‚
    </div>
  </section>

</main>

<script>
/* =========================
   Storage & helpers
========================= */
const STORAGE_KEY = "ofa_delivery_v2";
let gps = { lat:null, lng:null, at:null };

const pad = n => String(n).padStart(2,"0");
const today = new Date();
const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

function nowISO(){
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function uid(){
  return "S" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function load(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }catch{ return []; }
}
function save(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function statusLabel(s){
  return ({created:"æœªæŒå‡º", out:"æŒå‡º", done:"å®Œäº†", absent:"ä¸åœ¨", return:"è¿”å´"})[s] || s;
}
function statusClass(s){
  return ({created:"st-created", out:"st-out", done:"st-done", absent:"st-absent", return:"st-return"})[s] || "st-created";
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const t = btn.dataset.tab;
    document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
    document.getElementById("tab-"+t).style.display="block";
    if(t==="list") renderList();
    if(t==="report") renderReport();
  });
});

/* =========================
   Init
========================= */
document.getElementById("shipDate").value = todayStr;
document.getElementById("filterDate").value = todayStr;
document.getElementById("reportDate").value = todayStr;

/* =========================
   GPS
========================= */
const gpsState = document.getElementById("gpsState");
document.getElementById("btnGPS").addEventListener("click", async ()=>{
  if(!navigator.geolocation){
    alert("ã“ã®ç«¯æœ«ã¯GPSå–å¾—ã«éå¯¾å¿œã§ã™ã€‚");
    return;
  }
  gpsState.textContent = "å–å¾—ä¸­â€¦";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gps.lat = pos.coords.latitude;
      gps.lng = pos.coords.longitude;
      gps.at = nowISO();
      gpsState.textContent = "OK";
      alert(`GPSå–å¾—ã—ã¾ã—ãŸ\n${gps.lat.toFixed(6)}, ${gps.lng.toFixed(6)}`);
    },
    ()=>{
      gpsState.textContent = "å¤±æ•—";
      alert("GPSå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    },
    { enableHighAccuracy:true, timeout:12000 }
  );
});

/* =========================
   Add shipment (scan/manual)
========================= */
function addShipment(tracking){
  tracking = (tracking||"").trim();
  if(!tracking){ alert("ä¼ç¥¨ç•ªå·ãŒç©ºã§ã™"); return; }

  const shipDate = document.getElementById("shipDate").value || todayStr;
  const driver = (document.getElementById("driver").value || "").trim();
  const client = (document.getElementById("client").value || "").trim();
  const address = (document.getElementById("address").value || "").trim();

  const list = load();

  // é‡è¤‡ã¯ã€Œä»Šæ—¥ã®åŒä¸€ç•ªå·ã€ã¯ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆé€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã§äº‹æ•…ã‚Šã‚„ã™ã„ã®ã§ï¼‰
  const dup = list.find(x => x.shipDate===shipDate && x.tracking===tracking);
  if(dup){
    // è»½ã„ãƒã‚¤ãƒ–æ„Ÿã®ä»£æ›¿ï¼ˆiOSã¯åˆ¶é™ã‚ã‚Šï¼‰â†’ã‚¢ãƒ©ãƒ¼ãƒˆæœ€å°
    console.log("duplicate:", tracking);
    return;
  }

  const item = {
    id: uid(),
    shipDate, driver, client,
    tracking,
    address,
    status: "created",
    createdAt: nowISO(),
    history: [{at: nowISO(), action:"ç™»éŒ²"}]
  };
  list.unshift(item);
  save(list);
}

/* manual add */
document.getElementById("btnAddManual").addEventListener("click", ()=>{
  const t = document.getElementById("tracking").value;
  addShipment(t);
  document.getElementById("tracking").value = "";
  // å³ãƒªã‚¹ãƒˆã¸è¡Œãå°ç·šï¼ˆ50å€‹æƒ³å®šï¼‰
  flash("è¿½åŠ ã—ã¾ã—ãŸ");
});

/* =========================
   SCAN (BarcodeDetector)
========================= */
let stream = null;
let scanning = false;
let detector = null;

const camBox = document.getElementById("camBox");
const video = document.getElementById("video");
const btnStartScan = document.getElementById("btnStartScan");
const btnStopScan = document.getElementById("btnStopScan");

btnStartScan.addEventListener("click", async ()=>{
  // Check support
  if(!navigator.mediaDevices?.getUserMedia){
    alert("ã‚«ãƒ¡ãƒ©éå¯¾å¿œã§ã™ã€‚æ‰‹å…¥åŠ›ã§é‹ç”¨ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if(!("BarcodeDetector" in window)){
    alert("ã“ã®ç«¯æœ«ã¯è‡ªå‹•èª­ã¿å–ã‚Šã«éå¯¾å¿œã§ã™ã€‚æ‰‹å…¥åŠ›ã§é‹ç”¨ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const formats = ["qr_code","ean_13","ean_8","code_128","code_39","itf","upc_a","upc_e","data_matrix","pdf417"];
  detector = new BarcodeDetector({ formats });

  camBox.style.display = "block";
  btnStartScan.style.display = "none";
  btnStopScan.style.display = "inline-block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"environment" }, audio:false });
    video.srcObject = stream;
    await video.play();
  }catch(e){
    stopScan();
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTTPS/æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  scanning = true;
  loopScan();
  flash("SCANä¸­ï¼šä¼ç¥¨ã‚’ã‹ã–ã—ã¦ä¸‹ã•ã„");
});

btnStopScan.addEventListener("click", ()=> stopScan());

function stopScan(){
  scanning = false;
  btnStartScan.style.display = "inline-block";
  btnStopScan.style.display = "none";
  camBox.style.display = "none";
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  }catch{}
  stream = null;
}

let lastValue = "";
let lastAt = 0;

async function loopScan(){
  if(!scanning) return;
  try{
    const codes = await detector.detect(video);
    if(codes && codes.length){
      const val = (codes[0].rawValue || "").trim();
      const now = Date.now();
      // åŒä¸€é€£ç¶šèª­ã¿å–ã‚Šã‚’æŠ‘åˆ¶ï¼ˆ0.9ç§’ï¼‰
      if(val && (val !== lastValue || (now-lastAt) > 900)){
        lastValue = val; lastAt = now;
        addShipment(val);
        flash(`èª­ã¿å–ã‚Šï¼š${val}ï¼ˆè¿½åŠ ï¼‰`);
      }
    }
  }catch(e){
    // ignore
  }
  requestAnimationFrame(loopScan);
}

/* =========================
   List / filters / actions
========================= */
["filterDate","filterStatus","filterText"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderList);
});

function applyFilters(list){
  const d = document.getElementById("filterDate").value;
  const st = document.getElementById("filterStatus").value;
  const q = (document.getElementById("filterText").value||"").trim().toLowerCase();
  return list.filter(x=>{
    const okD = d ? x.shipDate===d : true;
    const okS = st ? x.status===st : true;
    const hay = `${x.tracking} ${x.address||""} ${x.client||""}`.toLowerCase();
    const okQ = q ? hay.includes(q) : true;
    return okD && okS && okQ;
  });
}

function computeKpis(listAll, dateStr){
  const list = listAll.filter(x=>x.shipDate===dateStr);
  const c = (st)=> list.filter(x=>x.status===st).length;
  return {
    total:list.length,
    created:c("created"),
    out:c("out"),
    done:c("done"),
    absent:c("absent"),
    ret:c("return"),
  };
}

function renderKpis(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const all = load();
  const k = computeKpis(all, dateStr);
  document.getElementById("kpis").innerHTML = `
    <div class="kpi"><small>åˆè¨ˆ</small><b>${k.total}</b></div>
    <div class="kpi"><small>æœªæŒå‡º</small><b>${k.created}</b></div>
    <div class="kpi"><small>æŒå‡º</small><b>${k.out}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${k.done}</b></div>
    <div class="kpi"><small>ä¸åœ¨</small><b>${k.absent}</b></div>
  `;
}

function renderList(){
  renderKpis();
  const box = document.getElementById("historyList");
  const all = load();
  const list = applyFilters(all);

  if(!list.length){
    box.innerHTML = `<div class="note">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚SCANã§èª­ã¿å–ã£ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  box.innerHTML = list.map(x=>{
    const mapBtn = x.address ? `<button class="btn-blue btn-mini" onclick="navTo('${x.id}')">ğŸ—º ãƒŠãƒ“</button>` : `<button class="btn-ghost btn-mini" onclick="editAddress('${x.id}')">ä½æ‰€å…¥åŠ›</button>`;
    return `
      <div class="item" id="row-${x.id}">
        <div class="itemTop">
          <div>
            <b>${escapeHtml(x.tracking)}</b>
            <div class="mini">${escapeHtml(x.client||"ï¼ˆå–å¼•å…ˆæœªå…¥åŠ›ï¼‰")} / ${escapeHtml(x.shipDate)}</div>
          </div>
          <div class="tag ${statusClass(x.status)}">${statusLabel(x.status)}</div>
        </div>
        <div class="meta">
          ä½æ‰€ï¼š${escapeHtml(x.address||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          é…é”å“¡ï¼š${escapeHtml(x.driver||"ï¼ˆæœªå…¥åŠ›ï¼‰")} / ç™»éŒ²ï¼š${escapeHtml(x.createdAt||"")}
        </div>

        <div class="actions">
          ${mapBtn}
          <button class="btn-ok btn-mini" onclick="setStatus('${x.id}','out','æŒå‡º')">æŒå‡º</button>
          <button class="btn-ok btn-mini" onclick="setStatus('${x.id}','done','å®Œäº†', true)">å®Œäº†</button>
          <button class="btn-warn btn-mini" onclick="setStatus('${x.id}','absent','ä¸åœ¨', true)">ä¸åœ¨</button>
          <button class="btn-bad btn-mini" onclick="setStatus('${x.id}','return','è¿”å´')">è¿”å´</button>
          <button class="btn-ghost btn-mini" onclick="showDetail('${x.id}')">è©³ç´°</button>
          <button class="btn-bad btn-mini" onclick="delOne('${x.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join("");
}

window.setStatus = function(id, st, label, autoNext=false){
  const list = load();
  const it = list.find(x=>x.id===id);
  if(!it) return;
  it.status = st;
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: label});
  save(list);
  renderList();
  flash(`${label}ï¼š${it.tracking}`);
  if(autoNext) jumpNextUnfinished();
};

window.delOne = function(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const list = load().filter(x=>x.id!==id);
  save(list);
  renderList();
};

window.showDetail = function(id){
  const it = load().find(x=>x.id===id);
  if(!it) return;
  const h = (it.history||[]).map(r=>`ãƒ»${r.at}ï¼š${r.action}`).join("\n");
  alert(
`ã€è©³ç´°ã€‘
ä¼ç¥¨ï¼š${it.tracking}
æ—¥ä»˜ï¼š${it.shipDate}
å–å¼•å…ˆï¼š${it.client||""}
ä½æ‰€ï¼š${it.address||""}
é…é”å“¡ï¼š${it.driver||""}
çŠ¶æ…‹ï¼š${statusLabel(it.status)}

ã€å±¥æ­´ã€‘
${h}`
  );
};

window.editAddress = function(id){
  const list = load();
  const it = list.find(x=>x.id===id);
  if(!it) return;
  const v = prompt("ä½æ‰€ã‚’å…¥åŠ›ï¼ˆGoogleãƒŠãƒ“ã«ä½¿ç”¨ï¼‰", it.address||"");
  if(v===null) return;
  it.address = v.trim();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action:"ä½æ‰€æ›´æ–°"});
  save(list);
  renderList();
};

window.navTo = function(id){
  const it = load().find(x=>x.id===id);
  if(!it || !it.address){
    alert("ä½æ‰€ãŒæœªå…¥åŠ›ã§ã™ã€‚");
    return;
  }

  // ç¾åœ¨åœ°ãŒå–ã‚Œã¦ã„ã‚Œã°originä»˜ã§ã‚ˆã‚Šç¢ºå®Ÿ
  const dest = encodeURIComponent(it.address);
  const origin = (gps.lat && gps.lng) ? `${gps.lat},${gps.lng}` : "";
  const url = origin
    ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&travelmode=driving`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;

  // ã€Œå‡ºç™ºã€æ‰±ã„ã«ã—ãŸã„å ´åˆã¯æŒå‡ºã¸å¯„ã›ã‚‹ï¼ˆå¥½ã¿ã§ï¼‰
  if(it.status==="created"){
    if(confirm("ãƒŠãƒ“é–‹å§‹ã¨åŒæ™‚ã«ã€ŒæŒå‡ºã€ã«ã—ã¾ã™ã‹ï¼Ÿ")){
      window.setStatus(it.id, "out", "æŒå‡º");
    }
  }
  window.open(url, "_blank");
};

/* Next unfinished (created/out) */
document.getElementById("btnNext").addEventListener("click", jumpNextUnfinished);

function jumpNextUnfinished(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const st = document.getElementById("filterStatus").value;
  // æœªå®Œå„ªå…ˆï¼šcreated â†’ out
  const all = load().filter(x=>x.shipDate===dateStr);
  const target = all.find(x=>x.status==="created") || all.find(x=>x.status==="out");
  if(!target){
    flash("æœªå®ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå®Œäº†æ¸ˆã¿ï¼‰");
    return;
  }
  // listã‚¿ãƒ–ã¸
  document.querySelector('[data-tab="list"]').click();
  setTimeout(()=>{
    const el = document.getElementById("row-"+target.id);
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  }, 50);
}

/* Bulk out */
document.getElementById("btnBulkOut").addEventListener("click", ()=>{
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const list = load();
  let cnt = 0;
  list.forEach(it=>{
    if(it.shipDate===dateStr && it.status==="created"){
      it.status="out";
      it.history = it.history || [];
      it.history.push({at: nowISO(), action:"æŒå‡ºï¼ˆè‡ªå‹•ä¸€æ‹¬ï¼‰"});
      cnt++;
    }
  });
  save(list);
  renderList();
  flash(`æŒå‡ºä¸€æ‹¬ï¼š${cnt}ä»¶`);
});

/* =========================
   Export CSV / PDF
========================= */
function toCSV(rows){
  const esc = v => `"${String(v??"").replaceAll('"','""')}"`;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

function rowsForExport(list){
  return list.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate,
      x.driver,
      x.tracking,
      x.client,
      x.address,
      statusLabel(x.status),
      last?.at || "",
      (x.history||[]).map(h=>`${h.at} ${h.action}`).join(" | ")
    ];
  });
}

document.getElementById("btnExportCSV").addEventListener("click", ()=>{
  const list = applyFilters(load());
  const header = ["æ—¥ä»˜","é…é”å“¡","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","ä½æ‰€","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æœ€çµ‚æ›´æ–°","å±¥æ­´"];
  const csv = toCSV([header, ...rowsForExport(list)]);
  downloadFile(csv, `OFA_é…é”å±¥æ­´_${todayStr}.csv`, "text/csv;charset=utf-8");
});

function exportPDF(title, list, filename, metaLines=[]){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});
  doc.setFontSize(14);
  doc.text(title, 14, 14);

  doc.setFontSize(10);
  let y=20;
  metaLines.forEach(line=>{ doc.text(line, 14, y); y+=5; });

  const head = [["æ—¥ä»˜","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","ä½æ‰€","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°"]];
  const body = list.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [x.shipDate, x.tracking, x.client||"", x.address||"", statusLabel(x.status), last?.at||""];
  });

  doc.autoTable({
    startY: y+2,
    head, body,
    styles:{fontSize:9, cellPadding:2},
    theme:"grid"
  });

  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`OFA GROUP / ${todayStr} / Page ${i}/${pageCount}`, 14, 292);
  }
  doc.save(filename);
}

document.getElementById("btnExportPDF").addEventListener("click", ()=>{
  const list = applyFilters(load());
  exportPDF("OFA é…é”å±¥æ­´", list, `OFA_é…é”å±¥æ­´_${todayStr}.pdf`, [
    `å‡ºåŠ›ï¼š${nowISO()}`,
    `GPSï¼š${gps.lat&&gps.lng ? gps.lat.toFixed(6)+","+gps.lng.toFixed(6) : "æœªå–å¾—"}`
  ]);
});

/* =========================
   Report
========================= */
document.getElementById("reportDate").addEventListener("change", renderReport);
document.getElementById("reportDriver").addEventListener("input", renderReport);

function byDate(dateStr){
  return load().filter(x=>x.shipDate===dateStr);
}
function renderReport(){
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = byDate(dateStr);
  const driver = (document.getElementById("reportDriver").value||"").trim() || (document.getElementById("driver").value||"").trim();

  const c = (st)=> list.filter(x=>x.status===st).length;
  const k = { total:list.length, created:c("created"), out:c("out"), done:c("done"), absent:c("absent"), ret:c("return") };

  document.getElementById("reportKpis").innerHTML = `
    <div class="kpi"><small>å¯¾è±¡æ—¥</small><b>${escapeHtml(dateStr)}</b></div>
    <div class="kpi"><small>é…é”å“¡</small><b>${escapeHtml(driver||"æœªå…¥åŠ›")}</b></div>
    <div class="kpi"><small>åˆè¨ˆ</small><b>${k.total}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${k.done}</b></div>
    <div class="kpi"><small>ä¸åœ¨</small><b>${k.absent}</b></div>
    <div class="kpi"><small>æœªæŒå‡º</small><b>${k.created}</b></div>
  `;
}

document.getElementById("btnReportCSV").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = byDate(dateStr);
  const header = ["æ—¥ä»˜","é…é”å“¡","ä¼ç¥¨ç•ªå·","å–å¼•å…ˆ","ä½æ‰€","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹","æœ€çµ‚æ›´æ–°","å±¥æ­´"];
  const csv = toCSV([header, ...rowsForExport(list)]);
  downloadFile(csv, `OFA_æ—¥å ±_${dateStr}.csv`, "text/csv;charset=utf-8");
});
document.getElementById("btnReportPDF").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const list = byDate(dateStr);
  const driver = (document.getElementById("reportDriver").value||"").trim() || (document.getElementById("driver").value||"").trim();
  exportPDF("OFA æ—¥å ±ï¼ˆé…é”ï¼‰", list, `OFA_æ—¥å ±_${dateStr}.pdf`, [
    `å¯¾è±¡æ—¥ï¼š${dateStr}`,
    `é…é”å“¡ï¼š${driver||"æœªå…¥åŠ›"}`,
    `å‡ºåŠ›ï¼š${nowISO()}`
  ]);
});

/* =========================
   Clear
========================= */
document.getElementById("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚")) return;
  localStorage.removeItem(STORAGE_KEY);
  flash("å‰Šé™¤ã—ã¾ã—ãŸ");
  renderList();
  renderReport();
});

/* =========================
   Toast (light flash)
========================= */
let toastTimer = null;
function flash(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="22px";
    el.style.transform="translateX(-50%)";
    el.style.background="rgba(17,24,39,.92)";
    el.style.color="#fff";
    el.style.padding="10px 14px";
    el.style.borderRadius="999px";
    el.style.fontWeight="900";
    el.style.fontSize="12px";
    el.style.boxShadow="0 12px 28px rgba(0,0,0,.18)";
    el.style.zIndex="9999";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity="1";
  toastTimer = setTimeout(()=>{ el.style.opacity="0"; }, 1200);
}

/* init render */
renderList();
renderReport();
</script>
</body>
</html>
