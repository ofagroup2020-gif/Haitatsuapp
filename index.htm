<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>OFA é…é”ã‚¢ãƒ—ãƒª</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- âœ… iPhoneå¯¾å¿œ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Noto Sans JP",sans-serif;
  background:#f5f7fb;
  color:#0f172a;
}
header{
  position:sticky;top:0;z-index:50;
  background:#fff;
  border-bottom:1px solid #e2e8f0;
}
.top{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px;
}
.logo{
  width:40px;height:40px;border-radius:12px;
  background:linear-gradient(135deg,#FFD400,#fff2a8);
  display:grid;place-items:center;font-weight:900;
}
nav{
  display:flex;gap:8px;padding:8px;
}
.tab{
  flex:1;
  padding:12px;
  border-radius:14px;
  border:1px solid #e2e8f0;
  background:#fff;
  font-weight:900;
}
.tab.active{background:#e8f0ff}
main{padding:12px}
.card{
  background:#fff;border-radius:18px;padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
button{
  border:0;border-radius:14px;
  padding:12px;font-weight:900;
}
.btn-scan{background:#FFD400}
.btn-blue{background:#2563eb;color:#fff}
.btn-red{background:#ef4444;color:#fff}
.btn-gray{background:#e5e7eb}
.list{margin-top:12px;display:grid;gap:10px}
.item{
  border:1px solid #e2e8f0;border-radius:14px;padding:10px;
}
.item b{font-size:14px}
.mini{font-size:12px;color:#64748b}
.actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
video{width:100%;border-radius:14px}
</style>
</head>

<body>

<header>
  <div class="top">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="logo">OFA</div>
      <div>
        <b>é…é”ã‚¢ãƒ—ãƒª</b><br>
        <small>SCAN â†’ ãƒŠãƒ“ â†’ å®Œäº†</small>
      </div>
    </div>
    <div id="gps">GPS: æœªå–å¾—</div>
  </div>
  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="list">æœªé…é”</button>
    <button class="tab" data-tab="done">å®Œäº†</button>
  </nav>
</header>

<main>

<!-- SCAN -->
<section id="scan" class="card">
  <button class="btn-blue" onclick="getGPS()">ğŸ“ GPSå–å¾—</button>
  <button class="btn-scan" onclick="startScan()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button class="btn-gray" onclick="toggleTorch()">ğŸ”¦ ãƒ©ã‚¤ãƒˆåˆ‡æ›¿</button>
  <div id="camera" style="margin-top:10px;display:none">
    <video id="video"></video>
  </div>
</section>

<!-- LIST -->
<section id="list" class="card" style="display:none">
  <div class="list" id="listBox"></div>
</section>

<!-- DONE -->
<section id="done" class="card" style="display:none">
  <div class="list" id="doneBox"></div>
</section>

</main>

<script>
const KEY="ofa_delivery_real";
let list=JSON.parse(localStorage.getItem(KEY)||"[]");
let stream=null,track=null,torch=false;
const codeReader=new ZXing.BrowserMultiFormatReader();
let gps=null;

/* Tabs */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    ["scan","list","done"].forEach(id=>document.getElementById(id).style.display="none");
    document.getElementById(t.dataset.tab).style.display="block";
    render();
  }
});

/* GPS */
function getGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    gps={lat:p.coords.latitude,lng:p.coords.longitude};
    document.getElementById("gps").innerText="GPS: OK";
  });
}

/* Scan */
async function startScan(){
  document.getElementById("camera").style.display="block";
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  track=stream.getVideoTracks()[0];
  document.getElementById("video").srcObject=stream;
  document.getElementById("video").play();

  codeReader.decodeFromVideoElement(document.getElementById("video"),(res)=>{
    if(res){
      add(res.text);
    }
  });
}

/* Torch */
async function toggleTorch(){
  if(!track) return alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã®ã¿");
  torch=!torch;
  await track.applyConstraints({advanced:[{torch}]});
}

/* Add */
function add(code){
  if(list.find(x=>x.code===code)) return;
  list.push({
    id:Date.now(),
    code,
    status:"todo",
    time:new Date().toLocaleString()
  });
  save(); render();
}

/* Status */
function done(id){
  const x=list.find(v=>v.id===id);
  x.status="done"; x.doneTime=new Date().toLocaleString();
  save(); render();
}

/* Map */
function nav(){
  if(!gps) return alert("GPSæœªå–å¾—");
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${gps.lat},${gps.lng}&destination=å¤§é˜ªå¸‚`);
}

/* Render */
function render(){
  listBox.innerHTML="";
  doneBox.innerHTML="";
  list.filter(x=>x.status==="todo").forEach(x=>{
    listBox.innerHTML+=`
      <div class="item">
        <b>${x.code}</b>
        <div class="mini">${x.time}</div>
        <div class="actions">
          <button class="btn-blue" onclick="nav()">ãƒŠãƒ“</button>
          <button class="btn-scan" onclick="done(${x.id})">å®Œäº†</button>
        </div>
      </div>`;
  });
  list.filter(x=>x.status==="done").forEach(x=>{
    doneBox.innerHTML+=`
      <div class="item">
        <b>${x.code}</b>
        <div class="mini">å®Œäº† ${x.doneTime}</div>
      </div>`;
  });
}

/* Save */
function save(){
  localStorage.setItem(KEY,JSON.stringify(list));
}

render();
</script>

</body>
</html>
