<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆç‚¹å‘¼â†’é›†è·â†’ãƒªã‚¹ãƒˆâ†’åœ°å›³â†’æ—¥å ±ï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Barcode -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- Map -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Sortable (Drag reorder) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<style>
  :root{
    --r:18px;
    --bg:#f6f8ff;
    --card:#fff;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e5e7eb;

    --red:#E53935;
    --yellow:#FFD400;
    --blue:#1565C0;

    --shadow:0 14px 40px rgba(15,23,42,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 10% -10%, rgba(255,212,0,.35), transparent 60%),
      radial-gradient(900px 520px at 110% 0%, rgba(21,101,192,.18), transparent 60%),
      radial-gradient(900px 520px at 60% 110%, rgba(229,57,53,.12), transparent 60%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .top{
    max-width:1200px; margin:0 auto;
    padding:12px 14px 8px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .logo{
    width:44px;height:44px;border-radius:16px;
    display:grid; place-items:center;
    font-weight:900;
    color:#111;
    background:linear-gradient(135deg,var(--yellow),#fff2a8);
    box-shadow:0 12px 26px rgba(255,212,0,.25);
  }
  .ttl b{display:block; font-size:14px}
  .ttl small{display:block; color:var(--muted); font-size:11px; margin-top:2px}

  .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-size:12px; color:var(--muted);
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    white-space:nowrap;
  }
  .chip b{color:var(--ink)}

  nav{
    max-width:1200px; margin:0 auto;
    padding:0 14px 12px;
    display:flex; gap:10px;
    overflow:auto;
  }
  .tab{
    min-width:120px;
    flex:1;
    padding:12px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900;
    font-size:12px;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    cursor:pointer;
    white-space:nowrap;
  }
  .tab.active{
    border-color:rgba(21,101,192,.28);
    background:linear-gradient(135deg, rgba(255,212,0,.28), rgba(21,101,192,.10));
  }

  main{max-width:1200px; margin:0 auto; padding:12px 14px 18px; display:grid; gap:12px;}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r);
    padding:14px;
    box-shadow:var(--shadow);
  }
  .card h2{margin:0 0 10px; font-size:14px}
  .mini{color:var(--muted); font-size:11px; line-height:1.6}
  .row{display:grid; gap:10px}
  @media(min-width:880px){
    .row.two{grid-template-columns:1fr 1fr}
    .row.three{grid-template-columns:1fr 1fr 1fr}
    .row.four{grid-template-columns:1fr 1fr 1fr 1fr}
  }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, textarea{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  textarea{min-height:86px; resize:vertical}
  .btns{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:16px;
    padding:12px 12px;
    font-weight:900;
    cursor:pointer;
    font-size:13px;
  }
  .btnY{background:linear-gradient(135deg,var(--yellow),#ffe77a); color:#111;}
  .btnB{background:linear-gradient(135deg, rgba(21,101,192,.95), rgba(21,101,192,.75)); color:#fff;}
  .btnR{background:linear-gradient(135deg, rgba(229,57,53,.95), rgba(229,57,53,.75)); color:#fff;}
  .btnG{background:#fff; border:1px solid var(--line); color:var(--ink);}
  .btnOK{background:rgba(16,185,129,.10); border:1px solid rgba(16,185,129,.25); color:#065f46;}
  .btnW{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.25); color:#7c2d12;}

  .hr{height:1px; background:var(--line); margin:12px 0}

  /* Pickup scan area */
  .scanWrap{
    border:1px dashed rgba(21,101,192,.26);
    background:linear-gradient(135deg, rgba(255,212,0,.18), rgba(21,101,192,.08));
    border-radius:18px;
    padding:12px;
  }
  .camBox{
    display:none;
    margin-top:10px;
    overflow:hidden;
    border-radius:16px;
    border:1px solid var(--line);
    background:#000;
  }
  video{width:100%; height:auto; display:block;}

  /* List + Swipe (simple) */
  .list{display:grid; gap:10px; margin-top:12px}
  .swipe{
    position:relative;
    border-radius:18px;
    border:1px solid var(--line);
    overflow:hidden;
    background:#fff;
  }
  .swipeBack{
    position:absolute; inset:0;
    display:flex; justify-content:flex-end; gap:8px;
    padding:10px;
    background:linear-gradient(135deg, rgba(229,57,53,.10), rgba(21,101,192,.06));
    align-items:center;
  }
  .swipeFront{
    position:relative;
    background:#fff;
    padding:12px;
    transform:translateX(0px);
    transition:transform .15s ease;
    touch-action:pan-y;
  }
  .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
  .tag{
    font-weight:900; font-size:11px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--line);
    white-space:nowrap;
  }
  .st-created{background:#f9fafb; color:var(--muted)}
  .st-out{background:rgba(21,101,192,.10); border-color:rgba(21,101,192,.22); color:#0b3a7a}
  .st-done{background:rgba(16,185,129,.10); border-color:rgba(16,185,129,.22); color:#065f46}
  .st-absent{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25); color:#7c2d12}

  .meta{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.55}
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#f8fafc;
    font-weight:900;
    font-size:12px;
    margin-right:8px;
  }
  .danger{color:#b45309; font-weight:900}

  /* Map */
  #map{
    width:100%;
    height:66vh;
    border-radius:18px;
    border:1px solid var(--line);
    overflow:hidden;
  }

  /* Modal */
  .modalBack{
    position:fixed; inset:0; z-index:9990;
    background:rgba(15,23,42,.42);
    display:none;
    align-items:flex-end;
    justify-content:center;
  }
  .modal{
    width:min(1020px, 100%);
    background:#fff;
    border-top-left-radius:22px;
    border-top-right-radius:22px;
    border:1px solid var(--line);
    box-shadow:0 20px 60px rgba(0,0,0,.22);
    padding:14px;
    max-height:90vh;
    overflow:auto;
  }
  .modal h3{margin:0 0 10px; font-size:14px}
  .warnBox{
    background:rgba(245,158,11,.12);
    border:1px solid rgba(245,158,11,.25);
    color:#7c2d12;
    border-radius:16px;
    padding:10px 12px;
    font-weight:900;
    font-size:12px;
  }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    bottom:22px;
    transform:translateX(-50%);
    background:rgba(15,23,42,.92);
    color:#fff;
    padding:10px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    box-shadow:0 14px 30px rgba(0,0,0,.18);
    z-index:9999;
    opacity:0;
    transition:opacity .2s ease;
    pointer-events:none;
  }
</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div class="ttl">
        <b>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</b>
        <small>â‘ ç‚¹å‘¼ â†’ â‘¡é›†è·ï¼ˆå¿…é ˆå…¥åŠ›ï¼‰â†’ â‘¢ãƒªã‚¹ãƒˆï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—/ä¸¦æ›¿ï¼‰â†’ â‘£åœ°å›³ï¼ˆç¾åœ¨åœ°å‘¨è¾ºï¼‰â†’ â‘¤æ—¥å ±</small>
      </div>
    </div>
    <div class="chips">
      <div class="chip">GPSï¼š<b id="gpsState">æœªå–å¾—</b></div>
      <div class="chip">ãƒ”ãƒ³ï¼š<b id="pinState">æœªä½œæˆ</b></div>
      <div class="chip">ãƒ©ã‚¤ãƒˆï¼š<b id="torchState">æœªå¯¾å¿œ</b></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="tenko">â‘  Webç‚¹å‘¼</button>
    <button class="tab" data-tab="pickup">â‘¡ é›†è·ï¼ˆSCANï¼‰</button>
    <button class="tab" data-tab="list">â‘¢ ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="map">â‘£ åœ°å›³</button>
    <button class="tab" data-tab="report">â‘¤ æ—¥å ±</button>
  </nav>
</header>

<main>

  <!-- â‘  TENKO -->
  <section id="tab-tenko" class="card">
    <h2>â‘  Webç‚¹å‘¼ï¼ˆé–‹å§‹/çµ‚äº†ï¼‰</h2>

    <div class="row three">
      <div>
        <label>æ—¥ä»˜</label>
        <input id="tenkoDate" type="date">
      </div>
      <div>
        <label>é…é”å“¡åï¼ˆå¿…é ˆï¼‰</label>
        <input id="tenkoDriver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸">
      </div>
      <div>
        <label>è»Šä¸¡ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input id="tenkoCar" type="text" placeholder="ä¾‹ï¼šé¹¿å…å³¶ 123 ã‚ 45-67">
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ï¼ˆ0.00 ãªã‚‰ OKï¼‰</label>
        <input id="tenkoAlcohol" inputmode="decimal" placeholder="0.00">
      </div>
      <div>
        <label>å¥åº·çŠ¶æ…‹</label>
        <select id="tenkoHealth">
          <option value="è‰¯å¥½">è‰¯å¥½</option>
          <option value="ã‚„ã‚„ä¸èª¿">ã‚„ã‚„ä¸èª¿</option>
          <option value="ä¸èª¿">ä¸èª¿</option>
        </select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>ç‚¹å‘¼ãƒ¡ãƒ¢</label>
        <textarea id="tenkoMemo" placeholder="ä¾‹ï¼šç¡çœ 6hã€å•é¡Œãªã—"></textarea>
      </div>
      <div>
        <label>æ“ä½œ</label>
        <div class="btns">
          <button class="btnB" id="btnGPS">ğŸ“GPSå–å¾—</button>
          <button class="btnY" id="btnTenkoStart">â–¶ æ¥­å‹™é–‹å§‹</button>
          <button class="btnR" id="btnTenkoEnd">â¹ æ¥­å‹™çµ‚äº†</button>
        </div>
        <div class="mini" style="margin-top:8px;">â€»ç‚¹å‘¼å±¥æ­´ã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆå¾Œã§CSV/PDFå‡ºåŠ›ã‚‚å¯èƒ½ã«ã§ãã¾ã™ï¼‰</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="mini">
      ç‚¹å‘¼ãŒçµ‚ã‚ã£ãŸã‚‰ <b>â‘¡é›†è·ï¼ˆSCANï¼‰</b> ã¸ã€‚
    </div>
  </section>

  <!-- â‘¡ PICKUP -->
  <section id="tab-pickup" class="card" style="display:none;">
    <h2>â‘¡ é›†è·ï¼ˆSCAN â†’ å¿…é ˆå…¥åŠ› â†’ è‡ªå‹•ãƒ”ãƒ³ï¼‰</h2>

    <div class="scanWrap">
      <div class="row three">
        <div>
          <label>é…é”æ—¥</label>
          <input id="shipDate" type="date">
        </div>
        <div>
          <label>é…é”å“¡åï¼ˆç‚¹å‘¼ã‹ã‚‰è‡ªå‹•ï¼‰</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸">
        </div>
        <div>
          <label>è·ç‰©ç¨®åˆ¥</label>
          <select id="kind">
            <option>å®…é…</option>
            <option>æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰</option>
            <option>æ›¸é¡</option>
            <option>ãƒã‚¹ãƒˆæŠ•å‡½</option>
            <option>å†·è”µãƒ»å†·å‡</option>
            <option>ä»£å¼•</option>
            <option>å¤§ç‰©</option>
            <option>å£Šã‚Œç‰©</option>
            <option>åŒ»ç™‚å“</option>
            <option>å»ºæ</option>
            <option>ãã®ä»–</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row two">
        <div>
          <label>ä¼ç¥¨ç•ªå·ï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
          <input id="manualCode" type="text" placeholder="èª­ã‚ãªã„å ´åˆã¯ã“ã“ã«å…¥åŠ›â†’è¿½åŠ ">
          <div class="mini" style="margin-top:6px;">
            â€»ç¾å ´ã§ã¯ <b>ä¼ç¥¨ç•ªå·</b> ã¨ <b>ä½æ‰€</b> ã§è·ç‰©ã‚’æ¢ã™ â†’ ãªã®ã§ç™»éŒ²æ™‚ã«å¿…é ˆå…¥åŠ›ã—ã¾ã™ã€‚
          </div>
        </div>
        <div>
          <label>æ“ä½œ</label>
          <div class="btns">
            <button class="btnB" id="btnStartScan">ğŸ“· SCANé–‹å§‹</button>
            <button class="btnG" id="btnStopScan" style="display:none;">åœæ­¢</button>
            <button class="btnG" id="btnTorch" disabled>ğŸ”¦ãƒ©ã‚¤ãƒˆ</button>
            <button class="btnY" id="btnAddManual">ï¼‹è¿½åŠ </button>
          </div>
        </div>
      </div>

      <div class="camBox" id="camBox">
        <video id="video" playsinline></video>
      </div>

      <div class="hr"></div>
      <div class="btns">
        <button class="btnY" id="btnQuickAdd">ï¼‹ ä¼ç¥¨ãªã—ã§ã‚‚è¿½åŠ ï¼ˆä»®ç•ªå·ï¼‰</button>
        <button class="btnG" id="btnOpenList">â†’ â‘¢ãƒªã‚¹ãƒˆã¸</button>
      </div>

      <div class="mini" style="margin-top:8px;">
        âœ… è¿½åŠ ã—ãŸã‚‰ <b>å¿…é ˆå…¥åŠ›ï¼ˆåå‰/éƒµä¾¿ç•ªå·/ä½æ‰€/é›»è©±ï¼‰</b> ç”»é¢ãŒå¿…ãšå‡ºã¾ã™ã€‚<br>
        âœ… éƒµä¾¿ç•ªå·â†’ä½æ‰€ã¯è‡ªå‹•å…¥åŠ›ï¼ˆç·¨é›†OKï¼‰ / ãƒ”ãƒ³ã¯è‡ªå‹•ï¼ˆå¤±æ•—æ™‚ã¯ãƒ”ãƒ³ä¿®æ­£ï¼‰
      </div>
    </div>
  </section>

  <!-- â‘¢ LIST -->
  <section id="tab-list" class="card" style="display:none;">
    <h2>â‘¢ ãƒªã‚¹ãƒˆï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—/ä¸¦ã³æ›¿ãˆ/æ¤œç´¢ï¼‰</h2>

    <div class="row four">
      <div>
        <label>æ—¥ä»˜</label>
        <input id="filterDate" type="date">
      </div>
      <div>
        <label>çŠ¶æ…‹</label>
        <select id="filterStatus">
          <option value="">ã™ã¹ã¦</option>
          <option value="out">æŒå‡º</option>
          <option value="created">æœªæŒå‡º</option>
          <option value="done">å®Œäº†</option>
          <option value="absent">ä¸åœ¨</option>
        </select>
      </div>
      <div>
        <label>æ¤œç´¢ï¼ˆä¼ç¥¨/ä½æ‰€/åå‰/é›»è©±/éƒµä¾¿ç•ªå·ï¼‰</label>
        <input id="filterText" type="text" placeholder="ä¾‹ï¼š5300001 / å¤§æ­£åŒº / ç›¸ç”° / 090">
      </div>
      <div>
        <label>æ“ä½œ</label>
        <div class="btns">
          <button class="btnB" id="btnBulkOut">ğŸššæŒå‡ºä¸€æ‹¬</button>
          <button class="btnY" id="btnAutoPins">ğŸ“Œãƒ”ãƒ³è‡ªå‹•ä½œæˆ</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="mini">
      ğŸ‘† ãƒªã‚¹ãƒˆã¯ <b>ãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªå¤‰æ›´</b> ã§ãã¾ã™ã€‚<br>
      ğŸ‘‰ ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦ã¸ï¼‰ã™ã‚‹ã¨ãƒœã‚¿ãƒ³ãŒå‡ºã‚‹ï¼ˆå®Œäº†/ä¸åœ¨/åœ°å›³/å‰Šé™¤ï¼‰
    </div>

    <div class="list" id="listBox"></div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btnG" id="btnExportCSV">CSVå‡ºåŠ›</button>
      <button class="btnG" id="btnExportPDF">PDFå‡ºåŠ›</button>
      <button class="btnR" id="btnClearAll">å…¨å‰Šé™¤</button>
    </div>
  </section>

  <!-- â‘£ MAP -->
  <section id="tab-map" class="card" style="display:none;">
    <h2>â‘£ åœ°å›³ï¼ˆå¸¸ã«ç¾åœ¨åœ°å‘¨è¾ºãƒ»è»½ããƒ»ãƒ”ãƒ³è¦‹ã‚„ã™ã„ï¼‰</h2>
    <div class="row two">
      <div class="warnBox" style="margin-bottom:10px;">
        âœ… ãƒ”ãƒ³ã¯è‡ªå‹•ä½œæˆã—ã¾ã™ï¼ˆä½æ‰€â†’åº§æ¨™ï¼‰ã€‚<br>
        âŒ ç«‹ãŸãªã„å ´åˆã¯ <b>ã€Œãƒ”ãƒ³ä¿®æ­£ã€</b> ã‚’æŠ¼ã—ã¦åœ°å›³ã‚¯ãƒªãƒƒã‚¯/ãƒ‰ãƒ©ãƒƒã‚°ã§ä¿®æ­£ã§ãã¾ã™ã€‚
      </div>
      <div class="btns" style="justify-content:flex-end;">
        <button class="btnB" id="btnMapCenter">ğŸ¯ ç¾åœ¨åœ°ã¸</button>
        <button class="btnY" id="btnMapRefresh">ğŸ”„ ãƒ”ãƒ³æ›´æ–°</button>
      </div>
    </div>

    <div id="map"></div>
    <div class="mini" style="margin-top:10px;">
      â€»é‡ããªã‚‰ãªã„ã‚ˆã†ã«ã€Œè¡¨ç¤ºç¯„å›²ã®ãƒ”ãƒ³ã®ã¿ã€æç”»ã—ã¾ã™ã€‚<br>
      â€»ãƒŠãƒ“ã¯Googleãƒãƒƒãƒ—ã«é£›ã³ã¾ã™ï¼ˆç¾å ´ã§ä¸€ç•ªå®‰å®šï¼‰ã€‚
    </div>
  </section>

  <!-- â‘¤ REPORT -->
  <section id="tab-report" class="card" style="display:none;">
    <h2>â‘¤ æ—¥å ±ï¼ˆPDF/CSVï¼‰</h2>

    <div class="row two">
      <div>
        <label>å¯¾è±¡æ—¥</label>
        <input id="reportDate" type="date">
      </div>
      <div>
        <label>é…é”å“¡åï¼ˆæœªå…¥åŠ›ãªã‚‰ç‚¹å‘¼/é›†è·ã®å€¤ï¼‰</label>
        <input id="reportDriver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸">
      </div>
    </div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btnY" id="btnReportCSV">CSVï¼ˆæ—¥å ±ï¼‰</button>
      <button class="btnB" id="btnReportPDF">PDFï¼ˆæ—¥å ±ï¼‰</button>
    </div>
  </section>

</main>

<!-- MODAL: å¿…é ˆå…¥åŠ› + ãƒ”ãƒ³ä¿®æ­£ -->
<div class="modalBack" id="modalBack" onclick="if(event.target.id==='modalBack') closeModal();">
  <div class="modal">
    <h3 id="mTitle">å¿…é ˆå…¥åŠ›</h3>
    <div class="mini" id="mSub"></div>

    <div class="hr"></div>

    <div class="warnBox" id="reqWarn" style="display:none;">
      âš ï¸ <b>åå‰ / éƒµä¾¿ç•ªå· / ä½æ‰€ / é›»è©±ç•ªå·</b> ã¯å¿…é ˆã§ã™
    </div>

    <div class="row three" style="margin-top:10px;">
      <div>
        <label>ä¼ç¥¨ç•ªå·</label>
        <input id="mCode">
      </div>
      <div>
        <label>è·ç‰©ç¨®åˆ¥</label>
        <input id="mKind" disabled>
      </div>
      <div>
        <label>åå‰ï¼ˆå¿…é ˆï¼‰</label>
        <input id="mName" placeholder="ä¾‹ï¼šç›¸ç”° å¹¸ä¹ƒ">
      </div>
    </div>

    <div class="row three" style="margin-top:10px;">
      <div>
        <label>éƒµä¾¿ç•ªå·ï¼ˆå¿…é ˆï¼‰</label>
        <input id="mZip" inputmode="numeric" placeholder="ä¾‹ï¼š5300001ï¼ˆãƒã‚¤ãƒ•ãƒ³ä¸è¦ï¼‰">
        <div class="btns" style="margin-top:8px;">
          <button class="btnG" id="btnZipFill">ã€’â†’ä½æ‰€è‡ªå‹•</button>
        </div>
      </div>
      <div style="grid-column:span 2;">
        <label>ä½æ‰€ï¼ˆå¿…é ˆï¼‰</label>
        <input id="mAddr" placeholder="ä¾‹ï¼šå¤§é˜ªå¸‚å¤§æ­£åŒºå¹³å°¾4ä¸ç›®17-3 å·å¿ ãƒ“ãƒ«">
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>é›»è©±ç•ªå·ï¼ˆå¿…é ˆï¼‰</label>
        <input id="mPhone" inputmode="tel" placeholder="ä¾‹ï¼š09012345678">
      </div>
      <div>
        <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input id="mMemo" placeholder="ç½®ãé…ãƒ»æ³¨æ„ç‚¹ãªã©">
      </div>
    </div>

    <div class="hr"></div>

    <div class="row two">
      <div>
        <label>ãƒ”ãƒ³ï¼ˆè‡ªå‹•ï¼‰</label>
        <input id="mLatLng" placeholder="ä¾‹ï¼š34.6699,135.4601" disabled>
        <div class="mini" id="mPinNote">è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚å¤±æ•—æ™‚ã¯ã€Œãƒ”ãƒ³ä¿®æ­£ã€</div>
      </div>
      <div class="btns" style="justify-content:flex-end; align-items:flex-end;">
        <button class="btnY" id="btnMakePin">ğŸ“Œ ãƒ”ãƒ³è‡ªå‹•</button>
        <button class="btnB" id="btnFixPin">ğŸ›  ãƒ”ãƒ³ä¿®æ­£</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btnB" id="btnSave">ä¿å­˜</button>
      <button class="btnOK" id="btnOut">æŒå‡º</button>
      <button class="btnOK" id="btnDone">å®Œäº†</button>
      <button class="btnW" id="btnAbsent">ä¸åœ¨</button>
      <button class="btnR" id="btnDel">å‰Šé™¤</button>
      <button class="btnG" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- MODAL: ãƒ”ãƒ³ä¿®æ­£ç”¨ï¼ˆåœ°å›³ã‚¯ãƒªãƒƒã‚¯/ãƒ‰ãƒ©ãƒƒã‚°ï¼‰ -->
<div class="modalBack" id="pinBack" onclick="if(event.target.id==='pinBack') closePinModal();">
  <div class="modal">
    <h3>ãƒ”ãƒ³ä¿®æ­£ï¼ˆåœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ or ãƒ”ãƒ³ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼‰</h3>
    <div class="mini">æ±ºã¾ã£ãŸã‚‰ã€Œã“ã®ä½ç½®ã§ä¿å­˜ã€</div>
    <div class="hr"></div>
    <div id="pinMap" style="height:58vh;border:1px solid var(--line);border-radius:18px;overflow:hidden;"></div>
    <div class="hr"></div>
    <div class="btns">
      <button class="btnB" id="btnPinSave">ã“ã®ä½ç½®ã§ä¿å­˜</button>
      <button class="btnG" onclick="closePinModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* =========================
   Storage
========================= */
const STORE = "ofa_delivery_v5_pop";
const TENKO = "ofa_tenko_v1";
const GEO_CACHE = "ofa_geo_cache_v2"; // addressKey -> {lat,lng}

const STATUS = { created:"æœªæŒå‡º", out:"æŒå‡º", done:"å®Œäº†", absent:"ä¸åœ¨" };
const statusClass = s => ({created:"st-created",out:"st-out",done:"st-done",absent:"st-absent"}[s]||"st-created");

let list = load(STORE, []);
let tenkoLog = load(TENKO, []);
let geoCache = load(GEO_CACHE, {});

function load(k, def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{ return def; } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function nowISO(){
  const d=new Date(); const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}
function pad(n){ return String(n).padStart(2,"0"); }
const today = new Date();
const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
function uid(){ return "S"+Math.random().toString(16).slice(2)+Date.now().toString(16); }
function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.opacity="1";
  clearTimeout(window.__tt);
  window.__tt=setTimeout(()=>t.style.opacity="0",1200);
}

/* =========================
   Tabs
========================= */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const name=btn.dataset.tab;
    document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
    document.getElementById("tab-"+name).style.display="block";

    if(name==="list") renderList();
    if(name==="map"){ ensureMap(); centerToGPS(true); refreshMapPins(true); }
  });
});

/* =========================
   Defaults
========================= */
document.getElementById("tenkoDate").value = todayStr;
document.getElementById("shipDate").value = todayStr;
document.getElementById("filterDate").value = todayStr;
document.getElementById("reportDate").value = todayStr;

/* =========================
   GPS
========================= */
let gps = {lat:null,lng:null};
const gpsState = document.getElementById("gpsState");
document.getElementById("btnGPS").addEventListener("click", getGPS);
function getGPS(){
  if(!navigator.geolocation){ toast("GPSéå¯¾å¿œ"); return; }
  gpsState.textContent="å–å¾—ä¸­â€¦";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gps.lat=pos.coords.latitude;
      gps.lng=pos.coords.longitude;
      gpsState.textContent="OK";
      toast("GPS OK");
      if(map) centerToGPS(false);
    },
    ()=>{ gpsState.textContent="å¤±æ•—"; toast("GPSå¤±æ•—ï¼šè¨±å¯ã‚’ç¢ºèª"); },
    {enableHighAccuracy:true,timeout:12000}
  );
}

/* =========================
   â‘  TENKO
========================= */
document.getElementById("btnTenkoStart").addEventListener("click", ()=>{
  const driver = document.getElementById("tenkoDriver").value.trim();
  if(!driver){ toast("é…é”å“¡åã¯å¿…é ˆ"); return; }
  const rec={
    id:uid(),
    type:"é–‹å§‹",
    at:nowISO(),
    date:document.getElementById("tenkoDate").value||todayStr,
    driver,
    car:document.getElementById("tenkoCar").value.trim(),
    alcohol:document.getElementById("tenkoAlcohol").value.trim(),
    health:document.getElementById("tenkoHealth").value,
    memo:document.getElementById("tenkoMemo").value.trim(),
    gps:(gps.lat&&gps.lng)?`${gps.lat},${gps.lng}`:""
  };
  tenkoLog.unshift(rec);
  save(TENKO, tenkoLog);

  // é›†è·ç”»é¢ã¸åæ˜ 
  document.getElementById("driver").value = driver;
  toast("æ¥­å‹™é–‹å§‹ï¼ˆç‚¹å‘¼OKï¼‰â†’ é›†è·ã¸");
  document.querySelector('[data-tab="pickup"]').click();
});
document.getElementById("btnTenkoEnd").addEventListener("click", ()=>{
  const driver = document.getElementById("tenkoDriver").value.trim();
  if(!driver){ toast("é…é”å“¡åã¯å¿…é ˆ"); return; }
  tenkoLog.unshift({id:uid(),type:"çµ‚äº†",at:nowISO(),date:document.getElementById("tenkoDate").value||todayStr,driver});
  save(TENKO, tenkoLog);
  toast("æ¥­å‹™çµ‚äº†ï¼ˆä¿å­˜ï¼‰");
});

/* =========================
   â‘¡ PICKUP (Scan)
========================= */
const torchState = document.getElementById("torchState");
const pinState = document.getElementById("pinState");
const video = document.getElementById("video");
const camBox = document.getElementById("camBox");
const btnStartScan = document.getElementById("btnStartScan");
const btnStopScan = document.getElementById("btnStopScan");
const btnTorch = document.getElementById("btnTorch");

let stream=null, track=null, torch=false, scanning=false;
const codeReader = new ZXing.BrowserMultiFormatReader();
let lastVal="", lastAt=0;

btnStartScan.addEventListener("click", startScan);
btnStopScan.addEventListener("click", stopScan);
btnTorch.addEventListener("click", toggleTorch);

async function startScan(){
  if(!navigator.mediaDevices?.getUserMedia){ toast("ã‚«ãƒ¡ãƒ©éå¯¾å¿œ"); return; }
  camBox.style.display="block";
  btnStartScan.style.display="none";
  btnStopScan.style.display="inline-block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"}, audio:false });
    video.srcObject=stream;
    await video.play();
    track = stream.getVideoTracks()[0];
    updateTorchSupport();
  }catch(e){
    stopScan();
    toast("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼šHTTPS/è¨±å¯ç¢ºèª");
    return;
  }

  scanning=true;
  toast("SCANä¸­ï¼šä¼ç¥¨ã‚’ã‹ã–ã—ã¦ä¸‹ã•ã„");
  codeReader.decodeFromVideoElement(video, (result, err)=>{
    if(!scanning) return;
    if(result?.text){
      const val=String(result.text).trim();
      const now=Date.now();
      if(val && (val!==lastVal || (now-lastAt)>900)){
        lastVal=val; lastAt=now;
        quickCreateFromCode(val);
      }
    }
  });
}
function stopScan(){
  scanning=false;
  btnStartScan.style.display="inline-block";
  btnStopScan.style.display="none";
  camBox.style.display="none";
  try{ codeReader.reset(); }catch{}
  try{ if(stream) stream.getTracks().forEach(t=>t.stop()); }catch{}
  stream=null; track=null; torch=false;
  btnTorch.disabled=true;
  torchState.textContent="æœªå¯¾å¿œ";
}
function updateTorchSupport(){
  if(!track) return;
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  btnTorch.disabled = !hasTorch;
  torchState.textContent = hasTorch ? "OFF" : "æœªå¯¾å¿œ";
}
async function toggleTorch(){
  if(!track){ toast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã®ã¿"); return; }
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  if(!hasTorch){ toast("ãƒ©ã‚¤ãƒˆéå¯¾å¿œ"); return; }
  torch = !torch;
  try{
    await track.applyConstraints({ advanced:[{ torch }] });
    torchState.textContent = torch ? "ON" : "OFF";
  }catch{ toast("ãƒ©ã‚¤ãƒˆåˆ‡æ›¿å¤±æ•—"); }
}

document.getElementById("btnAddManual").addEventListener("click", ()=>{
  const code=document.getElementById("manualCode").value.trim();
  if(!code){ toast("ä¼ç¥¨ç•ªå·ã‚’å…¥åŠ›"); return; }
  document.getElementById("manualCode").value="";
  quickCreateFromCode(code);
});
document.getElementById("btnQuickAdd").addEventListener("click", ()=>{
  const tmp = "TEMP-"+String(Date.now()).slice(-6);
  quickCreateFromCode(tmp);
});
document.getElementById("btnOpenList").addEventListener("click", ()=> document.querySelector('[data-tab="list"]').click());

function baseFields(){
  return {
    shipDate: document.getElementById("shipDate").value || todayStr,
    driver: document.getElementById("driver").value.trim() || document.getElementById("tenkoDriver").value.trim(),
    kind: document.getElementById("kind").value
  };
}

/* âœ… ç™»éŒ²ã—ãŸã‚‰å¿…ãšã€Œå¿…é ˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã¸ */
function quickCreateFromCode(code){
  const b=baseFields();
  if(!b.driver){ toast("é…é”å“¡åï¼ˆç‚¹å‘¼ or é›†è·ï¼‰å¿…é ˆ"); return; }

  // ä¼ç¥¨é‡è¤‡é˜²æ­¢ï¼ˆåŒæ—¥/åŒã‚³ãƒ¼ãƒ‰ï¼‰
  if(list.some(x=>x.shipDate===b.shipDate && x.code===code)){
    toast("é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
    return;
  }

  const it={
    id:uid(),
    shipDate:b.shipDate,
    driver:b.driver,
    kind:b.kind,
    code:code,

    // å¿…é ˆ
    name:"",
    zip:"",
    address:"",
    phone:"",

    memo:"",
    status:"created",
    lat:null,lng:null,
    createdAt:nowISO(),
    updatedAt:nowISO(),
    history:[{at:nowISO(),action:"é›†è·ç™»éŒ²"}]
  };
  list.unshift(it);
  save(STORE, list);
  toast("è¿½åŠ  â†’ å¿…é ˆå…¥åŠ›ã¸");
  openModal(it.id, true);
}

/* =========================
   Postal: Zip -> Address (ZipCloud)
========================= */
async function zipToAddress(zip){
  const z = String(zip||"").replaceAll("-","").trim();
  if(!/^\d{7}$/.test(z)) return null;
  const url = "https://zipcloud.ibsnet.co.jp/api/search?zipcode="+encodeURIComponent(z);
  const res = await fetch(url);
  if(!res.ok) return null;
  const data = await res.json();
  if(!data || data.status!==200 || !data.results?.length) return null;
  const r = data.results[0];
  // éƒ½é“åºœçœŒ + å¸‚åŒºç”ºæ‘ + ç”ºåŸŸ
  return `${r.address1||""}${r.address2||""}${r.address3||""}`.trim();
}

/* =========================
   Geocode: Address -> LatLng (Nominatim)
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ + å¤±æ•—æ™‚ã¯ãƒ”ãƒ³ä¿®æ­£
========================= */
async function geocode(addressKey){
  const key = addressKey.trim();
  if(!key) return null;
  if(geoCache[key]) return geoCache[key];

  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q="+encodeURIComponent(key);
  const res = await fetch(url, {headers:{Accept:"application/json"}});
  if(!res.ok) return null;
  const data = await res.json();
  if(!data?.length) return null;
  const out = {lat:Number(data[0].lat), lng:Number(data[0].lon)};
  geoCache[key]=out;
  save(GEO_CACHE, geoCache);
  return out;
}

function makeAddressKey(it){
  // éƒµä¾¿ç•ªå· + ä½æ‰€ï¼ˆå»ºç‰©å«ã‚€ï¼‰ã§ç²¾åº¦UP
  const zip = (it.zip||"").replaceAll("-","").trim();
  const addr = (it.address||"").trim();
  return (zip?("ã€’"+zip+" "):"") + addr;
}

/* =========================
   â‘¢ LIST (filters + swipe + reorder)
========================= */
document.getElementById("filterDate").addEventListener("change", renderList);
document.getElementById("filterStatus").addEventListener("change", renderList);
document.getElementById("filterText").addEventListener("input", renderList);

document.getElementById("btnBulkOut").addEventListener("click", ()=>{
  const d=document.getElementById("filterDate").value||todayStr;
  let n=0;
  list.forEach(it=>{
    if(it.shipDate===d && it.status==="created"){
      it.status="out";
      it.updatedAt=nowISO();
      it.history.push({at:nowISO(),action:"æŒå‡ºï¼ˆä¸€æ‹¬ï¼‰"});
      n++;
    }
  });
  save(STORE, list);
  toast(`æŒå‡ºä¸€æ‹¬ï¼š${n}`);
  renderList();
  refreshMapPins(false);
});

document.getElementById("btnAutoPins").addEventListener("click", async ()=>{
  const d=document.getElementById("filterDate").value||todayStr;
  const targets = list.filter(it=>it.shipDate===d && it.address && it.zip && (!it.lat || !it.lng));
  if(!targets.length){ toast("ãƒ”ãƒ³æœªä½œæˆãªã—"); return; }
  toast(`ãƒ”ãƒ³ä½œæˆï¼š${targets.length}ä»¶`);
  let ok=0, ng=0;
  for(const it of targets){
    try{
      const r = await geocode(makeAddressKey(it));
      if(r){ it.lat=r.lat; it.lng=r.lng; ok++; }
      else ng++;
      it.updatedAt=nowISO();
      it.history.push({at:nowISO(),action:"ãƒ”ãƒ³è‡ªå‹•"});
      save(STORE, list);
      // ç„¡æ–™APIå¯¾ç­–
      await new Promise(r=>setTimeout(r, 800));
    }catch{ ng++; }
  }
  pinState.textContent = ok?`OK(${ok})`:`å¤±æ•—(${ng})`;
  toast(`ãƒ”ãƒ³OK:${ok} / å¤±æ•—:${ng}`);
  renderList();
  refreshMapPins(true);
});

function applyFilters(items){
  const d=document.getElementById("filterDate").value||todayStr;
  const st=document.getElementById("filterStatus").value;
  const q=(document.getElementById("filterText").value||"").trim().toLowerCase();
  return items.filter(it=>{
    if(it.shipDate!==d) return false;
    if(st && it.status!==st) return false;
    if(!q) return true;
    const hay = `${it.code} ${it.name} ${it.zip} ${it.address} ${it.phone} ${it.kind}`.toLowerCase();
    return hay.includes(q);
  });
}

let sortable = null;
function renderList(){
  const box=document.getElementById("listBox");
  const filtered=applyFilters(list);

  if(!filtered.length){
    box.innerHTML = `<div class="mini">ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚â‘¡é›†è·ï¼ˆSCANï¼‰ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  box.innerHTML = filtered.map(it=>{
    const need = (!it.name || !it.zip || !it.address || !it.phone);
    const pin = (it.lat && it.lng) ? "ğŸ“" : "ï¼ˆãƒ”ãƒ³æœªï¼‰";
    return `
      <div class="swipe" data-id="${it.id}">
        <div class="swipeBack">
          <button class="btnOK" onclick="setStatus('${it.id}','done')">å®Œäº†</button>
          <button class="btnW" onclick="setStatus('${it.id}','absent')">ä¸åœ¨</button>
          <button class="btnB" onclick="navTo('${it.id}')">ãƒŠãƒ“</button>
          <button class="btnR" onclick="delOne('${it.id}')">å‰Šé™¤</button>
        </div>
        <div class="swipeFront">
          <div class="itemTop">
            <div>
              <b>${esc(it.code)}</b>
              <div class="mini"><span class="badge">${esc(it.kind)}</span> ${esc(it.shipDate)} / ${pin}</div>
            </div>
            <div class="tag ${statusClass(it.status)}">${esc(STATUS[it.status]||it.status)}</div>
          </div>

          <div class="meta">
            åå‰ï¼š${esc(it.name||"ï¼ˆæœªå…¥åŠ›ï¼‰")} ${need?`<span class="danger">â†å¿…é ˆ</span>`:""}<br>
            ã€’ï¼š${esc(it.zip||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
            ä½æ‰€ï¼š${esc(it.address||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
            é›»è©±ï¼š${esc(it.phone||"ï¼ˆæœªå…¥åŠ›ï¼‰")}
          </div>

          <div class="btns" style="margin-top:10px;">
            <button class="btnG" onclick="openModal('${it.id}', true)">è©³ç´°/ä¿®æ­£</button>
            <button class="btnOK" onclick="setStatus('${it.id}','out')">æŒå‡º</button>
            <button class="btnB" onclick="focusPin('${it.id}')">åœ°å›³</button>
          </div>

          <div class="mini" style="margin-top:6px;">â€»å·¦ã¸ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã€Œå®Œäº†/ä¸åœ¨/ãƒŠãƒ“/å‰Šé™¤ã€</div>
        </div>
      </div>
    `;
  }).join("");

  // Swipe handlers
  initSwipe(box);

  // Sortable (ä¸¦ã³æ›¿ãˆï¼šfilteredã®é †ã‚’ã€Œlistã€ã«åæ˜ )
  if(sortable) sortable.destroy();
  sortable = new Sortable(box, {
    animation: 150,
    handle: ".swipeFront",
    onEnd: (evt)=>{
      // boxã®ä¸¦ã³ï¼ˆè¡¨ç¤ºï¼‰ â†’ å®Ÿãƒ‡ãƒ¼ã‚¿ã®é †ã«åæ˜ ï¼ˆå½“æ—¥åˆ†ã ã‘ï¼‰
      const d=document.getElementById("filterDate").value||todayStr;
      const ids=[...box.querySelectorAll(".swipe")].map(x=>x.getAttribute("data-id"));

      const dayItems = list.filter(x=>x.shipDate===d);
      const others = list.filter(x=>x.shipDate!==d);

      // idsé †ã« dayItems ã‚’ä¸¦ã¹æ›¿ãˆï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ï¼‰
      const map = new Map(dayItems.map(x=>[x.id,x]));
      const reordered = ids.map(id=>map.get(id)).filter(Boolean);

      // idsã«å«ã¾ã‚Œã¦ãªã„å½“æ—¥åˆ†ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¤–ï¼‰ã¯æœ«å°¾ç¶­æŒ
      const rest = dayItems.filter(x=>!ids.includes(x.id));

      list = [...reordered, ...rest, ...others];
      save(STORE, list);
      toast("é †ç•ªã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }
  });
}

function initSwipe(container){
  container.querySelectorAll(".swipeFront").forEach(front=>{
    let startX=0, currentX=0, open=false;
    const max = 210; // reveal width
    front.addEventListener("touchstart",(e)=>{
      startX = e.touches[0].clientX;
      currentX = 0;
    },{passive:true});
    front.addEventListener("touchmove",(e)=>{
      const dx = e.touches[0].clientX - startX;
      // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ã ã‘
      currentX = Math.max(-max, Math.min(0, dx));
      front.style.transform = `translateX(${currentX}px)`;
    },{passive:true});
    front.addEventListener("touchend",()=>{
      if(currentX < -70){ open=true; front.style.transform=`translateX(${-max}px)`; }
      else { open=false; front.style.transform=`translateX(0px)`; }
    });
    // ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
    front.addEventListener("click", ()=>{
      if(open){ open=false; front.style.transform="translateX(0px)"; }
    });
  });
}

/* =========================
   Modal (å¿…é ˆå…¥åŠ›)
========================= */
let modalId=null;

const modalBack=document.getElementById("modalBack");
const reqWarn=document.getElementById("reqWarn");

document.getElementById("btnZipFill").addEventListener("click", async ()=>{
  const zip=document.getElementById("mZip").value.trim();
  const addr=await zipToAddress(zip);
  if(!addr){ toast("éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
  // ä½æ‰€ã¯è‡ªå‹•ã§ã€Œéƒ½é“åºœçœŒ+å¸‚åŒºç”ºæ‘+ç”ºåŸŸã€â†’ å»ºç‰©ã¯è¿½è¨˜ã—ã¦ã‚‚ã‚‰ã†
  if(!document.getElementById("mAddr").value.trim()){
    document.getElementById("mAddr").value = addr;
  }else{
    // æ—¢ã«ã‚ã‚‹å ´åˆã¯å…ˆé ­ã«å…¥ã‚Œæ›¿ãˆææ¡ˆ
    toast("ä½æ‰€ï¼ˆéƒ½é“åºœçœŒç­‰ï¼‰ã‚’è£œå®Œã—ã¾ã—ãŸ");
  }
});

document.getElementById("btnMakePin").addEventListener("click", async ()=>{
  const it = getIt(modalId); if(!it) return;
  await autoPin(it, true);
});

document.getElementById("btnFixPin").addEventListener("click", ()=>{
  const it = getIt(modalId); if(!it) return;
  openPinModal(it);
});

document.getElementById("btnSave").addEventListener("click", ()=> saveModalOnly());
document.getElementById("btnOut").addEventListener("click", ()=> setStatus(modalId,"out",true));
document.getElementById("btnDone").addEventListener("click", ()=> setStatus(modalId,"done",true));
document.getElementById("btnAbsent").addEventListener("click", ()=> setStatus(modalId,"absent",true));
document.getElementById("btnDel").addEventListener("click", ()=> delOne(modalId,true));

function getIt(id){ return list.find(x=>x.id===id); }

window.openModal = function(id, force){
  modalId=id;
  const it=getIt(id); if(!it) return;
  document.getElementById("mTitle").textContent="å¿…é ˆå…¥åŠ›ï¼ˆç™»éŒ²å®Œäº†ã¾ã§ï¼‰";
  document.getElementById("mSub").textContent = `${it.shipDate} / ${it.kind} / ${it.code}`;

  document.getElementById("mCode").value = it.code||"";
  document.getElementById("mKind").value = it.kind||"";
  document.getElementById("mName").value = it.name||"";
  document.getElementById("mZip").value  = it.zip||"";
  document.getElementById("mAddr").value = it.address||"";
  document.getElementById("mPhone").value= it.phone||"";
  document.getElementById("mMemo").value = it.memo||"";
  document.getElementById("mLatLng").value = (it.lat&&it.lng)?`${it.lat},${it.lng}`:"";

  reqWarn.style.display="none";
  modalBack.style.display="flex";
};

window.closeModal = function(){
  modalBack.style.display="none";
  modalId=null;
};

function validateRequired(){
  const name=document.getElementById("mName").value.trim();
  const zip=document.getElementById("mZip").value.replaceAll("-","").trim();
  const addr=document.getElementById("mAddr").value.trim();
  const phone=document.getElementById("mPhone").value.trim();
  return (name && /^\d{7}$/.test(zip) && addr && phone);
}

async function saveModalOnly(){
  const it=getIt(modalId); if(!it) return;

  it.code = document.getElementById("mCode").value.trim() || it.code;
  it.name = document.getElementById("mName").value.trim();
  it.zip  = document.getElementById("mZip").value.replaceAll("-","").trim();
  it.address = document.getElementById("mAddr").value.trim();
  it.phone = document.getElementById("mPhone").value.trim();
  it.memo  = document.getElementById("mMemo").value.trim();

  it.updatedAt=nowISO();
  it.history.push({at:nowISO(),action:"æƒ…å ±æ›´æ–°"});
  save(STORE, list);

  // å¿…é ˆãŒæƒã£ã¦ãŸã‚‰ãƒ”ãƒ³è‡ªå‹•ï¼ˆæ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«è£ã§ï¼‰
  if(validateRequired() && (!it.lat || !it.lng)){
    autoPin(it, false);
  }

  toast("ä¿å­˜ã—ã¾ã—ãŸ");
  closeModal();
  renderList();
  refreshMapPins(false);
}

async function autoPin(it, showToast){
  // å¿…é ˆæƒã£ã¦ãªã„ãªã‚‰ç„¡ç†
  if(!(it.zip && it.address)){
    if(showToast) toast("éƒµä¾¿ç•ªå·/ä½æ‰€ãŒå¿…è¦");
    return;
  }
  const key = makeAddressKey(it);
  if(showToast) toast("ãƒ”ãƒ³ä½œæˆä¸­â€¦");

  const r = await geocode(key);
  if(!r){
    pinState.textContent="å¤±æ•—";
    if(showToast) toast("è‡ªå‹•ãƒ”ãƒ³å¤±æ•— â†’ ãƒ”ãƒ³ä¿®æ­£ã¸");
    // ãƒ”ãƒ³ä¿®æ­£ã¸èª˜å°
    openPinModal(it);
    return;
  }
  it.lat=r.lat; it.lng=r.lng;
  it.updatedAt=nowISO();
  it.history.push({at:nowISO(),action:"ãƒ”ãƒ³è‡ªå‹•"});
  save(STORE, list);

  document.getElementById("mLatLng").value = `${it.lat},${it.lng}`;
  pinState.textContent="OK";
  refreshMapPins(false);
  if(showToast) toast("ãƒ”ãƒ³OK");
}

async function setStatus(id, st, fromModal){
  const it=getIt(id); if(!it) return;

  // çŠ¶æ…‹å¤‰æ›´å‰ã«å¿…é ˆãƒã‚§ãƒƒã‚¯
  // ï¼ˆç¾å ´ã§ã€Œå®Œäº†/ä¸åœ¨ã€ã‚’æŠ¼ã™å‰ã«æ¼ã‚ŒãŒã‚ã‚‹ã¨äº‹æ•…ã‚‹ã®ã§ï¼‰
  if(!(it.name && it.zip && it.address && it.phone)){
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å¿…é ˆå…¥åŠ›ã•ã›ã‚‹
    openModal(it.id, true);
    reqWarn.style.display="block";
    toast("å¿…é ˆå…¥åŠ›ãŒä¸è¶³");
    return;
  }
  if(!it.lat || !it.lng){
    // ãƒ”ãƒ³ã¯ã€Œåœ°å›³ã€ç”¨é€”ã®ãŸã‚ã€æœªä½œæˆãªã‚‰ä½œã‚Šã«è¡Œãï¼ˆå¤±æ•—æ™‚ã¯æ‰‹å‹•ï¼‰
    await autoPin(it, true);
  }

  it.status=st;
  it.updatedAt=nowISO();
  it.history.push({at:nowISO(),action:STATUS[st]||st});
  save(STORE, list);

  if(fromModal) closeModal();
  renderList();
  refreshMapPins(false);
  toast(`${STATUS[st]||st}ï¼š${it.code}`);
}

window.delOne = function(id, fromModal){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  list=list.filter(x=>x.id!==id);
  save(STORE, list);
  if(fromModal) closeModal();
  renderList();
  refreshMapPins(false);
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
};

/* =========================
   Navigation (Google Maps)
========================= */
window.navTo = function(id){
  const it=getIt(id); if(!it) return;
  if(!it.address){ toast("ä½æ‰€ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  const dest=encodeURIComponent(it.address);
  const origin=(gps.lat&&gps.lng)?`${gps.lat},${gps.lng}`:"";
  const url = origin
    ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&travelmode=driving`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;
  window.open(url,"_blank");
};

/* =========================
   â‘£ MAP (fast / current area)
========================= */
let map=null, markers=new Map(), gpsMarker=null;
document.getElementById("btnMapCenter").addEventListener("click", ()=>{ if(!gps.lat) getGPS(); setTimeout(()=>centerToGPS(true), 900); });
document.getElementById("btnMapRefresh").addEventListener("click", ()=>refreshMapPins(true));

function ensureMap(){
  if(map) return;
  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }).addTo(map);
  // åˆæœŸï¼šå¤§é˜ª
  map.setView([34.6937,135.5023], 13);

  // ç”»é¢ç§»å‹•ã—ãŸã‚‰ç¯„å›²å†…ãƒ”ãƒ³ã ã‘æç”»
  map.on("moveend", ()=> refreshMapPins(false));
}

function centerToGPS(forceZoom){
  if(!map) return;
  if(gps.lat && gps.lng){
    map.setView([gps.lat,gps.lng], forceZoom?15:map.getZoom());
    if(!gpsMarker){
      gpsMarker = L.circleMarker([gps.lat,gps.lng], {radius:8}).addTo(map).bindPopup("ç¾åœ¨åœ°");
    }else{
      gpsMarker.setLatLng([gps.lat,gps.lng]);
    }
  }
}

function withinBounds(lat,lng,b){
  return b.contains([lat,lng]);
}

function refreshMapPins(recenter){
  if(!map) return;

  const d=document.getElementById("filterDate").value||todayStr;
  const bounds = map.getBounds();

  // å½“æ—¥åˆ†ã§ãƒ”ãƒ³ã‚ã‚Šã®ã¿
  const items = list.filter(it=>it.shipDate===d && it.lat && it.lng);

  // ç¯„å›²å†…ã ã‘æç”»ï¼ˆé‡ããªã‚‰ãªã„ï¼‰
  const inView = items.filter(it=>withinBounds(it.lat,it.lng,bounds));

  // remove old markers not needed
  for(const [id,m] of markers.entries()){
    if(!inView.find(x=>x.id===id)){
      map.removeLayer(m);
      markers.delete(id);
    }
  }

  // add/update in small batches (å›ºã¾ã‚‰ãªã„)
  let i=0;
  const batch = ()=>{
    const slice=inView.slice(i, i+20);
    slice.forEach(it=>{
      const popup = `
        <b>${esc(it.code)}</b><br>
        ${esc(it.name)}<br>
        ã€’${esc(it.zip)}<br>
        ${esc(it.address)}<br>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button onclick="openModal('${it.id}', true)" style="padding:8px 10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:900;cursor:pointer;">é–‹ã</button>
          <button onclick="setStatus('${it.id}','done')" style="padding:8px 10px;border-radius:12px;border:0;background:#10b981;color:#fff;font-weight:900;cursor:pointer;">å®Œäº†</button>
          <button onclick="setStatus('${it.id}','absent')" style="padding:8px 10px;border-radius:12px;border:0;background:#f59e0b;color:#111;font-weight:900;cursor:pointer;">ä¸åœ¨</button>
          <button onclick="navTo('${it.id}')" style="padding:8px 10px;border-radius:12px;border:0;background:#1565C0;color:#fff;font-weight:900;cursor:pointer;">ãƒŠãƒ“</button>
        </div>
      `;
      if(!markers.has(it.id)){
        const m = L.marker([it.lat,it.lng]).addTo(map).bindPopup(popup);
        markers.set(it.id, m);
      }else{
        markers.get(it.id).setLatLng([it.lat,it.lng]).setPopupContent(popup);
      }
    });
    i+=20;
    if(i<inView.length) requestAnimationFrame(batch);
  };
  requestAnimationFrame(batch);

  // pin state label
  const okCount = items.length;
  pinState.textContent = okCount ? `OK(${okCount})` : "æœªä½œæˆ";

  // recenter to GPS on first open
  if(recenter){
    if(gps.lat && gps.lng) centerToGPS(true);
  }
}

window.focusPin = function(id){
  const it=getIt(id); if(!it) return;
  document.querySelector('[data-tab="map"]').click();
  setTimeout(()=>{
    if(it.lat && it.lng){
      map.setView([it.lat,it.lng], 17);
      const m = markers.get(it.id);
      if(m) m.openPopup();
    }else{
      toast("ãƒ”ãƒ³æœªä½œæˆï¼šè©³ç´°â†’ãƒ”ãƒ³è‡ªå‹•/ä¿®æ­£");
      openModal(it.id, true);
    }
  }, 200);
};

/* =========================
   Pin Fix Modal
========================= */
let pinMap=null, pinMarker=null, pinTargetId=null;

function openPinModal(it){
  pinTargetId = it.id;
  document.getElementById("pinBack").style.display="flex";

  setTimeout(()=>{
    if(!pinMap){
      pinMap = L.map("pinMap", { zoomControl:true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }).addTo(pinMap);
      pinMap.on("click",(e)=>{
        if(pinMarker) pinMarker.setLatLng(e.latlng);
        else pinMarker = L.marker(e.latlng,{draggable:true}).addTo(pinMap);
      });
    }
    pinMap.invalidateSize();

    // åˆæœŸä½ç½®ï¼šæ—¢å­˜ãƒ”ãƒ³â†’ä½æ‰€ä»˜è¿‘ï¼ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœï¼‰â†’ç¾åœ¨åœ°â†’å¤§é˜ª
    let latlng=null;
    if(it.lat && it.lng) latlng = [it.lat,it.lng];
    else if(gps.lat && gps.lng) latlng = [gps.lat,gps.lng];
    else latlng = [34.6937,135.5023];

    pinMap.setView(latlng, 16);
    if(pinMarker) pinMap.removeLayer(pinMarker);
    pinMarker = L.marker(latlng, {draggable:true}).addTo(pinMap);
  }, 120);
}

function closePinModal(){
  document.getElementById("pinBack").style.display="none";
  pinTargetId=null;
}
document.getElementById("btnPinSave").addEventListener("click", ()=>{
  if(!pinTargetId || !pinMarker) return;
  const it=getIt(pinTargetId); if(!it) return;
  const ll=pinMarker.getLatLng();
  it.lat=ll.lat; it.lng=ll.lng;
  it.updatedAt=nowISO();
  it.history.push({at:nowISO(),action:"ãƒ”ãƒ³æ‰‹å‹•ä¿®æ­£"});
  save(STORE, list);

  // å¿…é ˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚åæ˜ 
  if(modalId===it.id){
    document.getElementById("mLatLng").value = `${it.lat},${it.lng}`;
  }
  closePinModal();
  refreshMapPins(false);
  toast("ãƒ”ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

/* =========================
   Exports (CSV/PDF)
========================= */
document.getElementById("btnExportCSV").addEventListener("click", ()=>{
  const d=document.getElementById("filterDate").value||todayStr;
  const items=list.filter(it=>it.shipDate===d);
  const header=["æ—¥ä»˜","é…é”å“¡","ç¨®åˆ¥","ä¼ç¥¨","åå‰","éƒµä¾¿ç•ªå·","ä½æ‰€","é›»è©±","çŠ¶æ…‹","lat","lng","ãƒ¡ãƒ¢","æ›´æ–°"];
  const rows=items.map(it=>[
    it.shipDate,it.driver,it.kind,it.code,it.name,it.zip,it.address,it.phone,STATUS[it.status]||it.status,
    it.lat||"",it.lng||"",it.memo||"",it.updatedAt||""
  ]);
  downloadCSV([header,...rows], `OFA_é…é”_${d}.csv`);
});
document.getElementById("btnExportPDF").addEventListener("click", ()=>{
  const d=document.getElementById("filterDate").value||todayStr;
  const items=list.filter(it=>it.shipDate===d);
  exportPDF(`OFA é…é”ãƒªã‚¹ãƒˆ ${d}`, items, `OFA_é…é”_${d}.pdf`);
});
document.getElementById("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå¾©å…ƒã§ãã¾ã›ã‚“")) return;
  list=[];
  save(STORE, list);
  renderList();
  refreshMapPins(true);
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
});

function downloadCSV(table, filename){
  const escv=v=> `"${String(v??"").replaceAll('"','""')}"`;
  const csv = table.map(r=>r.map(escv).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}
function exportPDF(title, items, filename){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});
  doc.setFontSize(14);
  doc.text(title, 14, 14);
  doc.setFontSize(10);
  doc.text(`å‡ºåŠ›ï¼š${nowISO()}`, 14, 20);

  const head=[["ç¨®åˆ¥","ä¼ç¥¨","åå‰","ã€’","ä½æ‰€","é›»è©±","çŠ¶æ…‹"]];
  const body=items.map(it=>[
    it.kind||"", it.code||"", it.name||"", it.zip||"", it.address||"", it.phone||"", STATUS[it.status]||it.status
  ]);
  doc.autoTable({ startY: 24, head, body, styles:{fontSize:9, cellPadding:2}, theme:"grid" });
  doc.save(filename);
}

/* =========================
   â‘¤ REPORT
========================= */
document.getElementById("btnReportCSV").addEventListener("click", ()=>{
  const d=document.getElementById("reportDate").value||todayStr;
  const driver=(document.getElementById("reportDriver").value.trim() || document.getElementById("driver").value.trim() || document.getElementById("tenkoDriver").value.trim());
  const items=list.filter(it=>it.shipDate===d && (!driver || it.driver===driver));

  const header=["æ—¥ä»˜","é…é”å“¡","åˆè¨ˆ","æŒå‡º","å®Œäº†","ä¸åœ¨"];
  const total=items.length;
  const out=items.filter(x=>x.status==="out").length;
  const done=items.filter(x=>x.status==="done").length;
  const abs=items.filter(x=>x.status==="absent").length;
  downloadCSV([header,[d,driver||"",total,out,done,abs]], `OFA_æ—¥å ±_${d}.csv`);
});
document.getElementById("btnReportPDF").addEventListener("click", ()=>{
  const d=document.getElementById("reportDate").value||todayStr;
  const driver=(document.getElementById("reportDriver").value.trim() || document.getElementById("driver").value.trim() || document.getElementById("tenkoDriver").value.trim());
  const items=list.filter(it=>it.shipDate===d && (!driver || it.driver===driver));
  exportPDF(`OFA æ—¥å ± ${d} ${driver||""}`, items, `OFA_æ—¥å ±_${d}.pdf`);
});

/* =========================
   Start state
========================= */
renderList();
</script>
</body>
</html>
