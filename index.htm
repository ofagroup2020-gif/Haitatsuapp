<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- âœ… iPhoneå¯¾å¿œ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆZXingï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- âœ… OCRï¼ˆTesseract.jsï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<style>
  :root{
    --ofa-yellow:#FFD400;
    --ofa-red:#E53935;
    --ofa-blue:#1565C0;

    --bg:#F5F7FB;
    --card:#fff;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e2e8f0;
    --shadow:0 12px 34px rgba(15,23,42,.10);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1000px 500px at 10% -10%, rgba(255,212,0,.35), transparent 60%),
      radial-gradient(900px 480px at 100% 0%, rgba(21,101,192,.18), transparent 60%),
      radial-gradient(900px 480px at 70% 110%, rgba(229,57,53,.10), transparent 60%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,.90);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .top{
    max-width:1100px; margin:0 auto;
    padding:12px 14px 8px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .logo{
    width:42px;height:42px;border-radius:14px;
    background:linear-gradient(135deg,var(--ofa-yellow),#fff2a8);
    display:grid; place-items:center;
    font-weight:900;
    box-shadow:0 12px 26px rgba(255,212,0,.25);
  }
  .ttl b{display:block; font-size:14px}
  .ttl small{display:block; color:var(--muted); font-size:11px; margin-top:2px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-size:12px; color:var(--muted);
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    white-space:nowrap;
  }
  .chip b{color:var(--ink)}
  nav{
    max-width:1100px; margin:0 auto;
    padding:0 14px 12px;
    display:flex; gap:10px;
  }
  .tab{
    flex:1;
    padding:12px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900;
    font-size:12px;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    cursor:pointer;
  }
  .tab.active{
    background:linear-gradient(135deg, rgba(21,101,192,.10), rgba(255,212,0,.18));
    border-color:rgba(21,101,192,.25);
  }

  main{max-width:1100px; margin:0 auto; padding:12px 14px 18px; display:grid; gap:12px;}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r);
    padding:14px;
    box-shadow:var(--shadow);
  }
  .card h2{margin:0 0 10px; font-size:14px}
  .row{display:grid; gap:10px}
  @media(min-width:820px){
    .row.two{grid-template-columns: 1fr 1fr;}
    .row.three{grid-template-columns: 1fr 1fr 1fr;}
  }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, textarea{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  textarea{min-height:86px; resize:vertical}
  .btns{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:16px;
    padding:12px 12px;
    font-weight:900;
    cursor:pointer;
    font-size:13px;
  }
  .btn-primary{background:linear-gradient(135deg,var(--ofa-yellow),#ffe77a); color:#111;}
  .btn-blue{background:linear-gradient(135deg, rgba(21,101,192,.95), rgba(21,101,192,.75)); color:#fff;}
  .btn-ghost{background:#fff; border:1px solid var(--line); color:var(--ink);}
  .btn-ok{background:rgba(16,185,129,.10); border:1px solid rgba(16,185,129,.25); color:#065f46;}
  .btn-warn{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.25); color:#7c2d12;}
  .btn-bad{background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.25); color:#7f1d1d;}
  .mini{color:var(--muted); font-size:11px; line-height:1.6}
  .hr{height:1px; background:var(--line); margin:12px 0}

  /* Scanner */
  .scanWrap{
    border:1px dashed rgba(21,101,192,.28);
    background:linear-gradient(135deg, rgba(21,101,192,.05), rgba(255,212,0,.12));
    border-radius:18px;
    padding:12px;
  }
  .camBox{
    display:none;
    margin-top:10px;
    overflow:hidden;
    border-radius:16px;
    border:1px solid var(--line);
    background:#000;
  }
  video{width:100%; height:auto; display:block;}

  /* Kind buttons (ç¾å ´ãƒ¢ãƒ¼ãƒ‰) */
  .kindBar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .kindBtn{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .kindBtn.active{
    background:linear-gradient(135deg, rgba(255,212,0,.35), rgba(21,101,192,.10));
    border-color:rgba(255,212,0,.55);
  }

  /* List */
  .toolbar{
    display:flex; flex-wrap:wrap; gap:10px;
    align-items:flex-end; justify-content:space-between;
  }
  .kpis{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
  .kpi{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px 12px;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    min-width:130px;
  }
  .kpi small{display:block; color:var(--muted); font-size:11px}
  .kpi b{display:block; font-size:18px; margin-top:2px}

  .list{display:grid; gap:10px; margin-top:12px}
  .item{
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    background:#fff;
  }
  .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
  .tag{
    font-weight:900; font-size:11px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--line);
    white-space:nowrap;
  }
  .st-created{background:#f9fafb; color:var(--muted)}
  .st-out{background:rgba(21,101,192,.10); border-color:rgba(21,101,192,.22); color:#0b3a7a}
  .st-done{background:rgba(16,185,129,.10); border-color:rgba(16,185,129,.22); color:#065f46}
  .st-absent{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25); color:#7c2d12}
  .st-post{background:rgba(99,102,241,.10); border-color:rgba(99,102,241,.22); color:#3730a3}
  .st-return{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.22); color:#7f1d1d}

  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#f8fafc;
    font-weight:900;
    font-size:12px;
    margin-right:8px;
  }
  .meta{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.55}
  .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
  .btn-mini{padding:10px 10px; border-radius:14px; font-size:12px;}

  /* Modal */
  .modalBack{
    position:fixed; inset:0; z-index:9990;
    background:rgba(15,23,42,.40);
    display:none;
    align-items:flex-end;
    justify-content:center;
  }
  .modal{
    width:min(980px, 100%);
    background:#fff;
    border-top-left-radius:22px;
    border-top-right-radius:22px;
    border:1px solid var(--line);
    box-shadow:0 20px 60px rgba(0,0,0,.22);
    padding:14px;
    max-height:88vh;
    overflow:auto;
  }
  .modal h3{margin:0 0 10px; font-size:14px}
  .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .pill{
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900; font-size:12px;
    cursor:pointer;
  }
  .pill.active{background:linear-gradient(135deg, rgba(255,212,0,.30), rgba(21,101,192,.10)); border-color:rgba(255,212,0,.55)}
  .progress{
    height:10px; border-radius:999px; border:1px solid var(--line);
    background:#f8fafc; overflow:hidden;
  }
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--ofa-yellow), var(--ofa-blue));}
</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div class="ttl">
        <b>é…é”ã‚¢ãƒ—ãƒªï¼ˆç¾å ´ä»•æ§˜ï¼‰</b>
        <small>SCAN â†’ ãƒªã‚¹ãƒˆ â†’ ãƒŠãƒ“ â†’ å®Œäº†/ä¸åœ¨/æŠ•å‡½ â†’ æ—¥å ±</small>
      </div>
    </div>
    <div class="chips">
      <div class="chip">GPSï¼š<b id="gpsState">æœªå–å¾—</b></div>
      <div class="chip">ãƒ©ã‚¤ãƒˆï¼š<b id="torchState">æœªå¯¾å¿œ</b></div>
      <div class="chip">ãƒ¢ãƒ¼ãƒ‰ï¼š<b id="modeState">ç¾å ´</b></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="list">ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="report">æ—¥å ±</button>
  </nav>
</header>

<main>

  <!-- SCAN -->
  <section id="tab-scan" class="card">
    <h2>â‘  SCANï¼ˆ100å€‹ã§ã‚‚æ­¢ã¾ã‚‰ãªã„ï¼‰</h2>

    <div class="scanWrap">
      <div class="row three">
        <div>
          <label>é…é”æ—¥</label>
          <input id="shipDate" type="date" />
        </div>
        <div>
          <label>é…é”å“¡å</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸" />
        </div>
        <div>
          <label>å–å¼•å…ˆï¼ˆä»»æ„ï¼‰</label>
          <input id="client" type="text" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆ / ä½å· / Amazonâ€¦" />
        </div>
      </div>

      <div class="hr"></div>

      <!-- ç¾å ´ï¼šç¨®åˆ¥ãƒ¯ãƒ³ã‚¿ãƒƒãƒ— -->
      <div>
        <div class="mini"><b>è·ç‰©ç¨®åˆ¥ï¼ˆæ¬¡ã«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹è·ç‰©ã¸è‡ªå‹•ä»˜ä¸ï¼‰</b></div>
        <div class="kindBar" id="kindBar"></div>
        <div class="mini" style="margin-top:6px;">â€»æ‰‹ç´™/æŠ•å‡½ç³»ã¯ã€ŒæŠ•å‡½å®Œäº†ã€ãƒœã‚¿ãƒ³ã«ãªã‚Šã¾ã™ã€‚</div>
      </div>

      <!-- ç®¡ç†ï¼šè©³ç´°å…¥åŠ›ï¼ˆç¾å ´ãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼‰ -->
      <div id="adminFields" style="display:none; margin-top:10px;">
        <div class="row two">
          <div>
            <label>ä½æ‰€ï¼ˆä»»æ„ï¼šãƒŠãƒ“ç”¨ï¼‰</label>
            <input id="address" type="text" placeholder="ä¾‹ï¼šé¹¿å…å³¶å¸‚ã€‡ã€‡â€¦" />
          </div>
          <div>
            <label>é›»è©±ï¼ˆä»»æ„ï¼‰</label>
            <input id="phone" type="tel" placeholder="ä¾‹ï¼š090â€¦" />
          </div>
        </div>
        <div style="margin-top:10px;">
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="memo" placeholder="ç½®ãé…ãƒ»æ™‚é–“æŒ‡å®šãªã©"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <!-- ã‚¹ã‚­ãƒ£ãƒ³/æ‰‹å…¥åŠ›/OCR -->
      <div class="row two">
        <div>
          <label>æ‰‹å…¥åŠ›ï¼ˆèª­ã‚ãªã„æ™‚ï¼šã™ãè¿½åŠ ï¼‰</label>
          <input id="manualCode" type="text" inputmode="numeric" placeholder="ä¼ç¥¨ç•ªå· or ä»»æ„ã‚³ãƒ¼ãƒ‰ â†’ è¿½åŠ " />
          <div class="mini" style="margin-top:6px;">
            ä¾‹ï¼šãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç„¡ã—ã®æ‰‹ç´™ã¯ç©ºã§ã‚‚OKï¼ˆè‡ªå‹•ã§TEMPæ¡ç•ªï¼‰ã€‚
          </div>
        </div>
        <div>
          <label>ç°¡æ˜“æ“ä½œ</label>
          <div class="btns">
            <button class="btn-blue" id="btnGPS">ğŸ“GPS</button>
            <button class="btn-primary" id="btnStartScan">ğŸ“·SCANé–‹å§‹</button>
            <button class="btn-ghost" id="btnStopScan" style="display:none;">åœæ­¢</button>
            <button class="btn-ghost" id="btnTorch" disabled>ğŸ”¦ãƒ©ã‚¤ãƒˆ</button>
            <button class="btn-ghost" id="btnToggleMode">ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
          </div>
        </div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button class="btn-ghost" id="btnAddManual">ï¼‹æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
        <button class="btn-ghost" id="btnTemp">ï¼‹èª­ã‚ãªã„â†’ä»®ç™»éŒ²ï¼ˆTEMPï¼‰</button>
      </div>

      <div class="camBox" id="camBox">
        <video id="video" playsinline></video>
      </div>

      <div class="mini" style="margin-top:10px;">
        âœ… é›†è·/æŒå‡ºã¯ã€ŒSCANã§æµã™ã ã‘ã€ã€‚ä½æ‰€ã‚„ãƒ¡ãƒ¢ã¯é…é”ä¸­ã«å¿…è¦ãªã‚‚ã®ã ã‘è¿½åŠ ã™ã‚Œã°OKã€‚
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section id="tab-list" class="card" style="display:none;">
    <h2>â‘¡ ãƒªã‚¹ãƒˆï¼ˆæœªå®Œâ†’æ¬¡ã¸ï¼‰</h2>

    <div class="toolbar">
      <div class="row three" style="margin:0; min-width:min(860px,100%);">
        <div>
          <label>æ—¥ä»˜</label>
          <input id="filterDate" type="date" />
        </div>
        <div>
          <label>çŠ¶æ…‹</label>
          <select id="filterStatus">
            <option value="created">æœªæŒå‡º</option>
            <option value="out">æŒå‡º</option>
            <option value="done">å®Œäº†</option>
            <option value="absent">ä¸åœ¨</option>
            <option value="post">æŠ•å‡½</option>
            <option value="return">è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div>
          <label>æ¤œç´¢ï¼ˆç•ªå·/ä½æ‰€/ç¨®åˆ¥/å–å¼•å…ˆï¼‰</label>
          <input id="filterText" type="text" placeholder="ä¾‹ï¼šæ‰‹ç´™ / å†·è”µ / é¹¿å…å³¶ / 1234" />
        </div>
      </div>

      <div class="btns">
        <button class="btn-primary btn-mini" id="btnBulkOut">ğŸššæŒå‡ºä¸€æ‹¬</button>
        <button class="btn-ghost btn-mini" id="btnNext">â–¶æ¬¡ã®æœªå®Œã¸</button>
      </div>
    </div>

    <div class="kpis" id="kpis"></div>
    <div class="list" id="historyList"></div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btn-ghost" id="btnExportCSV">CSVå‡ºåŠ›</button>
      <button class="btn-ghost" id="btnExportPDF">PDFå‡ºåŠ›</button>
      <button class="btn-bad" id="btnClearAll">å…¨å‰Šé™¤ï¼ˆæ³¨æ„ï¼‰</button>
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="card" style="display:none;">
    <h2>â‘¢ æ—¥å ±ï¼ˆPDF/CSVï¼‰</h2>

    <div class="row two">
      <div>
        <label>å¯¾è±¡æ—¥</label>
        <input id="reportDate" type="date" />
      </div>
      <div>
        <label>é…é”å“¡åï¼ˆå°å­—ï¼‰</label>
        <input id="reportDriver" type="text" placeholder="æœªå…¥åŠ›ãªã‚‰SCANã®é…é”å“¡å" />
      </div>
    </div>

    <div class="kpis" id="reportKpis"></div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btn-primary" id="btnReportCSV">CSVå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
      <button class="btn-primary" id="btnReportPDF">PDFå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
    </div>

    <div class="mini" style="margin-top:10px;">
      â€»ä¼šç¤¾å…±æœ‰ã¯ã€ã¾ãšã“ã®PDF/CSVã‚’LINEã§é€ã‚‹é‹ç”¨ãŒæœ€é€Ÿã§ã™ï¼ˆæ¬¡æ®µéšã§ç®¡ç†ç”»é¢åŒ–ã§ãã¾ã™ï¼‰ã€‚
    </div>
  </section>

</main>

<!-- DETAIL / OCR Modal -->
<div class="modalBack" id="modalBack" onclick="if(event.target.id==='modalBack') closeModal();">
  <div class="modal">
    <h3 id="modalTitle">è©³ç´°</h3>
    <div class="mini" id="modalSub"></div>

    <div class="hr"></div>

    <div class="row two">
      <div>
        <label>è·ç‰©ã‚³ãƒ¼ãƒ‰ï¼ˆä¼ç¥¨/ç®¡ç†ç•ªå·ï¼‰</label>
        <input id="mCode" />
      </div>
      <div>
        <label>è·ç‰©ç¨®åˆ¥</label>
        <select id="mKind"></select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>ä½æ‰€ï¼ˆãƒŠãƒ“ç”¨ï¼‰</label>
        <input id="mAddress" placeholder="OCR/æ‰‹å…¥åŠ›ã§OK" />
      </div>
      <div>
        <label>é›»è©±ï¼ˆä»»æ„ï¼‰</label>
        <input id="mPhone" placeholder="090â€¦" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>ãƒ¡ãƒ¢</label>
      <textarea id="mMemo" placeholder="ç½®ãé…ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
    </div>

    <div class="hr"></div>

    <div>
      <div class="mini"><b>è©³ç´°ã‚¿ã‚°ï¼ˆä»»æ„ï¼šè¤‡æ•°ï¼‰</b></div>
      <div class="pillRow" id="tagPills"></div>
    </div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-blue" onclick="navFromModal()">ğŸ—º ãƒŠãƒ“</button>
      <button class="btn-ghost" onclick="copyAddress()">ğŸ“‹ ä½æ‰€ã‚³ãƒ”ãƒ¼</button>
      <button class="btn-ghost" onclick="callPhone()">â˜ï¸ é›»è©±</button>
      <button class="btn-ghost" onclick="runOCR()">ğŸ…¾ï¸ OCRï¼ˆæ–‡å­—èª­ã¿å–ã‚Šï¼‰</button>
      <button class="btn-ghost" onclick="captureOCRFromCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‹ã‚‰OCR</button>
    </div>

    <div style="margin-top:10px;">
      <div class="mini"><b>OCRé€²æ—</b></div>
      <div class="progress"><div class="bar" id="ocrBar"></div></div>
      <div class="mini" id="ocrStatus" style="margin-top:6px;">æœªå®Ÿè¡Œ</div>
      <div class="pillRow" id="ocrCandidates" style="margin-top:10px;"></div>
      <div class="mini" style="margin-top:6px;">â€»å€™è£œã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ä½æ‰€/ã‚³ãƒ¼ãƒ‰ã«åæ˜ ã—ã¾ã™ã€‚</div>
    </div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-primary" onclick="saveModal()">ä¿å­˜</button>
      <button class="btn-ghost" onclick="closeModal()">é–‰ã˜ã‚‹</button>
      <button class="btn-bad" onclick="deleteFromModal()">å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- Hidden canvas for OCR capture -->
<canvas id="capCanvas" style="display:none;"></canvas>

<script>
/* =========================
   State / Storage
========================= */
const STORAGE_KEY = "ofa_delivery_app_v3";
const STATUS = {
  created: "æœªæŒå‡º",
  out: "æŒå‡º",
  done: "å®Œäº†",
  absent: "ä¸åœ¨",
  post: "æŠ•å‡½",
  return: "è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
};
const statusClass = (s)=>({
  created:"st-created",
  out:"st-out",
  done:"st-done",
  absent:"st-absent",
  post:"st-post",
  return:"st-return"
}[s]||"st-created");

const KINDS = [
  "å®…é…",
  "æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰",
  "ãƒã‚¹ãƒˆæŠ•å‡½",
  "æ›¸é¡",
  "å†·è”µãƒ»å†·å‡",
  "ä»£å¼•",
  "å¤§ç‰©",
  "å£Šã‚Œç‰©",
  "åŒ»ç™‚å“",
  "å»ºæ",
  "ãã®ä»–"
];

const TAGS = [
  "ã‚¢ãƒ‘ãƒ¬ãƒ«","é›‘è²¨","é£Ÿå“","åŒ»ç™‚","å»ºæ","ç²¾å¯†æ©Ÿå™¨","å‰²ã‚Œç‰©æ³¨æ„","æ™‚é–“æŒ‡å®š","ç½®ãé…","è¦ã‚µã‚¤ãƒ³","è¦è¿”é€"
];

let mode = "field"; // field or admin
let currentKind = "å®…é…"; // æ¬¡ã‚¹ã‚­ãƒ£ãƒ³ã«é©ç”¨
let gps = {lat:null, lng:null, at:null};
let list = load();

function load(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
const pad = n => String(n).padStart(2,"0");
const today = new Date();
const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
function nowISO(){
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function uid(){
  return "S" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* =========================
   Init UI
========================= */
document.getElementById("shipDate").value = todayStr;
document.getElementById("filterDate").value = todayStr;
document.getElementById("reportDate").value = todayStr;

document.getElementById("modeState").textContent = "ç¾å ´";
document.getElementById("adminFields").style.display = "none";

initKinds();
initModalKinds();
initTagPills();

/* Tabs */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const name = btn.dataset.tab;
    document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
    document.getElementById("tab-"+name).style.display="block";
    if(name==="list") renderList();
    if(name==="report") renderReport();
  });
});

/* Filters */
["filterDate","filterStatus","filterText"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderList);
});

/* Mode toggle */
document.getElementById("btnToggleMode").addEventListener("click", ()=>{
  mode = (mode==="field") ? "admin" : "field";
  document.getElementById("modeState").textContent = (mode==="field") ? "ç¾å ´" : "ç®¡ç†";
  document.getElementById("adminFields").style.display = (mode==="admin") ? "block" : "none";
  toast(mode==="field" ? "ç¾å ´ãƒ¢ãƒ¼ãƒ‰ï¼šå…¥åŠ›æœ€å°" : "ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼šè©³ç´°å…¥åŠ›");
});

/* Kind buttons */
function initKinds(){
  const bar = document.getElementById("kindBar");
  bar.innerHTML = "";
  // ç¾å ´ã§ä½¿ã†ä¸Šä½ã ã‘ï¼ˆå¤šã™ãã‚‹ã¨é…ã„ï¼‰
  const topKinds = ["å®…é…","æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰","ãƒã‚¹ãƒˆæŠ•å‡½","å†·è”µãƒ»å†·å‡","ä»£å¼•","å¤§ç‰©","å£Šã‚Œç‰©","æ›¸é¡","ãã®ä»–"];
  topKinds.forEach(k=>{
    const b = document.createElement("button");
    b.className = "kindBtn" + (k===currentKind ? " active" : "");
    b.textContent = k.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","");
    b.onclick = ()=>{
      currentKind = k;
      [...bar.children].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      toast("ç¨®åˆ¥ï¼š" + k);
    };
    bar.appendChild(b);
  });
}

/* Modal kind select */
function initModalKinds(){
  const sel = document.getElementById("mKind");
  sel.innerHTML = "";
  KINDS.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });
}
function initTagPills(){
  const box = document.getElementById("tagPills");
  box.innerHTML = "";
  TAGS.forEach(t=>{
    const p = document.createElement("button");
    p.className = "pill";
    p.textContent = t;
    p.onclick = ()=> p.classList.toggle("active");
    box.appendChild(p);
  });
}

/* =========================
   GPS
========================= */
const gpsState = document.getElementById("gpsState");
document.getElementById("btnGPS").addEventListener("click", ()=>{
  if(!navigator.geolocation){
    toast("GPSéå¯¾å¿œ");
    return;
  }
  gpsState.textContent = "å–å¾—ä¸­â€¦";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gps.lat = pos.coords.latitude;
      gps.lng = pos.coords.longitude;
      gps.at = nowISO();
      gpsState.textContent = "OK";
      toast("GPSå–å¾—OK");
    },
    ()=>{
      gpsState.textContent = "å¤±æ•—";
      toast("GPSå¤±æ•—ï¼šè¨±å¯ã‚’ç¢ºèª");
    },
    { enableHighAccuracy:true, timeout:12000 }
  );
});

/* =========================
   Add / TEMP / Manual
========================= */
function getBaseFields(){
  const shipDate = document.getElementById("shipDate").value || todayStr;
  const driver = (document.getElementById("driver").value || "").trim();
  const client = (document.getElementById("client").value || "").trim();
  const address = (document.getElementById("address")?.value || "").trim();
  const phone = (document.getElementById("phone")?.value || "").trim();
  const memo = (document.getElementById("memo")?.value || "").trim();
  return { shipDate, driver, client, address, phone, memo };
}

function nextTempCode(){
  const n = list.filter(x=>String(x.code||"").startsWith("TEMP-")).length + 1;
  return `TEMP-${String(n).padStart(4,"0")}`;
}

function normalizeCode(code){
  return String(code||"").trim();
}

function isDuplicate(shipDate, code){
  return list.some(x => x.shipDate===shipDate && x.code===code);
}

function addShipment(code, forceTemp=false){
  const base = getBaseFields();
  let c = normalizeCode(code);

  // ç©ºã‚„èª­ã‚ãªã„ â†’ TEMP
  if(forceTemp || !c){
    c = nextTempCode();
  }

  if(isDuplicate(base.shipDate, c)){
    // é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³æ™‚ã®é‡è¤‡ã¯é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
    return false;
  }

  const item = {
    id: uid(),
    shipDate: base.shipDate,
    driver: base.driver,
    client: base.client,
    kind: currentKind,
    tags: [],
    code: c,
    address: (mode==="admin") ? base.address : "",
    phone: (mode==="admin") ? base.phone : "",
    memo: (mode==="admin") ? base.memo : "",
    status: "created",
    createdAt: nowISO(),
    updatedAt: nowISO(),
    history: [{at: nowISO(), action: "ç™»éŒ²"}]
  };

  list.unshift(item);
  save();
  return true;
}

document.getElementById("btnAddManual").addEventListener("click", ()=>{
  const v = document.getElementById("manualCode").value;
  const ok = addShipment(v, false);
  document.getElementById("manualCode").value = "";
  toast(ok ? "è¿½åŠ ã—ã¾ã—ãŸ" : "é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
});

document.getElementById("btnTemp").addEventListener("click", ()=>{
  addShipment("", true);
  toast("ä»®ç™»éŒ²ï¼ˆTEMPï¼‰");
});

/* =========================
   SCAN (ZXing)
========================= */
const torchState = document.getElementById("torchState");
const btnTorch = document.getElementById("btnTorch");
const btnStartScan = document.getElementById("btnStartScan");
const btnStopScan = document.getElementById("btnStopScan");
const camBox = document.getElementById("camBox");
const video = document.getElementById("video");

let stream = null;
let track = null;
let torch = false;
let scanning = false;
let lastVal = "";
let lastAt = 0;

const codeReader = new ZXing.BrowserMultiFormatReader();

btnStartScan.addEventListener("click", startScan);
btnStopScan.addEventListener("click", stopScan);
btnTorch.addEventListener("click", toggleTorch);

async function startScan(){
  if(!navigator.mediaDevices?.getUserMedia){
    toast("ã‚«ãƒ¡ãƒ©éå¯¾å¿œ");
    return;
  }

  camBox.style.display = "block";
  btnStartScan.style.display = "none";
  btnStopScan.style.display = "inline-block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"environment" }, audio:false });
    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];
    updateTorchSupport();

  }catch(e){
    stopScan();
    toast("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼šHTTPS/è¨±å¯ã‚’ç¢ºèª");
    return;
  }

  scanning = true;

  // ZXing decode loop
  codeReader.decodeFromVideoElement(video, (result, err)=>{
    if(!scanning) return;
    if(result?.text){
      const val = String(result.text).trim();
      const now = Date.now();
      // é€£ç¶šåŒä¸€ã®æŠ‘åˆ¶
      if(val && (val !== lastVal || (now-lastAt) > 900)){
        lastVal = val; lastAt = now;
        const ok = addShipment(val, false);
        if(ok) toast(`èª­ã¿å–ã‚Šâ†’è¿½åŠ ï¼š${val}`);
      }
    }
  });

  toast("SCANä¸­ï¼šä¼ç¥¨ã‚’ã‹ã–ã—ã¦ä¸‹ã•ã„");
}

function stopScan(){
  scanning = false;
  btnStartScan.style.display = "inline-block";
  btnStopScan.style.display = "none";
  camBox.style.display = "none";

  try{ codeReader.reset(); }catch{}
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
    }
  }catch{}
  stream = null;
  track = null;
  torch = false;
  btnTorch.disabled = true;
  torchState.textContent = "æœªå¯¾å¿œ";
}

function updateTorchSupport(){
  if(!track) return;
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  btnTorch.disabled = !hasTorch;
  torchState.textContent = hasTorch ? "OFF" : "æœªå¯¾å¿œ";
}

async function toggleTorch(){
  if(!track){ toast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã®ã¿"); return; }
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  if(!hasTorch){ toast("ãƒ©ã‚¤ãƒˆéå¯¾å¿œ"); return; }
  torch = !torch;
  try{
    await track.applyConstraints({ advanced:[{ torch }] });
    torchState.textContent = torch ? "ON" : "OFF";
    toast(torch ? "ãƒ©ã‚¤ãƒˆON" : "ãƒ©ã‚¤ãƒˆOFF");
  }catch{
    toast("ãƒ©ã‚¤ãƒˆåˆ‡æ›¿å¤±æ•—");
  }
}

/* =========================
   List / KPI / Actions
========================= */
function applyFilters(listIn){
  const d = document.getElementById("filterDate").value;
  const st = document.getElementById("filterStatus").value;
  const q = (document.getElementById("filterText").value || "").trim().toLowerCase();
  return listIn.filter(x=>{
    const okD = d ? x.shipDate === d : true;
    const okS = st ? x.status === st : true;
    const hay = `${x.code} ${x.address||""} ${x.client||""} ${x.kind||""} ${(x.tags||[]).join(" ")}`.toLowerCase();
    const okQ = q ? hay.includes(q) : true;
    return okD && okS && okQ;
  });
}

function kpiByDate(dateStr){
  const l = list.filter(x=>x.shipDate===dateStr);
  const c = s => l.filter(x=>x.status===s).length;
  const kindCount = {};
  l.forEach(x=>{
    const k = x.kind || "æœªè¨­å®š";
    kindCount[k] = (kindCount[k]||0)+1;
  });
  return {
    total: l.length,
    created: c("created"),
    out: c("out"),
    done: c("done"),
    absent: c("absent"),
    post: c("post"),
    return: c("return"),
    kindCount
  };
}

function renderKpis(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const k = kpiByDate(dateStr);
  const topKinds = Object.entries(k.kindCount).sort((a,b)=>b[1]-a[1]).slice(0,4);
  const kindLine = topKinds.map(([name,n])=>`${name.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","")} ${n}`).join(" / ") || "â€”";

  document.getElementById("kpis").innerHTML = `
    <div class="kpi"><small>åˆè¨ˆ</small><b>${k.total}</b></div>
    <div class="kpi"><small>æœªæŒå‡º</small><b>${k.created}</b></div>
    <div class="kpi"><small>æŒå‡º</small><b>${k.out}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${k.done}</b></div>
    <div class="kpi"><small>ä¸åœ¨/æŠ•å‡½</small><b>${k.absent + k.post}</b></div>
    <div class="kpi"><small>ä¸Šä½ç¨®åˆ¥</small><b style="font-size:13px">${escapeHtml(kindLine)}</b></div>
  `;
}

function renderList(){
  renderKpis();
  const box = document.getElementById("historyList");
  const filtered = applyFilters(list);

  if(!filtered.length){
    box.innerHTML = `<div class="mini">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚SCANã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  box.innerHTML = filtered.map(x=>{
    const kindBadge = `<span class="badge">${escapeHtml((x.kind||"å®…é…").replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰",""))}</span>`;
    const tagText = (x.tags && x.tags.length) ? `ğŸ“¦ ${escapeHtml(x.tags.join(" / "))}` : "";
    const last = x.history?.[x.history.length-1];
    const lastLine = last ? `${last.at} / ${last.action}` : "";

    const doneLabel = (x.kind==="æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰" || x.kind==="ãƒã‚¹ãƒˆæŠ•å‡½") ? "æŠ•å‡½å®Œäº†" : "å®Œäº†";

    return `
      <div class="item" id="row-${x.id}">
        <div class="itemTop">
          <div>
            <b>${escapeHtml(x.code)}</b>
            <div class="mini">${kindBadge} ${escapeHtml(x.client||"")} / ${escapeHtml(x.shipDate)}</div>
          </div>
          <div class="tag ${statusClass(x.status)}">${escapeHtml(STATUS[x.status]||x.status)}</div>
        </div>

        <div class="meta">
          ä½æ‰€ï¼š${escapeHtml(x.address||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          æœ€çµ‚ï¼š${escapeHtml(lastLine)}<br>
          ${tagText ? tagText + "<br>" : ""}
          é…é”å“¡ï¼š${escapeHtml(x.driver||"ï¼ˆæœªå…¥åŠ›ï¼‰")}
        </div>

        <div class="actions">
          <button class="btn-blue btn-mini" onclick="navTo('${x.id}')">ğŸ—º ãƒŠãƒ“</button>
          <button class="btn-ok btn-mini" onclick="setStatus('${x.id}','out','æŒå‡º')">æŒå‡º</button>
          <button class="btn-ok btn-mini" onclick="setDone('${x.id}')">${doneLabel}</button>
          <button class="btn-warn btn-mini" onclick="setStatus('${x.id}','absent','ä¸åœ¨',true)">ä¸åœ¨</button>
          <button class="btn-bad btn-mini" onclick="setStatus('${x.id}','return','è¿”å´')">è¿”å´</button>
          <button class="btn-ghost btn-mini" onclick="openModal('${x.id}')">è©³ç´°/å…¥åŠ›/OCR</button>
          <button class="btn-bad btn-mini" onclick="delOne('${x.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join("");
}

window.setStatus = function(id, st, label, autoNext=false){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  it.status = st;
  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: label});
  save();
  renderList();
  toast(`${label}ï¼š${it.code}`);
  if(autoNext) jumpNextUnfinished();
};

window.setDone = function(id){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  const isPost = (it.kind==="æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰" || it.kind==="ãƒã‚¹ãƒˆæŠ•å‡½");
  it.status = isPost ? "post" : "done";
  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: isPost ? "æŠ•å‡½" : "å®Œäº†"});
  save();
  renderList();
  toast(`${isPost ? "æŠ•å‡½" : "å®Œäº†"}ï¼š${it.code}`);
  jumpNextUnfinished();
};

window.delOne = function(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  list = list.filter(x=>x.id!==id);
  save();
  renderList();
};

document.getElementById("btnBulkOut").addEventListener("click", ()=>{
  const dateStr = document.getElementById("filterDate").value || todayStr;
  let cnt = 0;
  list.forEach(it=>{
    if(it.shipDate===dateStr && it.status==="created"){
      it.status="out";
      it.updatedAt = nowISO();
      it.history = it.history || [];
      it.history.push({at: nowISO(), action:"æŒå‡ºï¼ˆä¸€æ‹¬ï¼‰"});
      cnt++;
    }
  });
  save();
  renderList();
  toast(`æŒå‡ºä¸€æ‹¬ï¼š${cnt}ä»¶`);
});

document.getElementById("btnNext").addEventListener("click", jumpNextUnfinished);

function jumpNextUnfinished(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  // å„ªå…ˆï¼šæœªæŒå‡ºâ†’æŒå‡º
  const all = list.filter(x=>x.shipDate===dateStr);
  const target = all.find(x=>x.status==="created") || all.find(x=>x.status==="out");
  if(!target){
    toast("æœªå®Œãªã—ï¼ˆå®Œäº†ï¼‰");
    return;
  }
  // list tabã¸
  document.querySelector('[data-tab="list"]').click();
  setTimeout(()=>{
    const el = document.getElementById("row-"+target.id);
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  }, 60);
}

/* =========================
   Navigation (Google Maps)
========================= */
window.navTo = function(id){
  const it = list.find(x=>x.id===id);
  if(!it) return;

  // ä½æ‰€æœªå…¥åŠ›ãªã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å…¥åŠ›ã¸
  if(!it.address){
    openModal(id);
    toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãƒŠãƒ“");
    return;
  }

  const dest = encodeURIComponent(it.address);
  const origin = (gps.lat && gps.lng) ? `${gps.lat},${gps.lng}` : "";
  const url = origin
    ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&travelmode=driving`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;

  if(it.status==="created"){
    if(confirm("ãƒŠãƒ“é–‹å§‹ã¨åŒæ™‚ã«ã€ŒæŒå‡ºã€ã«ã—ã¾ã™ã‹ï¼Ÿ")){
      window.setStatus(it.id, "out", "æŒå‡º");
    }
  }
  window.open(url, "_blank");
};

/* =========================
   Export CSV / PDF
========================= */
function toCSV(rows){
  const esc = v => `"${String(v??"").replaceAll('"','""')}"`;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

function rowsForExport(items){
  return items.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate, x.driver, x.client,
      x.kind, (x.tags||[]).join("/"),
      x.code, x.address, x.phone,
      STATUS[x.status]||x.status,
      last?.at || "",
      (x.memo||"")
    ];
  });
}

document.getElementById("btnExportCSV").addEventListener("click", ()=>{
  const items = applyFilters(list);
  const header = ["æ—¥ä»˜","é…é”å“¡","å–å¼•å…ˆ","ç¨®åˆ¥","ã‚¿ã‚°","ã‚³ãƒ¼ãƒ‰","ä½æ‰€","é›»è©±","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsForExport(items)]);
  downloadFile(csv, `OFA_é…é”å±¥æ­´_${todayStr}.csv`, "text/csv;charset=utf-8");
});

function exportPDF(title, items, filename, metaLines=[]){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});

  doc.setFontSize(14);
  doc.text(title, 14, 14);

  doc.setFontSize(10);
  let y=20;
  metaLines.forEach(line=>{ doc.text(line, 14, y); y+=5; });

  const head = [["æ—¥ä»˜","ç¨®åˆ¥","ã‚³ãƒ¼ãƒ‰","ä½æ‰€","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°"]];
  const body = items.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate,
      (x.kind||"").replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰",""),
      x.code,
      x.address||"",
      STATUS[x.status]||x.status,
      last?.at || ""
    ];
  });

  doc.autoTable({
    startY: y+2,
    head, body,
    styles:{fontSize:9, cellPadding:2},
    theme:"grid"
  });

  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`OFA GROUP / ${todayStr} / Page ${i}/${pageCount}`, 14, 292);
  }
  doc.save(filename);
}

document.getElementById("btnExportPDF").addEventListener("click", ()=>{
  const items = applyFilters(list);
  exportPDF("OFA é…é”å±¥æ­´", items, `OFA_é…é”å±¥æ­´_${todayStr}.pdf`, [
    `å‡ºåŠ›ï¼š${nowISO()}`,
    `GPSï¼š${gps.lat&&gps.lng ? gps.lat.toFixed(6)+","+gps.lng.toFixed(6) : "æœªå–å¾—"}`
  ]);
});

document.getElementById("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚")) return;
  if(!confirm("æœ€çµ‚ç¢ºèªï¼šå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY);
  list = [];
  renderList();
  renderReport();
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
});

/* =========================
   Report
========================= */
document.getElementById("reportDate").addEventListener("change", renderReport);
document.getElementById("reportDriver").addEventListener("input", renderReport);

function itemsByDate(dateStr){
  return list.filter(x=>x.shipDate===dateStr);
}

function renderReport(){
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);

  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();

  const c = (st)=> items.filter(x=>x.status===st).length;
  const kindCount = {};
  items.forEach(x=>{
    const k = x.kind || "æœªè¨­å®š";
    kindCount[k] = (kindCount[k]||0)+1;
  });
  const kindTop = Object.entries(kindCount).sort((a,b)=>b[1]-a[1]).slice(0,6)
    .map(([k,n])=>`${k.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","")} ${n}`).join(" / ") || "â€”";

  document.getElementById("reportKpis").innerHTML = `
    <div class="kpi"><small>å¯¾è±¡æ—¥</small><b>${escapeHtml(dateStr)}</b></div>
    <div class="kpi"><small>é…é”å“¡</small><b>${escapeHtml(driver||"æœªå…¥åŠ›")}</b></div>
    <div class="kpi"><small>åˆè¨ˆ</small><b>${items.length}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${c("done")}</b></div>
    <div class="kpi"><small>æŠ•å‡½</small><b>${c("post")}</b></div>
    <div class="kpi"><small>ä¸åœ¨</small><b>${c("absent")}</b></div>
    <div class="kpi"><small>ç¨®åˆ¥å†…è¨³</small><b style="font-size:13px">${escapeHtml(kindTop)}</b></div>
  `;
}

document.getElementById("btnReportCSV").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);
  const header = ["æ—¥ä»˜","é…é”å“¡","å–å¼•å…ˆ","ç¨®åˆ¥","ã‚¿ã‚°","ã‚³ãƒ¼ãƒ‰","ä½æ‰€","é›»è©±","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsForExport(items)]);
  downloadFile(csv, `OFA_æ—¥å ±_${dateStr}.csv`, "text/csv;charset=utf-8");
});

document.getElementById("btnReportPDF").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);
  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();

  exportPDF("OFA æ—¥å ±ï¼ˆé…é”ï¼‰", items, `OFA_æ—¥å ±_${dateStr}.pdf`, [
    `å¯¾è±¡æ—¥ï¼š${dateStr}`,
    `é…é”å“¡ï¼š${driver||"æœªå…¥åŠ›"}`,
    `å‡ºåŠ›ï¼š${nowISO()}`
  ]);
});

/* =========================
   Modal (Detail / OCR / Tags)
========================= */
let modalId = null;

window.openModal = function(id){
  modalId = id;
  const it = list.find(x=>x.id===id);
  if(!it) return;

  document.getElementById("modalTitle").textContent = "è©³ç´° / å…¥åŠ› / OCR";
  document.getElementById("modalSub").textContent = `${it.shipDate} / ${it.kind?.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","") || ""} / ${it.code}`;

  document.getElementById("mCode").value = it.code || "";
  document.getElementById("mKind").value = it.kind || "å®…é…";
  document.getElementById("mAddress").value = it.address || "";
  document.getElementById("mPhone").value = it.phone || "";
  document.getElementById("mMemo").value = it.memo || "";

  // tag pills set
  [...document.querySelectorAll("#tagPills .pill")].forEach(p=>{
    p.classList.toggle("active", (it.tags||[]).includes(p.textContent));
  });

  // OCR UI reset
  setOCRProgress(0, "æœªå®Ÿè¡Œ");
  document.getElementById("ocrCandidates").innerHTML = "";

  document.getElementById("modalBack").style.display = "flex";
};

window.closeModal = function(){
  document.getElementById("modalBack").style.display = "none";
  modalId = null;
};

window.saveModal = function(){
  if(!modalId) return;
  const it = list.find(x=>x.id===modalId);
  if(!it) return;

  it.code = document.getElementById("mCode").value.trim() || it.code;
  it.kind = document.getElementById("mKind").value;
  it.address = document.getElementById("mAddress").value.trim();
  it.phone = document.getElementById("mPhone").value.trim();
  it.memo = document.getElementById("mMemo").value.trim();
  it.tags = [...document.querySelectorAll("#tagPills .pill.active")].map(p=>p.textContent);

  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action:"è©³ç´°æ›´æ–°"});

  save();
  renderList();
  renderReport();
  toast("ä¿å­˜ã—ã¾ã—ãŸ");
  closeModal();
};

window.deleteFromModal = function(){
  if(!modalId) return;
  if(!confirm("ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  list = list.filter(x=>x.id!==modalId);
  save();
  renderList();
  renderReport();
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  closeModal();
};

window.navFromModal = function(){
  if(!modalId) return;
  navTo(modalId);
};

window.copyAddress = function(){
  const addr = document.getElementById("mAddress").value.trim();
  if(!addr){ toast("ä½æ‰€ãŒç©ºã§ã™"); return; }
  navigator.clipboard?.writeText(addr).then(()=>toast("ä½æ‰€ã‚³ãƒ”ãƒ¼OK")).catch(()=>toast("ã‚³ãƒ”ãƒ¼å¤±æ•—"));
};

window.callPhone = function(){
  const ph = document.getElementById("mPhone").value.trim();
  if(!ph){ toast("é›»è©±ãŒç©ºã§ã™"); return; }
  window.location.href = `tel:${encodeURIComponent(ph)}`;
};

/* =========================
   OCR
   - ç”»åƒã‚½ãƒ¼ã‚¹ï¼šâ‘ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â‘¡ã‚«ãƒ¡ãƒ©æ˜ åƒã®1ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆcaptureï¼‰
   - æŠ½å‡ºï¼šä½æ‰€å€™è£œ / ã‚³ãƒ¼ãƒ‰å€™è£œ
========================= */
function setOCRProgress(pct, text){
  document.getElementById("ocrBar").style.width = `${pct}%`;
  document.getElementById("ocrStatus").textContent = text;
}

function addCandidateButton(label, onClick){
  const b = document.createElement("button");
  b.className = "pill";
  b.textContent = label;
  b.onclick = onClick;
  document.getElementById("ocrCandidates").appendChild(b);
}

function extractCandidates(text){
  const t = (text||"").replace(/\s+/g," ").trim();

  // ã‚³ãƒ¼ãƒ‰å€™è£œï¼šè‹±æ•°å­—/æ•°å­—ã®ã¾ã¨ã¾ã‚Šï¼ˆ8-22ï¼‰
  const codeMatches = [...t.matchAll(/[A-Z0-9\-]{8,22}/g)].map(m=>m[0]);
  const numMatches = [...t.matchAll(/\d{8,22}/g)].map(m=>m[0]);
  const codes = Array.from(new Set([...codeMatches, ...numMatches])).slice(0,8);

  // ä½æ‰€å€™è£œï¼šéƒ½é“åºœçœŒ + å¸‚åŒºç”ºæ‘ã£ã½ã„æ–‡å­—åˆ—
  const lines = (text||"").split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const prefectures = ["åŒ—æµ·é“","æ±äº¬éƒ½","å¤§é˜ªåºœ","äº¬éƒ½åºœ","ç¥å¥ˆå·çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ„›çŸ¥çœŒ","ç¦å²¡çœŒ","é¹¿å…å³¶çœŒ","ç†Šæœ¬çœŒ","å®®å´çœŒ","é•·å´çœŒ","ä½è³€çœŒ","å¤§åˆ†çœŒ","æ²–ç¸„çœŒ"];
  // 47éƒ½é“åºœçœŒã‚’é›‘ã«è£œå®Œï¼ˆçœŒ/åºœ/éƒ½/é“ã‚’å«ã‚€ãªã‚‰å€™è£œï¼‰
  const addrLines = lines.filter(l=>/(éƒ½|é“|åºœ|çœŒ)/.test(l) && (/(å¸‚|åŒº|ç”º|æ‘)/.test(l) || /\d{1,3}[-ä¸ç›®ç•ªåœ°å·]/.test(l)));

  // é€£çµå€™è£œï¼ˆä½æ‰€ãŒåˆ†å‰²ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã®ã§2è¡Œçµåˆï¼‰
  const addrCandidates = [];
  for(let i=0;i<lines.length;i++){
    const a = lines[i];
    const b = lines[i+1] || "";
    const c = lines[i+2] || "";
    const comb2 = (a + " " + b).trim();
    const comb3 = (a + " " + b + " " + c).trim();
    if(/(éƒ½|é“|åºœ|çœŒ)/.test(comb2) && /(å¸‚|åŒº|ç”º|æ‘)/.test(comb2)) addrCandidates.push(comb2);
    if(/(éƒ½|é“|åºœ|çœŒ)/.test(comb3) && /(å¸‚|åŒº|ç”º|æ‘)/.test(comb3)) addrCandidates.push(comb3);
  }
  const addrs = Array.from(new Set([...addrLines, ...addrCandidates])).slice(0,8);

  return { codes, addrs, raw: text };
}

async function runOCR(){
  if(!modalId){ toast("å¯¾è±¡ãªã—"); return; }

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§OCRï¼ˆç¢ºå®Ÿï¼‰
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = async ()=>{
    const file = input.files?.[0];
    if(!file) return;

    setOCRProgress(5, "OCRæº–å‚™ä¸­â€¦");
    document.getElementById("ocrCandidates").innerHTML = "";

    try{
      const res = await Tesseract.recognize(file, "jpn", {
        logger: m=>{
          if(m.status==="recognizing text"){
            setOCRProgress(Math.floor((m.progress||0)*100), `OCRä¸­â€¦ ${Math.floor((m.progress||0)*100)}%`);
          }
        }
      });

      setOCRProgress(100, "OCRå®Œäº†");
      const text = res?.data?.text || "";
      const cand = extractCandidates(text);

      addCandidateButton("ã€å…¨æ–‡è¡¨ç¤ºã€‘", ()=> alert(cand.raw.slice(0,5000)));

      cand.codes.forEach(c=>{
        addCandidateButton(`ã‚³ãƒ¼ãƒ‰å€™è£œï¼š${c}`, ()=>{
          document.getElementById("mCode").value = c;
          toast("ã‚³ãƒ¼ãƒ‰åæ˜ ");
        });
      });
      cand.addrs.forEach(a=>{
        addCandidateButton(`ä½æ‰€å€™è£œï¼š${a}`, ()=>{
          document.getElementById("mAddress").value = a;
          toast("ä½æ‰€åæ˜ ");
        });
      });

      if(!cand.codes.length && !cand.addrs.length){
        addCandidateButton("å€™è£œãªã—ï¼ˆå…¨æ–‡ç¢ºèªï¼‰", ()=> alert(cand.raw.slice(0,5000)));
      }

    }catch(e){
      setOCRProgress(0, "OCRå¤±æ•—ï¼ˆç”»åƒã‚’æ˜ã‚‹ã/å¯„ã›ã¦å†è©¦è¡Œï¼‰");
    }
  };
  input.click();
}

window.runOCR = runOCR;

// ã‚«ãƒ¡ãƒ©æ˜ åƒã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åˆ‡ã‚Šå‡ºã—ã¦OCRï¼ˆé€Ÿã„ã‘ã©ãƒ–ãƒ¬ã‚‹æ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«OCRæ¨å¥¨ï¼‰
async function captureOCRFromCamera(){
  if(!modalId){ toast("å¯¾è±¡ãªã—"); return; }
  if(!video || !stream){
    toast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼ˆSCANé–‹å§‹ï¼‰");
    return;
  }

  try{
    const canvas = document.getElementById("capCanvas");
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    setOCRProgress(5, "ã‚«ãƒ¡ãƒ©ç”»åƒOCRä¸­â€¦");
    document.getElementById("ocrCandidates").innerHTML = "";

    const res = await Tesseract.recognize(canvas, "jpn", {
      logger: m=>{
        if(m.status==="recognizing text"){
          setOCRProgress(Math.floor((m.progress||0)*100), `OCRä¸­â€¦ ${Math.floor((m.progress||0)*100)}%`);
        }
      }
    });

    setOCRProgress(100, "OCRå®Œäº†");
    const text = res?.data?.text || "";
    const cand = extractCandidates(text);

    addCandidateButton("ã€å…¨æ–‡è¡¨ç¤ºã€‘", ()=> alert(cand.raw.slice(0,5000)));
    cand.codes.forEach(c=>{
      addCandidateButton(`ã‚³ãƒ¼ãƒ‰å€™è£œï¼š${c}`, ()=>{
        document.getElementById("mCode").value = c;
        toast("ã‚³ãƒ¼ãƒ‰åæ˜ ");
      });
    });
    cand.addrs.forEach(a=>{
      addCandidateButton(`ä½æ‰€å€™è£œï¼š${a}`, ()=>{
        document.getElementById("mAddress").value = a;
        toast("ä½æ‰€åæ˜ ");
      });
    });
    if(!cand.codes.length && !cand.addrs.length){
      addCandidateButton("å€™è£œãªã—ï¼ˆå…¨æ–‡ç¢ºèªï¼‰", ()=> alert(cand.raw.slice(0,5000)));
    }
  }catch(e){
    setOCRProgress(0, "OCRå¤±æ•—ï¼ˆãƒ–ãƒ¬/æš—ã•ï¼‰â†’ãƒ•ã‚¡ã‚¤ãƒ«OCRæ¨å¥¨");
  }
}

window.captureOCRFromCamera = captureOCRFromCamera;

/* =========================
   Toast
========================= */
let toastTimer=null;
function toast(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="22px";
    el.style.transform="translateX(-50%)";
    el.style.background="rgba(15,23,42,.92)";
    el.style.color="#fff";
    el.style.padding="10px 14px";
    el.style.borderRadius="999px";
    el.style.fontWeight="900";
    el.style.fontSize="12px";
    el.style.boxShadow="0 14px 30px rgba(0,0,0,.18)";
    el.style.zIndex="9999";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity="1";
  toastTimer = setTimeout(()=>{ el.style.opacity="0"; }, 1300);
}

/* =========================
   Manual add (enter key)
========================= */
document.getElementById("manualCode").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    document.getElementById("btnAddManual").click();
  }
});

/* =========================
   First render
========================= */
renderList();
renderReport();
</script>

</body>
</html>
