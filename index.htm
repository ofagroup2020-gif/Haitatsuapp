<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>OFA 配達アプリ（Web）</title>

  <!-- UI Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Leaflet (軽量地図) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;

      /* OFA pop */
      --blue:#1e88e5;
      --red:#ef4444;
      --yellow:#facc15;
      --green:#22c55e;

      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans JP", system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(30,136,229,.10), transparent 55%),
                  radial-gradient(1000px 600px at 100% 10%, rgba(250,204,21,.12), transparent 50%),
                  radial-gradient(900px 700px at 80% 100%, rgba(239,68,68,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding-bottom:84px; /* bottom nav */
    }
    header{
      position:sticky; top:0; z-index:20;
      background: rgba(247,248,251,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px 8px;
    }
    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width:0;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--yellow), #ffe680);
      display:grid; place-items:center;
      font-weight:900;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brand h1{
      font-size:14px; margin:0;
      line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:11px; color:var(--muted); margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .statusPills{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:var(--card);
      border:1px solid var(--line);
      box-shadow: 0 6px 16px rgba(17,24,39,.06);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:#9ca3af}
    .dot.ok{background:var(--green)}
    .dot.warn{background:var(--yellow)}
    .dot.bad{background:var(--red)}
    main{padding:12px; max-width:920px; margin:0 auto;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      margin-bottom:12px;
    }
    .grid2{
      display:grid; gap:10px;
      grid-template-columns:1fr;
    }
    @media(min-width:720px){
      .grid2{grid-template-columns:1.1fr .9fr;}
    }
    h2{margin:0 0 10px; font-size:15px}
    .help{font-size:12px; color:var(--muted); line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1 1 auto}

    label{font-size:12px; color:var(--muted); display:block; margin:8px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(30,136,229,.6);
      box-shadow: 0 0 0 4px rgba(30,136,229,.12);
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:none; border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition:.12s transform, .12s opacity;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btnBlue{background:linear-gradient(135deg, var(--blue), #58a6ff); color:#fff}
    .btnYellow{background:linear-gradient(135deg, var(--yellow), #ffe680); color:#1f2937}
    .btnRed{background:linear-gradient(135deg, var(--red), #ff7a7a); color:#fff}
    .btnGhost{background:#fff; border:1px solid var(--line); color:var(--text)}
    .btnSmall{padding:9px 10px; border-radius:12px; font-size:12px}
    .kpi{
      display:grid; gap:10px;
      grid-template-columns:repeat(3, 1fr);
    }
    .kpi .box{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, #fff, #fbfbff);
      text-align:center;
    }
    .kpi .num{font-size:20px; font-weight:900}
    .kpi .lbl{font-size:12px; color:var(--muted)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tabBtn{
      flex:1 1 auto;
      text-align:center;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color: rgba(250,204,21,.9);
      box-shadow: 0 0 0 4px rgba(250,204,21,.18);
      background:linear-gradient(180deg, #fffef2, #ffffff);
    }

    /* Bottom nav */
    nav.bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      display:flex; gap:8px;
      justify-content:space-between;
      max-width:920px; margin:0 auto;
    }
    .navBtn{
      flex:1 1 0;
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:10px 8px;
      display:flex; flex-direction:column; align-items:center; gap:2px;
      font-weight:900;
      cursor:pointer;
    }
    .navBtn small{font-weight:700; color:var(--muted)}
    .navBtn.active{
      border-color: rgba(30,136,229,.45);
      box-shadow: 0 0 0 4px rgba(30,136,229,.12);
    }

    /* List */
    .listHeader{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .searchBox{flex:1 1 280px}
    .sortRow{display:flex; gap:8px; flex-wrap:wrap}
    .shipList{list-style:none; padding:0; margin:10px 0 0}
    .shipItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      margin-bottom:10px;
      background:linear-gradient(180deg, #fff, #fbfbff);
    }
    .shipTop{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .shipMain{min-width:0}
    .shipName{font-weight:900}
    .shipSub{font-size:12px; color:var(--muted); margin-top:2px}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      white-space:nowrap;
    }
    .bTodo{color:#111827}
    .bDone{color:#065f46; border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .bFail{color:#7f1d1d; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .shipBtns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}

    /* Map */
    #map{
      width:100%;
      height: 56vh;
      min-height:360px;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .mapTools{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:50;
      background: rgba(17,24,39,.55);
      display:none;
      align-items:flex-end;
      padding:12px;
    }
    .modal.show{display:flex}
    .sheet{
      width:100%;
      max-width:920px;
      margin:0 auto;
      background:#fff;
      border-radius:22px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:12px;
      max-height: 82vh;
      overflow:auto;
    }
    .sheetHead{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      border-bottom:1px solid var(--line);
      padding-bottom:8px;
      margin-bottom:10px;
    }
    .sheetHead h3{margin:0; font-size:14px}
    .muted{color:var(--muted); font-size:12px}
    .photoPreview{
      width:100%;
      max-height:220px;
      border-radius:16px;
      border:1px solid var(--line);
      object-fit:cover;
      background:#f3f4f6;
    }
    .warnBox{
      border:1px dashed rgba(239,68,68,.55);
      background:rgba(239,68,68,.06);
      border-radius:16px;
      padding:10px;
      font-size:12px;
      color:#7f1d1d;
      margin-top:10px;
      line-height:1.5;
    }
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div style="min-width:0">
        <h1>OFA 配達アプリ（Web）</h1>
        <div class="sub">①点呼 → ②集荷(SCAN/OCR) → ③リスト → ④地図 → ⑤日報</div>
      </div>
    </div>

    <div class="statusPills">
      <div class="pill"><span id="gpsDot" class="dot"></span>GPS：<b id="gpsTxt">未</b></div>
      <div class="pill"><span id="camDot" class="dot"></span>カメラ：<b id="camTxt">未</b></div>
      <div class="pill"><span id="torchDot" class="dot"></span>ライト：<b id="torchTxt">OFF</b></div>
      <div class="pill"><span class="dot ok"></span>件数：<b id="countTxt">0</b></div>
    </div>
  </div>

  <div class="tabs" style="margin-top:10px">
    <button class="tabBtn active" data-view="tenko">① 点呼</button>
    <button class="tabBtn" data-view="scan">② 集荷（SCAN）</button>
    <button class="tabBtn" data-view="list">③ リスト</button>
    <button class="tabBtn" data-view="map">④ 地図</button>
    <button class="tabBtn" data-view="report">⑤ 日報</button>
  </div>
</header>

<main>
  <!-- ① 点呼 -->
  <section id="view-tenko" class="card">
    <h2>① Web点呼（スマホ最適）</h2>
    <div class="help">※ここは「最初に必ず」押す運用にできます。点呼データも日報に反映されます。</div>

    <div class="grid2" style="margin-top:10px">
      <div class="card" style="margin:0">
        <h2 style="margin:0 0 8px">アルコール・体調</h2>

        <label>開始時刻</label>
        <input id="tenkoStart" type="datetime-local"/>

        <label>アルコール測定値（例：0.00）</label>
        <input id="tenkoAlcohol" inputmode="decimal" placeholder="0.00"/>

        <label>体調</label>
        <select id="tenkoHealth">
          <option value="良好">良好</option>
          <option value="普通">普通</option>
          <option value="不調">不調</option>
        </select>

        <label>点呼メモ</label>
        <textarea id="tenkoMemo" placeholder="眠気・咳・注意事項など"></textarea>

        <div class="btnRow">
          <button class="btn btnBlue" id="btnTenkoSave">点呼を保存</button>
          <button class="btn btnGhost" id="btnTenkoNow">今の時刻を入れる</button>
        </div>
      </div>

      <div class="card" style="margin:0">
        <h2 style="margin:0 0 8px">日常点検（チェックだけでOK）</h2>
        <div class="help">✓にして「点呼を保存」で登録。</div>

        <div style="display:grid; gap:8px; margin-top:10px">
          <label style="display:flex; gap:10px; align-items:center; margin:0">
            <input type="checkbox" class="tenkoChk" value="タイヤ（空気圧/損傷）"> タイヤ（空気圧/損傷）
          </label>
          <label style="display:flex; gap:10px; align-items:center; margin:0">
            <input type="checkbox" class="tenkoChk" value="ライト（前/後/ウインカー）"> ライト（前/後/ウインカー）
          </label>
          <label style="display:flex; gap:10px; align-items:center; margin:0">
            <input type="checkbox" class="tenkoChk" value="ブレーキ（踏み込み/効き）"> ブレーキ（踏み込み/効き）
          </label>
          <label style="display:flex; gap:10px; align-items:center; margin:0">
            <input type="checkbox" class="tenkoChk" value="オイル/水（漏れ/量）"> オイル/水（漏れ/量）
          </label>
          <label style="display:flex; gap:10px; align-items:center; margin:0">
            <input type="checkbox" class="tenkoChk" value="車内（積載物固定/整理）"> 車内（積載物固定/整理）
          </label>
        </div>

        <div class="warnBox">
          <b>ポイント：</b>点呼フォームが見づらいと現場が止まるので、ここは「最短で完了」できるUIにしています。
        </div>
      </div>
    </div>
  </section>

  <!-- ② 集荷 -->
  <section id="view-scan" class="card" style="display:none">
    <h2>② 集荷（SCAN / OCR → 必須入力 → 自動ピン）</h2>
    <div class="help">
      ・バーコードが弱い荷物は<b>OCR</b>で「住所/名前/郵便番号」を拾って入力を減らします。<br/>
      ・登録した瞬間に<b>地図ピン</b>を立てます（失敗時は手動ピン修正）。<br/>
      ・現場は100個でも10分で入るように “最短導線” にしています。
    </div>

    <div class="grid2" style="margin-top:10px">
      <!-- camera -->
      <div class="card" style="margin:0">
        <h2 style="margin:0 0 8px">カメラ（高解像度）</h2>
        <div class="help">※端末によって自動読み取り/ライトが制限されます（特にiPhone Safari）。</div>

        <video id="video" playsinline muted style="width:100%; border-radius:16px; border:1px solid var(--line); background:#111827; aspect-ratio: 4/3;"></video>

        <div class="btnRow">
          <button class="btn btnBlue" id="btnCamStart">カメラ開始（高画質）</button>
          <button class="btn btnYellow" id="btnTorch">ライト</button>
          <button class="btn btnGhost" id="btnCamStop">停止</button>
        </div>

        <div class="btnRow" style="margin-top:6px">
          <button class="btn btnBlue" id="btnScanBarcode">スキャン（バーコード）</button>
          <button class="btn btnGhost" id="btnCaptureForOCR">OCR（文字読み取り）</button>
        </div>

        <canvas id="cap" style="display:none"></canvas>

        <div class="warnBox">
          <b>誤配防止：</b>「配達先で荷物を取ってスキャン → 完了」運用ができます（リスト/地図どちらでも）。
        </div>
      </div>

      <!-- form -->
      <div class="card" style="margin:0">
        <h2 style="margin:0 0 8px">登録（最短入力）</h2>

        <label>荷物種別</label>
        <select id="pkgType">
          <option value="宅配">宅配</option>
          <option value="手紙">手紙</option>
          <option value="メール便">メール便</option>
          <option value="ポスティング">ポスティング</option>
          <option value="小包">小包</option>
          <option value="冷蔵/冷凍">冷蔵/冷凍</option>
          <option value="家電スポット">家電スポット</option>
          <option value="引越しスポット">引越しスポット</option>
          <option value="その他">その他</option>
        </select>

        <label>伝票番号（任意：読めたら入れる）</label>
        <input id="tracking" class="mono" placeholder="例）SB2511-LF-A-... / 9501-0001-...."/>

        <div class="row">
          <div style="flex:1 1 160px">
            <label>郵便番号（任意：取れたら）</label>
            <input id="zip" inputmode="numeric" placeholder="例）8910705 or 891-0705"/>
          </div>
          <div style="flex:1 1 160px">
            <label>電話番号（任意）</label>
            <input id="phone" inputmode="tel" placeholder="例）09012345678"/>
          </div>
        </div>

        <label><b>お名前（必須）</b></label>
        <input id="name" placeholder="例）田中 太郎"/>

        <label><b>ご住所（必須）</b></label>
        <input id="addr" placeholder="例）鹿児島県南九州市頴娃町上別府1699-1"/>

        <label>メモ（置き配指示・特徴など）</label>
        <input id="memo" placeholder="例）置き配：玄関横／犬注意／暗証番号など"/>

        <div class="btnRow">
          <button class="btn btnYellow" id="btnZipToAddr">郵便番号→住所補完</button>
          <button class="btn btnBlue" id="btnAdd">追加（ピン自動）</button>
          <button class="btn btnGhost" id="btnClearForm">入力クリア</button>
        </div>

        <div class="help" style="margin-top:8px">
          ※必須は「名前＋住所」。電話が無い荷物が多い前提で “任意” にしています。
        </div>

      </div>
    </div>
  </section>

  <!-- ③ リスト -->
  <section id="view-list" class="card" style="display:none">
    <h2>③ リスト（検索 / 並び替え / スワイプ運用）</h2>

    <div class="listHeader">
      <div class="searchBox">
        <input id="q" placeholder="検索：名前 / 住所 / 伝票番号 / 下4桁"/>
      </div>
      <div class="sortRow">
        <button class="btn btnSmall btnGhost" id="btnSortNear">近い順</button>
        <button class="btn btnSmall btnGhost" id="btnSortAddr">番地順</button>
        <button class="btn btnSmall btnGhost" id="btnSortTime">時間指定順</button>
        <button class="btn btnSmall btnGhost" id="btnSortType">種別順</button>
      </div>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="box"><div class="num" id="kTodo">0</div><div class="lbl">未配達</div></div>
      <div class="box"><div class="num" id="kDone">0</div><div class="lbl">完了</div></div>
      <div class="box"><div class="num" id="kFail">0</div><div class="lbl">不在/持戻</div></div>
    </div>

    <ul id="list" class="shipList"></ul>

    <div class="help">
      ・リストは<b>ドラッグで順番入れ替え</b>できます（荷物の取り出し順に合わせる）。<br/>
      ・完了は「スキャン確認」を挟めます（誤配防止）。
    </div>
  </section>

  <!-- ④ 地図 -->
  <section id="view-map" class="card" style="display:none">
    <h2>④ 地図（軽量 / ピンタップで操作）</h2>
    <div class="help">地図は固まりにくいように<b>Canvas描画</b>。現在地中心に追従できます。</div>

    <div id="map"></div>

    <div class="mapTools">
      <button class="btn btnBlue btnSmall" id="btnLocate">現在地へ</button>
      <button class="btn btnGhost btnSmall" id="btnFollow">追従：OFF</button>
      <button class="btn btnGhost btnSmall" id="btnShowTodo">未配達だけ</button>
      <button class="btn btnGhost btnSmall" id="btnRefreshPins">ピン再描画</button>
    </div>

    <div class="help" style="margin-top:8px">
      ※ピンがズレたら「詳細→ピン修正（ドラッグ）」ができます。
    </div>
  </section>

  <!-- ⑤ 日報 -->
  <section id="view-report" class="card" style="display:none">
    <h2>⑤ 日報（CSV / PDF）</h2>

    <div class="kpi" style="margin-top:10px">
      <div class="box"><div class="num" id="rTotal">0</div><div class="lbl">総数</div></div>
      <div class="box"><div class="num" id="rDone">0</div><div class="lbl">完了</div></div>
      <div class="box"><div class="num" id="rFail">0</div><div class="lbl">不在/持戻</div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h2 style="margin:0 0 8px">エクスポート</h2>
      <div class="btnRow">
        <button class="btn btnBlue" id="btnCSV">CSV出力</button>
        <button class="btn btnYellow" id="btnPDF">PDF出力</button>
        <button class="btn btnGhost" id="btnBackup">バックアップJSON</button>
        <button class="btn btnRed" id="btnReset">全削除（端末）</button>
      </div>
      <div class="help" style="margin-top:8px">
        ※今は端末保存（localStorage）です。会社側で履歴を見る場合は「管理者DB版」に拡張します。
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h2 style="margin:0 0 8px">点呼データ（当日）</h2>
      <pre id="tenkoOut" style="white-space:pre-wrap; margin:0; font-size:12px; color:var(--muted)"></pre>
    </div>
  </section>

</main>

<!-- bottom nav -->
<nav class="bottom">
  <button class="navBtn active" data-view="tenko">点呼<small>①</small></button>
  <button class="navBtn" data-view="scan">集荷<small>②</small></button>
  <button class="navBtn" data-view="list">リスト<small>③</small></button>
  <button class="navBtn" data-view="map">地図<small>④</small></button>
  <button class="navBtn" data-view="report">日報<small>⑤</small></button>
</nav>

<!-- modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <h3 id="mTitle">詳細</h3>
      <button class="btn btnGhost btnSmall" id="mClose">閉じる</button>
    </div>

    <div id="mBody"></div>
  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===========================
  OFA Delivery Web App (Single File)
  - localStorage
  - BarcodeDetector (if supported)
  - OCR via Tesseract.js
  - Map via Leaflet (Canvas renderer)
  - Geocode via Nominatim (OSM) (no-key, rate limited)
  - Zip->Address via ZipCloud (Japan)
=========================== */

const LS_KEY = "ofa_delivery_v2";
const LS_TENKO = "ofa_tenko_v1";

let state = {
  shipments: [], // {id, type, tracking, zip, name, addr, phone, memo, status, lat,lng, createdAt, updatedAt, events:[], photoDataUrl, timeWindow, packages}
  ui: { showTodoOnly:false, follow:false }
};

let tenko = null;

function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
function nowISO(){ return new Date().toISOString(); }
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  renderAll();
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){}
}
function saveTenko(){
  localStorage.setItem(LS_TENKO, JSON.stringify(tenko));
  renderTenkoOut();
}
function loadTenko(){
  try{
    const raw = localStorage.getItem(LS_TENKO);
    if(raw) tenko = JSON.parse(raw);
  }catch(e){}
}

function setPill(dotEl, txtEl, status, text){
  txtEl.textContent = text;
  dotEl.classList.remove('ok','warn','bad');
  if(status==='ok') dotEl.classList.add('ok');
  if(status==='warn') dotEl.classList.add('warn');
  if(status==='bad') dotEl.classList.add('bad');
}

function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.08;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}
function buzz(){
  if(navigator.vibrate) navigator.vibrate([60, 40, 60]);
}

/* ===========================
  Navigation / Tabs
=========================== */
const tabBtns = [...document.querySelectorAll(".tabBtn")];
const navBtns = [...document.querySelectorAll(".navBtn")];
const views = {
  tenko: document.getElementById("view-tenko"),
  scan: document.getElementById("view-scan"),
  list: document.getElementById("view-list"),
  map: document.getElementById("view-map"),
  report: document.getElementById("view-report"),
};
function showView(v){
  Object.entries(views).forEach(([k,el])=> el.style.display = (k===v) ? "" : "none");
  tabBtns.forEach(b => b.classList.toggle("active", b.dataset.view===v));
  navBtns.forEach(b => b.classList.toggle("active", b.dataset.view===v));
  if(v==="map") setTimeout(()=>{ initMapIfNeeded(); mapInvalidate(); drawPins(); }, 80);
  if(v==="report") renderTenkoOut();
}
tabBtns.forEach(b=> b.addEventListener("click", ()=> showView(b.dataset.view)));
navBtns.forEach(b=> b.addEventListener("click", ()=> showView(b.dataset.view)));

/* ===========================
  Tenko
=========================== */
const tenkoStart = document.getElementById("tenkoStart");
const tenkoAlcohol = document.getElementById("tenkoAlcohol");
const tenkoHealth = document.getElementById("tenkoHealth");
const tenkoMemo = document.getElementById("tenkoMemo");
const tenkoOut = document.getElementById("tenkoOut");

document.getElementById("btnTenkoNow").addEventListener("click", ()=>{
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,'0');
  const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  tenkoStart.value = v;
});

document.getElementById("btnTenkoSave").addEventListener("click", ()=>{
  const checks = [...document.querySelectorAll(".tenkoChk")].filter(x=>x.checked).map(x=>x.value);
  tenko = {
    day: todayKey(),
    start: tenkoStart.value || null,
    alcohol: tenkoAlcohol.value || "",
    health: tenkoHealth.value,
    memo: tenkoMemo.value || "",
    checks,
    savedAt: nowISO(),
  };
  beep(); buzz();
  saveTenko();
  alert("点呼を保存しました。次は「②集荷」でOKです。");
});

function renderTenkoOut(){
  if(!tenko || tenko.day !== todayKey()){
    tenkoOut.textContent = "本日の点呼データは未登録です。";
    return;
  }
  tenkoOut.textContent =
`日付: ${tenko.day}
開始: ${tenko.start || "-"}
アルコール: ${tenko.alcohol || "-"}
体調: ${tenko.health}
点検: ${tenko.checks?.join(" / ") || "-"}
メモ: ${tenko.memo || "-"}
保存: ${tenko.savedAt}`;
}

/* ===========================
  Camera / Barcode / Torch / OCR
=========================== */
const video = document.getElementById("video");
const cap = document.getElementById("cap");
const btnCamStart = document.getElementById("btnCamStart");
const btnCamStop = document.getElementById("btnCamStop");
const btnTorch = document.getElementById("btnTorch");
const btnScanBarcode = document.getElementById("btnScanBarcode");
const btnCaptureForOCR = document.getElementById("btnCaptureForOCR");

const gpsDot = document.getElementById("gpsDot");
const gpsTxt = document.getElementById("gpsTxt");
const camDot = document.getElementById("camDot");
const camTxt = document.getElementById("camTxt");
const torchDot = document.getElementById("torchDot");
const torchTxt = document.getElementById("torchTxt");
const countTxt = document.getElementById("countTxt");

let stream = null;
let track = null;
let torchOn = false;
let barcodeDetector = null;

async function startCam(){
  try{
    const constraints = {
      audio:false,
      video:{
        facingMode:{ideal:"environment"},
        width:{ideal:1920},
        height:{ideal:1080}
      }
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];
    setPill(camDot, camTxt, "ok", "OK");
    // BarcodeDetector
    if("BarcodeDetector" in window){
      try{
        barcodeDetector = new BarcodeDetector({formats:["qr_code","code_128","code_39","ean_13","ean_8","itf","upc_a","upc_e"]});
      }catch(e){
        barcodeDetector = null;
      }
    }else{
      barcodeDetector = null;
    }

    // Torch availability
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    const torchCap = !!caps.torch;
    setPill(torchDot, torchTxt, torchCap ? "ok":"warn", torchCap ? "対応":"未対応");
  }catch(e){
    setPill(camDot, camTxt, "bad", "NG");
    alert("カメラを起動できません。Safari設定のカメラ許可をご確認ください。");
  }
}
function stopCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
    track = null;
  }
  torchOn = false;
  setPill(torchDot, torchTxt, "warn", "OFF");
  setPill(camDot, camTxt, "warn", "停止");
}
btnCamStart.addEventListener("click", startCam);
btnCamStop.addEventListener("click", stopCam);

btnTorch.addEventListener("click", async ()=>{
  if(!track) return alert("先にカメラ開始してください。");
  if(!track.applyConstraints) return alert("この端末/ブラウザはライト制御に非対応です。");
  const caps = track.getCapabilities ? track.getCapabilities() : {};
  if(!caps.torch) return alert("この端末/ブラウザはライト（torch）に非対応です。iPhone Safariは非対応が多いです。");

  torchOn = !torchOn;
  try{
    await track.applyConstraints({advanced:[{torch: torchOn}]});
    setPill(torchDot, torchTxt, "ok", torchOn ? "ON":"OFF");
  }catch(e){
    torchOn = false;
    setPill(torchDot, torchTxt, "warn", "OFF");
    alert("ライトを切り替えできませんでした。");
  }
});

function captureFrame(){
  if(!video.videoWidth) return null;
  cap.width = video.videoWidth;
  cap.height = video.videoHeight;
  const ctx = cap.getContext("2d", {willReadFrequently:true});
  ctx.drawImage(video, 0, 0, cap.width, cap.height);
  return cap;
}

async function scanBarcodeOnce(){
  if(!track || !barcodeDetector){
    // not supported
    return null;
  }
  const canvas = captureFrame();
  if(!canvas) return null;
  try{
    const bitmap = await createImageBitmap(canvas);
    const codes = await barcodeDetector.detect(bitmap);
    if(codes && codes.length){
      return codes[0].rawValue || null;
    }
  }catch(e){}
  return null;
}

btnScanBarcode.addEventListener("click", async ()=>{
  if(!track) return alert("先にカメラ開始してください。");
  if(!barcodeDetector){
    alert("この端末はバーコード自動読取に非対応です。OCR（文字読み取り）か手入力をご利用ください。");
    return;
  }
  const v = await scanBarcodeOnce();
  if(v){
    beep(); buzz();
    document.getElementById("tracking").value = v;
  }else{
    alert("バーコードを検出できません。角度/距離/明るさを調整するか、OCR/手入力をご利用ください。");
  }
});

function normalizeZip(z){
  if(!z) return "";
  const m = z.replace(/[^\d]/g,"");
  if(m.length===7) return m.slice(0,3)+"-"+m.slice(3);
  return z.trim();
}

function guessFieldsFromText(text){
  const t = (text||"").replace(/\s+/g," ").trim();

  // zip like 〒123-4567
  let zip = "";
  const zm = t.match(/〒?\s*(\d{3})\s*[-ー]?\s*(\d{4})/);
  if(zm) zip = `${zm[1]}-${zm[2]}`;

  // address heuristic: pick substring containing 都道府県 or 市/区/町/村
  let addr = "";
  const lines = (text||"").split(/\n+/).map(x=>x.trim()).filter(Boolean);
  // prefer line containing 都道府県
  const cand = lines.find(x=> /(都|道|府|県)/.test(x)) ||
               lines.find(x=> /(市|区|町|村)/.test(x)) ||
               "";
  if(cand) addr = cand.replace(/^〒?\s*\d{3}\s*[-ー]?\s*\d{4}\s*/,"").trim();

  // name heuristic: line containing 様 or 御中 or likely kanji name
  let name = "";
  const nm = lines.find(x=> /(様|御中)/.test(x)) ||
             lines.find(x=> /^[一-龥ぁ-んァ-ンa-zA-Z\s]{2,20}$/.test(x)) ||
             "";
  if(nm){
    name = nm.replace(/(様|御中)/g,"").trim();
  }
  return {zip, addr, name};
}

btnCaptureForOCR.addEventListener("click", async ()=>{
  if(!track) return alert("先にカメラ開始してください。");
  const canvas = captureFrame();
  if(!canvas) return;

  alert("OCR開始します（数秒〜端末により10秒以上）。終わるまで画面を閉じないでください。");

  try{
    const { data } = await Tesseract.recognize(canvas, "jpn", {
      logger: (m)=> { /* console.log(m) */ }
    });

    const text = data?.text || "";
    const g = guessFieldsFromText(text);

    if(g.zip) document.getElementById("zip").value = g.zip;
    if(g.addr) document.getElementById("addr").value = g.addr;
    if(g.name) document.getElementById("name").value = g.name;

    beep(); buzz();

    // if zip exists, try auto address fill
    if(g.zip) await zipToAddress();
    // if addr exists, try auto pin
    if(document.getElementById("addr").value.trim()){
      await geocodeAndPreview();
    }

    // Show a small hint
    if(!g.addr && !g.name && !g.zip){
      alert("OCR結果から住所/名前/郵便番号を推定できませんでした。明るさや角度を調整して再度お試しください。");
    }else{
      alert("OCRで入力補助しました。必要なら修正して「追加」を押してください。");
    }

  }catch(e){
    alert("OCRに失敗しました。通信状況や端末性能により失敗する場合があります。");
  }
});

/* ===========================
  Form / Add Shipment
=========================== */
const pkgType = document.getElementById("pkgType");
const tracking = document.getElementById("tracking");
const zip = document.getElementById("zip");
const nameEl = document.getElementById("name");
const addrEl = document.getElementById("addr");
const phoneEl = document.getElementById("phone");
const memoEl = document.getElementById("memo");

document.getElementById("btnClearForm").addEventListener("click", ()=>{
  pkgType.value="宅配";
  tracking.value="";
  zip.value="";
  nameEl.value="";
  addrEl.value="";
  phoneEl.value="";
  memoEl.value="";
});

document.getElementById("btnZipToAddr").addEventListener("click", zipToAddress);

async function zipToAddress(){
  const z = normalizeZip(zip.value);
  if(!z) return alert("郵便番号を入力してください。");
  const only = z.replace(/[^\d]/g,"");
  if(only.length!==7) return alert("郵便番号は7桁で入力してください。");
  try{
    const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${only}`);
    const js = await res.json();
    if(js && js.results && js.results[0]){
      const r = js.results[0];
      const a = `${r.address1}${r.address2}${r.address3}`;
      addrEl.value = a;
      beep(); buzz();
      await geocodeAndPreview();
    }else{
      alert("郵便番号から住所を取得できませんでした。手入力してください。");
    }
  }catch(e){
    alert("郵便番号→住所の取得に失敗しました。通信をご確認ください。");
  }
}

async function geocode(addr){
  // Nominatim (rate limited). For production company-wide, use your own geocoder or Google Geocoding with key.
  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(addr);
  const res = await fetch(url, {headers: {"Accept-Language":"ja"}});
  const js = await res.json();
  if(js && js[0]){
    return {lat: parseFloat(js[0].lat), lng: parseFloat(js[0].lon)};
  }
  return null;
}

async function geocodeAndPreview(){
  const a = addrEl.value.trim();
  if(!a) return;
  try{
    const p = await geocode(a);
    if(p){
      // cache preview in temp fields
      addrEl.dataset.lat = String(p.lat);
      addrEl.dataset.lng = String(p.lng);
    }else{
      addrEl.dataset.lat = "";
      addrEl.dataset.lng = "";
    }
  }catch(e){
    addrEl.dataset.lat = "";
    addrEl.dataset.lng = "";
  }
}

addrEl.addEventListener("blur", geocodeAndPreview);

document.getElementById("btnAdd").addEventListener("click", async ()=>{
  const nm = nameEl.value.trim();
  const ad = addrEl.value.trim();
  if(!nm || !ad){
    alert("必須：名前 と 住所 を入力してください。");
    return;
  }

  // if not yet geocoded, try now
  let lat = parseFloat(addrEl.dataset.lat || "NaN");
  let lng = parseFloat(addrEl.dataset.lng || "NaN");
  if(!Number.isFinite(lat) || !Number.isFinite(lng)){
    try{
      const p = await geocode(ad);
      if(p){ lat=p.lat; lng=p.lng; }
    }catch(e){}
  }

  const item = {
    id: uid(),
    type: pkgType.value,
    tracking: tracking.value.trim(),
    zip: normalizeZip(zip.value.trim()),
    name: nm,
    addr: ad,
    phone: phoneEl.value.trim(),
    memo: memoEl.value.trim(),
    status: "todo", // todo, done, fail
    lat: Number.isFinite(lat) ? lat : null,
    lng: Number.isFinite(lng) ? lng : null,
    createdAt: nowISO(),
    updatedAt: nowISO(),
    events: [{at: nowISO(), kind:"pickup", note:"集荷登録"}],
    photoDataUrl: null,
    timeWindow: "", // optional (未来拡張)
    packages: 1
  };

  state.shipments.unshift(item);
  beep(); buzz();
  save();

  // clear minimal fields to speed next input
  tracking.value="";
  nameEl.value="";
  phoneEl.value="";
  memoEl.value="";
  // keep address if many in same area? -> keep zip/address as convenience
  alert("追加しました。次の荷物を続けて登録できます。");
});

/* ===========================
  List Rendering + Sortable
=========================== */
const listEl = document.getElementById("list");
const qEl = document.getElementById("q");

qEl.addEventListener("input", ()=> renderList());

document.getElementById("btnSortNear").addEventListener("click", ()=> sortByNear());
document.getElementById("btnSortAddr").addEventListener("click", ()=> sortByAddress());
document.getElementById("btnSortTime").addEventListener("click", ()=> sortByTime());
document.getElementById("btnSortType").addEventListener("click", ()=> sortByType());

let sortable = null;

function shortTracking(t){
  if(!t) return "";
  const s = t.trim();
  const digits = s.replace(/[^\d]/g,"");
  if(digits.length>=4) return "****" + digits.slice(-4);
  if(s.length>=4) return "****" + s.slice(-4);
  return s;
}

function calcKPIs(){
  const todo = state.shipments.filter(x=>x.status==="todo").length;
  const done = state.shipments.filter(x=>x.status==="done").length;
  const fail = state.shipments.filter(x=>x.status==="fail").length;
  document.getElementById("kTodo").textContent = todo;
  document.getElementById("kDone").textContent = done;
  document.getElementById("kFail").textContent = fail;

  document.getElementById("rTotal").textContent = state.shipments.length;
  document.getElementById("rDone").textContent = done;
  document.getElementById("rFail").textContent = fail;

  countTxt.textContent = state.shipments.length;
}

function renderList(){
  const q = qEl.value.trim().toLowerCase();
  const items = state.shipments.filter(s=>{
    if(!q) return true;
    const t = `${s.type} ${s.tracking} ${shortTracking(s.tracking)} ${s.name} ${s.addr} ${s.phone}`.toLowerCase();
    return t.includes(q);
  });

  listEl.innerHTML = "";
  for(const s of items){
    const li = document.createElement("li");
    li.className = "shipItem";
    li.dataset.id = s.id;

    const badge = s.status==="done" ? `<span class="badge bDone">完了</span>` :
                  s.status==="fail" ? `<span class="badge bFail">不在/持戻</span>` :
                                      `<span class="badge bTodo">未配達</span>`;

    li.innerHTML = `
      <div class="shipTop">
        <div class="shipMain">
          <div class="shipName">${escapeHtml(s.name)} <span class="badge" style="margin-left:6px">${escapeHtml(s.type)}</span></div>
          <div class="shipSub">
            <span class="mono">${escapeHtml(shortTracking(s.tracking))}</span>
            ${s.tracking ? `<span class="muted">（${escapeHtml(s.tracking)}）</span>` : ""}
            <br/>
            ${escapeHtml(s.addr)} ${s.phone ? " / " + escapeHtml(s.phone) : ""}
          </div>
        </div>
        <div>${badge}</div>
      </div>

      <div class="shipBtns">
        <button class="btn btnSmall btnGhost" data-act="detail">詳細</button>
        <button class="btn btnSmall btnBlue" data-act="nav">Googleナビ</button>
        <button class="btn btnSmall btnYellow" data-act="done">完了（確認）</button>
        <button class="btn btnSmall btnRed" data-act="fail">不在/持戻</button>
      </div>
    `;

    li.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", ()=> handleListAction(s.id, b.dataset.act));
    });

    listEl.appendChild(li);
  }

  // enable drag reorder on the FULL list view (no search)
  if(!sortable){
    sortable = new Sortable(listEl, {
      animation:150,
      onEnd: (evt)=>{
        const ids = [...listEl.querySelectorAll(".shipItem")].map(x=>x.dataset.id);
        // reorder state.shipments to match visible order only when not searching
        if(qEl.value.trim()) return;
        const map = new Map(state.shipments.map(x=>[x.id,x]));
        state.shipments = ids.map(id=>map.get(id)).filter(Boolean);
        save();
      }
    });
  }
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function openGoogleNav(addr){
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`;
  window.open(url, "_blank");
}

function findById(id){ return state.shipments.find(x=>x.id===id); }

async function confirmByScanModal(s){
  // Require scan confirm if tracking exists OR allow last4 match
  const must = s.tracking ? `「${s.tracking}」` : "（伝票が無い場合は下4桁）";

  showModal("完了（誤配防止）", `
    <div class="help">配達先で荷物を取って<b>スキャン or 入力</b>して一致したら完了にします。</div>

    <label>確認方法</label>
    <div class="btnRow">
      <button class="btn btnBlue" id="cScan">バーコードで確認</button>
      <button class="btn btnGhost" id="cOCR">OCRで確認</button>
    </div>

    <label>手入力（伝票番号 or 下4桁）</label>
    <input id="cInput" class="mono" placeholder="例）950100015222 / 5222"/>

    <div class="btnRow">
      <button class="btn btnYellow" id="cOK">一致→完了</button>
      <button class="btn btnRed" id="cNG">キャンセル</button>
    </div>

    <div class="warnBox">
      期待値：${escapeHtml(must)}
    </div>
  `);

  document.getElementById("cNG").onclick = ()=> hideModal();

  document.getElementById("cScan").onclick = async ()=>{
    if(!track) return alert("先に②集荷でカメラ開始してください。");
    if(!barcodeDetector) return alert("この端末はバーコード自動読取に非対応です。OCRか手入力でお願いします。");
    const v = await scanBarcodeOnce();
    if(v){
      beep(); buzz();
      document.getElementById("cInput").value = v;
    }else{
      alert("検出できませんでした。角度/距離/明るさを調整してください。");
    }
  };

  document.getElementById("cOCR").onclick = async ()=>{
    if(!track) return alert("先に②集荷でカメラ開始してください。");
    const canvas = captureFrame();
    if(!canvas) return;
    try{
      const { data } = await Tesseract.recognize(canvas, "jpn");
      const text = data?.text || "";
      // try to find a long-ish code in OCR text
      const digits = text.replace(/[^\d]/g,"");
      const best = digits.length>=8 ? digits : "";
      if(best){
        beep(); buzz();
        document.getElementById("cInput").value = best;
      }else{
        alert("OCRから番号を推定できませんでした。手入力してください。");
      }
    }catch(e){
      alert("OCRに失敗しました。");
    }
  };

  document.getElementById("cOK").onclick = ()=>{
    const input = (document.getElementById("cInput").value||"").trim();
    const ok = matchTracking(s.tracking, input);
    if(!ok){
      alert("一致しません。誤配防止のため完了にできません。");
      return;
    }
    hideModal();
    setStatus(s.id, "done", "配達完了");
  };
}

function matchTracking(original, input){
  const a = (original||"").replace(/[^\dA-Za-z]/g,"").toLowerCase();
  const b = (input||"").replace(/[^\dA-Za-z]/g,"").toLowerCase();
  if(!b) return false;
  if(a && (a===b || a.includes(b) || b.includes(a))) return true;

  // last4 match
  const ad = (original||"").replace(/[^\d]/g,"");
  const bd = (input||"").replace(/[^\d]/g,"");
  if(ad.length>=4 && bd.length>=4){
    return ad.slice(-4) === bd.slice(-4);
  }
  // if original empty, allow any input (spot/no-slip) -> treat as ok
  if(!original) return true;
  return false;
}

function handleListAction(id, act){
  const s = findById(id);
  if(!s) return;

  if(act==="nav") return openGoogleNav(s.addr);
  if(act==="detail") return openDetailModal(s);
  if(act==="done") return confirmByScanModal(s);
  if(act==="fail") return setStatus(id, "fail", "不在/持戻");
}

function setStatus(id, status, note){
  const s = findById(id);
  if(!s) return;
  s.status = status;
  s.updatedAt = nowISO();
  s.events = s.events || [];
  s.events.push({at: nowISO(), kind: status, note: note || ""});
  beep(); buzz();
  save();
}

function openDetailModal(s){
  const latlng = (s.lat && s.lng) ? `${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}` : "未設定";
  showModal("配達詳細", `
    <div class="help">
      <b>${escapeHtml(s.name)}</b> / ${escapeHtml(s.type)}<br/>
      伝票：<span class="mono">${escapeHtml(s.tracking || "（なし）")}</span> / 表示：<span class="mono">${escapeHtml(shortTracking(s.tracking))}</span><br/>
      住所：${escapeHtml(s.addr)}<br/>
      電話：${escapeHtml(s.phone || "（なし）")}<br/>
      ピン：${escapeHtml(latlng)}
    </div>

    <label>メモ（置き配・特徴）</label>
    <input id="dMemo" value="${escapeHtml(s.memo||"")}" />

    <label>置き配写真（任意）</label>
    <input id="dPhoto" type="file" accept="image/*" capture="environment"/>
    <div style="margin-top:8px">
      <img id="dPrev" class="photoPreview" src="${s.photoDataUrl ? escapeHtml(s.photoDataUrl) : ""}" alt="">
    </div>

    <div class="btnRow">
      <button class="btn btnBlue" id="dNav">Googleナビ</button>
      <button class="btn btnYellow" id="dDone">完了（確認）</button>
      <button class="btn btnRed" id="dFail">不在/持戻</button>
    </div>

    <div class="btnRow">
      <button class="btn btnGhost" id="dFixPin">ピン修正（ドラッグ）</button>
      <button class="btn btnGhost" id="dSave">保存</button>
    </div>

    <h2 style="margin-top:14px">履歴</h2>
    <pre style="white-space:pre-wrap; margin:0; font-size:12px; color:var(--muted)">${escapeHtml((s.events||[]).map(e=>`${e.at}  ${e.kind}  ${e.note||""}`).join("\n"))}</pre>
  `);

  document.getElementById("dNav").onclick = ()=> openGoogleNav(s.addr);
  document.getElementById("dDone").onclick = ()=> confirmByScanModal(s);
  document.getElementById("dFail").onclick = ()=> setStatus(s.id, "fail", "不在/持戻");

  const memoInput = document.getElementById("dMemo");
  document.getElementById("dSave").onclick = ()=>{
    s.memo = memoInput.value || "";
    s.updatedAt = nowISO();
    save();
    hideModal();
  };

  const file = document.getElementById("dPhoto");
  const prev = document.getElementById("dPrev");
  file.onchange = async ()=>{
    const f = file.files && file.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f, 1200); // resize for storage
    s.photoDataUrl = dataUrl;
    prev.src = dataUrl;
    s.updatedAt = nowISO();
    save();
  };

  document.getElementById("dFixPin").onclick = ()=>{
    hideModal();
    showView("map");
    setTimeout(()=>{
      focusAndEditPin(s.id);
    }, 120);
  };
}

function fileToDataURL(file, maxW){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = ()=>{ img.src = reader.result; };
    reader.onerror = reject;
    img.onload = ()=>{
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL("image/jpeg", 0.82));
    };
    reader.readAsDataURL(file);
  });
}

/* ===========================
  Sorting helpers
=========================== */
let lastGPS = null;

async function getGPS(){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){
      setPill(gpsDot, gpsTxt, "bad", "NG");
      return resolve(null);
    }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const p = {lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy};
      lastGPS = p;
      setPill(gpsDot, gpsTxt, "ok", "OK");
      resolve(p);
    }, ()=>{
      setPill(gpsDot, gpsTxt, "warn", "許可待ち/NG");
      resolve(null);
    }, {enableHighAccuracy:true, timeout:8000, maximumAge:8000});
  });
}

function distKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat) * Math.PI/180;
  const dLng = (b.lng-a.lng) * Math.PI/180;
  const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
  const c = s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
  return 2*R*Math.asin(Math.sqrt(c));
}

async function sortByNear(){
  const g = await getGPS();
  if(!g) return alert("GPSが取れません。位置情報を許可してください。");
  state.shipments.sort((x,y)=>{
    const dx = (x.lat && x.lng) ? distKm(g, {lat:x.lat, lng:x.lng}) : 9999;
    const dy = (y.lat && y.lng) ? distKm(g, {lat:y.lat, lng:y.lng}) : 9999;
    return dx - dy;
  });
  save();
}

function sortByAddress(){
  state.shipments.sort((a,b)=>{
    return String(a.addr||"").localeCompare(String(b.addr||""), "ja");
  });
  save();
}
function sortByType(){
  state.shipments.sort((a,b)=>{
    return String(a.type||"").localeCompare(String(b.type||""), "ja");
  });
  save();
}
function sortByTime(){
  // placeholder: if you later add timeWindow. For now: keep order but group by has memo includes "午前/午後/時間"
  const score = (s)=>{
    const m = (s.memo||"");
    if(/午前|AM|9-|10-|11-/.test(m)) return 1;
    if(/12|13|14|15/.test(m)) return 2;
    if(/夕方|16|17|18|PM/.test(m)) return 3;
    return 9;
  };
  state.shipments.sort((a,b)=> score(a)-score(b));
  save();
}

/* ===========================
  Map (Leaflet - Canvas)
=========================== */
let map = null;
let markers = new Map(); // id -> marker
let canvasRenderer = null;

function initMapIfNeeded(){
  if(map) return;
  canvasRenderer = L.canvas({ padding: 0.5 });

  map = L.map("map", {
    zoomControl: true,
    preferCanvas: true,
  });

  // OSM tiles (fast, no key). You can switch to Google Maps externally for navigation.
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "© OpenStreetMap"
  }).addTo(map);

  map.setView([31.5966, 130.5571], 12); // default: Kagoshima

  map.on("moveend", ()=>{
    if(state.ui.showTodoOnly) drawPins();
  });
}

function mapInvalidate(){
  if(map) map.invalidateSize();
}

async function centerToGPS(){
  const g = await getGPS();
  if(!g || !map) return;
  map.setView([g.lat, g.lng], 15, {animate:true});
}

document.getElementById("btnLocate").addEventListener("click", centerToGPS);
document.getElementById("btnFollow").addEventListener("click", async ()=>{
  state.ui.follow = !state.ui.follow;
  document.getElementById("btnFollow").textContent = `追従：${state.ui.follow ? "ON":"OFF"}`;
  save();

  if(state.ui.follow){
    const g = await getGPS();
    if(g && map) map.setView([g.lat, g.lng], 15, {animate:true});
  }
});
document.getElementById("btnShowTodo").addEventListener("click", ()=>{
  state.ui.showTodoOnly = !state.ui.showTodoOnly;
  document.getElementById("btnShowTodo").textContent = state.ui.showTodoOnly ? "未配達だけ：ON" : "未配達だけ";
  save();
  drawPins();
});
document.getElementById("btnRefreshPins").addEventListener("click", drawPins);

function clearPins(){
  for(const m of markers.values()){
    m.remove();
  }
  markers.clear();
}

function pinColor(s){
  if(s.status==="done") return "#22c55e";
  if(s.status==="fail") return "#ef4444";
  return "#1e88e5";
}

function drawPins(){
  if(!map) return;
  clearPins();

  const items = state.shipments.filter(s=>{
    if(state.ui.showTodoOnly) return s.status==="todo";
    return true;
  });

  // render pins (circle markers) using canvas for performance
  for(const s of items){
    if(!(s.lat && s.lng)) continue;

    const m = L.circleMarker([s.lat, s.lng], {
      radius: 8,
      color: pinColor(s),
      weight: 2,
      fillColor: pinColor(s),
      fillOpacity: 0.9,
      renderer: canvasRenderer
    }).addTo(map);

    m.on("click", ()=> openMapPinModal(s.id));
    markers.set(s.id, m);
  }
}

async function openMapPinModal(id){
  const s = findById(id);
  if(!s) return;

  showModal("ピン操作", `
    <div class="help">
      <b>${escapeHtml(s.name)}</b> / ${escapeHtml(s.type)}<br/>
      <span class="mono">${escapeHtml(shortTracking(s.tracking))}</span> / ${escapeHtml(s.addr)}
    </div>

    <div class="btnRow">
      <button class="btn btnBlue" id="pNav">Googleナビ</button>
      <button class="btn btnYellow" id="pDone">完了（確認）</button>
      <button class="btn btnRed" id="pFail">不在/持戻</button>
    </div>

    <label>メモ</label>
    <input id="pMemo" value="${escapeHtml(s.memo||"")}" />

    <div class="btnRow">
      <button class="btn btnGhost" id="pSave">保存</button>
      <button class="btn btnGhost" id="pFix">ピン修正（ドラッグ）</button>
    </div>

    <div class="help">※地図からでもリストからでも操作できます。</div>
  `);

  document.getElementById("pNav").onclick = ()=> openGoogleNav(s.addr);
  document.getElementById("pDone").onclick = ()=> confirmByScanModal(s);
  document.getElementById("pFail").onclick = ()=> setStatus(s.id, "fail", "不在/持戻");

  document.getElementById("pSave").onclick = ()=>{
    s.memo = document.getElementById("pMemo").value || "";
    s.updatedAt = nowISO();
    save();
    hideModal();
  };

  document.getElementById("pFix").onclick = ()=>{
    hideModal();
    focusAndEditPin(s.id);
  };
}

function focusAndEditPin(id){
  const s = findById(id);
  if(!s || !map) return;
  if(!(s.lat && s.lng)){
    alert("この荷物はピンが未設定です。住所を修正して再度追加するか、詳細から手動入力してください。");
    return;
  }
  map.setView([s.lat, s.lng], Math.max(map.getZoom(), 16), {animate:true});

  // Temporary draggable marker to set new position
  const temp = L.marker([s.lat, s.lng], {draggable:true}).addTo(map);
  temp.bindPopup("ドラッグして位置を修正 → 決定").openPopup();

  temp.on("dragend", ()=>{
    const p = temp.getLatLng();
    showModal("ピン修正（決定）", `
      <div class="help">新しい位置：${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</div>
      <div class="btnRow">
        <button class="btn btnYellow" id="fixOk">この位置で決定</button>
        <button class="btn btnGhost" id="fixCancel">キャンセル</button>
      </div>
    `);
    document.getElementById("fixCancel").onclick = ()=>{
      temp.remove();
      hideModal();
    };
    document.getElementById("fixOk").onclick = ()=>{
      s.lat = p.lat; s.lng = p.lng;
      s.updatedAt = nowISO();
      save();
      temp.remove();
      hideModal();
      drawPins();
      alert("ピン位置を更新しました。");
    };
  });
}

/* ===========================
  Report Export
=========================== */
document.getElementById("btnCSV").addEventListener("click", ()=>{
  const rows = [
    ["day","id","type","tracking","tracking_last4","name","zip","addr","phone","memo","status","lat","lng","createdAt","updatedAt"].join(",")
  ];
  for(const s of state.shipments){
    rows.push([
      todayKey(),
      s.id,
      s.type,
      s.tracking||"",
      shortTracking(s.tracking),
      s.name||"",
      s.zip||"",
      s.addr||"",
      s.phone||"",
      (s.memo||"").replace(/\n/g," "),
      s.status||"",
      s.lat??"",
      s.lng??"",
      s.createdAt||"",
      s.updatedAt||"",
    ].map(csvEscape).join(","));
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  downloadBlob(blob, `OFA_delivery_${todayKey()}.csv`);
});

function csvEscape(v){
  const s = String(v ?? "");
  if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById("btnPDF").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});

  const W = doc.internal.pageSize.getWidth();
  let y = 40;

  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("OFA 配達日報", 40, y);
  y += 18;

  doc.setFont("helvetica","normal");
  doc.setFontSize(11);
  doc.text(`日付：${todayKey()}`, 40, y);
  y += 14;

  const done = state.shipments.filter(x=>x.status==="done").length;
  const fail = state.shipments.filter(x=>x.status==="fail").length;
  const todo = state.shipments.filter(x=>x.status==="todo").length;
  doc.text(`総数：${state.shipments.length}  完了：${done}  不在/持戻：${fail}  未配達：${todo}`, 40, y);
  y += 18;

  if(tenko && tenko.day===todayKey()){
    doc.setFont("helvetica","bold"); doc.text("点呼", 40, y); y += 14;
    doc.setFont("helvetica","normal");
    doc.text(`開始: ${tenko.start||"-"}  アルコール: ${tenko.alcohol||"-"}  体調: ${tenko.health}`, 40, y); y+=14;
    doc.text(`点検: ${(tenko.checks||[]).join(" / ") || "-"}`, 40, y); y+=14;
    doc.text(`メモ: ${tenko.memo||"-"}`, 40, y); y+=18;
  }

  doc.setFont("helvetica","bold");
  doc.text("一覧", 40, y);
  y += 14;

  doc.setFont("helvetica","normal");
  doc.setFontSize(9);

  const header = ["状態","種別","下4桁","名前","住所"];
  const col = [40, 90, 140, 200, 300];

  doc.text(header[0], col[0], y);
  doc.text(header[1], col[1], y);
  doc.text(header[2], col[2], y);
  doc.text(header[3], col[3], y);
  doc.text(header[4], col[4], y);
  y += 10;
  doc.line(40, y, W-40, y);
  y += 12;

  for(const s of state.shipments){
    if(y > 780){ doc.addPage(); y = 40; }
    const st = s.status==="done" ? "完了" : s.status==="fail" ? "不在" : "未";
    const line1 = `${s.addr||""}`.slice(0, 34);

    doc.text(st, col[0], y);
    doc.text(String(s.type||"").slice(0,6), col[1], y);
    doc.text(String(shortTracking(s.tracking||"")).replace("****",""), col[2], y);
    doc.text(String(s.name||"").slice(0,10), col[3], y);
    doc.text(line1, col[4], y);
    y += 14;
  }

  doc.save(`OFA_delivery_${todayKey()}.pdf`);
});

document.getElementById("btnBackup").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json;charset=utf-8"});
  downloadBlob(blob, `OFA_delivery_backup_${todayKey()}.json`);
});

document.getElementById("btnReset").addEventListener("click", ()=>{
  if(!confirm("端末の全データ（荷物・履歴）を削除します。よろしいですか？")) return;
  state.shipments = [];
  save();
  alert("削除しました。");
});

/* ===========================
  Modal
=========================== */
const modal = document.getElementById("modal");
const mTitle = document.getElementById("mTitle");
const mBody = document.getElementById("mBody");
document.getElementById("mClose").addEventListener("click", hideModal);

function showModal(title, html){
  mTitle.textContent = title;
  mBody.innerHTML = html;
  modal.classList.add("show");
}
function hideModal(){
  modal.classList.remove("show");
  mTitle.textContent = "";
  mBody.innerHTML = "";
}

/* ===========================
  GPS init and pin auto
=========================== */
async function initGPSOnce(){
  const g = await getGPS();
  if(g && map) map.setView([g.lat, g.lng], 14);
}

/* ===========================
  Render All
=========================== */
function renderAll(){
  calcKPIs();
  renderList();

  // map
  if(map){
    drawPins();
    if(state.ui.follow){
      getGPS().then(g=>{
        if(g) map.setView([g.lat,g.lng], Math.max(map.getZoom(), 15), {animate:true});
      });
    }
  }

  // report KPIs already updated
  renderTenkoOut();
}

function boot(){
  load();
  loadTenko();
  renderTenkoOut();

  // default tenko time
  if(!tenkoStart.value){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    tenkoStart.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // initial pills
  setPill(camDot, camTxt, "warn", "未");
  setPill(gpsDot, gpsTxt, "warn", "未");
  setPill(torchDot, torchTxt, "warn", "OFF");

  // initial render
  renderAll();

  // try GPS
  getGPS();

  // hint about barcode detector
  if(!("BarcodeDetector" in window)){
    // show a gentle note once
    // (No blocking alert - iPhone users will be many)
  }
}
boot();
</script>
</body>
</html>
