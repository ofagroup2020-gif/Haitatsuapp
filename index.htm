<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼šMAP/è¿‘ã„é †/å¿…é ˆå…¥åŠ›ï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Barcode (ZXing) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- OCR (Tesseract) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<!-- Map (Leaflet + OSM tiles) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --ofa-yellow:#FFD400;
    --ofa-red:#E53935;
    --ofa-blue:#1565C0;

    --bg:#F5F7FB;
    --card:#fff;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e2e8f0;
    --shadow:0 12px 34px rgba(15,23,42,.10);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1000px 500px at 10% -10%, rgba(255,212,0,.35), transparent 60%),
      radial-gradient(900px 480px at 100% 0%, rgba(21,101,192,.18), transparent 60%),
      radial-gradient(900px 480px at 70% 110%, rgba(229,57,53,.10), transparent 60%),
      var(--bg);
  }
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,.90);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
  }
  .top{
    max-width:1200px; margin:0 auto;
    padding:12px 14px 8px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand{display:flex; gap:10px; align-items:center;}
  .logo{
    width:42px;height:42px;border-radius:14px;
    background:linear-gradient(135deg,var(--ofa-yellow),#fff2a8);
    display:grid; place-items:center;
    font-weight:900;
    box-shadow:0 12px 26px rgba(255,212,0,.25);
  }
  .ttl b{display:block; font-size:14px}
  .ttl small{display:block; color:var(--muted); font-size:11px; margin-top:2px}
  .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-size:12px; color:var(--muted);
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    white-space:nowrap;
  }
  .chip b{color:var(--ink)}
  nav{
    max-width:1200px; margin:0 auto;
    padding:0 14px 12px;
    display:flex; gap:10px;
  }
  .tab{
    flex:1;
    padding:12px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900;
    font-size:12px;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    cursor:pointer;
  }
  .tab.active{
    background:linear-gradient(135deg, rgba(21,101,192,.10), rgba(255,212,0,.18));
    border-color:rgba(21,101,192,.25);
  }

  main{max-width:1200px; margin:0 auto; padding:12px 14px 18px; display:grid; gap:12px;}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r);
    padding:14px;
    box-shadow:var(--shadow);
  }
  .card h2{margin:0 0 10px; font-size:14px}
  .row{display:grid; gap:10px}
  @media(min-width:880px){
    .row.two{grid-template-columns: 1fr 1fr;}
    .row.three{grid-template-columns: 1fr 1fr 1fr;}
    .row.four{grid-template-columns: 1fr 1fr 1fr 1fr;}
  }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, textarea{
    width:100%;
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  textarea{min-height:86px; resize:vertical}
  .btns{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  button{
    border:0; border-radius:16px;
    padding:12px 12px;
    font-weight:900;
    cursor:pointer;
    font-size:13px;
  }
  .btn-primary{background:linear-gradient(135deg,var(--ofa-yellow),#ffe77a); color:#111;}
  .btn-blue{background:linear-gradient(135deg, rgba(21,101,192,.95), rgba(21,101,192,.75)); color:#fff;}
  .btn-ghost{background:#fff; border:1px solid var(--line); color:var(--ink);}
  .btn-ok{background:rgba(16,185,129,.10); border:1px solid rgba(16,185,129,.25); color:#065f46;}
  .btn-warn{background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.25); color:#7c2d12;}
  .btn-bad{background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.25); color:#7f1d1d;}
  .mini{color:var(--muted); font-size:11px; line-height:1.6}
  .hr{height:1px; background:var(--line); margin:12px 0}

  .scanWrap{
    border:1px dashed rgba(21,101,192,.28);
    background:linear-gradient(135deg, rgba(21,101,192,.05), rgba(255,212,0,.12));
    border-radius:18px;
    padding:12px;
  }
  .camBox{
    display:none;
    margin-top:10px;
    overflow:hidden;
    border-radius:16px;
    border:1px solid var(--line);
    background:#000;
  }
  video{width:100%; height:auto; display:block;}

  .kindBar{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .kindBtn{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .kindBtn.active{
    background:linear-gradient(135deg, rgba(255,212,0,.35), rgba(21,101,192,.10));
    border-color:rgba(255,212,0,.55);
  }

  .toolbar{
    display:flex; flex-wrap:wrap; gap:10px;
    align-items:flex-end; justify-content:space-between;
  }
  .kpis{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
  .kpi{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px 12px;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    min-width:130px;
  }
  .kpi small{display:block; color:var(--muted); font-size:11px}
  .kpi b{display:block; font-size:18px; margin-top:2px}

  .list{display:grid; gap:10px; margin-top:12px}
  .item{
    border:1px solid var(--line);
    border-radius:18px;
    padding:12px;
    background:#fff;
  }
  .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
  .tag{
    font-weight:900; font-size:11px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--line);
    white-space:nowrap;
  }
  .st-created{background:#f9fafb; color:var(--muted)}
  .st-out{background:rgba(21,101,192,.10); border-color:rgba(21,101,192,.22); color:#0b3a7a}
  .st-done{background:rgba(16,185,129,.10); border-color:rgba(16,185,129,.22); color:#065f46}
  .st-absent{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25); color:#7c2d12}
  .st-post{background:rgba(99,102,241,.10); border-color:rgba(99,102,241,.22); color:#3730a3}
  .st-return{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.22); color:#7f1d1d}

  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#f8fafc;
    font-weight:900;
    font-size:12px;
    margin-right:8px;
  }
  .meta{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.55}
  .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
  .btn-mini{padding:10px 10px; border-radius:14px; font-size:12px;}

  /* Map */
  #map{
    width:100%;
    height:65vh;
    border-radius:18px;
    border:1px solid var(--line);
    overflow:hidden;
  }

  /* Modal */
  .modalBack{
    position:fixed; inset:0; z-index:9990;
    background:rgba(15,23,42,.40);
    display:none;
    align-items:flex-end;
    justify-content:center;
  }
  .modal{
    width:min(1020px, 100%);
    background:#fff;
    border-top-left-radius:22px;
    border-top-right-radius:22px;
    border:1px solid var(--line);
    box-shadow:0 20px 60px rgba(0,0,0,.22);
    padding:14px;
    max-height:90vh;
    overflow:auto;
  }
  .modal h3{margin:0 0 10px; font-size:14px}
  .pillRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .pill{
    padding:8px 10px; border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:900; font-size:12px;
    cursor:pointer;
  }
  .pill.active{background:linear-gradient(135deg, rgba(255,212,0,.30), rgba(21,101,192,.10)); border-color:rgba(255,212,0,.55)}
  .progress{
    height:10px; border-radius:999px; border:1px solid var(--line);
    background:#f8fafc; overflow:hidden;
  }
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--ofa-yellow), var(--ofa-blue));}

  .warnBox{
    background:rgba(245,158,11,.10);
    border:1px solid rgba(245,158,11,.25);
    color:#7c2d12;
    border-radius:16px;
    padding:10px 12px;
    font-weight:900;
    font-size:12px;
  }
</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div class="ttl">
        <b>é…é”ã‚¢ãƒ—ãƒªï¼ˆMAP/è¿‘ã„é †/å¿…é ˆå…¥åŠ›ï¼‰</b>
        <small>SCAN â†’ ä½æ‰€/åå‰ â†’ åœ°å›³ãƒ”ãƒ³ â†’ ã‚¿ãƒƒãƒ—ã§å®Œäº†/ä¸åœ¨ â†’ æ—¥å ±</small>
      </div>
    </div>
    <div class="chips">
      <div class="chip">GPSï¼š<b id="gpsState">æœªå–å¾—</b></div>
      <div class="chip">ãƒ©ã‚¤ãƒˆï¼š<b id="torchState">æœªå¯¾å¿œ</b></div>
      <div class="chip">ä¸¦ã³ï¼š<b id="sortState">æœªè¨­å®š</b></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="list">ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="map">åœ°å›³</button>
    <button class="tab" data-tab="report">æ—¥å ±</button>
  </nav>
</header>

<main>

  <!-- SCAN -->
  <section id="tab-scan" class="card">
    <h2>â‘  SCANï¼ˆæœ€é€Ÿç™»éŒ² â†’ ã‚ã¨ã§ä½æ‰€/åå‰ã‚’åŸ‹ã‚ã‚‹ï¼‰</h2>

    <div class="scanWrap">
      <div class="row three">
        <div>
          <label>é…é”æ—¥</label>
          <input id="shipDate" type="date" />
        </div>
        <div>
          <label>é…é”å“¡å</label>
          <input id="driver" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸" />
        </div>
        <div>
          <label>å–å¼•å…ˆï¼ˆä»»æ„ï¼‰</label>
          <input id="client" type="text" placeholder="ä¾‹ï¼šãƒ¤ãƒãƒˆ / ä½å· / Amazonâ€¦" />
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <div class="mini"><b>è·ç‰©ç¨®åˆ¥ï¼ˆæ¬¡ã«ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹è·ç‰©ã¸è‡ªå‹•ä»˜ä¸ï¼‰</b></div>
        <div class="kindBar" id="kindBar"></div>
      </div>

      <div class="hr"></div>

      <div class="row two">
        <div>
          <label>æ‰‹å…¥åŠ›ï¼ˆèª­ã‚ãªã„æ™‚ï¼‰</label>
          <input id="manualCode" type="text" placeholder="ä¼ç¥¨ç•ªå·ï¼ˆç©ºãªã‚‰TEMPï¼‰" />
          <div class="mini" style="margin-top:6px;">â€»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå¼±ã„ç¾å ´ã¯ã€Œä»®ç™»éŒ²â†’é…é”å‰ã«ä½æ‰€/åå‰ã‚’åŸ‹ã‚ã‚‹ã€é‹ç”¨ãŒä¸€ç•ªé€Ÿã„ã€‚</div>
        </div>
        <div>
          <label>æ“ä½œ</label>
          <div class="btns">
            <button class="btn-blue" id="btnGPS">ğŸ“GPS</button>
            <button class="btn-primary" id="btnStartScan">ğŸ“·SCANé–‹å§‹</button>
            <button class="btn-ghost" id="btnStopScan" style="display:none;">åœæ­¢</button>
            <button class="btn-ghost" id="btnTorch" disabled>ğŸ”¦ãƒ©ã‚¤ãƒˆ</button>
          </div>
        </div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button class="btn-ghost" id="btnAddManual">ï¼‹æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
        <button class="btn-ghost" id="btnTemp">ï¼‹èª­ã‚ãªã„â†’ä»®ç™»éŒ²ï¼ˆTEMPï¼‰</button>
        <button class="btn-ghost" id="btnGoFill">ğŸ“ ä½æ‰€/åå‰ã‚’åŸ‹ã‚ã‚‹ï¼ˆæœªå…¥åŠ›ã ã‘ï¼‰</button>
      </div>

      <div class="camBox" id="camBox">
        <video id="video" playsinline></video>
      </div>
    </div>
  </section>

  <!-- LIST -->
  <section id="tab-list" class="card" style="display:none;">
    <h2>â‘¡ ãƒªã‚¹ãƒˆï¼ˆè¿‘ã„é †OK / å¿…é ˆå…¥åŠ›ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰</h2>

    <div class="toolbar">
      <div class="row four" style="margin:0; min-width:min(980px,100%);">
        <div>
          <label>æ—¥ä»˜</label>
          <input id="filterDate" type="date" />
        </div>
        <div>
          <label>çŠ¶æ…‹</label>
          <select id="filterStatus">
            <option value="created">æœªæŒå‡º</option>
            <option value="out">æŒå‡º</option>
            <option value="done">å®Œäº†</option>
            <option value="absent">ä¸åœ¨</option>
            <option value="post">æŠ•å‡½</option>
            <option value="return">è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div>
          <label>ä¸¦ã³æ›¿ãˆ</label>
          <select id="sortMode">
            <option value="createdAt">ç™»éŒ²é †</option>
            <option value="distance">è¿‘ã„é †ï¼ˆGPSå¿…è¦ï¼‰</option>
          </select>
        </div>
        <div>
          <label>æ¤œç´¢ï¼ˆç•ªå·/åå‰/ä½æ‰€/ç¨®åˆ¥ï¼‰</label>
          <input id="filterText" type="text" placeholder="ä¾‹ï¼šç›¸ç”° / å¤§æ­£åŒº / æ‰‹ç´™ / 1234" />
        </div>
      </div>

      <div class="btns">
        <button class="btn-primary btn-mini" id="btnBulkOut">ğŸššæŒå‡ºä¸€æ‹¬</button>
        <button class="btn-ghost btn-mini" id="btnGeoMissing">ğŸ“Œ ä½æ‰€â†’ãƒ”ãƒ³ä½œæˆï¼ˆæœªä½œæˆã®ã¿ï¼‰</button>
        <button class="btn-ghost btn-mini" id="btnNext">â–¶æ¬¡ã®æœªå®Œã¸</button>
      </div>
    </div>

    <div class="kpis" id="kpis"></div>
    <div class="list" id="historyList"></div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btn-ghost" id="btnExportCSV">CSVå‡ºåŠ›</button>
      <button class="btn-ghost" id="btnExportPDF">PDFå‡ºåŠ›</button>
      <button class="btn-bad" id="btnClearAll">å…¨å‰Šé™¤ï¼ˆæ³¨æ„ï¼‰</button>
    </div>
  </section>

  <!-- MAP -->
  <section id="tab-map" class="card" style="display:none;">
    <h2>â‘¢ åœ°å›³ï¼ˆãƒ”ãƒ³â†’ã‚¿ãƒƒãƒ—â†’å®Œäº†/ä¸åœ¨ï¼‰</h2>

    <div class="row two">
      <div class="warnBox">
        âœ… ãƒ”ãƒ³è¡¨ç¤ºã«ã¯ <b>ä½æ‰€â†’åº§æ¨™</b> ãŒå¿…è¦ã§ã™ã€‚<br>
        ã€ŒğŸ“Œä½æ‰€â†’ãƒ”ãƒ³ä½œæˆã€ã‚’æŠ¼ã™ã¨æœªä½œæˆã®ã‚‚ã®ã‚’è‡ªå‹•ã§ä½œã‚Šã¾ã™ï¼ˆç„¡æ–™ã®OSMã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä½¿ç”¨ï¼‰ã€‚
      </div>
      <div class="btns" style="justify-content:flex-end;">
        <button class="btn-blue" id="btnMapCenter">ğŸ¯ ç¾åœ¨åœ°ã¸</button>
        <button class="btn-ghost" id="btnMapReload">ğŸ”„ ãƒ”ãƒ³æ›´æ–°</button>
      </div>
    </div>

    <div style="margin-top:10px;" id="map"></div>

    <div class="mini" style="margin-top:10px;">
      â€»ãƒŠãƒ“ã¯Googleãƒãƒƒãƒ—ã¸é£›ã³ã¾ã™ï¼ˆæœ€ã‚‚å®‰å®šï¼‰ã€‚<br>
      â€»OSM/Nominatimã¯ç„¡æ–™ã®ãŸã‚ã€å¤§é‡é€£ç¶šã§ä½æ‰€å¤‰æ›ã™ã‚‹ã¨é…ããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ï¼‰ã€‚
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="card" style="display:none;">
    <h2>â‘£ æ—¥å ±ï¼ˆPDF/CSVï¼‰</h2>

    <div class="row two">
      <div>
        <label>å¯¾è±¡æ—¥</label>
        <input id="reportDate" type="date" />
      </div>
      <div>
        <label>é…é”å“¡åï¼ˆå°å­—ï¼‰</label>
        <input id="reportDriver" type="text" placeholder="æœªå…¥åŠ›ãªã‚‰SCANã®é…é”å“¡å" />
      </div>
    </div>

    <div class="kpis" id="reportKpis"></div>

    <div class="hr"></div>
    <div class="btns">
      <button class="btn-primary" id="btnReportCSV">CSVå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
      <button class="btn-primary" id="btnReportPDF">PDFå‡ºåŠ›ï¼ˆæ—¥å ±ï¼‰</button>
    </div>
  </section>

</main>

<!-- DETAIL / OCR Modal -->
<div class="modalBack" id="modalBack" onclick="if(event.target.id==='modalBack') closeModal();">
  <div class="modal">
    <h3 id="modalTitle">è©³ç´°</h3>
    <div class="mini" id="modalSub"></div>

    <div class="hr"></div>

    <div id="requiredWarn" class="warnBox" style="display:none;">
      âš ï¸ <b>ä½æ‰€ã¨åå‰ãŒå¿…é ˆ</b>ã§ã™ï¼ˆå®Œäº†/ä¸åœ¨ã®å‰ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>

    <div class="row three" style="margin-top:10px;">
      <div>
        <label>è·ç‰©ã‚³ãƒ¼ãƒ‰ï¼ˆä¼ç¥¨/ç®¡ç†ç•ªå·ï¼‰</label>
        <input id="mCode" />
      </div>
      <div>
        <label>è·ç‰©ç¨®åˆ¥</label>
        <select id="mKind"></select>
      </div>
      <div>
        <label>å—å–äººåï¼ˆå¿…é ˆï¼‰</label>
        <input id="mName" placeholder="ä¾‹ï¼šç›¸ç”° å¹¸ä¹ƒ" />
      </div>
    </div>

    <div class="row three" style="margin-top:10px;">
      <div style="grid-column:span 2;">
        <label>ä½æ‰€ï¼ˆå¿…é ˆï¼šãƒŠãƒ“/ãƒ”ãƒ³ç”¨ï¼‰</label>
        <input id="mAddress" placeholder="ä¾‹ï¼šå¤§é˜ªå¸‚å¤§æ­£åŒºå¹³å°¾4ä¸ç›®17-3 å·å¿ ãƒ“ãƒ«" />
      </div>
      <div>
        <label>é›»è©±ï¼ˆä»»æ„ï¼‰</label>
        <input id="mPhone" placeholder="090â€¦" />
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>åº§æ¨™ï¼ˆãƒ”ãƒ³ï¼‰</label>
        <input id="mLatLng" placeholder="ä¾‹ï¼š34.6699,135.4601ï¼ˆè‡ªå‹•å¯ï¼‰" />
        <div class="btns" style="margin-top:8px;">
          <button class="btn-ghost btn-mini" onclick="geoFromModal()">ğŸ“Œ ä½æ‰€â†’åº§æ¨™</button>
          <button class="btn-ghost btn-mini" onclick="clearLatLng()">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <div>
        <label>ãƒ¡ãƒ¢</label>
        <textarea id="mMemo" placeholder="ç½®ãé…ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
      </div>
    </div>

    <div class="hr"></div>

    <div>
      <div class="mini"><b>è©³ç´°ã‚¿ã‚°ï¼ˆä»»æ„ï¼šè¤‡æ•°ï¼‰</b></div>
      <div class="pillRow" id="tagPills"></div>
    </div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-blue" onclick="navFromModal()">ğŸ—º ãƒŠãƒ“ï¼ˆGoogleï¼‰</button>
      <button class="btn-ghost" onclick="copyAddress()">ğŸ“‹ ä½æ‰€ã‚³ãƒ”ãƒ¼</button>
      <button class="btn-ghost" onclick="callPhone()">â˜ï¸ é›»è©±</button>
      <button class="btn-ghost" onclick="runOCRFile()">ğŸ…¾ï¸ å†™çœŸã‹ã‚‰OCR</button>
      <button class="btn-ghost" onclick="captureOCRFromCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‹ã‚‰OCR</button>
    </div>

    <div style="margin-top:10px;">
      <div class="mini"><b>OCRé€²æ—</b></div>
      <div class="progress"><div class="bar" id="ocrBar"></div></div>
      <div class="mini" id="ocrStatus" style="margin-top:6px;">æœªå®Ÿè¡Œ</div>
      <div class="pillRow" id="ocrCandidates" style="margin-top:10px;"></div>
      <div class="mini" style="margin-top:6px;">â€»å€™è£œã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€Œä½æ‰€/åå‰/ã‚³ãƒ¼ãƒ‰ã€ã«åæ˜ ã—ã¾ã™ã€‚</div>
    </div>

    <div class="hr"></div>

    <div class="btns">
      <button class="btn-primary" onclick="saveModal()">ä¿å­˜</button>
      <button class="btn-ok" onclick="doneFromModal()">å®Œäº†/æŠ•å‡½</button>
      <button class="btn-warn" onclick="absentFromModal()">ä¸åœ¨</button>
      <button class="btn-bad" onclick="deleteFromModal()">å‰Šé™¤</button>
      <button class="btn-ghost" onclick="closeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<canvas id="capCanvas" style="display:none;"></canvas>

<script>
/* =========================
   Storage / Const
========================= */
const STORAGE_KEY = "ofa_delivery_app_v4_map";
const GEO_CACHE_KEY = "ofa_geo_cache_v1"; // address -> {lat,lng,display}
const STATUS = {
  created: "æœªæŒå‡º",
  out: "æŒå‡º",
  done: "å®Œäº†",
  absent: "ä¸åœ¨",
  post: "æŠ•å‡½",
  return: "è¿”å´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
};
const statusClass = (s)=>({
  created:"st-created",
  out:"st-out",
  done:"st-done",
  absent:"st-absent",
  post:"st-post",
  return:"st-return"
}[s]||"st-created");

const KINDS = [
  "å®…é…","æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰","ãƒã‚¹ãƒˆæŠ•å‡½","æ›¸é¡","å†·è”µãƒ»å†·å‡","ä»£å¼•","å¤§ç‰©","å£Šã‚Œç‰©","åŒ»ç™‚å“","å»ºæ","ãã®ä»–"
];
const TAGS = ["ã‚¢ãƒ‘ãƒ¬ãƒ«","é›‘è²¨","é£Ÿå“","åŒ»ç™‚","å»ºæ","ç²¾å¯†æ©Ÿå™¨","å‰²ã‚Œç‰©æ³¨æ„","æ™‚é–“æŒ‡å®š","ç½®ãé…","è¦ã‚µã‚¤ãƒ³","è¦è¿”é€"];

let gps = {lat:null, lng:null, at:null};
let currentKind = "å®…é…";
let list = load();
let geoCache = loadGeoCache();

/* =========================
   Helpers
========================= */
const pad = n => String(n).padStart(2,"0");
const today = new Date();
const todayStr = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;
function nowISO(){
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function uid(){
  return "S" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function load(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function loadGeoCache(){
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); } catch { return {}; }
}
function saveGeoCache(){
  localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache));
}
function normalizeCode(code){ return String(code||"").trim(); }
function nextTempCode(){
  const n = list.filter(x=>String(x.code||"").startsWith("TEMP-")).length + 1;
  return `TEMP-${String(n).padStart(4,"0")}`;
}
function isDuplicate(shipDate, code){
  return list.some(x => x.shipDate===shipDate && x.code===code);
}
function haversineKm(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function parseLatLng(s){
  const m = String(s||"").match(/(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/);
  if(!m) return null;
  return {lat: Number(m[1]), lng: Number(m[3])};
}

/* =========================
   Init UI
========================= */
document.getElementById("shipDate").value = todayStr;
document.getElementById("filterDate").value = todayStr;
document.getElementById("reportDate").value = todayStr;

initKinds();
initModalKinds();
initTagPills();
renderList();
renderReport();

/* Tabs */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    const name = btn.dataset.tab;
    document.querySelectorAll("main section").forEach(sec=>sec.style.display="none");
    document.getElementById("tab-"+name).style.display="block";
    if(name==="list") renderList();
    if(name==="report") renderReport();
    if(name==="map") { ensureMap(); refreshMapPins(true); }
  });
});

/* Filters */
["filterDate","filterStatus","filterText"].forEach(id=>{
  document.getElementById(id).addEventListener("input", renderList);
});
document.getElementById("sortMode").addEventListener("change", renderList);

/* =========================
   GPS
========================= */
const gpsState = document.getElementById("gpsState");
document.getElementById("btnGPS").addEventListener("click", getGPS);

function getGPS(){
  if(!navigator.geolocation){
    toast("GPSéå¯¾å¿œ");
    return;
  }
  gpsState.textContent = "å–å¾—ä¸­â€¦";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gps.lat = pos.coords.latitude;
      gps.lng = pos.coords.longitude;
      gps.at = nowISO();
      gpsState.textContent = "OK";
      toast("GPSå–å¾—OK");
      // è·é›¢ä¸¦ã³ã®å†è¨ˆç®—
      renderList();
      if(map){ centerToGPS(); }
    },
    ()=>{
      gpsState.textContent = "å¤±æ•—";
      toast("GPSå¤±æ•—ï¼šè¨±å¯ã‚’ç¢ºèª");
    },
    { enableHighAccuracy:true, timeout:12000 }
  );
}

/* =========================
   Kind buttons
========================= */
function initKinds(){
  const bar = document.getElementById("kindBar");
  bar.innerHTML = "";
  const topKinds = ["å®…é…","æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰","ãƒã‚¹ãƒˆæŠ•å‡½","å†·è”µãƒ»å†·å‡","ä»£å¼•","å¤§ç‰©","å£Šã‚Œç‰©","æ›¸é¡","ãã®ä»–"];
  topKinds.forEach(k=>{
    const b = document.createElement("button");
    b.className = "kindBtn" + (k===currentKind ? " active" : "");
    b.textContent = k.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","");
    b.onclick = ()=>{
      currentKind = k;
      [...bar.children].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      toast("ç¨®åˆ¥ï¼š" + k);
    };
    bar.appendChild(b);
  });
}
function initModalKinds(){
  const sel = document.getElementById("mKind");
  sel.innerHTML = "";
  KINDS.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });
}
function initTagPills(){
  const box = document.getElementById("tagPills");
  box.innerHTML = "";
  TAGS.forEach(t=>{
    const p = document.createElement("button");
    p.className = "pill";
    p.textContent = t;
    p.onclick = ()=> p.classList.toggle("active");
    box.appendChild(p);
  });
}

/* =========================
   Add shipment
========================= */
function getBaseFields(){
  const shipDate = document.getElementById("shipDate").value || todayStr;
  const driver = (document.getElementById("driver").value || "").trim();
  const client = (document.getElementById("client").value || "").trim();
  return { shipDate, driver, client };
}

function addShipment(code, forceTemp=false){
  const base = getBaseFields();
  let c = normalizeCode(code);

  if(forceTemp || !c) c = nextTempCode();
  if(isDuplicate(base.shipDate, c)) return false;

  const item = {
    id: uid(),
    shipDate: base.shipDate,
    driver: base.driver,
    client: base.client,
    kind: currentKind,
    tags: [],
    code: c,

    // âœ…å¿…é ˆé …ç›®ï¼ˆæœ€åˆã¯ç©ºã§ã‚‚OKã€å®Œäº†/ä¸åœ¨æ™‚ã«å¼·åˆ¶å…¥åŠ›ï¼‰
    name: "",
    address: "",
    phone: "",
    memo: "",

    // ãƒ”ãƒ³ç”¨
    lat: null,
    lng: null,
    geoSource: "",

    status: "created",
    createdAt: nowISO(),
    updatedAt: nowISO(),
    history: [{at: nowISO(), action: "ç™»éŒ²"}]
  };
  list.unshift(item);
  save();
  return true;
}

document.getElementById("btnAddManual").addEventListener("click", ()=>{
  const v = document.getElementById("manualCode").value;
  const ok = addShipment(v, false);
  document.getElementById("manualCode").value = "";
  toast(ok ? "è¿½åŠ ã—ã¾ã—ãŸ" : "é‡è¤‡ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
});
document.getElementById("btnTemp").addEventListener("click", ()=>{
  addShipment("", true);
  toast("ä»®ç™»éŒ²ï¼ˆTEMPï¼‰");
});
document.getElementById("manualCode").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){ e.preventDefault(); document.getElementById("btnAddManual").click(); }
});
document.getElementById("btnGoFill").addEventListener("click", ()=>{
  // æœªå…¥åŠ›ï¼ˆä½æ‰€oråå‰ï¼‰ã‚’ä¸€ç•ªä¸Šã‹ã‚‰é–‹ã
  const shipDate = document.getElementById("shipDate").value || todayStr;
  const it = list.find(x=>x.shipDate===shipDate && (!x.address || !x.name));
  if(!it){ toast("æœªå…¥åŠ›ãªã—"); return; }
  openModal(it.id, true);
});

/* =========================
   SCAN (ZXing)
========================= */
const torchState = document.getElementById("torchState");
const btnTorch = document.getElementById("btnTorch");
const btnStartScan = document.getElementById("btnStartScan");
const btnStopScan = document.getElementById("btnStopScan");
const camBox = document.getElementById("camBox");
const video = document.getElementById("video");

let stream = null;
let track = null;
let torch = false;
let scanning = false;
let lastVal = "";
let lastAt = 0;

const codeReader = new ZXing.BrowserMultiFormatReader();

btnStartScan.addEventListener("click", startScan);
btnStopScan.addEventListener("click", stopScan);
btnTorch.addEventListener("click", toggleTorch);

async function startScan(){
  if(!navigator.mediaDevices?.getUserMedia){
    toast("ã‚«ãƒ¡ãƒ©éå¯¾å¿œ");
    return;
  }
  camBox.style.display = "block";
  btnStartScan.style.display = "none";
  btnStopScan.style.display = "inline-block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"environment" }, audio:false });
    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];
    updateTorchSupport();

  }catch(e){
    stopScan();
    toast("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼šHTTPS/è¨±å¯ã‚’ç¢ºèª");
    return;
  }

  scanning = true;
  codeReader.decodeFromVideoElement(video, (result, err)=>{
    if(!scanning) return;
    if(result?.text){
      const val = String(result.text).trim();
      const now = Date.now();
      if(val && (val !== lastVal || (now-lastAt) > 900)){
        lastVal = val; lastAt = now;
        const ok = addShipment(val, false);
        if(ok) toast(`èª­ã¿å–ã‚Šâ†’è¿½åŠ ï¼š${val}`);
      }
    }
  });
  toast("SCANä¸­ï¼šä¼ç¥¨ã‚’ã‹ã–ã—ã¦ä¸‹ã•ã„");
}

function stopScan(){
  scanning = false;
  btnStartScan.style.display = "inline-block";
  btnStopScan.style.display = "none";
  camBox.style.display = "none";

  try{ codeReader.reset(); }catch{}
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  }catch{}
  stream = null;
  track = null;
  torch = false;
  btnTorch.disabled = true;
  torchState.textContent = "æœªå¯¾å¿œ";
}

function updateTorchSupport(){
  if(!track) return;
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  btnTorch.disabled = !hasTorch;
  torchState.textContent = hasTorch ? "OFF" : "æœªå¯¾å¿œ";
}

async function toggleTorch(){
  if(!track){ toast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã®ã¿"); return; }
  const caps = (track.getCapabilities && track.getCapabilities()) ? track.getCapabilities() : null;
  const hasTorch = !!(caps && "torch" in caps);
  if(!hasTorch){ toast("ãƒ©ã‚¤ãƒˆéå¯¾å¿œ"); return; }
  torch = !torch;
  try{
    await track.applyConstraints({ advanced:[{ torch }] });
    torchState.textContent = torch ? "ON" : "OFF";
    toast(torch ? "ãƒ©ã‚¤ãƒˆON" : "ãƒ©ã‚¤ãƒˆOFF");
  }catch{
    toast("ãƒ©ã‚¤ãƒˆåˆ‡æ›¿å¤±æ•—");
  }
}

/* =========================
   Filters / Sort
========================= */
function applyFilters(listIn){
  const d = document.getElementById("filterDate").value;
  const st = document.getElementById("filterStatus").value;
  const q = (document.getElementById("filterText").value || "").trim().toLowerCase();
  return listIn.filter(x=>{
    const okD = d ? x.shipDate === d : true;
    const okS = st ? x.status === st : true;
    const hay = `${x.code} ${x.name||""} ${x.address||""} ${x.client||""} ${x.kind||""} ${(x.tags||[]).join(" ")}`.toLowerCase();
    const okQ = q ? hay.includes(q) : true;
    return okD && okS && okQ;
  });
}

function sortItems(items){
  const mode = document.getElementById("sortMode").value;
  if(mode==="distance"){
    if(!(gps.lat && gps.lng)){
      document.getElementById("sortState").textContent = "GPSå¿…è¦";
      return items;
    }
    document.getElementById("sortState").textContent = "è¿‘ã„é †";
    return items.slice().sort((a,b)=>{
      const da = (a.lat && a.lng) ? haversineKm(gps.lat,gps.lng,a.lat,a.lng) : 999999;
      const db = (b.lat && b.lng) ? haversineKm(gps.lat,gps.lng,b.lat,b.lng) : 999999;
      return da - db;
    });
  }
  document.getElementById("sortState").textContent = "ç™»éŒ²é †";
  return items; // æ—¢ã«unshiftã§ç™»éŒ²é †ï¼ˆæ–°ã—ã„é †ï¼‰
}

function kpiByDate(dateStr){
  const l = list.filter(x=>x.shipDate===dateStr);
  const c = s => l.filter(x=>x.status===s).length;
  const missing = l.filter(x=>!x.address || !x.name).length;
  return { total:l.length, created:c("created"), out:c("out"), done:c("done"), absent:c("absent"), post:c("post"), ret:c("return"), missing };
}

function renderKpis(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const k = kpiByDate(dateStr);
  document.getElementById("kpis").innerHTML = `
    <div class="kpi"><small>åˆè¨ˆ</small><b>${k.total}</b></div>
    <div class="kpi"><small>æœªæŒå‡º</small><b>${k.created}</b></div>
    <div class="kpi"><small>æŒå‡º</small><b>${k.out}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${k.done}</b></div>
    <div class="kpi"><small>ä¸åœ¨/æŠ•å‡½</small><b>${k.absent + k.post}</b></div>
    <div class="kpi"><small>å¿…é ˆæœªå…¥åŠ›</small><b>${k.missing}</b></div>
  `;
}

function fmtKm(km){
  if(km===null || km===undefined || !isFinite(km)) return "";
  if(km < 1) return `${Math.round(km*1000)}m`;
  return `${km.toFixed(2)}km`;
}

function renderList(){
  renderKpis();
  const box = document.getElementById("historyList");
  let filtered = applyFilters(list);
  filtered = sortItems(filtered);

  if(!filtered.length){
    box.innerHTML = `<div class="mini">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚SCANã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  box.innerHTML = filtered.map(x=>{
    const kindBadge = `<span class="badge">${escapeHtml((x.kind||"å®…é…").replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰",""))}</span>`;
    const last = x.history?.[x.history.length-1];
    const lastLine = last ? `${last.at} / ${last.action}` : "";
    const need = (!x.address || !x.name);
    const needLine = need ? `<div class="mini" style="color:#b45309;font-weight:900;">âš ï¸ ä½æ‰€/åå‰ æœªå…¥åŠ›</div>` : "";
    const distance = (gps.lat && gps.lng && x.lat && x.lng) ? haversineKm(gps.lat,gps.lng,x.lat,x.lng) : null;
    const distLine = (document.getElementById("sortMode").value==="distance")
      ? `<div class="mini">è·é›¢ï¼š<b>${escapeHtml(fmtKm(distance||999999))}</b> ${(!x.lat||!x.lng) ? "ï¼ˆãƒ”ãƒ³æœªä½œæˆï¼‰":""}</div>` : "";

    const doneLabel = (x.kind==="æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰" || x.kind==="ãƒã‚¹ãƒˆæŠ•å‡½") ? "æŠ•å‡½å®Œäº†" : "å®Œäº†";

    return `
      <div class="item" id="row-${x.id}">
        <div class="itemTop">
          <div>
            <b>${escapeHtml(x.code)}</b>
            <div class="mini">${kindBadge} ${escapeHtml(x.client||"")} / ${escapeHtml(x.shipDate)}</div>
          </div>
          <div class="tag ${statusClass(x.status)}">${escapeHtml(STATUS[x.status]||x.status)}</div>
        </div>

        <div class="meta">
          åå‰ï¼š${escapeHtml(x.name||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          ä½æ‰€ï¼š${escapeHtml(x.address||"ï¼ˆæœªå…¥åŠ›ï¼‰")}<br>
          ${needLine}
          ${distLine}
          æœ€çµ‚ï¼š${escapeHtml(lastLine)}<br>
          é…é”å“¡ï¼š${escapeHtml(x.driver||"ï¼ˆæœªå…¥åŠ›ï¼‰")}
        </div>

        <div class="actions">
          <button class="btn-blue btn-mini" onclick="navTo('${x.id}')">ğŸ—º ãƒŠãƒ“</button>
          <button class="btn-ok btn-mini" onclick="setStatus('${x.id}','out','æŒå‡º')">æŒå‡º</button>
          <button class="btn-ok btn-mini" onclick="setDone('${x.id}')">${doneLabel}</button>
          <button class="btn-warn btn-mini" onclick="setAbsent('${x.id}')">ä¸åœ¨</button>
          <button class="btn-ghost btn-mini" onclick="openModal('${x.id}', ${need})">è©³ç´°/å…¥åŠ›/OCR</button>
          <button class="btn-ghost btn-mini" onclick="focusPin('${x.id}')">ğŸ“ãƒ”ãƒ³</button>
          <button class="btn-bad btn-mini" onclick="delOne('${x.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
   Status with required check
========================= */
function requireFields(it){
  return (it && it.address && it.name);
}
window.setStatus = function(id, st, label){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  it.status = st;
  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: label});
  save();
  renderList();
  toast(`${label}ï¼š${it.code}`);
};

window.setDone = function(id){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  if(!requireFields(it)){
    openModal(id, true);
    toast("ä½æ‰€/åå‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰å®Œäº†");
    return;
  }
  const isPost = (it.kind==="æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰" || it.kind==="ãƒã‚¹ãƒˆæŠ•å‡½");
  it.status = isPost ? "post" : "done";
  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: isPost ? "æŠ•å‡½" : "å®Œäº†"});
  save();
  renderList();
  refreshMapPins(false);
  toast(`${isPost ? "æŠ•å‡½" : "å®Œäº†"}ï¼š${it.code}`);
  jumpNextUnfinished();
};

window.setAbsent = function(id){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  if(!requireFields(it)){
    openModal(id, true);
    toast("ä½æ‰€/åå‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ä¸åœ¨");
    return;
  }
  it.status = "absent";
  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action: "ä¸åœ¨"});
  save();
  renderList();
  refreshMapPins(false);
  toast(`ä¸åœ¨ï¼š${it.code}`);
  jumpNextUnfinished();
};

window.delOne = function(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  list = list.filter(x=>x.id!==id);
  save();
  renderList();
  refreshMapPins(false);
};

document.getElementById("btnBulkOut").addEventListener("click", ()=>{
  const dateStr = document.getElementById("filterDate").value || todayStr;
  let cnt = 0;
  list.forEach(it=>{
    if(it.shipDate===dateStr && it.status==="created"){
      it.status="out";
      it.updatedAt = nowISO();
      it.history = it.history || [];
      it.history.push({at: nowISO(), action:"æŒå‡ºï¼ˆä¸€æ‹¬ï¼‰"});
      cnt++;
    }
  });
  save();
  renderList();
  refreshMapPins(false);
  toast(`æŒå‡ºä¸€æ‹¬ï¼š${cnt}ä»¶`);
});

document.getElementById("btnNext").addEventListener("click", jumpNextUnfinished);

function jumpNextUnfinished(){
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const all = list.filter(x=>x.shipDate===dateStr);
  const target = all.find(x=>x.status==="created") || all.find(x=>x.status==="out");
  if(!target){ toast("æœªå®Œãªã—ï¼ˆå®Œäº†ï¼‰"); return; }
  document.querySelector('[data-tab="list"]').click();
  setTimeout(()=>{
    const el = document.getElementById("row-"+target.id);
    if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
  }, 60);
}

/* =========================
   Navigation (Google)
========================= */
window.navTo = function(id){
  const it = list.find(x=>x.id===id);
  if(!it) return;
  if(!it.address){
    openModal(id, true);
    toast("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãƒŠãƒ“");
    return;
  }
  const dest = encodeURIComponent(it.address);
  const origin = (gps.lat && gps.lng) ? `${gps.lat},${gps.lng}` : "";
  const url = origin
    ? `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${dest}&travelmode=driving`
    : `https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`;
  if(it.status==="created"){
    if(confirm("ãƒŠãƒ“é–‹å§‹ã¨åŒæ™‚ã«ã€ŒæŒå‡ºã€ã«ã—ã¾ã™ã‹ï¼Ÿ")){
      window.setStatus(it.id, "out", "æŒå‡º");
    }
  }
  window.open(url, "_blank");
};

/* =========================
   Geocoding (Nominatim)
   - address -> lat/lng
========================= */
async function geocodeAddress(address){
  const key = address.trim();
  if(!key) return null;

  if(geoCache[key]) return geoCache[key];

  // Nominatim
  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(key);
  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  if(!res.ok) return null;
  const data = await res.json();
  if(!data || !data.length) return null;

  const out = { lat: Number(data[0].lat), lng: Number(data[0].lon), display: data[0].display_name || "" };
  geoCache[key] = out;
  saveGeoCache();
  return out;
}

document.getElementById("btnGeoMissing").addEventListener("click", async ()=>{
  const dateStr = document.getElementById("filterDate").value || todayStr;
  const targets = list.filter(x=>x.shipDate===dateStr && x.address && (!x.lat || !x.lng));
  if(!targets.length){ toast("ãƒ”ãƒ³æœªä½œæˆãªã—"); return; }

  toast(`ä½æ‰€â†’åº§æ¨™ï¼š${targets.length}ä»¶ï¼ˆé †ç•ªã«å‡¦ç†ï¼‰`);
  for(const it of targets){
    try{
      const r = await geocodeAddress(it.address);
      if(r){
        it.lat = r.lat; it.lng = r.lng; it.geoSource = "nominatim";
        it.updatedAt = nowISO();
        it.history.push({at: nowISO(), action:"åº§æ¨™å–å¾—"});
        save();
      }
      // ç„¡æ–™APIã®ãŸã‚å°‘ã—å¾…ã¤ï¼ˆé€£ç¶šã§å©ãã™ããªã„ï¼‰
      await new Promise(r=>setTimeout(r, 900));
    }catch(e){}
  }
  renderList();
  refreshMapPins(true);
  toast("ãƒ”ãƒ³ä½œæˆå®Œäº†");
});

/* =========================
   MAP (Leaflet)
========================= */
let map = null;
let markers = new Map(); // id -> marker
let gpsMarker = null;

function ensureMap(){
  if(map) return;
  map = L.map('map', { zoomControl:true });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // default center
  map.setView([34.6937, 135.5023], 12); // Osaka

  // click: nothing
}

function centerToGPS(){
  if(!(gps.lat && gps.lng)) return;
  map.setView([gps.lat, gps.lng], 15);
  if(!gpsMarker){
    gpsMarker = L.circleMarker([gps.lat,gps.lng], {radius:8}).addTo(map).bindPopup("ç¾åœ¨åœ°");
  }else{
    gpsMarker.setLatLng([gps.lat,gps.lng]);
  }
}

document.getElementById("btnMapCenter").addEventListener("click", ()=>{
  if(!(gps.lat && gps.lng)){
    getGPS();
    setTimeout(centerToGPS, 1200);
  }else centerToGPS();
});

document.getElementById("btnMapReload").addEventListener("click", ()=>refreshMapPins(true));

function pinColorByStatus(st){
  // simple: return class-based emoji in popup; marker style is default
  return st;
}

function refreshMapPins(recenter){
  if(!map) return;

  const dateStr = document.getElementById("filterDate").value || todayStr;
  const items = list.filter(x=>x.shipDate===dateStr && x.lat && x.lng);

  // remove missing
  for(const [id,m] of markers.entries()){
    if(!items.find(x=>x.id===id)){
      map.removeLayer(m);
      markers.delete(id);
    }
  }

  // add/update
  items.forEach(it=>{
    const title = `${it.code} / ${it.name||"åå‰æœªå…¥åŠ›"} / ${STATUS[it.status]||it.status}`;
    const popupHtml = `
      <b>${escapeHtml(it.code)}</b><br>
      ${escapeHtml(it.name||"ï¼ˆåå‰æœªå…¥åŠ›ï¼‰")}<br>
      ${escapeHtml(it.address||"ï¼ˆä½æ‰€æœªå…¥åŠ›ï¼‰")}<br>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="openFromMap('${it.id}')" style="padding:8px 10px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;font-weight:900;cursor:pointer;">é–‹ã</button>
        <button onclick="navTo('${it.id}')" style="padding:8px 10px;border-radius:12px;border:0;background:#1565C0;color:#fff;font-weight:900;cursor:pointer;">ãƒŠãƒ“</button>
      </div>
    `;

    if(!markers.has(it.id)){
      const m = L.marker([it.lat,it.lng]).addTo(map);
      m.bindPopup(popupHtml);
      m.on("click", ()=>{ /* popup shows */ });
      markers.set(it.id, m);
    }else{
      markers.get(it.id).setLatLng([it.lat,it.lng]).setPopupContent(popupHtml);
    }
  });

  // gps marker
  if(gps.lat && gps.lng){
    if(!gpsMarker) gpsMarker = L.circleMarker([gps.lat,gps.lng], {radius:8}).addTo(map).bindPopup("ç¾åœ¨åœ°");
    else gpsMarker.setLatLng([gps.lat,gps.lng]);
  }

  if(recenter){
    if(gps.lat && gps.lng){
      centerToGPS();
    }else if(items.length){
      const group = L.featureGroup(items.map(it=>L.marker([it.lat,it.lng])));
      try{ map.fitBounds(group.getBounds().pad(0.2)); }catch{}
    }
  }
}

window.openFromMap = function(id){
  openModal(id, true);
};

window.focusPin = function(id){
  const it = list.find(x=>x.id===id);
  if(!it){ return; }
  if(!(it.lat && it.lng)){
    openModal(id, true);
    toast("ãƒ”ãƒ³æœªä½œæˆï¼šä½æ‰€â†’åº§æ¨™ã‚’æŠ¼ã—ã¦ãã ã•ã„");
    return;
  }
  document.querySelector('[data-tab="map"]').click();
  setTimeout(()=>{
    map.setView([it.lat,it.lng], 17);
    const m = markers.get(id);
    if(m) m.openPopup();
  }, 120);
};

/* =========================
   Exports (CSV / PDF)
========================= */
function toCSV(rows){
  const esc = v => `"${String(v??"").replaceAll('"','""')}"`;
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadFile(content, filename, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}
function rowsForExport(items){
  return items.map(x=>{
    const last = x.history?.[x.history.length-1];
    return [
      x.shipDate, x.driver, x.client,
      x.kind, (x.tags||[]).join("/"),
      x.code, x.name, x.address, x.phone,
      x.lat||"", x.lng||"",
      STATUS[x.status]||x.status,
      last?.at || "",
      (x.memo||"")
    ];
  });
}
document.getElementById("btnExportCSV").addEventListener("click", ()=>{
  const items = sortItems(applyFilters(list));
  const header = ["æ—¥ä»˜","é…é”å“¡","å–å¼•å…ˆ","ç¨®åˆ¥","ã‚¿ã‚°","ã‚³ãƒ¼ãƒ‰","åå‰","ä½æ‰€","é›»è©±","lat","lng","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsForExport(items)]);
  downloadFile(csv, `OFA_é…é”å±¥æ­´_${todayStr}.csv`, "text/csv;charset=utf-8");
});
function exportPDF(title, items, filename, metaLines=[]){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});

  doc.setFontSize(14);
  doc.text(title, 14, 14);

  doc.setFontSize(10);
  let y=20;
  metaLines.forEach(line=>{ doc.text(line, 14, y); y+=5; });

  const head = [["æ—¥ä»˜","ç¨®åˆ¥","ã‚³ãƒ¼ãƒ‰","åå‰","ä½æ‰€","çŠ¶æ…‹"]];
  const body = items.map(x=>[
    x.shipDate,
    (x.kind||"").replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰",""),
    x.code,
    x.name||"",
    x.address||"",
    STATUS[x.status]||x.status
  ]);

  doc.autoTable({ startY: y+2, head, body, styles:{fontSize:9, cellPadding:2}, theme:"grid" });

  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`OFA GROUP / ${todayStr} / Page ${i}/${pageCount}`, 14, 292);
  }
  doc.save(filename);
}
document.getElementById("btnExportPDF").addEventListener("click", ()=>{
  const items = sortItems(applyFilters(list));
  exportPDF("OFA é…é”å±¥æ­´", items, `OFA_é…é”å±¥æ­´_${todayStr}.pdf`, [
    `å‡ºåŠ›ï¼š${nowISO()}`,
    `GPSï¼š${gps.lat&&gps.lng ? gps.lat.toFixed(6)+","+gps.lng.toFixed(6) : "æœªå–å¾—"}`
  ]);
});
document.getElementById("btnClearAll").addEventListener("click", ()=>{
  if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã€‚å¾©å…ƒã§ãã¾ã›ã‚“ã€‚")) return;
  if(!confirm("æœ€çµ‚ç¢ºèªï¼šå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY);
  list = [];
  renderList();
  renderReport();
  refreshMapPins(true);
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
});

/* =========================
   Report
========================= */
document.getElementById("reportDate").addEventListener("change", renderReport);
document.getElementById("reportDriver").addEventListener("input", renderReport);

function itemsByDate(dateStr){ return list.filter(x=>x.shipDate===dateStr); }
function renderReport(){
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);
  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();

  const c = (st)=> items.filter(x=>x.status===st).length;
  const missing = items.filter(x=>!x.address || !x.name).length;

  document.getElementById("reportKpis").innerHTML = `
    <div class="kpi"><small>å¯¾è±¡æ—¥</small><b>${escapeHtml(dateStr)}</b></div>
    <div class="kpi"><small>é…é”å“¡</small><b>${escapeHtml(driver||"æœªå…¥åŠ›")}</b></div>
    <div class="kpi"><small>åˆè¨ˆ</small><b>${items.length}</b></div>
    <div class="kpi"><small>å®Œäº†</small><b>${c("done")}</b></div>
    <div class="kpi"><small>æŠ•å‡½</small><b>${c("post")}</b></div>
    <div class="kpi"><small>ä¸åœ¨</small><b>${c("absent")}</b></div>
    <div class="kpi"><small>å¿…é ˆæœªå…¥åŠ›</small><b>${missing}</b></div>
  `;
}
document.getElementById("btnReportCSV").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);
  const header = ["æ—¥ä»˜","é…é”å“¡","å–å¼•å…ˆ","ç¨®åˆ¥","ã‚¿ã‚°","ã‚³ãƒ¼ãƒ‰","åå‰","ä½æ‰€","é›»è©±","lat","lng","çŠ¶æ…‹","æœ€çµ‚æ›´æ–°","ãƒ¡ãƒ¢"];
  const csv = toCSV([header, ...rowsForExport(items)]);
  downloadFile(csv, `OFA_æ—¥å ±_${dateStr}.csv`, "text/csv;charset=utf-8");
});
document.getElementById("btnReportPDF").addEventListener("click", ()=>{
  const dateStr = document.getElementById("reportDate").value || todayStr;
  const items = itemsByDate(dateStr);
  const driver = (document.getElementById("reportDriver").value || "").trim()
    || (document.getElementById("driver").value || "").trim();
  exportPDF("OFA æ—¥å ±ï¼ˆé…é”ï¼‰", items, `OFA_æ—¥å ±_${dateStr}.pdf`, [
    `å¯¾è±¡æ—¥ï¼š${dateStr}`, `é…é”å“¡ï¼š${driver||"æœªå…¥åŠ›"}`, `å‡ºåŠ›ï¼š${nowISO()}`
  ]);
});

/* =========================
   Modal (Detail / OCR / Geo)
========================= */
let modalId = null;
let forceRequired = false;

window.openModal = function(id, require=false){
  modalId = id;
  forceRequired = !!require;

  const it = list.find(x=>x.id===id);
  if(!it) return;

  document.getElementById("modalTitle").textContent = "è©³ç´°ï¼ˆä½æ‰€/åå‰/ãƒ”ãƒ³/å®Œäº†ï¼‰";
  document.getElementById("modalSub").textContent = `${it.shipDate} / ${it.kind?.replace("ï¼ˆéƒµä¾¿ç‰©ï¼‰","") || ""} / ${it.code}`;

  document.getElementById("mCode").value = it.code || "";
  document.getElementById("mKind").value = it.kind || "å®…é…";
  document.getElementById("mName").value = it.name || "";
  document.getElementById("mAddress").value = it.address || "";
  document.getElementById("mPhone").value = it.phone || "";
  document.getElementById("mMemo").value = it.memo || "";
  document.getElementById("mLatLng").value = (it.lat && it.lng) ? `${it.lat},${it.lng}` : "";

  // tag pills
  [...document.querySelectorAll("#tagPills .pill")].forEach(p=>{
    p.classList.toggle("active", (it.tags||[]).includes(p.textContent));
  });

  // required warn
  const need = (!it.address || !it.name) && forceRequired;
  document.getElementById("requiredWarn").style.display = need ? "block" : "none";

  // OCR reset
  setOCRProgress(0, "æœªå®Ÿè¡Œ");
  document.getElementById("ocrCandidates").innerHTML = "";

  document.getElementById("modalBack").style.display = "flex";
};

window.closeModal = function(){
  document.getElementById("modalBack").style.display = "none";
  modalId = null;
  forceRequired = false;
};

function getModalItem(){
  if(!modalId) return null;
  return list.find(x=>x.id===modalId);
}

window.saveModal = function(){
  const it = getModalItem();
  if(!it) return;

  it.code = document.getElementById("mCode").value.trim() || it.code;
  it.kind = document.getElementById("mKind").value;
  it.name = document.getElementById("mName").value.trim();
  it.address = document.getElementById("mAddress").value.trim();
  it.phone = document.getElementById("mPhone").value.trim();
  it.memo = document.getElementById("mMemo").value.trim();
  it.tags = [...document.querySelectorAll("#tagPills .pill.active")].map(p=>p.textContent);

  const ll = parseLatLng(document.getElementById("mLatLng").value);
  if(ll){ it.lat = ll.lat; it.lng = ll.lng; }

  it.updatedAt = nowISO();
  it.history = it.history || [];
  it.history.push({at: nowISO(), action:"è©³ç´°æ›´æ–°"});

  save();
  renderList();
  renderReport();
  refreshMapPins(false);
  toast("ä¿å­˜ã—ã¾ã—ãŸ");
  closeModal();
};

window.deleteFromModal = function(){
  if(!modalId) return;
  if(!confirm("ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  list = list.filter(x=>x.id!==modalId);
  save();
  renderList();
  renderReport();
  refreshMapPins(false);
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  closeModal();
};

window.doneFromModal = function(){
  const it = getModalItem();
  if(!it) return;
  // å…ˆã«ä¿å­˜ï¼ˆå¿…é ˆåæ˜ ï¼‰
  const name = document.getElementById("mName").value.trim();
  const addr = document.getElementById("mAddress").value.trim();
  if(!name || !addr){
    document.getElementById("requiredWarn").style.display = "block";
    toast("ä½æ‰€/åå‰ãŒå¿…é ˆ");
    return;
  }
  saveModalInline();

  const isPost = (it.kind==="æ‰‹ç´™ï¼ˆéƒµä¾¿ç‰©ï¼‰" || it.kind==="ãƒã‚¹ãƒˆæŠ•å‡½");
  it.status = isPost ? "post" : "done";
  it.updatedAt = nowISO();
  it.history.push({at: nowISO(), action: isPost ? "æŠ•å‡½" : "å®Œäº†"});
  save();
  renderList();
  refreshMapPins(false);
  toast(isPost ? "æŠ•å‡½" : "å®Œäº†");
  closeModal();
};

window.absentFromModal = function(){
  const it = getModalItem();
  if(!it) return;
  const name = document.getElementById("mName").value.trim();
  const addr = document.getElementById("mAddress").value.trim();
  if(!name || !addr){
    document.getElementById("requiredWarn").style.display = "block";
    toast("ä½æ‰€/åå‰ãŒå¿…é ˆ");
    return;
  }
  saveModalInline();

  it.status = "absent";
  it.updatedAt = nowISO();
  it.history.push({at: nowISO(), action: "ä¸åœ¨"});
  save();
  renderList();
  refreshMapPins(false);
  toast("ä¸åœ¨");
  closeModal();
};

function saveModalInline(){
  const it = getModalItem();
  if(!it) return;
  it.code = document.getElementById("mCode").value.trim() || it.code;
  it.kind = document.getElementById("mKind").value;
  it.name = document.getElementById("mName").value.trim();
  it.address = document.getElementById("mAddress").value.trim();
  it.phone = document.getElementById("mPhone").value.trim();
  it.memo = document.getElementById("mMemo").value.trim();
  it.tags = [...document.querySelectorAll("#tagPills .pill.active")].map(p=>p.textContent);
  const ll = parseLatLng(document.getElementById("mLatLng").value);
  if(ll){ it.lat = ll.lat; it.lng = ll.lng; }
}

/* Geo in modal */
window.geoFromModal = async function(){
  const it = getModalItem();
  if(!it) return;
  const addr = document.getElementById("mAddress").value.trim();
  if(!addr){ toast("ä½æ‰€ãŒç©ºã§ã™"); return; }
  toast("ä½æ‰€â†’åº§æ¨™ å–å¾—ä¸­â€¦");
  try{
    const r = await geocodeAddress(addr);
    if(!r){ toast("åº§æ¨™å–å¾—ã§ãã¾ã›ã‚“"); return; }
    document.getElementById("mLatLng").value = `${r.lat},${r.lng}`;
    toast("åº§æ¨™å–å¾—OK");
  }catch{
    toast("åº§æ¨™å–å¾—å¤±æ•—");
  }
};
window.clearLatLng = function(){
  document.getElementById("mLatLng").value = "";
};

/* Nav/copy/call */
window.navFromModal = function(){
  if(!modalId) return;
  navTo(modalId);
};
window.copyAddress = function(){
  const addr = document.getElementById("mAddress").value.trim();
  if(!addr){ toast("ä½æ‰€ãŒç©ºã§ã™"); return; }
  navigator.clipboard?.writeText(addr).then(()=>toast("ä½æ‰€ã‚³ãƒ”ãƒ¼OK")).catch(()=>toast("ã‚³ãƒ”ãƒ¼å¤±æ•—"));
};
window.callPhone = function(){
  const ph = document.getElementById("mPhone").value.trim();
  if(!ph){ toast("é›»è©±ãŒç©ºã§ã™"); return; }
  window.location.href = `tel:${encodeURIComponent(ph)}`;
};

/* =========================
   OCR (address/name/code candidates)
========================= */
function setOCRProgress(pct, text){
  document.getElementById("ocrBar").style.width = `${pct}%`;
  document.getElementById("ocrStatus").textContent = text;
}
function addCandidateButton(label, onClick){
  const b = document.createElement("button");
  b.className = "pill";
  b.textContent = label;
  b.onclick = onClick;
  document.getElementById("ocrCandidates").appendChild(b);
}
function extractCandidates(text){
  const raw = text || "";
  const t = raw.replace(/\s+/g," ").trim();

  // code candidates
  const codeMatches = [...t.matchAll(/[A-Z0-9\-]{8,22}/g)].map(m=>m[0]);
  const numMatches = [...t.matchAll(/\d{8,22}/g)].map(m=>m[0]);
  const codes = Array.from(new Set([...codeMatches, ...numMatches])).slice(0,8);

  // address candidates (very practical heuristic)
  const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const addrLines = lines.filter(l=>/(éƒ½|é“|åºœ|çœŒ)/.test(l) && (/(å¸‚|åŒº|ç”º|æ‘)/.test(l) || /\d{1,3}[-ä¸ç›®ç•ªåœ°å·]/.test(l)));
  const addrCandidates = [];
  for(let i=0;i<lines.length;i++){
    const a = lines[i], b = lines[i+1]||"", c = lines[i+2]||"";
    const comb2 = (a+" "+b).trim();
    const comb3 = (a+" "+b+" "+c).trim();
    if(/(éƒ½|é“|åºœ|çœŒ)/.test(comb2) && /(å¸‚|åŒº|ç”º|æ‘)/.test(comb2)) addrCandidates.push(comb2);
    if(/(éƒ½|é“|åºœ|çœŒ)/.test(comb3) && /(å¸‚|åŒº|ç”º|æ‘)/.test(comb3)) addrCandidates.push(comb3);
  }
  const addrs = Array.from(new Set([...addrLines, ...addrCandidates])).slice(0,8);

  // name candidates: lines that look like Japanese names (simple)
  const nameLines = lines
    .filter(l=>l.length<=12 && /[ä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ³]/.test(l))
    .filter(l=>!/(éƒ½|é“|åºœ|çœŒ|å¸‚|åŒº|ç”º|æ‘|ä¸ç›®|ç•ªåœ°|å·)/.test(l))
    .slice(0,6);

  return { codes, addrs, names:nameLines, raw };
}

async function runOCRFile(){
  if(!modalId){ toast("å¯¾è±¡ãªã—"); return; }
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = async ()=>{
    const file = input.files?.[0];
    if(!file) return;
    setOCRProgress(5, "OCRæº–å‚™ä¸­â€¦");
    document.getElementById("ocrCandidates").innerHTML = "";
    try{
      const res = await Tesseract.recognize(file, "jpn", {
        logger: m=>{
          if(m.status==="recognizing text"){
            setOCRProgress(Math.floor((m.progress||0)*100), `OCRä¸­â€¦ ${Math.floor((m.progress||0)*100)}%`);
          }
        }
      });
      setOCRProgress(100, "OCRå®Œäº†");
      const text = res?.data?.text || "";
      const cand = extractCandidates(text);

      addCandidateButton("ã€å…¨æ–‡è¡¨ç¤ºã€‘", ()=> alert(cand.raw.slice(0,5000)));

      cand.codes.forEach(c=>{
        addCandidateButton(`ã‚³ãƒ¼ãƒ‰ï¼š${c}`, ()=>{
          document.getElementById("mCode").value = c;
          toast("ã‚³ãƒ¼ãƒ‰åæ˜ ");
        });
      });
      cand.names.forEach(n=>{
        addCandidateButton(`åå‰ï¼š${n}`, ()=>{
          document.getElementById("mName").value = n;
          toast("åå‰åæ˜ ");
        });
      });
      cand.addrs.forEach(a=>{
        addCandidateButton(`ä½æ‰€ï¼š${a}`, ()=>{
          document.getElementById("mAddress").value = a;
          toast("ä½æ‰€åæ˜ ");
        });
      });
      if(!cand.codes.length && !cand.addrs.length && !cand.names.length){
        addCandidateButton("å€™è£œãªã—ï¼ˆå…¨æ–‡ç¢ºèªï¼‰", ()=> alert(cand.raw.slice(0,5000)));
      }
    }catch(e){
      setOCRProgress(0, "OCRå¤±æ•—ï¼ˆæ˜ã‚‹ã/å¯„ã›ã¦å†è©¦è¡Œï¼‰");
    }
  };
  input.click();
}
window.runOCRFile = runOCRFile;

async function captureOCRFromCamera(){
  if(!modalId){ toast("å¯¾è±¡ãªã—"); return; }
  if(!video || !stream){
    toast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼ˆSCANé–‹å§‹ï¼‰");
    return;
  }
  try{
    const canvas = document.getElementById("capCanvas");
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    setOCRProgress(5, "ã‚«ãƒ¡ãƒ©OCRä¸­â€¦");
    document.getElementById("ocrCandidates").innerHTML = "";

    const res = await Tesseract.recognize(canvas, "jpn", {
      logger: m=>{
        if(m.status==="recognizing text"){
          setOCRProgress(Math.floor((m.progress||0)*100), `OCRä¸­â€¦ ${Math.floor((m.progress||0)*100)}%`);
        }
      }
    });

    setOCRProgress(100, "OCRå®Œäº†");
    const text = res?.data?.text || "";
    const cand = extractCandidates(text);

    addCandidateButton("ã€å…¨æ–‡è¡¨ç¤ºã€‘", ()=> alert(cand.raw.slice(0,5000)));
    cand.codes.forEach(c=> addCandidateButton(`ã‚³ãƒ¼ãƒ‰ï¼š${c}`, ()=>{ document.getElementById("mCode").value=c; toast("ã‚³ãƒ¼ãƒ‰åæ˜ "); }));
    cand.names.forEach(n=> addCandidateButton(`åå‰ï¼š${n}`, ()=>{ document.getElementById("mName").value=n; toast("åå‰åæ˜ "); }));
    cand.addrs.forEach(a=> addCandidateButton(`ä½æ‰€ï¼š${a}`, ()=>{ document.getElementById("mAddress").value=a; toast("ä½æ‰€åæ˜ "); }));
    if(!cand.codes.length && !cand.addrs.length && !cand.names.length){
      addCandidateButton("å€™è£œãªã—ï¼ˆå…¨æ–‡ç¢ºèªï¼‰", ()=> alert(cand.raw.slice(0,5000)));
    }
  }catch{
    setOCRProgress(0, "OCRå¤±æ•—ï¼ˆãƒ–ãƒ¬/æš—ã•ï¼‰â†’å†™çœŸOCRæ¨å¥¨");
  }
}
window.captureOCRFromCamera = captureOCRFromCamera;

/* =========================
   Map open pin from list
========================= */
let mapReadyOnce = false;
function openMapTab(){
  document.querySelector('[data-tab="map"]').click();
}
function openListTab(){
  document.querySelector('[data-tab="list"]').click();
}

/* =========================
   Toast
========================= */
let toastTimer=null;
function toast(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="22px";
    el.style.transform="translateX(-50%)";
    el.style.background="rgba(15,23,42,.92)";
    el.style.color="#fff";
    el.style.padding="10px 14px";
    el.style.borderRadius="999px";
    el.style.fontWeight="900";
    el.style.fontSize="12px";
    el.style.boxShadow="0 14px 30px rgba(0,0,0,.18)";
    el.style.zIndex="9999";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity="1";
  toastTimer = setTimeout(()=>{ el.style.opacity="0"; }, 1300);
}
</script>
</body>
</html>
