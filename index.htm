<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</title>

  <!-- ===== CDNï¼ˆè»½é‡åŒ–ï¼šOCRã¯ãƒœã‚¿ãƒ³æŠ¼ã—ãŸã¨ãã ã‘èª­ã¿è¾¼ã¿ï¼‰ ===== -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --yellow:#facc15; /* æ“ä½œ */
      --red:#ef4444;    /* NG */
      --blue:#3b82f6;   /* ãƒŠãƒ“ */
      --green:#22c55e;  /* å®Œäº† */
      --black:#111111;

      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans JP", Segoe UI, Roboto, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(250,204,21,.25), transparent 60%),
                  radial-gradient(800px 600px at 95% 0%, rgba(59,130,246,.18), transparent 55%),
                  #fff;
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* iOS Safari å¯¾ç­–ï¼š100vhã‚ˆã‚Š 100svh */
    .app{
      min-height: 100svh;
      display:flex;
      flex-direction:column;
    }

    header{
      position: sticky;
      top:0;
      z-index: 50;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      padding: 14px 14px 10px;
    }

    .topRow{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, #facc15, #111);
      display:grid;place-items:center;
      color:#fff;font-weight:900;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title{
      line-height:1.1;
      font-weight:900;
      font-size:15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .statusPills{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,.9);
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .dot{ width:8px;height:8px;border-radius:99px; background: #9ca3af; }
    .dot.ok{ background: var(--green); }
    .dot.ng{ background: var(--red); }
    .dot.warn{ background: var(--yellow); }

    .tabs{
      display:flex;
      gap:10px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .tabBtn{
      flex:1 1 120px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,.9);
      background:#fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      font-weight:800;
      color:#111;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn small{
      font-weight:900;
      padding:4px 10px;
      border-radius:999px;
      background:#f3f4f6;
      color:#111;
      min-width:34px;
      text-align:center;
    }
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(250,204,21,.95), rgba(250,204,21,.35));
      border-color: rgba(250,204,21,.9);
    }

    main{
      flex:1;
      padding: 14px;
      max-width: 980px;
      width:100%;
      margin: 0 auto;
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
      overflow:hidden;
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionTitle h3{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .hint{ font-size:12px; color:var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:740px){
      .grid2{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      font-size:14px;
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 5px rgba(59,130,246,.12);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:900;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn.primary{ background: linear-gradient(135deg, var(--yellow), rgba(250,204,21,.55)); color:#111; }
    .btn.danger{ background: linear-gradient(135deg, var(--red), rgba(239,68,68,.55)); color:#fff; }
    .btn.blue{ background: linear-gradient(135deg, var(--blue), rgba(59,130,246,.55)); color:#fff; }
    .btn.green{ background: linear-gradient(135deg, var(--green), rgba(34,197,94,.55)); color:#fff; }
    .btn.gray{ background: #111; color:#fff; }
    .btn.ghost{
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      color:#111;
      box-shadow:none;
    }

    /* ===== Login overlay ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: radial-gradient(1000px 700px at 10% 0%, rgba(250,204,21,.22), transparent 55%),
                  radial-gradient(800px 600px at 90% 10%, rgba(59,130,246,.18), transparent 55%),
                  rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index: 1000;
    }
    .overlay.show{ display:flex; }
    .loginBox{
      width: min(520px, 100%);
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.12);
      padding: 16px;
    }
    .loginHead{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .loginHead .logo{ width:48px;height:48px; border-radius:16px; }
    .loginHead h2{ margin:0; font-size:16px; font-weight:1000; }
    .loginHead p{ margin:0; font-size:12px; color:var(--muted); }

    /* ===== Scan view ===== */
    .scanWrap{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width:840px){ .scanWrap{ grid-template-columns:1fr; } }

    .videoBox{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(229,231,235,.95);
      background:#000;
      position:relative;
      box-shadow: var(--shadow);
      min-height: 240px;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .scanHud{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .scanFrame{
      width: min(360px, 78%);
      aspect-ratio: 1.6/1;
      border-radius: 18px;
      border: 3px solid rgba(250,204,21,.95);
      box-shadow: 0 0 0 8px rgba(250,204,21,.12);
    }

    .listItem{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      padding: 12px;
      background:#fff;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      margin-bottom:10px;
      display:flex;
      gap:10px;
    }
    .badgeNum{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      font-weight:1000;
      background: rgba(59,130,246,.12);
      color: var(--blue);
      flex:0 0 auto;
    }
    .liMain{ flex:1; min-width:0; }
    .liTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .liName{
      font-weight:1000;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .liSmall{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chip{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      color:#111;
    }
    .chip.yellow{ background: rgba(250,204,21,.2); border-color: rgba(250,204,21,.65); }
    .chip.blue{ background: rgba(59,130,246,.14); border-color: rgba(59,130,246,.45); color:var(--blue); }
    .chip.green{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.55); color:var(--green); }
    .chip.red{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.45); color:var(--red); }

    .liBtns{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      justify-content:flex-start;
      min-width: 148px;
    }
    @media (max-width:520px){
      .liBtns{ min-width: 120px; }
    }
    .miniBtn{
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .miniBtn.blue{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.4); color:var(--blue); }
    .miniBtn.yellow{ background: rgba(250,204,21,.22); border-color: rgba(250,204,21,.55); color:#111; }
    .miniBtn.red{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.45); color:var(--red); }
    .miniBtn.green{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.55); color:var(--green); }
    .miniBtn.gray{ background:#111; color:#fff; border-color:#111; }

    /* swipe hint */
    .swipeHint{
      font-size:12px;color:var(--muted);
      margin-top:8px;
    }

    /* bottom nav (mobile) */
    .bottomBar{
      position: sticky;
      bottom: 0;
      z-index: 60;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(229,231,235,.95);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
    }
    .bottomRow{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .counter{
      display:flex;
      gap:10px;
      font-weight:1000;
      color:#111;
      font-size:12px;
    }
    .counter span{ color:var(--muted); font-weight:900; }

    /* toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(80px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(17,17,17,.92);
      color:#fff;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight:900;
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
      display:none;
      z-index: 2000;
      max-width: min(560px, 92vw);
      text-align:center;
    }
    .toast.show{ display:block; }

    /* map */
    #map{
      width:100%;
      height: 58svh;
      border-radius: 18px;
      border:1px solid rgba(229,231,235,.95);
      overflow:hidden;
      box-shadow: var(--shadow);
      background:#f3f4f6;
    }

    /* danger banner */
    .banner{
      padding: 12px 12px;
      border-radius: 18px;
      font-weight:1000;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color:#991b1b;
      margin-bottom: 12px;
    }
    .banner b{ color:#7f1d1d; }
  </style>
</head>

<body>
<div class="app" id="app">

  <!-- ===== LOGIN OVERLAY ===== -->
  <div class="overlay" id="loginOverlay">
    <div class="loginBox">
      <div class="loginHead">
        <div class="logo">OFA</div>
        <div>
          <h2>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆãƒ­ã‚°ã‚¤ãƒ³ï¼‰</h2>
          <p>é›»è©±ç•ªå· â†’ SMS 6æ¡ã§èªè¨¼ï¼ˆFirebaseæ¨å¥¨ï¼‰</p>
        </div>
      </div>

      <div class="card" style="margin:0; box-shadow:none;">
        <div class="grid2">
          <div>
            <label>é›»è©±ç•ªå·ï¼ˆä¾‹ï¼š09012345678ï¼‰</label>
            <input id="phone" inputmode="tel" placeholder="09012345678" />
          </div>
          <div>
            <label>SMSã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
            <input id="code" inputmode="numeric" placeholder="123456" />
          </div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnSendSMS">ğŸ“© SMSé€ä¿¡</button>
          <button class="btn green" id="btnVerify">âœ… èªè¨¼ã—ã¦é–‹å§‹</button>
          <button class="btn ghost" id="btnDemo">ğŸ‘€ ãƒ‡ãƒ¢ã§å…¥ã‚‹ï¼ˆéµãªã—ï¼‰</button>
          <button class="btn danger" id="btnLogout">â›” ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          â€» Firebase ã‚’ä½¿ã†å ´åˆã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸‹éƒ¨ã® <b>Firebaseè¨­å®š</b> ã«ã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚<br>
          â€» ãƒ‡ãƒ¢ã¯ç«¯æœ«å†…ä¿å­˜ã®ã¿ï¼ˆæœ¬ç•ªã¯å¿…ãšSMSèªè¨¼æ¨å¥¨ï¼‰
        </div>

        <div id="recaptcha-container" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <header>
    <div class="topRow">
      <div class="brand">
        <div class="logo">OFA</div>
        <div style="min-width:0;">
          <div class="title">OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆWebï¼‰</div>
          <div class="subtitle">â‘ ç‚¹å‘¼ â†’ â‘¡é›†è·(SCAN/OCR) â†’ â‘¢ãƒªã‚¹ãƒˆ â†’ â‘£åœ°å›³ â†’ â‘¤æ—¥å ±</div>
        </div>
      </div>

      <div class="statusPills">
        <div class="pill" id="pillGps"><span class="dot ng" id="dotGps"></span>GPS <b id="gpsText">NG</b></div>
        <div class="pill"><span class="dot" id="dotPin"></span>ãƒ”ãƒ³ <b id="pinCount">0</b></div>
        <div class="pill"><span class="dot warn" id="dotTorch"></span>ãƒ©ã‚¤ãƒˆ <b id="torchText">OFF</b></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tabBtn active" data-tab="tenko" id="tabTenko">â‘  Webç‚¹å‘¼ <small id="cTenko">OK</small></div>
      <div class="tabBtn" data-tab="scan" id="tabScan">â‘¡ é›†è·(SCAN) <small id="cScan">0</small></div>
      <div class="tabBtn" data-tab="list" id="tabList">â‘¢ ãƒªã‚¹ãƒˆ <small id="cList">0</small></div>
      <div class="tabBtn" data-tab="map" id="tabMap">â‘£ åœ°å›³ <small id="cMap">0</small></div>
      <div class="tabBtn" data-tab="report" id="tabReport">â‘¤ æ—¥å ± <small id="cReport">0</small></div>
    </div>
  </header>

  <main>

    <div class="banner" id="gpsBanner" style="display:none;">
      <div>âš  <b>GPSãŒOFFã§ã™ã€‚</b> ç¨¼åƒå‰ã«å¿…ãšONã«ã—ã¦ãã ã•ã„ï¼ˆä½œæ¥­é–‹å§‹ã§ãã¾ã›ã‚“ï¼‰</div>
      <button class="btn blue" id="btnRequestGPS">ğŸ“ GPSã‚’è¨±å¯</button>
    </div>

    <!-- ===== TENKO ===== -->
    <section class="view" id="view-tenko">
      <div class="card">
        <div class="sectionTitle">
          <h3>ç‚¹å‘¼ / æ—¥å¸¸ç‚¹æ¤œ</h3>
          <div class="hint">ã‚¹ãƒãƒ›æ ã«åã¾ã‚‹ã‚ˆã†ä¿®æ­£æ¸ˆã¿ï¼ˆ100svh + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰</div>
        </div>

        <div class="grid2">
          <div>
            <label>æ°å</label>
            <input id="tenkoName" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸" />
          </div>
          <div>
            <label>ã‚¨ãƒªã‚¢</label>
            <input id="tenkoArea" placeholder="ä¾‹ï¼šé¹¿å…å³¶" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>æ—¥å¸¸ç‚¹æ¤œï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰</label>
          <div class="grid2">
            <label><input type="checkbox" class="chkTenko" /> ãƒ–ãƒ¬ãƒ¼ã‚­</label>
            <label><input type="checkbox" class="chkTenko" /> ç¯ç«é¡ï¼ˆãƒ©ã‚¤ãƒˆ/ã‚¦ã‚£ãƒ³ã‚«ãƒ¼ï¼‰</label>
            <label><input type="checkbox" class="chkTenko" /> ã‚ªã‚¤ãƒ«/æ°´æ¼ã‚Œ</label>
            <label><input type="checkbox" class="chkTenko" /> ã‚¿ã‚¤ãƒ¤ç©ºæ°—åœ§</label>
            <label><input type="checkbox" class="chkTenko" /> è»Šä¸¡å‘¨ã‚Šç•°å¸¸ãªã—</label>
            <label><input type="checkbox" class="chkTenko" /> ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯å®Ÿæ–½</label>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
          <textarea id="tenkoMemo" placeholder="ä¾‹ï¼šå³å¾Œè¼ªç©ºæ°—åœ§æ³¨æ„ ãªã©"></textarea>
        </div>

        <div class="btnRow">
          <button class="btn green" id="btnSaveTenko">âœ… ç‚¹å‘¼ã‚’ä¿å­˜</button>
          <button class="btn ghost" id="btnTenkoPDF">ğŸ“„ ç‚¹å‘¼ã‚’PDFï¼ˆå°åˆ·ï¼‰</button>
        </div>
      </div>
    </section>

    <!-- ===== SCAN ===== -->
    <section class="view" id="view-scan" style="display:none;">
      <div class="card">
        <div class="sectionTitle">
          <h3>é›†è·ï¼ˆSCAN / OCRï¼‰</h3>
          <div class="hint">èª­ã¿è¾¼ã¿æˆåŠŸï¼šãƒ”ãƒƒéŸ³ï¼‹ãƒã‚¤ãƒ–ï¼‹è‡ªå‹•ã§ãƒªã‚¹ãƒˆã¸</div>
        </div>

        <div class="scanWrap">
          <div>
            <div class="videoBox">
              <video id="video" playsinline muted></video>
              <div class="scanHud"><div class="scanFrame"></div></div>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="btnStartCam">ğŸ“· SCANé–‹å§‹ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰</button>
              <button class="btn yellow" id="btnTorch">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
              <button class="btn danger" id="btnStopCam">â›” åœæ­¢</button>
            </div>

            <div class="btnRow">
              <button class="btn blue" id="btnOCR">ğŸ” OCRï¼ˆæ–‡å­—èª­å–ï¼‰</button>
              <button class="btn ghost" id="btnManualAdd">âœï¸ æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
            </div>

            <div class="hint" style="margin-top:8px;">
              ãƒ»ãƒãƒ¼ã‚³ãƒ¼ãƒ‰éå¯¾å¿œ/èª­ã‚ãªã„å ´åˆ â†’ OCR or æ‰‹å…¥åŠ›ã€‚<br>
              ãƒ»èª­ã‚ãªã„å ´åˆã¯å¿…ãšã‚¢ãƒ©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆé»™ã‚‰ãªã„ï¼‰ã€‚
            </div>
          </div>

          <div class="card" style="margin:0;">
            <div class="sectionTitle">
              <h3>è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå¿…é ˆï¼‰</h3>
              <div class="hint">åå‰/éƒµä¾¿ç•ªå·/ä½æ‰€/é›»è©± = å¿…é ˆ</div>
            </div>

            <label>ãŠå®¢æ§˜åï¼ˆå¿…é ˆï¼‰</label>
            <input id="fName" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ" />

            <div style="height:8px;"></div>
            <label>éƒµä¾¿ç•ªå·ï¼ˆå¿…é ˆï¼‰</label>
            <input id="fZip" inputmode="numeric" placeholder="ä¾‹ï¼š892-0816" />

            <div style="height:8px;"></div>
            <label>ä½æ‰€ï¼ˆå¿…é ˆï¼‰</label>
            <input id="fAddr" placeholder="ä¾‹ï¼šé¹¿å…å³¶çœŒé¹¿å…å³¶å¸‚..." />

            <div style="height:8px;"></div>
            <label>é›»è©±ç•ªå·ï¼ˆå¿…é ˆï¼‰</label>
            <input id="fTel" inputmode="tel" placeholder="ä¾‹ï¼š090xxxxxxxx" />

            <div style="height:8px;"></div>
            <label>ä¼ç¥¨ç•ªå·ï¼ˆä»»æ„ï¼šã‚¹ã‚­ãƒ£ãƒ³ã§å…¥ã‚‹ï¼‰</label>
            <input id="fWaybill" placeholder="ä¾‹ï¼š1234-5678-..." />

            <div class="btnRow">
              <button class="btn green" id="btnAdd">â• ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
              <button class="btn ghost" id="btnClearForm">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
            </div>

            <div class="hint" style="margin-top:8px;">
              éƒµä¾¿ç•ªå·â†’ä½æ‰€ã¯è‡ªå‹•è£œå®Œï¼ˆZipCloudï¼‰ã€‚ä½æ‰€ãŒå–ã‚Œãªã„å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒ ã€‚
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== LIST ===== -->
    <section class="view" id="view-list" style="display:none;">
      <div class="card">
        <div class="sectionTitle">
          <h3>é…é”ãƒªã‚¹ãƒˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆ / ã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰</h3>
          <div class="hint">é‡è¤‡ã¯ã‚¢ãƒ©ãƒ¼ãƒ è¡¨ç¤º</div>
        </div>

        <div class="btnRow">
          <button class="btn blue" id="btnSortNear">ğŸ“ è¿‘ã„é †ã«ä¸¦ã¹ã‚‹ï¼ˆGPSå¿…é ˆï¼‰</button>
          <button class="btn ghost" id="btnExportCSV">â¬‡ï¸ CSVå‡ºåŠ›</button>
          <button class="btn ghost" id="btnPrintList">ğŸ“„ PDFï¼ˆå°åˆ·ï¼‰</button>
          <button class="btn danger" id="btnClearAll">ğŸ—‘ å…¨å‰Šé™¤</button>
        </div>

        <div class="swipeHint">æ“ä½œï¼š<b>å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼å®Œäº†</b> / <b>å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ä¸åœ¨</b> / é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ï¼é †ç•ªå¤‰æ›´</div>

        <div id="listWrap" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- ===== MAP ===== -->
    <section class="view" id="view-map" style="display:none;">
      <div class="card">
        <div class="sectionTitle">
          <h3>åœ°å›³ï¼ˆGoogle Map / 360Â°å›è»¢ / GPSè¿½å¾“ï¼‰</h3>
          <div class="hint">ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—â†’å¯¾è±¡ã¸ã€‚ãƒ”ãƒ³ä¿®æ­£OKã€‚</div>
        </div>

        <div class="btnRow">
          <button class="btn blue" id="btnInitMap">ğŸ—º åœ°å›³ã‚’è¡¨ç¤ºï¼ˆAPIã‚­ãƒ¼å¿…é ˆï¼‰</button>
          <button class="btn primary" id="btnFollowMe">ğŸ§­ è‡ªè»Šè¿½å¾“ON/OFF</button>
          <button class="btn ghost" id="btnRebuildPins">ğŸ“Œ ãƒ”ãƒ³å†ç”Ÿæˆ</button>
        </div>

        <div id="map"></div>

        <div class="hint" style="margin-top:10px;">
          â€» 360Â°å›è»¢/å‚¾ãã¯ Google Map ã® <b>heading/tilt</b> ã‚’ä½¿ã„ã¾ã™ã€‚ç«¯æœ«/è¨­å®šã«ã‚ˆã‚ŠæŒ™å‹•ãŒç•°ãªã‚Šã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- ===== REPORT ===== -->
    <section class="view" id="view-report" style="display:none;">
      <div class="card">
        <div class="sectionTitle">
          <h3>æ—¥å ±</h3>
          <div class="hint">å®Œäº†/ä¸åœ¨/æœªé…é”ãŒè‡ªå‹•é›†è¨ˆ</div>
        </div>

        <div class="grid2">
          <div>
            <label>æœ¬æ—¥ã®ãƒ¡ãƒ¢</label>
            <textarea id="reportMemo" placeholder="ä¾‹ï¼šã‚¯ãƒ¬ãƒ¼ãƒ ãƒ»æ³¨æ„ç‚¹ãƒ»å¼•ç¶™ããªã©"></textarea>
          </div>
          <div>
            <label>é›†è¨ˆ</label>
            <div class="card" style="box-shadow:none;">
              <div style="font-weight:1000; line-height:1.9;">
                æœªé…é”ï¼š<span id="stTodo">0</span><br>
                å®Œäº†ï¼š<span id="stDone">0</span><br>
                ä¸åœ¨ï¼š<span id="stAbsent">0</span><br>
                åˆè¨ˆï¼š<span id="stAll">0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn green" id="btnSaveReport">âœ… æ—¥å ±ä¿å­˜</button>
          <button class="btn ghost" id="btnPrintReport">ğŸ“„ æ—¥å ±PDFï¼ˆå°åˆ·ï¼‰</button>
        </div>
      </div>
    </section>

  </main>

  <div class="bottomBar">
    <div class="bottomRow">
      <div class="counter">
        æœªé…é” <b id="bTodo">0</b> <span>|</span> å®Œäº† <b id="bDone">0</b> <span>|</span> ä¸åœ¨ <b id="bAbsent">0</b>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn primary" style="padding:10px 12px; border-radius:999px;" onclick="goToTab('scan')">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button class="btn ghost" style="padding:10px 12px; border-radius:999px;" onclick="goToTab('list')">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
        <button class="btn blue" style="padding:10px 12px; border-radius:999px;" onclick="goToTab('map')">ğŸ—º åœ°å›³</button>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- ===== Google Mapsï¼ˆã‚­ãƒ¼ã‚’å…¥ã‚ŒãŸã‚‰æœ‰åŠ¹ï¼‰===== -->
<script>
  // ã“ã“ã« Google Maps API Key ã‚’å…¥ã‚Œã‚‹ï¼ˆå¿…é ˆï¼‰
  // ä¾‹ï¼šconst GOOGLE_MAPS_API_KEY = "AIza....";
  const GOOGLE_MAPS_API_KEY = "";
</script>

<!-- ===== Firebaseï¼ˆSMSèªè¨¼ï¼šã‚­ãƒ¼ã‚’å…¥ã‚ŒãŸã‚‰æœ‰åŠ¹ï¼‰===== -->
<script type="module">
  /******************************************************************
   * âœ… 0) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ******************************************************************/
  const $ = (id)=>document.getElementById(id);
  const toast = (msg, ms=1500)=>{
    const t=$("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), ms);
  };

  // ãƒ”ãƒƒéŸ³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ï¼‰
  const beep = ()=>{
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine";
      o.frequency.value=880;
      g.gain.value=0.08;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
    }catch(e){}
  };
  const alarm = ()=>{
    beep();
    navigator.vibrate?.([120,80,120]);
  };

  const must = (v)=>String(v||"").trim().length>0;

  /******************************************************************
   * âœ… 1) çŠ¶æ…‹ï¼ˆlocalStorageï¼‰
   ******************************************************************/
  const LS_KEY = "ofa_delivery_app_v1";
  const state = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
  state.user = state.user || null; // { phone, mode }
  state.items = state.items || []; // deliveries
  state.tenko = state.tenko || {};
  state.report = state.report || {};
  state.settings = state.settings || { followMe:true };
  const save = ()=> localStorage.setItem(LS_KEY, JSON.stringify(state));

  // item model:
  // { id, name, zip, addr, tel, waybill, status: "todo|done|absent", lat, lng, createdAt }

  /******************************************************************
   * âœ… 2) ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆFirebaseãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ¢ï¼‰
   ******************************************************************/
  const showLogin = ()=> $("loginOverlay").classList.add("show");
  const hideLogin = ()=> $("loginOverlay").classList.remove("show");

  function ensureLogin(){
    if(!state.user){
      showLogin();
    }else{
      hideLogin();
    }
  }

  $("btnDemo").onclick = ()=>{
    const phone = $("phone").value.trim();
    if(!phone){ alarm(); alert("é›»è©±ç•ªå·ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ¢ã§ã‚‚å¿…è¦ï¼‰"); return; }
    state.user = { phone, mode:"demo" };
    save();
    toast("ãƒ‡ãƒ¢ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ");
    hideLogin();
  };

  $("btnLogout").onclick = ()=>{
    state.user=null; save();
    toast("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    showLogin();
  };

  /******************************************************************
   * âœ… 3) Firebase SMSï¼ˆã‚­ãƒ¼å…¥ã‚ŒãŸã‚‰å‹•ãï¼‰
   ******************************************************************/
  // Firebaseã‚’ä½¿ã†ãªã‚‰ã€ã“ã“ã«è¨­å®šã‚’å…¥ã‚Œã‚‹
  const FIREBASE_CONFIG = {
    // apiKey: "",
    // authDomain: "",
    // projectId: "",
    // appId: "",
  };

  let fbAuth=null, confirmationResult=null;

  async function initFirebaseIfReady(){
    const hasKey = FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey;
    if(!hasKey) return;

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js");
    const { getAuth, RecaptchaVerifier, signInWithPhoneNumber } =
      await import("https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js");

    const app = initializeApp(FIREBASE_CONFIG);
    fbAuth = getAuth(app);

    // invisible reCAPTCHAï¼ˆiOSã§ã‚‚æ¯”è¼ƒçš„å®‰å®šï¼‰
    window.recaptchaVerifier = new RecaptchaVerifier(fbAuth, "recaptcha-container", {
      size: "invisible"
    });
    window._signInWithPhoneNumber = (phone)=> signInWithPhoneNumber(fbAuth, phone, window.recaptchaVerifier);
    window._RecaptchaVerifier = RecaptchaVerifier;
  }

  await initFirebaseIfReady();

  $("btnSendSMS").onclick = async ()=>{
    if(!fbAuth){
      alarm();
      alert("Firebaseè¨­å®šãŒæœªå…¥åŠ›ã§ã™ã€‚ãƒ‡ãƒ¢ã§å…¥ã‚‹ã‹ã€Firebaseè¨­å®šã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
      return;
    }
    let phone = $("phone").value.trim();
    if(!phone){ alarm(); alert("é›»è©±ç•ªå·ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }
    // æ—¥æœ¬ç•ªå·ã‚’ +81 å½¢å¼ã«å¯„ã›ã‚‹ï¼ˆç°¡æ˜“ï¼‰
    if(phone.startsWith("0")) phone = "+81" + phone.slice(1);

    try{
      confirmationResult = await window._signInWithPhoneNumber(phone);
      toast("SMSã‚’é€ä¿¡ã—ã¾ã—ãŸ");
    }catch(e){
      alarm();
      alert("SMSé€ä¿¡å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  };

  $("btnVerify").onclick = async ()=>{
    if(!fbAuth){
      alarm();
      alert("Firebaseè¨­å®šãŒæœªå…¥åŠ›ã§ã™ã€‚ãƒ‡ãƒ¢ã§å…¥ã‚‹ã‹ã€Firebaseè¨­å®šã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
      return;
    }
    if(!confirmationResult){
      alarm();
      alert("å…ˆã«SMSé€ä¿¡ã—ã¦ãã ã•ã„");
      return;
    }
    const code = $("code").value.trim();
    if(!code){ alarm(); alert("6æ¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

    try{
      const res = await confirmationResult.confirm(code);
      const phone = $("phone").value.trim();
      state.user = { phone, mode:"sms", uid: res.user.uid };
      save();
      toast("èªè¨¼æˆåŠŸï¼");
      hideLogin();
    }catch(e){
      alarm();
      alert("èªè¨¼å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  };

  /******************************************************************
   * âœ… 4) ã‚¿ãƒ–åˆ‡æ›¿
   ******************************************************************/
  window.goToTab = (tab)=>{
    const tabs = ["tenko","scan","list","map","report"];
    for(const t of tabs){
      $("view-"+t).style.display = (t===tab) ? "" : "none";
      document.querySelector(`.tabBtn[data-tab="${t}"]`)?.classList.toggle("active", t===tab);
    }
    // ãƒãƒƒãƒ—ã‚¿ãƒ–ã«å…¥ã£ãŸã‚‰GPSãƒã‚§ãƒƒã‚¯å¼·ã‚ã«
    if(tab==="map") checkGPSGate();
  };

  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.onclick = ()=> goToTab(b.dataset.tab);
  });

  /******************************************************************
   * âœ… 5) GPSï¼ˆå¼·åˆ¶ONã‚²ãƒ¼ãƒˆï¼‰
   ******************************************************************/
  let watchId=null;
  let myPos = null;
  let gpsOK = false;

  function setGpsUI(ok){
    gpsOK = ok;
    $("gpsText").textContent = ok ? "OK" : "NG";
    $("dotGps").className = "dot " + (ok ? "ok":"ng");
    $("gpsBanner").style.display = ok ? "none" : "";
  }

  async function requestGPS(){
    if(!navigator.geolocation){
      setGpsUI(false);
      alarm();
      alert("ã“ã®ç«¯æœ«ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
      return;
    }
    // ã¾ãš1å›å–å¾—
    navigator.geolocation.getCurrentPosition((pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, heading: pos.coords.heading||0 };
      setGpsUI(true);
      startWatch();
      toast("GPS OK");
      if(map && state.settings.followMe) centerToMe();
    }, (err)=>{
      setGpsUI(false);
      alarm();
      alert("GPSãŒå–ã‚Œã¾ã›ã‚“ã€‚\nSafariè¨­å®šâ†’ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n" + (err?.message||""));
    }, { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
  }

  function startWatch(){
    if(watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition((pos)=>{
      myPos = { lat: pos.coords.latitude, lng: pos.coords.longitude, heading: pos.coords.heading||0 };
      setGpsUI(true);
      if(map && state.settings.followMe) centerToMe();
    }, (err)=>{
      setGpsUI(false);
    }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
  }

  function checkGPSGate(){
    if(!gpsOK){
      // ä½œæ¥­é–‹å§‹ä¸å¯ï¼šå¼·ã‚ã«é€šçŸ¥
      $("gpsBanner").style.display = "";
    }
  }

  $("btnRequestGPS").onclick = ()=> requestGPS();

  /******************************************************************
   * âœ… 6) éƒµä¾¿ç•ªå·â†’ä½æ‰€ï¼ˆZipCloudï¼‰
   ******************************************************************/
  function normalizeZip(z){
    z = String(z||"").trim().replace(/[^\d]/g,"");
    if(z.length===7) return z.slice(0,3)+"-"+z.slice(3);
    return z;
  }

  async function fillAddressByZip(zip){
    const z = normalizeZip(zip);
    $("fZip").value = z;
    const dig = z.replace("-","");
    if(dig.length!==7) return;

    try{
      const url = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${dig}`;
      const res = await fetch(url);
      const data = await res.json();
      if(data?.results?.[0]){
        const r = data.results[0];
        const addr = `${r.address1}${r.address2}${r.address3}`;
        $("fAddr").value = addr;
        toast("ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ");
      }else{
        alarm();
        alert("ä½æ‰€ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆéƒµä¾¿ç•ªå·ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
      }
    }catch(e){
      // ãƒãƒƒãƒˆä¸å®‰å®šæ™‚
      alarm();
      alert("ä½æ‰€å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡çŠ¶æ³ç¢ºèªï¼‰");
    }
  }

  $("fZip").addEventListener("change", (e)=> fillAddressByZip(e.target.value));

  /******************************************************************
   * âœ… 7) ãƒªã‚¹ãƒˆè¿½åŠ ï¼ˆé‡è¤‡ã‚¢ãƒ©ãƒ¼ãƒ  / å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼‰
   ******************************************************************/
  function makeId(){ return "id_" + Math.random().toString(16).slice(2) + Date.now(); }

  function isDuplicate(waybill, addr){
    const wb = String(waybill||"").trim();
    const ad = String(addr||"").trim();
    return state.items.some(it=>{
      const sameW = wb && it.waybill && String(it.waybill).trim()===wb;
      const sameA = ad && it.addr && String(it.addr).trim()===ad;
      return sameW || sameA;
    });
  }

  function addItem(payload){
    // å¿…é ˆ
    if(!must(payload.name) || !must(payload.zip) || !must(payload.addr) || !must(payload.tel)){
      alarm();
      alert("å¿…é ˆï¼šåå‰/éƒµä¾¿ç•ªå·/ä½æ‰€/é›»è©±ç•ªå· ã‚’å…¥ã‚Œã¦ãã ã•ã„");
      return false;
    }

    // é‡è¤‡åˆ¤å®š
    if(isDuplicate(payload.waybill, payload.addr)){
      alarm();
      alert("âš  ãƒªã‚¹ãƒˆé‡è¤‡ã§ã™ï¼ˆä¼ç¥¨ç•ªå· or ä½æ‰€ãŒæ—¢ã«å­˜åœ¨ï¼‰");
      return false;
    }

    const it = {
      id: makeId(),
      name: payload.name.trim(),
      zip: normalizeZip(payload.zip),
      addr: payload.addr.trim(),
      tel: payload.tel.trim(),
      waybill: (payload.waybill||"").trim(),
      status: "todo",
      lat: null,
      lng: null,
      createdAt: Date.now()
    };
    state.items.unshift(it);
    save();
    renderAll();
    successScanFeedback();
    goToTab("list"); // â† è‡ªå‹•ã§ãƒªã‚¹ãƒˆã¸
    return true;
  }

  function clearForm(){
    $("fName").value="";
    $("fZip").value="";
    $("fAddr").value="";
    $("fTel").value="";
    $("fWaybill").value="";
  }
  $("btnClearForm").onclick = clearForm;

  $("btnAdd").onclick = async ()=>{
    // zipâ†’ä½æ‰€é€£å‹•ï¼ˆæœªå…¥åŠ›ãªã‚‰å…ˆã«å–å¾—ã‚’è©¦ã¿ã‚‹ï¼‰
    const zip = $("fZip").value;
    const addr = $("fAddr").value;
    if(zip && !addr) await fillAddressByZip(zip);

    const ok = addItem({
      name: $("fName").value,
      zip: $("fZip").value,
      addr: $("fAddr").value,
      tel: $("fTel").value,
      waybill: $("fWaybill").value
    });

    if(ok) clearForm();
  };

  $("btnManualAdd").onclick = ()=>{
    alarm();
    toast("æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼šå¿…é ˆã‚’åŸ‹ã‚ã¦è¿½åŠ ã—ã¦ãã ã•ã„", 1800);
    $("fName").focus();
  };

  function successScanFeedback(){
    beep();
    navigator.vibrate?.(200);
  }

  /******************************************************************
   * âœ… 8) ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆBarcodeDetectorï¼šå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
   ******************************************************************/
  let stream=null, scanning=false;
  let detector=null;
  let torchOn=false;
  let lastHit="";

  async function startCamera(){
    // GPSãŒNGãªã‚‰å…ˆã«è¨±å¯
    if(!gpsOK){
      alarm();
      alert("GPSãŒOFFã§ã™ã€‚å…ˆã«GPSã‚’ONã«ã—ã¦ãã ã•ã„ï¼ˆç¨¼åƒå‰å¿…é ˆï¼‰");
      checkGPSGate();
      return;
    }

    if(!navigator.mediaDevices?.getUserMedia){
      alarm();
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã«éå¯¾å¿œã§ã™ã€‚");
      return;
    }
    // iOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã®ã¿èµ·å‹•ï¼ˆã“ã®ãƒœã‚¿ãƒ³ã§OKï¼‰
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:"environment", width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    $("video").srcObject = stream;
    await $("video").play();
    scanning=true;
    torchOn=false; updateTorchUI();

    // BarcodeDetector ãŒã‚ã‚Œã°ä½¿ã†ï¼ˆQR/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰
    if("BarcodeDetector" in window){
      try{
        detector = new BarcodeDetector({ formats:["qr_code","code_128","code_39","ean_13","ean_8","itf"] });
      }catch(e){
        detector = new BarcodeDetector();
      }
      scanLoop();
      toast("SCANé–‹å§‹");
    }else{
      alarm();
      alert("ã“ã®ç«¯æœ«ã¯è‡ªå‹•ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­å–ã«éå¯¾å¿œã§ã™ã€‚\nOCRã¾ãŸã¯æ‰‹å…¥åŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
    }
  }

  async function stopCamera(){
    scanning=false;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream=null;
    }
    $("video").srcObject=null;
    toast("åœæ­¢ã—ã¾ã—ãŸ");
  }

  async function scanLoop(){
    if(!scanning || !detector) return;

    try{
      const video = $("video");
      const barcodes = await detector.detect(video);
      if(barcodes?.length){
        const raw = barcodes[0].rawValue || "";
        if(raw && raw !== lastHit){
          lastHit = raw;
          // æˆåŠŸï¼šéŸ³
          successScanFeedback();
          // ä¼ç¥¨ç•ªå·ã¸å…¥ã‚Œã‚‹ï¼ˆæœ€ä½é™ï¼‰
          $("fWaybill").value = raw;
          toast("èª­å–æˆåŠŸï¼šä¼ç¥¨ç•ªå·ã‚’å…¥åŠ›ã—ã¾ã—ãŸ", 1400);
          // è‡ªå‹•ã§ãƒªã‚¹ãƒˆã¸ã¯ã€Œè¿½åŠ ã€å¾Œã«
        }
      }
    }catch(e){}
    requestAnimationFrame(scanLoop);
  }

  $("btnStartCam").onclick = async ()=>{
    try{ await startCamera(); }
    catch(e){ alarm(); alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼š\n"+(e?.message||e)); }
  };
  $("btnStopCam").onclick = ()=> stopCamera();

  async function toggleTorch(){
    if(!stream) { alarm(); alert("å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„"); return; }
    const track = stream.getVideoTracks()[0];
    const cap = track.getCapabilities?.();
    if(!cap?.torch){
      alarm();
      alert("ã“ã®ç«¯æœ«ã¯ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã«éå¯¾å¿œã§ã™");
      return;
    }
    torchOn = !torchOn;
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    updateTorchUI();
  }
  function updateTorchUI(){
    $("torchText").textContent = torchOn ? "ON" : "OFF";
    $("dotTorch").className = "dot " + (torchOn ? "ok":"warn");
  }
  $("btnTorch").onclick = ()=> toggleTorch();

  /******************************************************************
   * âœ… 9) OCRï¼ˆå¿…è¦æ™‚ã®ã¿ Tesseract.js ã‚’èª­ã¿è¾¼ã¿ï¼‰
   *    - ç”»åƒå‰å‡¦ç†ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ/äºŒå€¤åŒ–ï¼‰â†’ ç²¾åº¦UP
   ******************************************************************/
  async function loadTesseract(){
    if(window.Tesseract) return window.Tesseract;
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    document.head.appendChild(s);
    await new Promise((r,rej)=>{ s.onload=r; s.onerror=rej; });
    return window.Tesseract;
  }

  function preprocessToCanvas(video){
    const c = document.createElement("canvas");
    const w = 1280;
    const h = 720;
    c.width=w; c.height=h;
    const ctx = c.getContext("2d",{ willReadFrequently:true });
    ctx.drawImage(video, 0,0,w,h);

    // å‰å‡¦ç†ï¼šã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«â†’ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆâ†’äºŒå€¤åŒ–
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let v = (r*0.299 + g*0.587 + b*0.114);
      // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·ã‚
      v = (v - 128) * 1.3 + 128;
      // äºŒå€¤åŒ–
      const bw = v > 140 ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=bw;
    }
    ctx.putImageData(img,0,0);
    return c;
  }

  function extractFields(text){
    // éƒµä¾¿ç•ªå·
    const zipMatch = text.match(/\b\d{3}\s*-\s*\d{4}\b|\b\d{7}\b/);
    const zip = zipMatch ? normalizeZip(zipMatch[0]) : "";

    // é›»è©±
    const telMatch = text.match(/0\d{1,4}[-\s]?\d{1,4}[-\s]?\d{3,4}/);
    const tel = telMatch ? telMatch[0].replace(/\s/g,"") : "";

    return { zip, tel };
  }

  $("btnOCR").onclick = async ()=>{
    if(!stream || !scanning){
      alarm();
      alert("å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼ˆSCANé–‹å§‹ï¼‰");
      return;
    }
    try{
      toast("OCRæº–å‚™ä¸­â€¦");
      const T = await loadTesseract();

      const v = $("video");
      const canvas = preprocessToCanvas(v);

      toast("OCRè§£æä¸­â€¦ï¼ˆå°‘ã—å¾…ã£ã¦ï¼‰", 1800);
      const { data } = await T.recognize(canvas, "jpn");
      const txt = (data?.text || "").replace(/\n+/g,"\n");
      const { zip, tel } = extractFields(txt);

      if(!zip && !tel){
        alarm();
        alert("OCRã§èª­ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚\nå…‰é‡ã‚’ä¸Šã’ã‚‹ / ä¼ç¥¨ã‚’æ ã«è¿‘ã¥ã‘ã‚‹ / ãƒ©ã‚¤ãƒˆON ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if(zip) $("fZip").value = zip;
      if(tel) $("fTel").value = tel;

      // zipâ†’ä½æ‰€é€£å‹•
      if(zip) await fillAddressByZip(zip);

      successScanFeedback();
      toast("OCRæˆåŠŸï¼šéƒµä¾¿ç•ªå·/é›»è©±ã‚’å…¥åŠ›ã—ã¾ã—ãŸ", 1600);

    }catch(e){
      alarm();
      alert("OCRå¤±æ•—ï¼š\n"+(e?.message||e));
    }
  };

  /******************************************************************
   * âœ… 10) ãƒªã‚¹ãƒˆï¼šæç”» / ãƒ‰ãƒ©ãƒƒã‚° / ã‚¹ãƒ¯ã‚¤ãƒ— / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
   ******************************************************************/
  function setCounts(){
    $("cScan").textContent = state.items.length;
    $("cList").textContent = state.items.length;
    $("cMap").textContent = state.items.filter(i=>i.status==="todo").length;
    $("cReport").textContent = state.items.length;

    const todo = state.items.filter(i=>i.status==="todo").length;
    const done = state.items.filter(i=>i.status==="done").length;
    const absent = state.items.filter(i=>i.status==="absent").length;

    $("bTodo").textContent = todo;
    $("bDone").textContent = done;
    $("bAbsent").textContent = absent;

    $("stTodo").textContent = todo;
    $("stDone").textContent = done;
    $("stAbsent").textContent = absent;
    $("stAll").textContent = state.items.length;

    $("pinCount").textContent = String(state.items.length);
    $("dotPin").className = "dot " + (state.items.length ? "ok":"");
  }

  function statusChip(st){
    if(st==="todo") return `<span class="chip blue">æœªé…é”</span>`;
    if(st==="done") return `<span class="chip green">å®Œäº†</span>`;
    if(st==="absent") return `<span class="chip red">ä¸åœ¨</span>`;
    return `<span class="chip">-</span>`;
  }

  function openNav(addr){
    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    window.open(url, "_blank");
  }

  function copyText(text){
    navigator.clipboard?.writeText(text).then(()=>toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
  }

  function setStatus(id, st){
    const it = state.items.find(x=>x.id===id);
    if(!it) return;
    it.status = st;
    save();
    renderAll();
    alarm();
    toast(st==="done" ? "å®Œäº†ã«ã—ã¾ã—ãŸ" : "ä¸åœ¨ã«ã—ã¾ã—ãŸ");
  }

  function removeItem(id){
    state.items = state.items.filter(x=>x.id!==id);
    save();
    renderAll();
    alarm();
    toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function renderList(){
    const wrap = $("listWrap");
    wrap.innerHTML = "";

    const items = state.items;

    items.forEach((it, idx)=>{
      const div = document.createElement("div");
      div.className = "listItem";
      div.dataset.id = it.id;

      div.innerHTML = `
        <div class="badgeNum">${idx+1}</div>
        <div class="liMain">
          <div class="liTop">
            <div class="liName">${escapeHtml(it.name || "(ãŠå®¢æ§˜åãªã—)")}</div>
          </div>
          <div class="liSmall">ğŸ“ ${escapeHtml(it.addr || "")}</div>
          <div class="liSmall">â˜ ${escapeHtml(it.tel || "")}ã€€/ã€€ã€’ ${escapeHtml(it.zip || "")}</div>
          ${it.waybill ? `<div class="liSmall">ğŸ§¾ ${escapeHtml(it.waybill)}</div>` : ``}
          <div class="chips">
            ${statusChip(it.status)}
            <span class="chip yellow">å®…é…</span>
          </div>
        </div>
        <div class="liBtns">
          <button class="miniBtn blue" data-act="nav">ğŸ§­ ãƒŠãƒ“</button>
          <button class="miniBtn" data-act="copy">ğŸ“‹ ä½æ‰€ã‚³ãƒ”ãƒ¼</button>
          <button class="miniBtn gray" data-act="scan">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³ç…§åˆ</button>
          <button class="miniBtn yellow" data-act="pin">ğŸ“Œ ãƒ”ãƒ³ä¿®æ­£</button>
          <button class="miniBtn green" data-act="done">âœ… å®Œäº†</button>
          <button class="miniBtn red" data-act="absent">ğŸš« ä¸åœ¨</button>
          <button class="miniBtn" data-act="del">ğŸ—‘</button>
        </div>
      `;

      // ãƒœã‚¿ãƒ³
      div.querySelectorAll("button").forEach(btn=>{
        btn.onclick = ()=>{
          const act = btn.dataset.act;
          if(act==="nav") openNav(it.addr);
          if(act==="copy") copyText(it.addr);
          if(act==="scan"){
            // é…é”å…ˆã§ã‚¹ã‚­ãƒ£ãƒ³ç…§åˆã™ã‚‹æƒ³å®šï¼šã“ã“ã§ã¯ä¼ç¥¨ç•ªå·ä¸€è‡´ãƒã‚§ãƒƒã‚¯UIã®ç°¡æ˜“ç‰ˆ
            const input = prompt("ä¼ç¥¨ç•ªå·ã‚’å…¥åŠ›ï¼ˆç…§åˆï¼‰", "");
            if(!input) return;
            if(String(input).trim() === String(it.waybill||"").trim()){
              successScanFeedback(); toast("ç…§åˆOK", 1400);
            }else{
              alarm(); alert("âš  ç…§åˆNGï¼ˆä¼ç¥¨ç•ªå·ãŒé•ã„ã¾ã™ï¼‰");
            }
          }
          if(act==="pin"){
            goToTab("map");
            setTimeout(()=>focusItemOnMap(it.id, true), 300);
          }
          if(act==="done") setStatus(it.id, "done");
          if(act==="absent") setStatus(it.id, "absent");
          if(act==="del") removeItem(it.id);
        };
      });

      // ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆç°¡æ˜“ï¼‰
      addSwipe(div, {
        onLeft: ()=> setStatus(it.id, "done"),
        onRight: ()=> setStatus(it.id, "absent")
      });

      wrap.appendChild(div);
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆ
    Sortable.create(wrap, {
      animation: 150,
      onEnd: (evt)=>{
        const ids = [...wrap.querySelectorAll(".listItem")].map(el=>el.dataset.id);
        state.items.sort((a,b)=> ids.indexOf(a.id) - ids.indexOf(b.id));
        save();
        renderAll();
        toast("é †ç•ªã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }
    });
  }

  function addSwipe(el, {onLeft,onRight}){
    let x0=null, y0=null;
    el.addEventListener("touchstart",(e)=>{
      const t=e.touches[0];
      x0=t.clientX; y0=t.clientY;
    }, {passive:true});
    el.addEventListener("touchend",(e)=>{
      if(x0==null) return;
      const t=e.changedTouches[0];
      const dx=t.clientX-x0;
      const dy=t.clientY-y0;
      x0=null; y0=null;
      if(Math.abs(dy)>Math.abs(dx)) return;
      if(dx<-70) onLeft?.();
      if(dx>70) onRight?.();
    }, {passive:true});
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  /******************************************************************
   * âœ… 11) CSV / å°åˆ·ï¼ˆPDFï¼ãƒ–ãƒ©ã‚¦ã‚¶å°åˆ·ï¼‰
   ******************************************************************/
  function exportCSV(){
    const rows = [
      ["name","zip","addr","tel","waybill","status","createdAt"]
    ];
    for(const it of state.items){
      rows.push([
        it.name, it.zip, it.addr, it.tel, it.waybill, it.status, new Date(it.createdAt).toISOString()
      ]);
    }
    const csv = rows.map(r=>r.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `ofa_list_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    toast("CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ");
  }
  $("btnExportCSV").onclick = exportCSV;

  function printPage(){
    window.print();
  }
  $("btnPrintList").onclick = printPage;
  $("btnTenkoPDF").onclick = printPage;
  $("btnPrintReport").onclick = printPage;

  $("btnClearAll").onclick = ()=>{
    if(!confirm("å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    state.items = [];
    save();
    renderAll();
    alarm();
    toast("å…¨å‰Šé™¤ã—ã¾ã—ãŸ");
  };

  /******************************************************************
   * âœ… 12) ç‚¹å‘¼ / æ—¥å ± ä¿å­˜
   ******************************************************************/
  $("btnSaveTenko").onclick = ()=>{
    state.tenko = {
      name: $("tenkoName").value.trim(),
      area: $("tenkoArea").value.trim(),
      memo: $("tenkoMemo").value.trim(),
      checks: [...document.querySelectorAll(".chkTenko")].map(c=>c.checked),
      savedAt: Date.now()
    };
    save();
    successScanFeedback();
    toast("ç‚¹å‘¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  };

  $("btnSaveReport").onclick = ()=>{
    state.report = {
      memo: $("reportMemo").value.trim(),
      savedAt: Date.now()
    };
    save();
    successScanFeedback();
    toast("æ—¥å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  };

  /******************************************************************
   * âœ… 13) è¿‘ã„é †ä¸¦ã¹æ›¿ãˆï¼ˆç°¡æ˜“ï¼šç·¯åº¦çµŒåº¦ãŒã‚ã‚‹ã‚‚ã®ã ã‘ï¼‰
   ******************************************************************/
  $("btnSortNear").onclick = ()=>{
    if(!gpsOK || !myPos){
      alarm();
      alert("GPSãŒå¿…è¦ã§ã™ã€‚å…ˆã«GPSã‚’ONã«ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    // ä½æ‰€â†’åº§æ¨™ã¯Googleã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå¿…è¦ï¼ˆæœ¬ç•ªã¯APIã§å®Ÿè£…ï¼‰
    // ã“ã“ã§ã¯ã€Œæ—¢ã«åº§æ¨™ãŒã‚ã‚‹ã‚‚ã®ã€ã‚’è·é›¢ã§ä¸¦ã¹æ›¿ãˆã‚‹
    state.items.sort((a,b)=>{
      const da = (a.lat && a.lng) ? dist(myPos.lat,myPos.lng,a.lat,a.lng) : 1e9;
      const db = (b.lat && b.lng) ? dist(myPos.lat,myPos.lng,b.lat,b.lng) : 1e9;
      return da-db;
    });
    save();
    renderAll();
    toast("è¿‘ã„é †ï¼ˆåº§æ¨™ã‚ã‚Šã®ã¿ï¼‰ã§ä¸¦ã¹ã¾ã—ãŸ");
  };

  function dist(lat1,lng1,lat2,lng2){
    const R=6371e3;
    const toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1);
    const dLng=toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  /******************************************************************
   * âœ… 14) Google Mapï¼ˆ360Â°å›è»¢ / è¿½å¾“ / ãƒ”ãƒ³ï¼‰
   ******************************************************************/
  let map=null;
  let markers=new Map();
  let followMe=true;

  function loadGoogleMaps(){
    return new Promise((resolve, reject)=>{
      if(!GOOGLE_MAPS_API_KEY){
        alarm();
        alert("Google Maps APIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚\nã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šéƒ¨ã® GOOGLE_MAPS_API_KEY ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚");
        return reject(new Error("NO_KEY"));
      }
      if(window.google?.maps) return resolve();
      const s=document.createElement("script");
      s.src=`https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&v=weekly`;
      s.async=true;
      s.onload=()=>resolve();
      s.onerror=()=>reject(new Error("MAP_LOAD_FAIL"));
      document.head.appendChild(s);
    });
  }

  function centerToMe(){
    if(!map || !myPos) return;
    map.setCenter({lat:myPos.lat, lng:myPos.lng});
    // heading/tiltï¼ˆç«¯æœ«ã«ã‚ˆã£ã¦æœ‰åŠ¹ç„¡åŠ¹ã‚ã‚Šï¼‰
    try{
      map.setHeading(myPos.heading || 0);
      map.setTilt(45);
    }catch(e){}
  }

  function buildPins(){
    if(!map) return;
    // clear
    markers.forEach(m=>m.setMap(null));
    markers.clear();

    // todoã®ã¿è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰å…¨éƒ¨ã«å¤‰æ›´å¯èƒ½ï¼‰
    const showItems = state.items.filter(i=>i.status==="todo");

    for(const it of showItems){
      // åº§æ¨™ãŒç„¡ã„å ´åˆï¼šãƒ”ãƒ³ä¿®æ­£ã§é…ç½®ï¼ˆæœ¬ç•ªã¯ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§è‡ªå‹•åŒ–ï¼‰
      if(it.lat==null || it.lng==null) continue;

      const m = new google.maps.Marker({
        position:{lat:it.lat, lng:it.lng},
        map,
        title: it.name,
        draggable:true
      });

      m.addListener("dragend", (e)=>{
        it.lat = e.latLng.lat();
        it.lng = e.latLng.lng();
        save();
        toast("ãƒ”ãƒ³ã‚’ä¿®æ­£ã—ã¾ã—ãŸ");
      });

      m.addListener("click", ()=>{
        toast(`${it.name} ã‚’è¡¨ç¤º`);
      });

      markers.set(it.id, m);
    }

    $("pinCount").textContent = String(markers.size);
    $("dotPin").className = "dot " + (markers.size ? "ok":"");
  }

  window.focusItemOnMap = (id, askIfNoPos)=>{
    const it = state.items.find(x=>x.id===id);
    if(!it || !map) return;

    if(it.lat==null || it.lng==null){
      if(askIfNoPos){
        alarm();
        alert("ã“ã®è·ç‰©ã¯åº§æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nåœ°å›³ä¸Šã‚’é•·æŠ¼ã—ã§ãƒ”ãƒ³è¨­ç½®ã—ã¦ãã ã•ã„ã€‚");
      }
      return;
    }
    map.panTo({lat:it.lat, lng:it.lng});
    map.setZoom(17);
  };

  function enableLongPressToAddPin(){
    if(!map) return;
    let pressTimer=null;

    map.addListener("mousedown", (e)=>{
      pressTimer = setTimeout(()=>{
        // æœªé…é”ã®å…ˆé ­ã«ä»˜ä¸ï¼ˆã“ã“ã¯è¦æœ›ã«åˆã‚ã›ã¦ã€Œé¸æŠä¸­ã®è·ç‰©ã€ã«ä»˜ä¸ã¸å¤‰æ›´å¯èƒ½ï¼‰
        const target = state.items.find(i=>i.status==="todo");
        if(!target){
          alarm(); alert("æœªé…é”ãŒã‚ã‚Šã¾ã›ã‚“"); return;
        }
        target.lat = e.latLng.lat();
        target.lng = e.latLng.lng();
        save();
        buildPins();
        toast(`ãƒ”ãƒ³è¨­ç½®ï¼š${target.name}`);
      }, 600);
    });

    map.addListener("mouseup", ()=>{ if(pressTimer) clearTimeout(pressTimer); });
  }

  $("btnInitMap").onclick = async ()=>{
    try{
      if(!gpsOK){ alarm(); alert("GPSã‚’ONã«ã—ã¦ãã ã•ã„"); return; }
      await loadGoogleMaps();
      map = new google.maps.Map(document.getElementById("map"), {
        center: myPos ? {lat:myPos.lat, lng:myPos.lng} : {lat:31.5966, lng:130.5571},
        zoom: 15,
        mapTypeId: "roadmap",
        gestureHandling: "greedy",
        tilt: 45,
        heading: 0,
        rotateControl: true,
        fullscreenControl: false,
        streetViewControl: false
      });

      followMe = true;
      state.settings.followMe = true;
      save();

      enableLongPressToAddPin();
      buildPins();
      centerToMe();
      toast("åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
    }catch(e){
      alarm();
      alert("åœ°å›³ã‚¨ãƒ©ãƒ¼ï¼š\n"+(e?.message||e));
    }
  };

  $("btnFollowMe").onclick = ()=>{
    followMe = !followMe;
    state.settings.followMe = followMe;
    save();
    toast(followMe ? "è‡ªè»Šè¿½å¾“ ON" : "è‡ªè»Šè¿½å¾“ OFF");
    if(followMe) centerToMe();
  };

  $("btnRebuildPins").onclick = ()=>{
    buildPins();
    toast("ãƒ”ãƒ³ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ");
  };

  /******************************************************************
   * âœ… 15) åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
   ******************************************************************/
  function renderAll(){
    renderList();
    setCounts();
  }

  // åˆæœŸå€¤å¾©å…ƒ
  if(state.tenko){
    $("tenkoName").value = state.tenko.name || "";
    $("tenkoArea").value = state.tenko.area || "";
    $("tenkoMemo").value = state.tenko.memo || "";
    const ch = document.querySelectorAll(".chkTenko");
    (state.tenko.checks||[]).forEach((v,i)=>{ if(ch[i]) ch[i].checked = !!v; });
  }
  if(state.report){
    $("reportMemo").value = state.report.memo || "";
  }

  // èµ·å‹•æ™‚ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
  ensureLogin();

  // èµ·å‹•æ™‚ï¼šGPSã‚’å–ã‚Šã«è¡Œãï¼ˆãŸã ã—iOSã¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã‚‹ã®ã§ã€æœ€åˆã¯ãƒœã‚¿ãƒ³ã§ã‚‚OKï¼‰
  requestGPS();

  renderAll();
  goToTab("tenko");

</script>
</body>
</html>
