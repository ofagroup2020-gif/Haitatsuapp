<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA é…é” ç®¡ç†ç”»é¢ï¼ˆWebï¼‰</title>

  <!-- Leafletï¼ˆè»½ã„åœ°å›³ï¼‰ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PDF / CSV -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --ink:#0b1020; --muted:#667085; --border:#e6e8f0;
      --blue:#1f66ff; --yellow:#ffd400; --red:#ff2d2d; --green:#12b76a;
      --card:#fff; --panel:#f6f8ff; --shadow: 0 10px 30px rgba(15,23,42,.10);
      --r:18px; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Segoe UI", Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 400px at 20% 0%, rgba(31,102,255,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(255,212,0,.14), transparent 55%),
        linear-gradient(#fff,#fff);
      padding-top: calc(10px + var(--safe-top));
      padding-bottom: calc(10px + var(--safe-bottom));
    }
    .top{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.90); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(230,232,240,.9);
      padding: 10px 12px;
    }
    .top-inner{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, var(--yellow), #fff1a6);
      display:grid;place-items:center;font-weight:1000;color:#111;
      box-shadow: 0 10px 24px rgba(255,212,0,.35); border:1px solid rgba(0,0,0,.06);
    }
    h1{font-size:16px;margin:0;font-weight:1000}
    .sub{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}
    .wrap{max-width:1200px;margin:12px auto;padding:0 12px;display:grid;gap:12px;grid-template-columns: 1.2fr .8fr}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card-h{padding:14px;border-bottom:1px solid rgba(230,232,240,.9);display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(90deg, rgba(31,102,255,.10), rgba(255,212,0,.12))}
    .card-h b{font-weight:1000}
    .card-b{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      padding:10px 12px; font-weight:1000; cursor:pointer;
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
    }
    .btn.blue{border-color:rgba(31,102,255,.35); background:linear-gradient(180deg, rgba(31,102,255,.12), #fff)}
    .btn.red{border-color:rgba(255,45,45,.35); background:linear-gradient(180deg, rgba(255,45,45,.12), #fff)}
    .btn.yellow{border-color:rgba(255,212,0,.50); background:linear-gradient(180deg, rgba(255,212,0,.18), #fff)}
    .btn:active{transform: translateY(1px)}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px}
    label{font-size:12px;color:var(--muted);font-weight:900}
    input,select{
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);outline:none;
      font-weight:900;background:#fff
    }
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:700px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px;min-height:62px}
    .kpi .t{font-size:12px;color:var(--muted);font-weight:1000}
    .kpi .v{font-size:20px;font-weight:1100;margin-top:4px}
    .kpi.done .v{color:var(--green)}
    .kpi.ng .v{color:var(--red)}
    .kpi.hold .v{color: #b54708}
    .kpi.hand .v{color: var(--blue)}
    .kpi.total .v{color: #111}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{font-size:12px;text-align:left;color:var(--muted);padding:0 10px;font-weight:1000}
    td{background:#fff;border:1px solid var(--border);padding:10px;border-left:0;border-right:0;font-weight:900}
    tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:14px;border-bottom-right-radius:14px}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:1100;border:1px solid var(--border);background:#fff}
    .badge.done{border-color:rgba(18,183,106,.35);background:rgba(18,183,106,.10);color: #067647}
    .badge.absent{border-color:rgba(255,45,45,.35);background:rgba(255,45,45,.10);color: #b42318}
    .badge.hold{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#92400e}
    .badge.return{border-color:rgba(148,163,184,.6);background:rgba(148,163,184,.12);color:#334155}
    .badge.handover{border-color:rgba(31,102,255,.35);background:rgba(31,102,255,.10);color:#1f66ff}

    .mini{font-size:12px;color:var(--muted);font-weight:900}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .actions .btn{padding:8px 10px;border-radius:12px;font-size:12px}
    #map{height:420px;border-radius:18px;border:1px solid var(--border);overflow:hidden}
    .note{font-size:12px;color:var(--muted);font-weight:900;line-height:1.6}
    .split{display:grid;gap:10px;grid-template-columns:1fr}
  </style>
</head>

<body>
  <div class="top">
    <div class="top-inner">
      <div class="brand">
        <div class="logo">OFA</div>
        <div>
          <h1>OFA é…é” ç®¡ç†ç”»é¢ï¼ˆæœ¬éƒ¨ / æ‹ ç‚¹ï¼‰</h1>
          <div class="sub">é›†è¨ˆãƒ»æ¤œç´¢ãƒ»åœ°å›³ãƒ”ãƒ³ãƒ»CSV/PDFå‡ºåŠ›ï¼ˆGitHub Pagesé‹ç”¨OKï¼‰</div>
        </div>
      </div>

      <div class="row">
        <input id="fileIn" type="file" accept=".json" hidden />
        <button class="btn blue" id="btnImport">ğŸ“¥ JSONå–ã‚Šè¾¼ã¿</button>
        <button class="btn yellow" id="btnExportJSON">ğŸ“¤ JSONæ›¸ãå‡ºã—</button>
        <button class="btn" id="btnExportCSV">ğŸ“„ CSVå‡ºåŠ›</button>
        <button class="btn" id="btnExportPDF">ğŸ§¾ PDFå‡ºåŠ›</button>
        <button class="btn red" id="btnClear">ğŸ—‘ å…¨å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Left: List -->
    <div class="card">
      <div class="card-h">
        <b>ä¸€è¦§ï¼ˆæ¤œç´¢ãƒ»ä¸¦ã³æ›¿ãˆãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ“ä½œï¼‰</b>
        <span class="mini" id="lastInfo">-</span>
      </div>
      <div class="card-b">
        <div class="row" style="margin-bottom:10px">
          <div class="field">
            <label>å¯¾è±¡æ—¥</label>
            <input id="fDate" type="date" />
          </div>
          <div class="field">
            <label>æ‹ ç‚¹ï¼ˆä»»æ„ï¼‰</label>
            <input id="fHub" placeholder="ä¾‹ï¼‰é¹¿å…å³¶/å¤§é˜ª ãªã©">
          </div>
          <div class="field">
            <label>æ‹…å½“ï¼ˆä»»æ„ï¼‰</label>
            <input id="fDriver" placeholder="ä¾‹ï¼‰æ£®ä¸‹ ãªã©">
          </div>
          <div class="field">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="fStatus">
              <option value="">ã™ã¹ã¦</option>
              <option value="OUT">æŒå‡º</option>
              <option value="DONE">å®Œäº†</option>
              <option value="ABSENT">ä¸åœ¨</option>
              <option value="HOLD">ä¿ç®¡</option>
              <option value="RETURN">è¿”å´</option>
              <option value="HANDOVER">å¼•ç¶™</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width:240px">
            <label>æ¤œç´¢ï¼ˆåå‰/ä½æ‰€/ä¼ç¥¨/ä¸‹4æ¡/ãƒ¡ãƒ¢ï¼‰</label>
            <input id="fQuery" placeholder="ä¾‹ï¼‰å¤©ç¥æ©‹ / 5292 / ç”°ä¸­ / ç½®ãé…">
          </div>
          <div class="field">
            <label>ä¸¦ã³æ›¿ãˆ</label>
            <select id="fSort">
              <option value="updated_desc">æ›´æ–°ãŒæ–°ã—ã„é †</option>
              <option value="updated_asc">æ›´æ–°ãŒå¤ã„é †</option>
              <option value="name_asc">åå‰é †</option>
              <option value="addr_asc">ä½æ‰€é †</option>
              <option value="status_asc">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é †</option>
            </select>
          </div>
        </div>

        <div class="kpis" style="margin-bottom:12px">
          <div class="kpi total"><div class="t">ç·æ•°</div><div class="v" id="kTotal">0</div></div>
          <div class="kpi done"><div class="t">å®Œäº†</div><div class="v" id="kDone">0</div></div>
          <div class="kpi ng"><div class="t">ä¸åœ¨</div><div class="v" id="kAbsent">0</div></div>
          <div class="kpi hold"><div class="t">ä¿ç®¡/è¿”å´</div><div class="v" id="kHold">0</div></div>
          <div class="kpi hand"><div class="t">å¼•ç¶™</div><div class="v" id="kHandover">0</div></div>
        </div>

        <div class="note" style="margin-bottom:10px">
          ãƒ»ãƒ”ãƒ³ã‚„ä¸€è¦§ã‹ã‚‰ <b>å®Œäº†/ä¸åœ¨/ä¿ç®¡/è¿”å´/å¼•ç¶™</b> ã‚’æ“ä½œã§ãã¾ã™ï¼ˆæœ¬éƒ¨ãŒä¸€ç›®ã§æŠŠæ¡ã™ã‚‹ãŸã‚ï¼‰ã€‚<br/>
          ãƒ»ãƒ‡ãƒ¼ã‚¿å½¢å¼ã¯ã€Œdriverå´ãŒåãJSONã€ã‚’ãã®ã¾ã¾èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆã“ã®ã‚ã¨ driver.html ã‚’åŒå½¢å¼ã«æƒãˆã¾ã™ï¼‰ã€‚
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>ä¼ç¥¨(ä¸‹4)</th>
                <th>ãŠå®¢æ§˜</th>
                <th>ä½æ‰€</th>
                <th>é›»è©±</th>
                <th>ãƒ¡ãƒ¢</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right: Map -->
    <div class="card">
      <div class="card-h">
        <b>åœ°å›³ï¼ˆè»½é‡ / ãƒ”ãƒ³æ“ä½œï¼‰</b>
        <span class="mini">ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ— â†’ è©³ç´° + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</span>
      </div>
      <div class="card-b">
        <div id="map"></div>
        <div class="note" style="margin-top:10px">
          ãƒ»åœ°å›³ãŒé‡ã„åŸå› ã¯ã€ŒGoogle Mapsã®WebåŸ‹ã‚è¾¼ã¿ + å¤§é‡DOMã€ã§ã™ã€‚ã“ã“ã¯ <b>Leaflet + OSM</b> ã§è»½ãã—ã¾ã™ã€‚<br/>
          ãƒ»å¤§é‡ãƒ”ãƒ³ã¯çŠ¶æ³ã«ã‚ˆã‚Šé‡ããªã‚‹ã®ã§ã€æ¬¡æ®µã§ã€Œã‚¯ãƒ©ã‚¹ã‚¿ã€ã‚‚å…¥ã‚Œã‚‰ã‚Œã¾ã™ï¼ˆå¿…è¦ãªã‚‰è¿½åŠ ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

<script>
/**
 * ===========================
 *  ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆå…±é€šï¼‰
 * ===========================
 * shipment = {
 *   id, date, hub, driver,
 *   tracking, tracking4,
 *   name, zipcode, address, phone,
 *   type, status, memo,
 *   lat, lng,
 *   createdAt, updatedAt,
 *   events: [{t, status, note}]
 * }
 */

const LS_KEY = "ofa_admin_shipments_v1";
let shipments = loadLS();

const $ = (id)=>document.getElementById(id);
const fileIn = $("fileIn");

function nowISO(){ return new Date().toISOString(); }
function todayStr(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function loadLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveLS(){
  localStorage.setItem(LS_KEY, JSON.stringify(shipments));
  $("lastInfo").textContent = `ä¿å­˜ï¼š${new Date().toLocaleString()}`;
}

function statusLabel(s){
  switch(s){
    case "OUT": return ["æŒå‡º","hold"];
    case "DONE": return ["å®Œäº†","done"];
    case "ABSENT": return ["ä¸åœ¨","absent"];
    case "HOLD": return ["ä¿ç®¡","hold"];
    case "RETURN": return ["è¿”å´","return"];
    case "HANDOVER": return ["å¼•ç¶™","handover"];
    default: return ["æœªè¨­å®š",""];
  }
}
function toTracking4(trk){
  const d = (trk||"").replace(/[^\d]/g,"");
  return d.slice(-4) || "";
}

/* ===========================
 *  ãƒ•ã‚£ãƒ«ã‚¿ & è¡¨ç¤º
 * =========================== */
$("fDate").value = todayStr();

$("btnImport").onclick = ()=> fileIn.click();
fileIn.onchange = async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    const arr = Array.isArray(obj) ? obj : (obj.shipments || []);
    // merge by id
    const map = new Map(shipments.map(x=>[x.id,x]));
    for(const it of arr){
      if(!it.id) it.id = crypto.randomUUID();
      it.tracking4 = it.tracking4 || toTracking4(it.tracking);
      map.set(it.id, it);
    }
    shipments = [...map.values()];
    saveLS();
    renderAll();
    alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${arr.length}ä»¶`);
  }catch(err){
    alert("JSONãŒèª­ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }finally{
    fileIn.value = "";
  }
};

$("btnExportJSON").onclick = ()=>{
  const data = { exportedAt: nowISO(), shipments };
  downloadBlob("ofa_shipments.json", JSON.stringify(data,null,2), "application/json");
};

$("btnExportCSV").onclick = ()=>{
  const rows = filtered().map(x=>({
    date:x.date, hub:x.hub, driver:x.driver,
    status:x.status, type:x.type,
    tracking:x.tracking, tracking4:x.tracking4,
    name:x.name, zipcode:x.zipcode, address:x.address, phone:x.phone,
    lat:x.lat, lng:x.lng,
    memo:x.memo,
    updatedAt:x.updatedAt
  }));
  const csv = toCSV(rows);
  downloadBlob(`ofa_${$("fDate").value}_report.csv`, csv, "text/csv");
};

$("btnExportPDF").onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"p", unit:"mm", format:"a4"});
  doc.setFontSize(14);
  doc.text(`OFA é…é”æ—¥å ±ï¼ˆç®¡ç†ï¼‰ ${$("fDate").value}`, 14, 14);
  doc.setFontSize(10);
  const rows = filtered().map(x=>[
    x.status, x.tracking4, x.name,
    (x.address||"").slice(0,24),
    x.phone||"", (x.memo||"").slice(0,20),
    new Date(x.updatedAt||x.createdAt||nowISO()).toLocaleTimeString()
  ]);
  doc.autoTable({
    head:[["çŠ¶æ…‹","ä¸‹4æ¡","åå‰","ä½æ‰€","é›»è©±","ãƒ¡ãƒ¢","æ›´æ–°"]],
    body: rows,
    startY: 18,
    styles:{fontSize:8, cellPadding:2},
    headStyles:{fillColor:[31,102,255]},
  });
  doc.save(`ofa_${$("fDate").value}_report.pdf`);
};

$("btnClear").onclick = ()=>{
  if(!confirm("ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  shipments = [];
  saveLS();
  renderAll();
};

["fDate","fHub","fDriver","fStatus","fQuery","fSort"].forEach(id=>{
  $(id).addEventListener("input", ()=>renderAll());
  $(id).addEventListener("change", ()=>renderAll());
});

function filtered(){
  const d = $("fDate").value;
  const hub = ($("fHub").value||"").trim();
  const drv = ($("fDriver").value||"").trim();
  const st = $("fStatus").value;
  const q = ($("fQuery").value||"").trim().toLowerCase();

  let arr = shipments.filter(x=>{
    if(d && x.date !== d) return false;
    if(hub && !(x.hub||"").includes(hub)) return false;
    if(drv && !(x.driver||"").includes(drv)) return false;
    if(st && x.status !== st) return false;
    if(q){
      const blob = `${x.name||""} ${x.address||""} ${x.zipcode||""} ${x.phone||""} ${x.tracking||""} ${x.tracking4||""} ${x.memo||""}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });

  const sort = $("fSort").value;
  arr.sort((a,b)=>{
    const ua = a.updatedAt||a.createdAt||"";
    const ub = b.updatedAt||b.createdAt||"";
    if(sort==="updated_desc") return (ub>ua?1:-1);
    if(sort==="updated_asc") return (ua>ub?1:-1);
    if(sort==="name_asc") return (a.name||"").localeCompare(b.name||"","ja");
    if(sort==="addr_asc") return (a.address||"").localeCompare(b.address||"","ja");
    if(sort==="status_asc") return (a.status||"").localeCompare(b.status||"");
    return 0;
  });
  return arr;
}

function setStatus(id, status, note=""){
  const x = shipments.find(s=>s.id===id);
  if(!x) return;
  x.status = status;
  x.updatedAt = nowISO();
  x.events = x.events || [];
  x.events.push({t: x.updatedAt, status, note});
  saveLS();
  renderAll();
}

/* ===========================
 *  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
 * =========================== */
function renderTable(){
  const arr = filtered();
  const tb = $("tbody");
  tb.innerHTML = "";

  for(const x of arr){
    const [lab, cls] = statusLabel(x.status);
    const badge = `<span class="badge ${cls}">${lab}</span>`;
    const trk4 = x.tracking4 || toTracking4(x.tracking);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${badge}</td>
      <td><span class="badge" style="border-color:rgba(31,102,255,.35);background:rgba(31,102,255,.08);color:var(--blue)">${escapeHTML(trk4||"-")}</span></td>
      <td>${escapeHTML(x.name||"-")}</td>
      <td>${escapeHTML(x.address||"-")}</td>
      <td>${escapeHTML(x.phone||"")}</td>
      <td>${escapeHTML((x.memo||"").slice(0,40))}</td>
      <td>
        <div class="actions">
          <button class="btn blue" data-act="DONE" data-id="${x.id}">å®Œäº†</button>
          <button class="btn red" data-act="ABSENT" data-id="${x.id}">ä¸åœ¨</button>
          <button class="btn" data-act="HOLD" data-id="${x.id}">ä¿ç®¡</button>
          <button class="btn" data-act="RETURN" data-id="${x.id}">è¿”å´</button>
          <button class="btn" data-act="HANDOVER" data-id="${x.id}">å¼•ç¶™</button>
          <button class="btn" data-act="FOCUS" data-id="${x.id}">åœ°å›³</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  }

  // action handlers
  tb.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act==="FOCUS"){
        focusMarker(id);
        return;
      }
      setStatus(id, act, "admin");
    };
  });
}

/* ===========================
 *  KPI
 * =========================== */
function renderKPI(){
  const arr = filtered();
  const total = arr.length;
  const done = arr.filter(x=>x.status==="DONE").length;
  const absent = arr.filter(x=>x.status==="ABSENT").length;
  const hold = arr.filter(x=>x.status==="HOLD" || x.status==="RETURN").length;
  const hand = arr.filter(x=>x.status==="HANDOVER").length;

  $("kTotal").textContent = total;
  $("kDone").textContent = done;
  $("kAbsent").textContent = absent;
  $("kHold").textContent = hold;
  $("kHandover").textContent = hand;
}

/* ===========================
 *  Map
 * =========================== */
let map, layerMarkers;
const markerById = new Map();

function initMap(){
  map = L.map("map", { zoomControl:true, preferCanvas:true });
  // OSM
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  layerMarkers = L.layerGroup().addTo(map);

  // default Japan
  map.setView([34.6937, 135.5023], 12);
}

function iconFor(status){
  const color =
    status==="DONE" ? "#12b76a" :
    status==="ABSENT" ? "#ff2d2d" :
    status==="HANDOVER" ? "#1f66ff" :
    status==="HOLD" ? "#f59e0b" :
    status==="RETURN" ? "#64748b" :
    "#111827";

  return L.divIcon({
    className: "ofa-pin",
    html: `<div style="
      width:26px;height:26px;border-radius:999px;
      background:${color};
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      border:3px solid #fff;
    "></div>`,
    iconSize: [26,26],
    iconAnchor:[13,13],
    popupAnchor:[0,-12]
  });
}

function renderMap(){
  if(!map) return;
  layerMarkers.clearLayers();
  markerById.clear();

  const arr = filtered().filter(x=>Number.isFinite(x.lat) && Number.isFinite(x.lng));
  if(arr.length){
    const bounds = L.latLngBounds(arr.map(x=>[x.lat,x.lng]));
    map.fitBounds(bounds.pad(0.20));
  }

  for(const x of arr){
    const mk = L.marker([x.lat, x.lng], { icon: iconFor(x.status) }).addTo(layerMarkers);
    markerById.set(x.id, mk);

    const trk4 = x.tracking4 || toTracking4(x.tracking);
    const [lab, cls] = statusLabel(x.status);

    const html = `
      <div style="font-weight:1000;line-height:1.45">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="badge ${cls}">${lab}</span>
          <span class="badge" style="border-color:rgba(31,102,255,.35);background:rgba(31,102,255,.08);color:var(--blue)">ä¸‹4: ${escapeHTML(trk4||"-")}</span>
        </div>
        <div style="margin-top:8px"><b>æ°åï¼š</b>${escapeHTML(x.name||"-")}</div>
        <div><b>ä½æ‰€ï¼š</b>${escapeHTML(x.address||"-")}</div>
        <div><b>é›»è©±ï¼š</b>${escapeHTML(x.phone||"")}</div>
        <div style="margin-top:8px"><b>ãƒ¡ãƒ¢ï¼š</b>${escapeHTML(x.memo||"")}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
          <button class="btn blue" onclick="window.__setStatus('${x.id}','DONE')">å®Œäº†</button>
          <button class="btn red" onclick="window.__setStatus('${x.id}','ABSENT')">ä¸åœ¨</button>
          <button class="btn" onclick="window.__setStatus('${x.id}','HOLD')">ä¿ç®¡</button>
          <button class="btn" onclick="window.__setStatus('${x.id}','RETURN')">è¿”å´</button>
          <button class="btn" onclick="window.__setStatus('${x.id}','HANDOVER')">å¼•ç¶™</button>
        </div>
      </div>
    `;
    mk.bindPopup(html, {maxWidth: 360});
  }
}
window.__setStatus = (id, st)=> setStatus(id, st, "admin-map");

function focusMarker(id){
  const mk = markerById.get(id);
  if(!mk) return;
  map.setView(mk.getLatLng(), Math.max(map.getZoom(), 16), {animate:true});
  mk.openPopup();
}

/* ===========================
 *  Utils
 * =========================== */
function escapeHTML(s){
  return (s||"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function downloadBlob(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function toCSV(rows){
  const cols = Object.keys(rows[0]||{});
  const esc = (v)=>{
    const s = (v??"").toString().replaceAll('"','""');
    return `"${s}"`;
  };
  const head = cols.map(esc).join(",");
  const body = rows.map(r=>cols.map(c=>esc(r[c])).join(",")).join("\n");
  return head + "\n" + body;
}

/* ===========================
 *  Initial render
 * =========================== */
initMap();
renderAll();

function renderAll(){
  renderKPI();
  renderTable();
  renderMap();
}
</script>
</body>
</html>
