<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>OFA é…é”ã‚¢ãƒ—ãƒª</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆiPhoneå¯¾å¿œï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
:root{
  --yellow:#FFD400;
  --blue:#2563eb;
  --red:#ef4444;
  --gray:#e5e7eb;
}
body{
  margin:0;
  font-family:"Noto Sans JP",sans-serif;
  background:#f5f7fb;
}
header{
  position:sticky;top:0;z-index:10;
  background:#fff;border-bottom:1px solid #ddd;
}
.top{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px;
}
.logo{
  width:40px;height:40px;border-radius:12px;
  background:linear-gradient(135deg,var(--yellow),#fff2a8);
  display:grid;place-items:center;font-weight:900;
}
nav{
  display:flex;gap:6px;padding:6px;
}
.tab{
  flex:1;padding:10px;border-radius:12px;
  border:1px solid #ddd;background:#fff;font-weight:900;
}
.tab.active{background:#eef3ff}
main{padding:10px}
.card{
  background:#fff;border-radius:16px;padding:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
}
button{
  border:0;border-radius:12px;padding:10px;font-weight:900;
}
.btn-yellow{background:var(--yellow)}
.btn-blue{background:var(--blue);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-gray{background:var(--gray)}
.list{display:grid;gap:10px;margin-top:10px}
.item{
  border:1px solid #ddd;border-radius:12px;padding:10px;
}
.badge{
  display:inline-block;padding:3px 8px;border-radius:999px;
  border:1px solid #ddd;font-size:11px;font-weight:900;
}
.warn{color:var(--red)}
video{width:100%;border-radius:12px}
.mini{font-size:12px;color:#666}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
input,select{
  width:100%;padding:8px;border-radius:10px;border:1px solid #ccc;
}
</style>
</head>

<body>

<header>
  <div class="top">
    <div style="display:flex;gap:8px;align-items:center">
      <div class="logo">OFA</div>
      <div>
        <b>é…é”ã‚¢ãƒ—ãƒª</b><br>
        <small>ãƒ¤ãƒãƒˆå‹ãƒ»å®Œå…¨ç‰ˆ</small>
      </div>
    </div>
    <div id="gps">GPS: æœªå–å¾—</div>
  </div>
  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="todo">æœªé…é”</button>
    <button class="tab" data-tab="done">å®Œäº†</button>
  </nav>
</header>

<main>

<!-- SCAN -->
<section id="scan" class="card">
  <button class="btn-blue" onclick="getGPS()">ğŸ“ GPSå–å¾—</button>
  <button class="btn-yellow" onclick="startScan()">ğŸ“· é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³</button>
  <button class="btn-gray" onclick="toggleTorch()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>

  <label style="margin-top:10px">è·ç‰©ç¨®åˆ¥</label>
  <select id="kind">
    <option>å®…é…</option>
    <option>æ‰‹ç´™</option>
    <option>ãƒã‚¹ãƒˆæŠ•å‡½</option>
    <option>å†·è”µãƒ»å†·å‡</option>
    <option>ä»£å¼•</option>
    <option>å¤§ç‰©</option>
    <option>å£Šã‚Œç‰©</option>
    <option>æ›¸é¡</option>
    <option>åŒ»ç™‚å“</option>
    <option>å»ºæ</option>
  </select>

  <div id="camera" style="display:none;margin-top:8px">
    <video id="video"></video>
  </div>

  <button class="btn-gray" style="margin-top:8px" onclick="tempAdd()">ï¼‹ èª­ã‚ãªã„è·ç‰©ï¼ˆä»®ç™»éŒ²ï¼‰</button>
</section>

<!-- TODO -->
<section id="todo" class="card" style="display:none">
  <div class="list" id="todoList"></div>
</section>

<!-- DONE -->
<section id="done" class="card" style="display:none">
  <div class="list" id="doneList"></div>
</section>

</main>

<script>
/* ===== åŸºæœ¬ ===== */
const KEY="ofa_yamato_complete";
let data=JSON.parse(localStorage.getItem(KEY)||"[]");
let gps=null;
let stream,track,torch=false;
const reader=new ZXing.BrowserMultiFormatReader();

/* ===== Tabs ===== */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    ["scan","todo","done"].forEach(id=>document.getElementById(id).style.display="none");
    document.getElementById(t.dataset.tab).style.display="block";
    render();
  }
});

/* ===== GPS ===== */
function getGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    gps={lat:p.coords.latitude,lng:p.coords.longitude};
    document.getElementById("gps").innerText="GPS: OK";
  });
}

/* ===== Scan ===== */
async function startScan(){
  document.getElementById("camera").style.display="block";
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  track=stream.getVideoTracks()[0];
  video.srcObject=stream;
  video.play();

  reader.decodeFromVideoElement(video,(res)=>{
    if(res) add(res.text);
  });
}

/* ===== Torch ===== */
async function toggleTorch(){
  if(!track) return;
  torch=!torch;
  await track.applyConstraints({advanced:[{torch}]});
}

/* ===== Add ===== */
function add(code){
  if(data.find(x=>x.code===code && x.status==="todo")) return;
  data.push({
    id:Date.now()+Math.random(),
    code,
    kind:kind.value,
    name:"",
    address:"",
    status:"todo",
    time:new Date().toLocaleString()
  });
  save(); render();
}

/* ä»®ç™»éŒ² */
function tempAdd(){
  const n=data.filter(x=>x.code.startsWith("TEMP")).length+1;
  add("TEMP-"+String(n).padStart(4,"0"));
}

/* ===== OCR ===== */
async function ocr(id){
  const img=prompt("ç”»åƒURLã‚’è²¼ã£ã¦ãã ã•ã„ï¼ˆç°¡æ˜“OCRï¼‰");
  if(!img) return;
  const r=await Tesseract.recognize(img,"jpn");
  alert(r.data.text);
}

/* ===== é…é” ===== */
function nav(i){
  if(!i.address||!i.name) return alert("åå‰ãƒ»ä½æ‰€å¿…é ˆ");
  const url=gps
    ?`https://www.google.com/maps/dir/?api=1&origin=${gps.lat},${gps.lng}&destination=${encodeURIComponent(i.address)}`
    :`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.address)}`;
  window.open(url,"_blank");
}
function complete(i){
  if(!i.name||!i.address) return alert("åå‰ãƒ»ä½æ‰€å¿…é ˆ");
  i.status="done";
  i.done=new Date().toLocaleString();
  save(); render();
}

/* ===== Render ===== */
function render(){
  todoList.innerHTML=""; doneList.innerHTML="";
  data.filter(x=>x.status==="todo").forEach(x=>{
    todoList.innerHTML+=`
    <div class="item">
      <b>${x.code}</b>
      <div class="mini">
        <span class="badge">${x.kind}</span>
        ${(!x.name||!x.address)?'<span class="warn">âš  æœªå…¥åŠ›</span>':""}
      </div>
      <input placeholder="å®›åï¼ˆå¿…é ˆï¼‰" value="${x.name}" oninput="x=this.parentNode.obj.name=this.value">
      <input placeholder="ä½æ‰€ï¼ˆå¿…é ˆï¼‰" value="${x.address}" oninput="x=this.parentNode.obj.address=this.value">
      <div class="actions">
        <button class="btn-blue" onclick="nav(this.parentNode.parentNode.obj)">ãƒŠãƒ“</button>
        <button class="btn-yellow" onclick="complete(this.parentNode.parentNode.obj)">å®Œäº†</button>
        <button class="btn-gray" onclick="ocr(this.parentNode.parentNode.obj.id)">OCR</button>
      </div>
    </div>`;
    todoList.lastChild.obj=x;
  });
  data.filter(x=>x.status==="done").forEach(x=>{
    doneList.innerHTML+=`
    <div class="item">
      <b>${x.code}</b>
      <div class="mini">${x.kind} / å®Œäº† ${x.done}</div>
    </div>`;
  });
}
function save(){localStorage.setItem(KEY,JSON.stringify(data))}
render();
</script>

</body>
</html>
