<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>OFA é…é”ã‚¢ãƒ—ãƒªï¼ˆãƒªã‚¹ãƒˆÃ—åœ°å›³ï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- Map: Leaflet + MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
:root{
  --yellow:#FFD400; --blue:#2563eb; --red:#ef4444; --gray:#e5e7eb; --ink:#0f172a; --muted:#64748b;
  --line:#e2e8f0; --card:#fff; --bg:#f5f7fb; --r:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans JP",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line)}
.top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--yellow),#fff2a8);display:grid;place-items:center;font-weight:900}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:7px 10px;font-size:12px;background:#fff;color:var(--muted)}
nav{display:flex;gap:8px;padding:8px 12px 12px}
.tab{flex:1;border:1px solid var(--line);border-radius:14px;padding:12px;font-weight:900;background:#fff}
.tab.active{background:#eef3ff}
main{padding:12px;display:grid;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px;box-shadow:0 10px 26px rgba(15,23,42,.08)}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{border:0;border-radius:14px;padding:11px 12px;font-weight:900}
.btn-yellow{background:var(--yellow)}
.btn-blue{background:var(--blue);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-gray{background:var(--gray)}
input,select,textarea{width:100%;border:1px solid #cbd5e1;border-radius:12px;padding:10px;font-size:14px}
label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
.list{display:grid;gap:10px}
.item{border:1px solid var(--line);border-radius:14px;padding:10px}
.itemHead{display:flex;justify-content:space-between;gap:10px;align-items:center}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;font-weight:900;background:#f8fafc}
.warn{color:var(--red);font-weight:900}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
#map{height:52vh;border-radius:14px;overflow:hidden;border:1px solid var(--line)}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .chip{font-weight:900}
hr{border:0;border-top:1px solid var(--line);margin:10px 0}
</style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">OFA</div>
      <div>
        <b>é…é”ã‚¢ãƒ—ãƒª</b><br>
        <span class="small">ãƒªã‚¹ãƒˆ â‡„ åœ°å›³ï¼ˆãƒ”ãƒ³ï¼‰ã§è¦‹ãˆã‚‹åŒ–</span>
      </div>
    </div>
    <div class="chip" id="gps">GPS: æœªå–å¾—</div>
  </div>
  <nav>
    <button class="tab active" data-tab="add">ç™»éŒ²</button>
    <button class="tab" data-tab="list">ãƒªã‚¹ãƒˆ</button>
    <button class="tab" data-tab="map">åœ°å›³</button>
  </nav>
</header>

<main>
  <!-- ç™»éŒ² -->
  <section id="add" class="card">
    <div class="row">
      <button class="btn-blue" onclick="getGPS()">ğŸ“ GPSå–å¾—</button>
      <button class="btn-gray" onclick="tempAdd()">ï¼‹ ä»®ç™»éŒ²</button>
      <button class="btn-gray" onclick="exportCSV()">â¬‡ CSV</button>
    </div>

    <hr>

    <label>è·ç‰©ç•ªå·ï¼ˆä»»æ„ï¼šä»®ç™»éŒ²OKï¼‰</label>
    <input id="code" placeholder="ä¾‹ï¼‰1234-5678ï¼ˆç„¡ã‘ã‚Œã°ç©ºã§OKï¼‰">

    <label>è·ç‰©ç¨®åˆ¥</label>
    <select id="kind">
      <option value="å®…é…">å®…é…</option>
      <option value="æ‰‹ç´™">æ‰‹ç´™</option>
      <option value="ãƒã‚¹ãƒˆæŠ•å‡½">ãƒã‚¹ãƒˆæŠ•å‡½</option>
      <option value="å†·è”µãƒ»å†·å‡">å†·è”µãƒ»å†·å‡</option>
      <option value="ä»£å¼•">ä»£å¼•</option>
      <option value="å¤§ç‰©">å¤§ç‰©</option>
      <option value="å£Šã‚Œç‰©">å£Šã‚Œç‰©</option>
      <option value="æ›¸é¡">æ›¸é¡</option>
      <option value="åŒ»ç™‚å“">åŒ»ç™‚å“</option>
      <option value="å»ºæ">å»ºæ</option>
    </select>

    <label>å®›åï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰</label>
    <input id="name" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ">

    <label>ä½æ‰€ï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆ / ãƒ”ãƒ³ç”¨ï¼‰</label>
    <input id="address" placeholder="ä¾‹ï¼‰å¤§é˜ªå¸‚â—¯â—¯åŒºâ—¯â—¯â€¦">

    <div class="row" style="margin-top:10px">
      <button class="btn-yellow" onclick="add()">ï¼‹ ç™»éŒ²ï¼ˆä½æ‰€ãŒã‚ã‚Œã°ãƒ”ãƒ³åŒ–ï¼‰</button>
      <button class="btn-gray" onclick="batchGeocode()">ğŸ§­ æœªã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä¸€æ‹¬ãƒ”ãƒ³åŒ–</button>
    </div>

    <div class="small" id="msg" style="margin-top:8px">ãƒ’ãƒ³ãƒˆï¼šæŒã¡å‡ºã—æ™‚ã¯ä»®ç™»éŒ²â†’é…é”å‰ã«ä½æ‰€/å®›åã‚’å…¥ã‚Œã‚‹é‹ç”¨ãŒé€Ÿã„ã€‚</div>
  </section>

  <!-- ãƒªã‚¹ãƒˆ -->
  <section id="list" class="card" style="display:none">
    <div class="kpi">
      <span class="chip">æœªé…é”: <b id="kTodo">0</b></span>
      <span class="chip">å®Œäº†: <b id="kDone">0</b></span>
      <span class="chip">ä¸åœ¨: <b id="kAbsent">0</b></span>
      <span class="chip">ãƒ”ãƒ³æœ‰: <b id="kPinned">0</b></span>
    </div>
    <div class="small" style="margin-top:8px">ãƒªã‚¹ãƒˆã‚’æŠ¼ã™ã¨åœ°å›³ãŒãã®ãƒ”ãƒ³ã¸ç§»å‹•ã—ã¾ã™ã€‚</div>
    <div class="list" id="listBox" style="margin-top:10px"></div>
  </section>

  <!-- åœ°å›³ -->
  <section id="map" class="card" style="display:none">
    <div class="row">
      <button class="btn-blue" onclick="fitAll()">ğŸ—º å…¨ãƒ”ãƒ³è¡¨ç¤º</button>
      <button class="btn-gray" onclick="centerMe()">ğŸ¯ ç¾åœ¨åœ°ã¸</button>
      <button class="btn-gray" onclick="renderMap(true)">ğŸ”„ ãƒ”ãƒ³å†æç”»</button>
    </div>
    <div id="map" style="margin-top:10px"></div>
    <div class="small" style="margin-top:8px">
      ãƒ”ãƒ³ã‚’ã‚¿ãƒƒãƒ—â†’è©³ç´°ï¼ãƒŠãƒ“ï¼å®Œäº†ãƒ»ä¸åœ¨ãªã©æ“ä½œã§ãã¾ã™ã€‚
    </div>
  </section>
</main>

<script>
/* ====== ãƒ‡ãƒ¼ã‚¿ ====== */
const KEY="ofa_delivery_map_v1";
let items = JSON.parse(localStorage.getItem(KEY) || "[]");
let gps=null;

function save(){ localStorage.setItem(KEY, JSON.stringify(items)); }

/* ====== ã‚¿ãƒ– ====== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    ["add","list","map"].forEach(id=>document.getElementById(id).style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
    if(btn.dataset.tab==="list") renderList();
    if(btn.dataset.tab==="map") setTimeout(()=>initMapIfNeeded(), 0);
  };
});

/* ====== GPS ====== */
function getGPS(){
  navigator.geolocation.getCurrentPosition(
    p=>{
      gps={lat:p.coords.latitude,lng:p.coords.longitude};
      document.getElementById("gps").textContent="GPS: OK";
      if(meMarker) meMarker.setLatLng([gps.lat,gps.lng]);
      if(map && !map._userCentered){ map.setView([gps.lat,gps.lng], 14); map._userCentered=true; }
    },
    e=>alert("GPSå–å¾—ã§ãã¾ã›ã‚“ï¼ˆiPhoneè¨­å®šâ†’ä½ç½®æƒ…å ±â†’Safariã‚’è¨±å¯ï¼‰")
  );
}

/* ====== è¿½åŠ  ====== */
function tempAdd(){
  const n = items.filter(x=>String(x.code||"").startsWith("TEMP-")).length + 1;
  const code = `TEMP-${String(n).padStart(4,"0")}`;
  items.push(mkItem({code}));
  save();
  flash(`ä»®ç™»éŒ²ã—ã¾ã—ãŸï¼š${code}`);
}
function add(){
  const code = (document.getElementById("code").value||"").trim() || "";
  const kind = document.getElementById("kind").value;
  const name = (document.getElementById("name").value||"").trim();
  const address = (document.getElementById("address").value||"").trim();

  items.push(mkItem({code: code || autoTemp(), kind, name, address}));
  save();
  flash("ç™»éŒ²ã—ã¾ã—ãŸã€‚ä½æ‰€ãŒã‚ã‚‹å ´åˆã¯ãƒ”ãƒ³åŒ–ã§ãã¾ã™ï¼ˆã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã€‚");

  document.getElementById("code").value="";
  document.getElementById("name").value="";
  document.getElementById("address").value="";

  // ä½æ‰€ãŒã‚ã‚Œã°å³ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ1ä»¶ï¼‰
  const it = items[items.length-1];
  if(it.address) geocodeItem(it, true);
}
function autoTemp(){
  const n = items.filter(x=>String(x.code||"").startsWith("TEMP-")).length + 1;
  return `TEMP-${String(n).padStart(4,"0")}`;
}
function mkItem({code, kind="å®…é…", name="", address=""}){
  return {
    id: String(Date.now()+Math.random()),
    code: code || autoTemp(),
    kind, name, address,
    status: "todo",        // todo | done | absent
    createdAt: new Date().toLocaleString(),
    lat: null, lng: null,  // ãƒ”ãƒ³
    geocodeAt: null
  };
}
function flash(t){ document.getElementById("msg").textContent=t; }

/* ====== ãƒªã‚¹ãƒˆ ====== */
function renderList(){
  const box=document.getElementById("listBox");
  box.innerHTML="";

  const todo = items.filter(x=>x.status==="todo").length;
  const done = items.filter(x=>x.status==="done").length;
  const absent = items.filter(x=>x.status==="absent").length;
  const pinned = items.filter(x=>Number.isFinite(x.lat)&&Number.isFinite(x.lng)).length;

  document.getElementById("kTodo").textContent=todo;
  document.getElementById("kDone").textContent=done;
  document.getElementById("kAbsent").textContent=absent;
  document.getElementById("kPinned").textContent=pinned;

  // ãƒ¤ãƒãƒˆå‹ï¼šæœªé…é”ã‚’ä¸Šã«
  const sorted=[...items].sort((a,b)=>{
    const pa = a.status==="todo"?0:(a.status==="absent"?1:2);
    const pb = b.status==="todo"?0:(b.status==="absent"?1:2);
    return pa-pb;
  });

  sorted.forEach(it=>{
    const warn = (!it.name || !it.address) ? `<span class="warn">âš  æœªå…¥åŠ›</span>` : "";
    const pin = (Number.isFinite(it.lat)&&Number.isFinite(it.lng)) ? "" : `<span class="warn">ğŸ“æœªãƒ”ãƒ³</span>`;
    const st = it.status==="todo"?"æœªé…é”":(it.status==="done"?"å®Œäº†":"ä¸åœ¨");

    const html = `
      <div class="item" onclick="focusItem('${it.id}')">
        <div class="itemHead">
          <b>${esc(it.code)}</b>
          <span class="badge">${esc(it.kind)}</span>
        </div>
        <div class="small">${esc(it.createdAt)} / <b>${st}</b> ${warn} ${pin}</div>
        <div class="small">${esc(it.name||"ï¼ˆå®›åæœªå…¥åŠ›ï¼‰")} / ${esc(it.address||"ï¼ˆä½æ‰€æœªå…¥åŠ›ï¼‰")}</div>
        <div class="actions" onclick="event.stopPropagation()">
          <button class="btn-gray" onclick="editItem('${it.id}')">ç·¨é›†</button>
          <button class="btn-blue" onclick="nav('${it.id}')">ãƒŠãƒ“</button>
          <button class="btn-yellow" onclick="setStatus('${it.id}','done')">å®Œäº†</button>
          <button class="btn-red" onclick="setStatus('${it.id}','absent')">ä¸åœ¨</button>
          <button class="btn-gray" onclick="removeItem('${it.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
    box.insertAdjacentHTML("beforeend", html);
  });
}

/* ====== ç·¨é›†ãƒ»çŠ¶æ…‹ ====== */
function getById(id){ return items.find(x=>x.id===id); }

function editItem(id){
  const it=getById(id); if(!it) return;
  const name = prompt("å®›åï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰", it.name||"");
  if(name===null) return;
  const address = prompt("ä½æ‰€ï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰", it.address||"");
  if(address===null) return;
  it.name = name.trim();
  it.address = address.trim();
  save();
  renderList();
  // ä½æ‰€å¤‰ãˆãŸã‚‰å†ãƒ”ãƒ³åŒ–
  if(it.address) geocodeItem(it, true);
}

function setStatus(id, status){
  const it=getById(id); if(!it) return;

  // é…é”å‰ãƒã‚§ãƒƒã‚¯ï¼ˆâ‘¡ï¼šé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰
  if((status==="done" || status==="absent") && (!it.name || !it.address)){
    alert("é…é”å‰ã¾ã§ã«ã€Œå®›åãƒ»ä½æ‰€ã€ã¯å¿…é ˆã§ã™ã€‚ç·¨é›†ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  it.status=status;
  it.statusAt=new Date().toLocaleString();
  save();
  renderList();
  renderMap(true); // è‰²åæ˜ 
}

function removeItem(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  items = items.filter(x=>x.id!==id);
  save();
  renderList();
  renderMap(true);
}

/* ====== ãƒŠãƒ“ï¼ˆGoogleï¼‰ ====== */
function nav(id){
  const it=getById(id); if(!it) return;
  if(!it.address || !it.name){
    alert("é…é”å‰ã¾ã§ã«ã€Œå®›åãƒ»ä½æ‰€ã€ã¯å¿…é ˆã§ã™ã€‚");
    return;
  }
  const url = gps
    ? `https://www.google.com/maps/dir/?api=1&origin=${gps.lat},${gps.lng}&destination=${encodeURIComponent(it.address)}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address)}`;
  window.open(url, "_blank");
}

/* ====== CSV ====== */
function exportCSV(){
  const header = ["id","code","kind","name","address","status","createdAt","statusAt","lat","lng"];
  const rows = items.map(it=>[
    it.id,it.code,it.kind,it.name,it.address,it.status,it.createdAt,it.statusAt||"",
    (Number.isFinite(it.lat)?it.lat:""),(Number.isFinite(it.lng)?it.lng:"")
  ]);
  const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v??"").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `ofa_delivery_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== åœ°å›³ ====== */
let map=null;
let cluster=null;
let markersById=new Map();
let meMarker=null;

function initMapIfNeeded(){
  if(map) { map.invalidateSize(); renderMap(true); return; }

  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "Â© OpenStreetMap"
  }).addTo(map);

  cluster = L.markerClusterGroup();
  map.addLayer(cluster);

  map.setView([35.681236, 139.767125], 12); // åˆæœŸï¼šæ±äº¬é§…

  meMarker = L.circleMarker([35.681236, 139.767125], {radius:8});
  meMarker.addTo(map);

  if(gps){
    meMarker.setLatLng([gps.lat,gps.lng]);
    map.setView([gps.lat,gps.lng], 14);
    map._userCentered=true;
  }
  renderMap(true);
}

function markerColor(status){
  // Leafletæ¨™æº–ãƒãƒ¼ã‚«ãƒ¼è‰²ã®ä»£ã‚ã‚Šã«ã‚·ãƒ³ãƒ—ãƒ«ãªå††ã§è‰²åˆ†ã‘
  if(status==="done") return "#22c55e";
  if(status==="absent") return "#ef4444";
  return "#2563eb"; // todo
}

function renderMap(force=false){
  if(!map || !cluster) return;

  cluster.clearLayers();
  markersById.clear();

  items.forEach(it=>{
    if(!(Number.isFinite(it.lat) && Number.isFinite(it.lng))) return;

    const col = markerColor(it.status);
    const m = L.circleMarker([it.lat, it.lng], {radius:10, color:col, weight:3, fillColor:col, fillOpacity:0.25});

    m.on("click", ()=>{
      showPopup(it, m);
      // ãƒ”ãƒ³â†’ãƒªã‚¹ãƒˆã¸ã‚‚å¯„ã›ã‚‹
      document.querySelector('[data-tab="list"]').click();
      setTimeout(()=>highlightInList(it.id), 50);
    });

    markersById.set(it.id, m);
    cluster.addLayer(m);
  });

  // ç¾åœ¨åœ°
  if(gps){
    meMarker.setLatLng([gps.lat,gps.lng]);
  }
  setTimeout(()=>map.invalidateSize(), 0);
}

function showPopup(it, marker){
  const st = it.status==="todo"?"æœªé…é”":(it.status==="done"?"å®Œäº†":"ä¸åœ¨");
  const warn = (!it.name || !it.address) ? "âš  å®›å/ä½æ‰€ æœªå…¥åŠ›" : "";
  const html = `
    <div style="min-width:220px">
      <b>${esc(it.code)}</b> <span style="font-weight:900">[${esc(it.kind)}]</span><br>
      <span style="color:#64748b">${esc(st)} ${warn}</span><br><br>
      <div style="font-size:12px;color:#0f172a">${esc(it.name||"ï¼ˆå®›åæœªå…¥åŠ›ï¼‰")}</div>
      <div style="font-size:12px;color:#0f172a">${esc(it.address||"ï¼ˆä½æ‰€æœªå…¥åŠ›ï¼‰")}</div>
      <hr style="border:0;border-top:1px solid #e2e8f0;margin:8px 0">
      <button style="background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 10px;font-weight:900" onclick="nav('${it.id}')">ãƒŠãƒ“</button>
      <button style="background:#FFD400;border:0;border-radius:10px;padding:8px 10px;font-weight:900" onclick="setStatus('${it.id}','done')">å®Œäº†</button>
      <button style="background:#ef4444;color:#fff;border:0;border-radius:10px;padding:8px 10px;font-weight:900" onclick="setStatus('${it.id}','absent')">ä¸åœ¨</button>
      <button style="background:#e5e7eb;border:0;border-radius:10px;padding:8px 10px;font-weight:900" onclick="editItem('${it.id}')">ç·¨é›†</button>
    </div>
  `;
  marker.bindPopup(html).openPopup();
}

function fitAll(){
  initMapIfNeeded();
  const pts = items.filter(x=>Number.isFinite(x.lat)&&Number.isFinite(x.lng)).map(x=>[x.lat,x.lng]);
  if(!pts.length) return alert("ãƒ”ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆä½æ‰€å…¥åŠ›â†’ãƒ”ãƒ³åŒ–ã—ã¦ãã ã•ã„ï¼‰");
  map.fitBounds(pts, {padding:[20,20]});
}

function centerMe(){
  initMapIfNeeded();
  if(!gps) return alert("å…ˆã«GPSå–å¾—ã—ã¦ãã ã•ã„");
  map.setView([gps.lat,gps.lng], 15);
}

/* ====== ãƒªã‚¹ãƒˆâ†’åœ°å›³ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ ====== */
function focusItem(id){
  const it=getById(id); if(!it) return;

  // å…ˆã«åœ°å›³ã¸
  document.querySelector('[data-tab="map"]').click();
  setTimeout(()=>{
    initMapIfNeeded();
    if(Number.isFinite(it.lat) && Number.isFinite(it.lng)){
      map.setView([it.lat,it.lng], 17);
      const m = markersById.get(it.id);
      if(m) showPopup(it, m);
    }else{
      // ãƒ”ãƒ³ãŒç„¡ã„ãªã‚‰ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¿ƒã™
      alert("ã“ã®è·ç‰©ã¯ãƒ”ãƒ³æœªä½œæˆã§ã™ã€‚ä½æ‰€ãŒã‚ã‚Œã°ãƒ”ãƒ³åŒ–ã—ã¾ã™ã€‚");
      if(it.address) geocodeItem(it, true);
    }
  }, 80);
}

function highlightInList(id){
  // ç›®å°ã¨ã—ã¦è»½ãã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç°¡æ˜“ï¼‰
  const el = document.querySelector(`[onclick="focusItem('${id}')"]`);
  if(el) el.scrollIntoView({behavior:"smooth", block:"center"});
}

/* ====== ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä½æ‰€â†’ç·¯åº¦çµŒåº¦ï¼‰ ======
   ç„¡æ–™Nominatimï¼šå¤šæŠ•ã’ç¦æ­¢ãªã®ã§é–“éš”ã‚’ç©ºã‘ã¾ã™ï¼ˆæ¥­å‹™ã§ã¯Googleç­‰æ¨å¥¨ï¼‰
*/
async function geocodeItem(it, autoRender=false){
  if(!it.address) return;
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼šåŒã˜ä½æ‰€ã¯å†åˆ©ç”¨
  const cached = items.find(x=>x.address===it.address && Number.isFinite(x.lat)&&Number.isFinite(x.lng));
  if(cached && cached.id!==it.id){
    it.lat=cached.lat; it.lng=cached.lng; it.geocodeAt=new Date().toLocaleString();
    save();
    if(autoRender){ renderList(); renderMap(true); }
    return;
  }

  try{
    flash("ä½æ‰€ã‚’ãƒ”ãƒ³åŒ–ä¸­â€¦ï¼ˆå°‘ã—å¾…ã£ã¦ãã ã•ã„ï¼‰");
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(it.address)}`;
    const res = await fetch(url, {headers: {"Accept":"application/json"}});
    const js = await res.json();
    if(!js || !js[0]) { flash("ãƒ”ãƒ³åŒ–å¤±æ•—ï¼šä½æ‰€ã‚’ã‚‚ã†å°‘ã—è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    it.lat = parseFloat(js[0].lat);
    it.lng = parseFloat(js[0].lon);
    it.geocodeAt = new Date().toLocaleString();
    save();
    flash("ãƒ”ãƒ³åŒ–OKï¼ˆåœ°å›³ã«åæ˜ ï¼‰");
    if(autoRender){ renderList(); renderMap(true); }
  }catch(e){
    flash("ãƒ”ãƒ³åŒ–å¤±æ•—ï¼šãƒãƒƒãƒˆç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„");
  }
}

async function batchGeocode(){
  // æœªãƒ”ãƒ³ã®ä½æ‰€ã‚ã‚Šã‚’æœ€å¤§10ä»¶ãšã¤ï¼ˆåˆ¶é™å¯¾ç­–ï¼‰
  const targets = items.filter(x=>x.address && !(Number.isFinite(x.lat)&&Number.isFinite(x.lng))).slice(0, 10);
  if(!targets.length) return flash("æœªãƒ”ãƒ³ã®è·ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

  flash(`ä¸€æ‹¬ãƒ”ãƒ³åŒ–é–‹å§‹ï¼š${targets.length}ä»¶ï¼ˆé †ã«å‡¦ç†ã—ã¾ã™ï¼‰`);
  for(let i=0;i<targets.length;i++){
    await geocodeItem(targets[i], true);
    await sleep(900); // é€£æŠ•ã—ãªã„ï¼ˆé‡è¦ï¼‰
  }
  flash("ä¸€æ‹¬ãƒ”ãƒ³åŒ–å®Œäº†");
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* ====== Utils ====== */
function esc(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

/* åˆæœŸ */
renderList();
</script>
</body>
</html>
