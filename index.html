<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>OFA é…é”ã‚¢ãƒ—ãƒª</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- âœ… iPhoneå¯¾å¿œ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆZXingï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
:root{
  --yellow:#FFD400; --blue:#2563eb; --red:#ef4444; --gray:#e5e7eb;
}
body{margin:0;font-family:"Noto Sans JP",sans-serif;background:#f5f7fb;color:#0f172a}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
.top{display:flex;justify-content:space-between;align-items:center;padding:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--yellow),#fff2a8);
display:grid;place-items:center;font-weight:900}
nav{display:flex;gap:6px;padding:6px}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-weight:900}
.tab.active{background:#eef3ff}
main{padding:10px}
.card{background:#fff;border-radius:16px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
button{border:0;border-radius:12px;padding:10px;font-weight:900}
.btn-yellow{background:var(--yellow)}
.btn-blue{background:var(--blue);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-gray{background:var(--gray)}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
select,input{width:100%;padding:10px;border-radius:12px;border:1px solid #cbd5e1}
.small{font-size:12px;color:#64748b}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
.videoWrap{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1220}
video{width:100%;height:260px;object-fit:cover;display:block}
.list{display:grid;gap:10px;margin-top:10px}
.item{border:1px solid #e5e7eb;border-radius:14px;padding:10px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:11px;font-weight:900}
.warn{color:var(--red);font-weight:900}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
</style>
</head>

<body>
<header>
  <div class="top">
    <div style="display:flex;gap:8px;align-items:center">
      <div class="logo">OFA</div>
      <div>
        <b>é…é”ã‚¢ãƒ—ãƒª</b><br><small class="small">ãƒ¤ãƒãƒˆå‹ãƒ»å®Œå…¨ç‰ˆï¼ˆiPhoneå¯¾å¿œï¼‰</small>
      </div>
    </div>
    <div class="pill" id="gps">GPS: æœªå–å¾—</div>
  </div>
  <nav>
    <button class="tab active" data-tab="scan">SCAN</button>
    <button class="tab" data-tab="todo">æœªé…é”</button>
    <button class="tab" data-tab="done">å®Œäº†</button>
  </nav>
</header>

<main>
  <!-- SCAN -->
  <section id="scan" class="card">
    <div class="row">
      <button class="btn-blue" onclick="getGPS()">ğŸ“ GPSå–å¾—</button>
      <button class="btn-yellow" onclick="startScan()">ğŸ“· é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³</button>
      <button class="btn-gray" onclick="stopScan()">â¹ åœæ­¢</button>
      <button class="btn-gray" onclick="toggleTorch()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
    </div>

    <div style="margin-top:10px">
      <label class="small">è·ç‰©ç¨®åˆ¥</label>
      <select id="kind">
        <option value="å®…é…">å®…é…</option>
        <option value="æ‰‹ç´™">æ‰‹ç´™</option>
        <option value="ãƒã‚¹ãƒˆæŠ•å‡½">ãƒã‚¹ãƒˆæŠ•å‡½</option>
        <option value="å†·è”µãƒ»å†·å‡">å†·è”µãƒ»å†·å‡</option>
        <option value="ä»£å¼•">ä»£å¼•</option>
        <option value="å¤§ç‰©">å¤§ç‰©</option>
        <option value="å£Šã‚Œç‰©">å£Šã‚Œç‰©</option>
        <option value="æ›¸é¡">æ›¸é¡</option>
        <option value="åŒ»ç™‚å“">åŒ»ç™‚å“</option>
        <option value="å»ºæ">å»ºæ</option>
      </select>
    </div>

    <div class="videoWrap" id="videoWrap" style="display:none">
      <video id="video" playsinline muted></video>
    </div>

    <div class="row">
      <button class="btn-gray" onclick="tempAdd()">ï¼‹ èª­ã‚ãªã„è·ç‰©ï¼ˆä»®ç™»éŒ²ï¼‰</button>
      <button class="btn-gray" onclick="manualAdd()">ï¼‹ æ‰‹å‹•å…¥åŠ›</button>
    </div>

    <div class="small" id="status" style="margin-top:8px">å¾…æ©Ÿä¸­ï¼šé€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
  </section>

  <!-- TODO -->
  <section id="todo" class="card" style="display:none">
    <div class="small">â€»ã€Œåå‰ãƒ»ä½æ‰€ã€ã¯é…é”å‰ã¾ã§ã«å¿…é ˆï¼ˆæœªå…¥åŠ›ã¯èµ¤è¡¨ç¤ºï¼‰</div>
    <div class="list" id="todoList"></div>
  </section>

  <!-- DONE -->
  <section id="done" class="card" style="display:none">
    <div class="list" id="doneList"></div>
  </section>
</main>

<script>
const KEY="ofa_yamato_complete_v2";
let data = JSON.parse(localStorage.getItem(KEY) || "[]");

let gps=null;
let stream=null;
let track=null;
let torch=false;

let scanning=false;
let lastCode="";
let lastAt=0;

const { BrowserMultiFormatReader, NotFoundException, BarcodeFormat, DecodeHintType } = ZXing;

// âœ… èª­ã‚ã‚‹ç¢ºç‡ã‚’ä¸Šã’ã‚‹ãƒ’ãƒ³ãƒˆï¼ˆä¸»è¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
const hints = new Map();
hints.set(DecodeHintType.POSSIBLE_FORMATS, [
  BarcodeFormat.QR_CODE,
  BarcodeFormat.CODE_128,
  BarcodeFormat.CODE_39,
  BarcodeFormat.EAN_13,
  BarcodeFormat.EAN_8,
  BarcodeFormat.ITF,
  BarcodeFormat.DATA_MATRIX,
  BarcodeFormat.PDF_417
]);
hints.set(DecodeHintType.TRY_HARDER, true);

// é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³é–“éš”ï¼ˆmsï¼‰
const codeReader = new BrowserMultiFormatReader(hints, 250);

const $ = (id)=>document.getElementById(id);

// Tabs
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    ["scan","todo","done"].forEach(id=>$(id).style.display="none");
    $(t.dataset.tab).style.display="block";
    render();
  }
});

function save(){
  localStorage.setItem(KEY, JSON.stringify(data));
}

function getGPS(){
  navigator.geolocation.getCurrentPosition(
    p=>{
      gps={lat:p.coords.latitude,lng:p.coords.longitude};
      $("gps").textContent="GPS: OK";
    },
    e=>alert("GPSå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆè¨­å®šâ†’ä½ç½®æƒ…å ±ã‚’ONï¼‰")
  );
}

function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value=880;
    g.gain.value=0.05;
    o.start();
    setTimeout(()=>{o.stop(); ctx.close();}, 80);
  }catch{}
  if(navigator.vibrate) navigator.vibrate(40);
}

async function startScan(){
  if(scanning) return;
  scanning=true;
  $("status").textContent="ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­â€¦ï¼ˆè¨±å¯ãŒå‡ºãŸã‚‰OKï¼‰";
  $("videoWrap").style.display="block";

  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    track = stream.getVideoTracks()[0];

    $("video").srcObject = stream;
    await $("video").play();

    $("status").textContent="ã‚¹ã‚­ãƒ£ãƒ³ä¸­ï¼šãƒãƒ¼ã‚³ãƒ¼ãƒ‰/QRã‚’æ å†…ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚";

    // âœ… iPhoneã§å®‰å®šï¼šdecodeFromVideoDevice ã‚’ä½¿ã†
    codeReader.decodeFromVideoDevice(null, "video", (result, err) => {
      if(!scanning) return;

      if(result){
        const code = result.getText();
        const now = Date.now();

        // âœ… é€£ç¶šã§åŒã˜ã‚³ãƒ¼ãƒ‰æ‹¾ã†ã®é˜²æ­¢
        if(code === lastCode && (now-lastAt) < 1200) return;
        lastCode = code; lastAt = now;

        add(code);
        beep();
        $("status").textContent=`èª­ã¿å–ã‚ŠOKï¼š${code}`;
      }else if(err && !(err instanceof NotFoundException)){
        // NotFoundã¯ã€Œè¦‹ã¤ã‹ã‚‰ãªã„ã€ãªã®ã§ç„¡è¦–ã€‚ãã®ä»–ã ã‘è¡¨ç¤º
        $("status").textContent="èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ï¼šè·é›¢/æ˜ã‚‹ã•/è§’åº¦ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚";
      }
    });
  }catch(e){
    scanning=false;
    $("status").textContent="ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ï¼šSafariã®ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã€‚iPhoneè¨­å®šâ†’Safariâ†’ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã€ã¾ãŸã¯ã‚µã‚¤ãƒˆè¨­å®šã§ã‚«ãƒ¡ãƒ©è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
  }
}

function stopScan(){
  scanning=false;
  try{ codeReader.reset(); }catch{}
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null; track=null;
  }
  $("status").textContent="åœæ­¢ã—ã¾ã—ãŸã€‚";
}

async function toggleTorch(){
  try{
    if(!track) return alert("å…ˆã«é€£ç¶šã‚¹ã‚­ãƒ£ãƒ³ã§ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚");
    const cap = track.getCapabilities ? track.getCapabilities() : {};
    if(!cap.torch) return alert("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ã«éå¯¾å¿œã§ã™ã€‚");
    torch = !torch;
    await track.applyConstraints({ advanced: [{ torch }] });
  }catch(e){
    alert("ãƒ©ã‚¤ãƒˆåˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  }
}

function tempAdd(){
  const n = data.filter(x=>String(x.code||"").startsWith("TEMP-")).length + 1;
  add(`TEMP-${String(n).padStart(4,"0")}`);
}

function manualAdd(){
  const code = prompt("è·ç‰©ç•ªå·ï¼ˆç„¡ã‘ã‚Œã°ç©ºã§ã‚‚OKï¼‰");
  const fixed = (code && code.trim()) ? code.trim() : "";
  if(!fixed){
    tempAdd();
  }else{
    add(fixed);
  }
}

function add(code){
  // é‡è¤‡é˜²æ­¢ï¼ˆæœªé…é”å†…ï¼‰
  if(data.find(x=>x.code===code && x.status==="todo")) return;

  data.push({
    id: Date.now() + Math.random(),
    code,
    kind: $("kind").value,
    name: "",
    address: "",
    status: "todo",
    createdAt: new Date().toLocaleString()
  });
  save();
  render();
}

function openNav(item){
  if(!item.name || !item.address){
    alert("é…é”å‰ã¾ã§ã«ã€Œåå‰ãƒ»ä½æ‰€ã€ã¯å¿…é ˆã§ã™ã€‚æœªå…¥åŠ›ã‚’åŸ‹ã‚ã¦ãã ã•ã„ã€‚");
    return;
  }
  const url = gps
    ? `https://www.google.com/maps/dir/?api=1&origin=${gps.lat},${gps.lng}&destination=${encodeURIComponent(item.address)}`
    : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`;
  window.open(url, "_blank");
}

function markDone(item){
  if(!item.name || !item.address){
    alert("é…é”å‰ã¾ã§ã«ã€Œåå‰ãƒ»ä½æ‰€ã€ã¯å¿…é ˆã§ã™ã€‚æœªå…¥åŠ›ã‚’åŸ‹ã‚ã¦ãã ã•ã„ã€‚");
    return;
  }
  item.status="done";
  item.doneAt=new Date().toLocaleString();
  save();
  render();

  // âœ… æ¬¡ã®æœªé…é”ã¸è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¤ãƒãƒˆå‹ï¼‰
  const next = data.find(x=>x.status==="todo");
  if(next){
    // æœªé…é”ã‚¿ãƒ–ã¸
    document.querySelector('[data-tab="todo"]').click();
  }
}

function render(){
  $("todoList").innerHTML="";
  $("doneList").innerHTML="";

  const todos = data.filter(x=>x.status==="todo");
  const dones = data.filter(x=>x.status==="done");

  todos.forEach(x=>{
    const warn = (!x.name || !x.address) ? `<span class="warn">âš  æœªå…¥åŠ›</span>` : "";
    $("todoList").insertAdjacentHTML("beforeend", `
      <div class="item" data-id="${x.id}">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <b>${escapeHtml(x.code)}</b>
          <span class="badge">${escapeHtml(x.kind)}</span>
        </div>
        <div class="small">${escapeHtml(x.createdAt)} ${warn}</div>

        <div style="margin-top:8px" class="small">å®›åï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰</div>
        <input placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ" value="${escapeAttr(x.name)}" oninput="updateField('${x.id}','name',this.value)">

        <div style="margin-top:8px" class="small">ä½æ‰€ï¼ˆé…é”å‰ã¾ã§ã«å¿…é ˆï¼‰</div>
        <input placeholder="ä¾‹ï¼‰å¤§é˜ªå¸‚ã€‡ã€‡åŒºã€‡ã€‡â€¦" value="${escapeAttr(x.address)}" oninput="updateField('${x.id}','address',this.value)">

        <div class="actions">
          <button class="btn-blue" onclick="openNav(getItem('${x.id}'))">ãƒŠãƒ“</button>
          <button class="btn-yellow" onclick="markDone(getItem('${x.id}'))">${(x.kind==='æ‰‹ç´™'||x.kind==='ãƒã‚¹ãƒˆæŠ•å‡½')?'æŠ•å‡½å®Œäº†':'é…é”å®Œäº†'}</button>
          <button class="btn-gray" onclick="quickFill('${x.id}')">âš¡ ä½æ‰€/åå‰ã‚’è²¼ä»˜</button>
          <button class="btn-red" onclick="removeItem('${x.id}')">å‰Šé™¤</button>
        </div>
      </div>
    `);
  });

  dones.forEach(x=>{
    $("doneList").insertAdjacentHTML("beforeend", `
      <div class="item">
        <b>${escapeHtml(x.code)}</b>
        <div class="small"><span class="badge">${escapeHtml(x.kind)}</span> å®Œäº†ï¼š${escapeHtml(x.doneAt||"")}</div>
        <div class="small">${escapeHtml(x.name||"")} / ${escapeHtml(x.address||"")}</div>
      </div>
    `);
  });
}

function getItem(id){
  return data.find(x=>String(x.id)===String(id));
}

function updateField(id, key, val){
  const it = getItem(id);
  if(!it) return;
  it[key]=val;
  save();
}

function quickFill(id){
  const it = getItem(id);
  if(!it) return;
  const clip = prompt("ä½æ‰€ã‚„å®›åã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹ï¼šå±±ç”°å¤ªéƒ å¤§é˜ªå¸‚â€¦ï¼‰\nâ†’è‡ªåˆ†ã§ã‚³ãƒ”ãƒšã—ã¦è²¼ã£ã¦OK");
  if(!clip) return;
  // è¶…ç°¡æ˜“ï¼šæœ€åˆã®1è¡Œã‚’åå‰ã£ã½ãã€æ®‹ã‚Šã‚’ä½æ‰€ã«å¯„ã›ã‚‹
  const s = clip.replace(/\r/g,"").trim();
  if(!s) return;

  // ä½æ‰€ã£ã½ã„æ–‡å­—ï¼ˆéƒ½é“åºœçœŒ/å¸‚/åŒº/ç”º/ä¸ç›®ãªã©ï¼‰ãŒå…¥ã£ã¦ã„ã‚Œã°ä½æ‰€ã«
  const hasAddr = /(éƒ½|é“|åºœ|çœŒ|å¸‚|åŒº|ç”º|æ‘|ä¸ç›®|ç•ªåœ°|å·)/.test(s);

  if(hasAddr){
    // å…ˆé ­ã«åå‰ãŒå…¥ã£ã¦ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ã‚ã‚‹ã®ã§ã€åŒºåˆ‡ã‚Šã§åˆ†è§£
    const parts = s.split(/\s+/);
    if(parts.length>=2){
      it.name = it.name || parts[0];
      it.address = it.address || parts.slice(1).join(" ");
    }else{
      it.address = it.address || s;
    }
  }else{
    it.name = it.name || s;
  }
  save(); render();
}

function removeItem(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  data = data.filter(x=>String(x.id)!==String(id));
  save(); render();
}

function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function escapeAttr(str){ return escapeHtml(str); }

// åˆæœŸæç”»
render();

// ãƒšãƒ¼ã‚¸é›¢è„±ã§ã‚«ãƒ¡ãƒ©åœæ­¢
window.addEventListener("beforeunload", stopScan);
</script>
</body>
</html>
